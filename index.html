<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="monetag" content="22d6e8efe3a929cb1e541a157eff8963">
    <!-- Old Ad Script (Used for Daily Task) -->
    <script src='//libtl.com/sdk.js' data-zone='9966888' data-sdk='show_9966888'></script>
    <!-- NEW Rewarded Ad Script for Mining -->
    <script src='//libtl.com/sdk.js' data-zone='9966767' data-sdk='show_9966767'></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tap-Tap Coin Game</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ===== START: NEW LOADING SCREEN STYLES ===== */
        #firebase-loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999;
            margin:0; 
            overflow:hidden;
            display:flex;
            align-items:center;
            justify-content:center;
            background:#000;
            font-family:Arial, sans-serif;
            color:#fff;
            transition: opacity 0.8s ease-out;
        }
        #firebase-loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #firebase-loading-screen #bg {
            position:absolute;
            inset:0;
            background-size:cover;
            background-position:center;
            background-repeat:no-repeat;
        }
        #firebase-loading-screen #center {
            position:absolute;
            top:150px;
            left:50%;
            transform:translateX(-50%);
            max-width:50%;
            display:none;
            border-radius:18px;
            box-shadow:0 10px 30px rgba(0,0,0,0.4);
        }
        #firebase-loading-screen #trees {
            position:absolute;
            left:50%;
            transform:translateX(-50%);
            bottom:130px;
            background:linear-gradient(90deg,#ffa9de,#ffcba4);
            padding:8px 16px;
            border-radius:20px;
            font-weight:700;
            color:#fff;
            box-shadow:0 8px 20px rgba(0,0,0,0.2);
        }
        #firebase-loading-screen #progress-box {
            position:absolute;
            left:24px;
            right:24px;
            bottom:40px;
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        #firebase-loading-screen #bar {
            width:100%;
            height:26px;
            background:#512b1b;
            border-radius:16px;
            padding:3px;
        }
        #firebase-loading-screen #bar-inner {
            height:100%;
            width:0%;
            background:linear-gradient(90deg,#65e95d,#3cc031);
            border-radius:14px;
            transition:width 0.25s ease-out;
        }
        #firebase-loading-screen #bar-text {
            margin-top:8px;
            font-weight:600;
        }
        #firebase-loading-screen canvas {
            position:absolute;
            inset:0;
            pointer-events:none;
        }
        /* ===== END: NEW LOADING SCREEN STYLES ===== */

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;500;700&display=swap');

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body{
            background-color:#1a1a2e;
            color:#fff;
            font-family:'Poppins',sans-serif;
            display:flex;
            justify-content:center;
            align-items:center;
            user-select:none;
            -webkit-user-select:none;
        }
        
        .game-container{
            width:100%; 
            height:100%; 
            display:flex; 
            flex-direction:column; 
            position: relative; 
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e); 
            overflow: hidden;
        }
        
        .screen {
            flex-grow:1; 
            display:flex; 
            flex-direction:column; 
            justify-content: center; 
            align-items:center; 
            width:100%; 
            z-index: 2; 
            padding: 20px; 
            box-sizing: border-box; 
            position: relative; 
            overflow-y: auto;
            padding-bottom: 150px;
        }
        .screen.hidden{display:none}

        .scrollable-screen {
            justify-content: flex-start;
            padding-top: 30px;
        }

        .top-bar-container { position: absolute; top: 15px; left: 15px; z-index: 10; }
        .profile-section { display: flex; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 50px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: background-color 0.2s; }
        .profile-section:hover { background-color: rgba(0,0,0,0.5); }
        .profile-icon { font-size: 20px; }
        #player-name-display { font-size: 16px; font-weight: 600; }
        
        #notification-bell {
            position: absolute; top: 15px; right: 65px;
            z-index: 11; font-size: 28px; cursor: pointer;
            padding: 8px; background-color: rgba(0,0,0,0.3);
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        #notification-dot {
            position: absolute; top: 5px; right: 5px;
            width: 10px; height: 10px;
            background-color: red; border-radius: 50%;
            border: 2px solid #1a1a2e;
            display: none; 
        }
        #notification-dot.visible { display: block; }
        #notification-list { max-height: 250px; overflow-y: auto; text-align: left; width: 100%; }
        .notification-item { background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }

        #diamond-display {
            position: absolute; top: 15px; right: 15px;
            z-index: 11; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            background-color: rgba(0,0,0,0.3);
            padding: 6px 12px; border-radius: 50px;
            border: 1px solid rgba(0, 246, 255, 0.3);
        }
        #diamond-count {
            font-size: 16px;
            font-weight: 700;
            color: #00e0ff;
        }

        .nav-container{
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            display:flex;
            justify-content:space-around;
            background-color:rgba(0,0,0,.3);
            padding: 10px 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
            z-index: 100;
            backdrop-filter: blur(5px);
            box-sizing: border-box;
        }
        .nav-button{cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:5px;opacity:.8;transition:opacity .2s; flex: 1;}
        .nav-button:hover,.nav-button.active{opacity:1}
        .nav-icon{font-size:28px}
        .nav-text{font-size:14px}
        
        #offer-nav-button {
            border-radius: 12px;
            background-color: rgba(243, 156, 18, 0.2);
            animation: pulse-offer-button 2.5s infinite ease-in-out;
            transform-origin: center center;
        }
        @keyframes pulse-offer-button {
            0% { transform: scale(1); box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }
            50% { transform: scale(1.08); box-shadow: 0 0 20px rgba(243, 156, 18, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }
        }

        /* --- STYLES FOR ALL SIDE BUTTONS --- */
        #rewards-hub-button, #mining-button, #daily-tasks-side-button, #refer-button {
            position: absolute;
            left: 20px;
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: pulse-boost 2s infinite;
        }

        #mining-button {
            top: 130px;
            background: linear-gradient(45deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.5);
        }
        #rewards-hub-button {
            top: 180px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
        }
        #daily-tasks-side-button {
            top: 230px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.5);
        }
        #refer-button {
            top: 280px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.5);
        }

        #rewards-hub-button:hover, #mining-button:hover, #daily-tasks-side-button:hover, #refer-button:hover {
            transform: scale(1.1);
        }
        @keyframes pulse-boost {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        h2, h3{font-size:32px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        h3 {font-size: 28px;}
        p{font-size:18px;margin:5px 0}
        .back-button{background-color:#4CAF50;color:#fff;border:none;padding:15px 30px;font-size:18px;border-radius:10px;cursor:pointer;font-family:'Poppins',sans-serif; margin-top: 20px;}
        .popup{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .popup-content{background-color:#2c3e50;padding:30px;border-radius:15px;text-align:center;width:90%;max-width:380px;position:relative}
        .popup-content h3{margin-top:0}
        .popup-close{position:absolute;top:10px;right:15px;font-size:30px;cursor:pointer}
        
        .options-container { display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 400px; }
        .option-card { background-color: rgba(0,0,0,0.2); border: 2px solid #8e44ad; padding: 20px; border-radius: 15px; text-align: center; cursor: default; transition: background-color 0.2s; }
        .option-card.clickable:hover { background-color: rgba(0,0,0,0.4); cursor: pointer; }
        .option-card h3 { margin: 0 0 10px 0; color: #9b59b6; }
        .option-card p { margin: 0 0 15px 0; font-size: 16px; }
        .option-card img { max-width: 60px; max-height: 60px; margin-top: 10px; border-radius: 8px;}
        .action-button { background-color: #9b59b6; color: white; border: none; padding: 10px 20px; font-size: 18px; border-radius: 10px; cursor: pointer; font-family: 'Poppins',sans-serif; transition: background-color 0.2s;}
        .action-button:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        
        
        .tournament-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #f39c12;
            padding: 20px;
            border-radius: 15px;
            text-align: left;
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s;
        }
        .tournament-card.finished {
            opacity: 0.6;
            border-color: #7f8c8d;
        }

        .tournament-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .tournament-card-logo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            background-color: rgba(0,0,0,0.3);
        }
        .tournament-card-title h3 {
            margin: 0;
            color: #f1c40f;
            font-size: 22px;
        }
        .tournament-card-title p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        .tournament-card p {
            font-size: 16px;
            margin: 4px 0;
            line-height: 1.5;
        }
        .tournament-card p strong {
            color: #fff;
        }
        .join-button {
            background-color: #f39c12;
            color: white;
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.2s;
        }
        .join-button:hover:not(:disabled) {
            background-color: #e67e22;
        }
        .join-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #tournament-join-popup .popup-content {
            background-color: #34495e;
        }
        #tournament-join-popup-image {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            margin-bottom: 15px;
            object-fit: cover;
        }
        #tournament-join-popup-fee {
            color: #f1c40f;
            font-weight: bold;
        }
        .join-popup-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            gap: 15px;
        }

        .room-info-container {
            background-color: rgba(46, 204, 113, 0.1);
            border: 1px solid #2ecc71;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .room-info-container h4 {
            margin: 0 0 8px 0;
            color: #2ecc71;
            font-size: 16px;
        }
        .room-info-container p {
            margin: 3px 0;
            font-size: 15px;
        }

        .participant-display-container {
            display: none;
            justify-content: space-around;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid rgba(241, 196, 15, 0.3);
            gap: 5px;
        }
        .team-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            text-align: center;
            min-width: 0;
        }
        .team-list h4 {
            margin: 0 0 8px 0;
            color: #f39c12;
            font-size: 16px;
            text-transform: uppercase;
        }
        .participant-item {
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            background-color: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vs-separator {
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            padding: 0 5px;
            align-self: center;
        }
        
        .participant-item.winner strong {
            color: #f1c40f;
        }
        .prize-distributed-message {
            text-align: center;
            font-weight: bold;
            color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #27ae60;
        }
        
        .screen.tournament-bg {
            background: url('https://images.unsplash.com/photo-1581888224555-93d6a8f1b333?q=80&w=1932&auto=format&fit=crop') no-repeat center center/cover;
            position: relative;
            z-index: 1;
        }
        .screen.tournament-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(10, 10, 25, 0.7);
            z-index: -1;
        }
        
        .reward-task-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .reward-task-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .reward-task-buttons .action-button,
        .reward-task-buttons .join-telegram-button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
        }
        .join-telegram-button {
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins',sans-serif;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }
        .join-telegram-button:hover {
            background-color: #0077b3;
        }

        .floating-ad-emoji {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            z-index: 50;
            user-select: none;
            -webkit-user-select: none;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            will-change: transform;
        }
        
        .offer-submission-prompt {
            width: 95%;
            max-width: 500px;
            background-color: rgba(155, 89, 182, 0.15);
            border: 1px solid #9b59b6;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .offer-submission-prompt p {
            font-size: 14px;
            color: #ddd;
            margin: 0 0 15px 0;
            line-height: 1.5;
        }
        .user-id-container {
            background-color: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .user-id-container strong {
            color: #f39c12;
            font-family: monospace;
        }
        .copy-id-btn {
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .copy-id-btn:hover {
            opacity: 1;
        }
        .send-screenshot-btn {
            display: inline-block;
            background-color: #0088cc;
            color: #ffffff;
            padding: 10px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        .send-screenshot-btn:hover {
            background-color: #0077b3;
        }

        #ad-frame-wrapper {
            position: fixed; inset: 0; display: grid; 
            grid-template-rows: 1fr;
            background:#0b0f13; color:#fff; z-index: 9999;
        }
        #ad-frame-wrapper .overlay {
            position: absolute; top:16px; right:16px; display:flex; align-items:center; gap:8px;
            background: rgba(0,0,0,.55); border:1px solid #334155; padding:8px 12px; border-radius: 999px;
            backdrop-filter: blur(4px);
            z-index: 10;
            pointer-events: none;
        }
        #ad-frame-wrapper .timer {
            font-variant-numeric: tabular-nums; font-weight: 700;
        }
        #ad-frame-wrapper .closeBtn {
            pointer-events: auto; appearance:none; border:1px solid #334155; background:#111827; color:#9ca3af;
            padding:6px 10px; border-radius: 999px; cursor:not-allowed; opacity:.6;
            transition: all .2s ease;
        }
        #ad-frame-wrapper .closeBtn.enabled {
            background:#16a34a; border-color:#16a34a; color:#fff; cursor:pointer; opacity:1;
        }
        #ad-frame-wrapper .stage { position: relative; height: 100%; }
        #ad-container {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; overflow: auto;
        }
        #ad-container iframe {
            width: 100%; height: 100%; border: none;
        }
        
        #movable-ad-container {
            position: fixed;
            bottom: 85px; 
            right: 10px;
            width: 300px;
            height: 70px;
            background-color: #1a1a2e;
            border: 2px solid #9b59b6;
            border-radius: 10px;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            touch-action: none; 
        }
        #movable-ad-header {
            background-color: #9b59b6;
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            text-align: center;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
            font-weight: bold;
            height: 20px;
            line-height: 20px;
        }
        #movable-ad-iframe {
            width: 100%;
            height: 50px; 
            border: none;
        }
        
        #wallet-screen .ws-container {
            max-width: 420px;
            margin: auto;
            padding: 15px;
            width: 100%;
        }
        #wallet-screen .ws-profile {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1a40;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        #wallet-screen .ws-profile .name {
            font-weight: bold;
            font-size: 18px;
        }
        #wallet-screen .ws-profile .balance {
            font-size: 22px;
            font-weight: bold;
            color: #ffd369;
        }
        #wallet-screen .ws-value {
            text-align: center;
            font-size: 16px;
            margin: 10px 0 20px 0;
        }
        #wallet-screen .ws-btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #wallet-screen .ws-btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        #wallet-screen .ws-withdraw {
            background: #9d4edd;
            color: white;
        }
        #wallet-screen .ws-back {
            background: #6c63ff;
            color: white;
        }
        #wallet-screen .ws-history {
            margin-top: 20px;
            background: #1a1a40;
            border-radius: 12px;
            padding: 12px 15px;
            min-height: 100px;
        }
        #wallet-screen .ws-history h3 {
            margin: 0 0 10px;
            font-size: 18px;
            text-align: center;
            color: #00e0ff;
        }
        #wallet-screen .ws-history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        #wallet-screen .ws-history-item:last-child {
            border: none;
        }
        #wallet-screen .ws-history-item .amount {
            font-weight: bold;
            color: #ffd369;
        }
        #wallet-screen .ws-history-item .status {
            color: #00ff7f;
            font-size: 14px;
        }
        .ws-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .ws-card {
            background: #1a1c2b;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }
        .ws-card h2 {
            margin: 0 0 15px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #19c9e2;
        }
        .ws-rate {
            font-size: 12px;
            background: #0d3b4a;
            padding: 4px 10px;
            border-radius: 8px;
            color: #19c9e2;
            margin-left: 10px;
        }
        .ws-input-box {
            margin: 14px 0;
        }
        .ws-input-box label {
            font-size: 13px;
            margin-bottom: 6px;
            display: block;
            color: #c9c9c9;
        }
        .ws-input-box input,
        .ws-input-box select {
            width: 100%;
            padding: 14px;
            box-sizing: border-box;
            border-radius: 10px;
            border: 1px solid #2a2e45;
            background: #101223;
            color: #fff;
            font-size: 15px;
            outline: none;
        }
        .ws-note {
            font-size: 12px;
            color: #9c9c9c;
            margin-top: 5px;
        }
        .ws-receive-box {
            margin: 18px 0;
            padding: 12px 15px;
            background: #101223;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        .ws-receive-box span {
            color: #1ecb80;
            font-weight: 500;
        }
        .ws-withdraw-option-btn {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        .ws-withdrawal-logo {
            width: 28px; 
            height: 28px; 
            object-fit: contain;
            min-width: 28px; 
        }
        .ws-btn2 {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg,#1ecb80,#16a85f);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            transition: 0.3s;
            margin-top: 15px;
        }
        
        #ads-screen {
            background: #121212;
            padding-top: 20px;
        }
        #ads-screen h2 { font-size: 24px; color: #fff; }
        .ads-frame {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1f1f1f;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            width: 100%;
            max-width: 450px;
        }
        .text-content p { margin: 0; font-size: 1em; font-weight: 600; color: #fff; }
        .ad-counter {
            background: #333;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            color: #fff;
        }
        .play-button {
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .play-icon {
            width: 0; height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 12px solid white;
            margin-left: 3px;
        }

        #gift-screen {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
        }
        .gift-container {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
            color: #333;
        }
        .gift-container h2 {
            margin-bottom: 10px;
            color: #333;
        }
        .gift-container .sub-text {
            font-size: 14px;
            color: #444;
            margin-bottom: 5px;
        }
        .gift-container .highlight {
            font-size: 14px;
            color: #d32f2f;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .gift-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }
        .gift-container button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 10px;
        }
        .gift-container .redeem-btn {
            background: #6a11cb;
            color: white;
        }
        .gift-container .redeem-btn:hover {
            background: #5011a3;
        }
        .gift-container .claim-btn {
            background: #2575fc;
            color: white;
        }
        .gift-container .claim-btn:hover {
            background: #0b57d0;
        }
        .gift-container .note {
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }
        #claimButtonContainer {
            display: block;
        }
        .redeemed-message {
            display: none;
            padding: 12px;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }
        
        #daily-tasks-screen {
            background: #0f0f10;
        }
        #daily-tasks-screen .dt-wrap { max-width: 420px; margin: 0 auto; width: 100%; }
        #daily-tasks-screen .dt-header { margin-bottom: 16px; }
        #daily-tasks-screen .dt-title { font-size: 20px; font-weight: 700; color:#fff; }
        #daily-tasks-screen .dt-wallet { display: flex; justify-content: space-between; background: #191919; padding: 12px; border-radius: 14px; margin-bottom: 16px; }
        #daily-tasks-screen .dt-wallet div { font-size: 15px; font-weight: 600; color:#fff; }
        #daily-tasks-screen .dt-list { display: flex; flex-direction: column; gap: 12px; }
        #daily-tasks-screen .dt-card { display: flex; align-items: center; justify-content: space-between; background: #191919; border-radius: 14px; padding: 10px 14px; min-height: 60px; }
        #daily-tasks-screen .dt-left { display: flex; align-items: center; gap: 10px; }
        #daily-tasks-screen .dt-avatar { width: 42px; height: 42px; border-radius: 10px; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; font-size: 22px; }
        #daily-tasks-screen .dt-meta { display: flex; flex-direction: column; }
        #daily-tasks-screen .dt-name { font-size: 15px; font-weight: 600; color:#fff; text-align: left;}
        #daily-tasks-screen .dt-desc { font-size: 12px; color: #aaa; text-align: left;}
        #daily-tasks-screen .dt-task-right { display: flex; align-items: center; gap: 8px; }
        #daily-tasks-screen .dt-counter { font-size: 14px; font-weight: 600; color: #fff; }
        #daily-tasks-screen .dt-claim { background: #fff; color: #000; font-weight: 600; border: none; border-radius: 10px; padding: 6px 14px; cursor: pointer; font-size: 14px; }
        #daily-tasks-screen .dt-claim:disabled { background: #555; color: #999; cursor: not-allowed; }
        #daily-tasks-screen .dt-timerBox {
            margin-top: 20px;
            background: #191919;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            color: #0f0;
            font-weight: 600;
        }

        #game-screen {
            background: #000;
            color: #00eaff;
        }
        canvas#galaxy {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 1; 
        }
        #game-screen .mining-clock-title {
            color: #00eaff;
            margin-bottom: 25px;
            text-shadow: 0 0 15px #00eaff;
            z-index: 2;
            border: none;
            padding: 0;
            font-size: 28px;
        }
        #game-screen .outer-ring {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }
        #game-screen .rotating-border {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top: 4px solid #00eaff;
            border-radius: 50%;
            animation: rotateBorder 6s linear infinite;
            box-shadow: 0 0 25px #00eaff;
        }
        @keyframes rotateBorder {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #game-screen .coin {
            position: absolute;
            top: -15px;
            left: 50%;
            width: 35px;
            height: 35px;
            transform: translateX(-50%);
            background: radial-gradient(circle at center, gold 40%, #d4af37 80%);
            border-radius: 50%;
            box-shadow: 0 0 20px gold, 0 0 40px gold;
            animation: rotateCoin 6s linear infinite;
        }
        @keyframes rotateCoin {
            from { transform: rotate(0deg) translateY(-150px) rotate(0deg); }
            to { transform: rotate(360deg) translateY(-150px) rotate(-360deg); }
        }
        #game-screen .inner-clock {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(0,16,24,0.9), rgba(0,28,40,0.9));
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-screen .number {
            position: absolute;
            color: #00eaff;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 0 10px #00eaff;
        }
        #game-screen .hand {
            position: absolute;
            bottom: 50%;
            transform-origin: bottom;
            border-radius: 4px;
        }
        #game-screen .hour { width: 4px; height: 60px; background: #00aaff; }
        #game-screen .minute { width: 3px; height: 90px; background: #00ddff; }
        #game-screen .second { width: 2px; height: 100px; background: red; }

        /* NEW MINING BUTTON STYLES */
        .mining-controls {
            z-index: 10;
            margin-top: 30px;
            text-align: center;
        }
        #mining-progress-text {
            font-size: 14px;
            color: #f1c40f;
            margin-bottom: 10px;
            font-weight: 600;
            min-height: 20px;
        }
        #mining-control-button {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 114, 255, 0.4);
            text-transform: uppercase;
        }
        #mining-control-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 114, 255, 0.6);
        }
        #mining-control-button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        #mining-control-button.can-claim {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
        }
        
        /* ===== START: DRAGON VS TIGER GAME CSS ===== */
        .dvt-game-screen-styles {
          --bg:#071122;
          --accent:#1ea7ff;
          --card:#071826;
          --white:#fff;
          --muted:#c7d2da;
          --win:#21d07a;
          --lose:#ff4d4f;
          --glass: rgba(255,255,255,0.03);
          background: linear-gradient(180deg, var(--bg), #04111a 80%);
        }
        .dvt-game-screen-styles .app{ width:380px; max-width:95vw; text-align:center; font-family: "Montserrat", Arial, sans-serif; color: var(--white); }
        .dvt-game-screen-styles header{ margin-bottom:12px; }
        .dvt-game-screen-styles .title{ font-size:28px; letter-spacing:6px; color: #f5c542; font-weight:700; }
        .dvt-game-screen-styles .timer { font-size: 24px; font-weight: 700; color: var(--muted); margin-top: 15px; margin-bottom: 10px; }
        .dvt-game-screen-styles .top-row{ display:flex; align-items:center; justify-content:center; margin:16px 0 10px; }
        .dvt-game-screen-styles .coin-box{ display:flex; gap:8px; align-items:center; }
        .dvt-game-screen-styles .coin{ background:var(--glass); padding:8px 12px; border-radius:20px; display:flex; gap:8px; align-items:center; font-weight:700; }
        .dvt-game-screen-styles .coin img{width:18px; height:18px}
        .dvt-game-screen-styles .arena{ display:flex; gap:10px; align-items:center; justify-content:center; margin:10px 0 18px; }
        
        .dvt-game-screen-styles .side{ 
          width:48%; 
          min-height:210px; 
          border-radius:10px; 
          border:6px solid var(--accent); 
          display:flex; 
          align-items:center; 
          justify-content:center; 
          position:relative; 
          cursor:pointer; 
          transition: transform .15s ease, box-shadow .15s; 
          user-select:none;
          background-size: cover;
          background-position: center;
          overflow: hidden;
          background-image: none;
          background-color: #0c1a29;
        }
        .dvt-game-screen-styles .side::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(7, 24, 38, 0.7); z-index: 1; }
        .dvt-game-screen-styles .side > * { position: relative; z-index: 2; }
        .dvt-game-screen-styles .side.selected{ box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 16px rgba(30,167,255,0.12); transform: translateY(-6px); }
        .dvt-game-screen-styles .side-number{ font-size:72px; font-weight:900; color:var(--white); text-shadow: 0 0 15px rgba(0,0,0,0.7); }
        .dvt-game-screen-styles .side-label{ position:absolute; top:8px; left:10px; background:rgba(0,0,0,0.35); padding:6px 10px; border-radius:8px; font-weight:700; }
        .dvt-game-screen-styles .vs{ width:48px; height:48px; border-radius:12px; background: linear-gradient(180deg,#ffb24d,#ff8a00); display:flex; align-items:center; justify-content:center; font-weight:900; color:#fff; box-shadow:0 8px 18px rgba(255,138,0,0.18); }
        .dvt-game-screen-styles .start-wrap{ margin:18px 0; }
        .dvt-game-screen-styles .start-btn{ background:#fff; color:#071226; border:none; padding:14px 46px; border-radius:18px; font-size:20px; font-weight:800; cursor:pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
        .dvt-game-screen-styles .controls{ margin-top:14px; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
        .dvt-game-screen-styles .bet-btn{ background:rgba(255,255,255,0.06); border-radius:12px; padding:8px 12px; min-width:56px; text-align:center; font-weight:700; cursor:pointer; }
        .dvt-game-screen-styles .bet-btn.active{ background: linear-gradient(180deg,#0ea7ff,#0077c8); color:#fff; box-shadow:0 8px 20px rgba(14,167,255,0.12); }
        .dvt-game-screen-styles .message{ margin-top:12px; min-height:24px; font-weight:700; }
        .dvt-game-screen-styles .result.win{ color:var(--win); }
        .dvt-game-screen-styles .result.lose{ color:var(--lose); }
        .dvt-game-screen-styles .footer{ margin-top:18px; display:flex; align-items:center; justify-content:center; }
        .dvt-game-screen-styles .balance{ background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:12px; font-weight:800; }
        .dvt-game-screen-styles .bet-display { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.5); padding: 8px 16px; border-radius: 20px; font-size: 16px; font-weight: 700; border: 1px solid rgba(255, 255, 255, 0.1); display: none; }
        .dvt-game-screen-styles .all-in-btn { background: linear-gradient(180deg, #ff8a00, #e74c3c); color: #fff; border: 1px solid #ffb24d; }
        .dvt-game-screen-styles .all-in-btn.active { background: linear-gradient(180deg, #ffb24d, #ff4d4f); box-shadow: 0 8px 20px rgba(255, 77, 79, 0.2); }
        @media (max-width:420px){ .dvt-game-screen-styles .side-number{ font-size:56px; } .dvt-game-screen-styles .app{ width:340px; } }
        /* ===== END: DRAGON VS TIGER GAME CSS ===== */

        /* ===== START: NEW OFFERWALL PAGE STYLES (FROM USER) ===== */
        #offerwall-screen {
            --primary-color: #6c63ff;
            --secondary-color: #a4508b;
            --dark-bg: #0e1220;
            --card-bg: #1b2133;
            --text-light: #fff;
            --text-muted: #a0a0a0;
            --status-pending: #f39c12;
            --status-completed: #2ecc71;
            --status-rejected: #e74c3c;
            background-color: var(--dark-bg);
            color: var(--text-light);
            padding: 0;
            justify-content: flex-start;
        }
        #offerwall-screen #mainContainer { padding: 20px; width: 100%; height: 100%; overflow-y: auto; padding-bottom: 80px; box-sizing: border-box; }
        #offerwall-screen #mainContainer p { width: 100%; text-align: center; opacity: 0.8; font-size: 16px; color: var(--text-muted);}
        #offerwall-screen h3 { font-size: 1.2rem; color: #fff; text-align: left; text-shadow: none; margin-bottom: 15px;}
        
        #offerwall-screen .tabs { display: flex; justify-content: center; margin: 0 auto 20px auto; background: var(--card-bg); border-radius: 12px; width: 100%; max-width: 600px; padding: 5px; box-sizing: border-box; }
        #offerwall-screen .tab { flex: 1; text-align: center; padding: 12px 0; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        #offerwall-screen .tab.active { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); }
        #offerwall-screen #taskContainer { width: 100%; max-width: 600px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        #offerwall-screen .task-card-list { width: 100%; background: var(--card-bg); border-radius: 16px; padding: 18px; display: flex; align-items: center; justify-content: space-between; transition: transform 0.3s; box-sizing: border-box; }
        #offerwall-screen .task-card-list:hover { transform: scale(1.02); }
        #offerwall-screen .task-left { display: flex; align-items: center; }
        #offerwall-screen .task-logo { width: 50px; height: 50px; border-radius: 12px; background: #272e47; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; }
        #offerwall-screen .task-logo img { width: 35px; height: 35px; border-radius: 8px; }
        #offerwall-screen .task-info h3 { margin: 0; font-size: 1rem; }
        #offerwall-screen .task-info p { margin: 4px 0 0; color: var(--text-muted); font-size: 0.9rem; }
        #offerwall-screen .task-btn { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border: none; padding: 10px 18px; color: #fff; font-weight: 600; border-radius: 10px; cursor: pointer; }
        #offerwall-screen .grid-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        #offerwall-screen .task-card-grid { width: 110px; height: 160px; border-radius: 15px; background-size: cover; background-position: center; display: flex; align-items: flex-end; justify-content: center; padding: 10px; font-weight: 600; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.8); cursor: pointer; transition: transform 0.2s; box-sizing: border-box; }
        #offerwall-screen .task-card-grid:hover { transform: scale(1.05); }
        #offerwall-screen .app-install-container { align-items: flex-start; align-content: flex-start; }
        #offerwall-screen .offerwall-card { background-color: var(--card-bg); border-radius: 10px; padding: 8px; width: 95px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: center; position: relative; overflow: hidden; cursor: pointer; }
        #offerwall-screen .offer-logo { width: 100%; height: 65px; border-radius: 6px; overflow: hidden; margin-bottom: 6px; }
        #offerwall-screen .offer-logo img { width: 100%; height: 100%; object-fit: cover; }
        #offerwall-screen .offer-title { font-size: 0.7rem; font-weight: 600; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #offerwall-screen .offer-provider { font-size: 0.6rem; color: #8a92b1; margin: 2px 0; }
        #offerwall-screen .offer-reward { display: flex; align-items: center; justify-content: center; gap: 3px; font-weight: 600; margin-top: 4px; font-size: 0.75rem; }
        #offerwall-screen .offer-reward img { width: 14px; height: 14px; }
        #offerwall-screen .offer-page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #1a1a2e; z-index: 2000; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 20px; box-sizing: border-box; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #offerwall-screen .offer-page-overlay.show { opacity: 1; visibility: visible; }
        #offerwall-screen .offer-page-content { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; max-width: 400px; margin-top: 5vh; flex-grow: 1; overflow-y: auto; }
        #offerwall-screen .offer-page-close-btn { position: absolute; top: 20px; right: 20px; font-size: 2rem; color: #fff; cursor: pointer; line-height: 1; z-index: 10; }
        #offerwall-screen .offer-page-reward-circle { width: 130px; height: 130px; border-radius: 50%; background: linear-gradient(145deg, #a4508b, #6c63ff); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; font-size: 2rem; box-shadow: 0 0 25px rgba(164, 80, 139, 0.6); flex-shrink: 0; }
        #offerwall-screen .offer-page-reward-circle small { font-size: 1rem; font-weight: 500; margin-top: 5px; text-transform: capitalize; }
        #offerwall-screen .offer-page-title { font-size: 1.8rem; font-weight: 600; margin: 30px 0 10px 0; }
        #offerwall-screen .offer-page-subtitle { font-size: 1rem; color: #c0c8e7; margin: 0 0 25px 0; font-weight: 500;}
        #offerwall-screen .offer-page-steps { background-color: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 15px 20px; text-align: left; width: 100%; color: #e0e5ff; font-size: 0.9rem; line-height: 1.6; white-space: pre-line; border: 1px solid rgba(255, 255, 255, 0.1); }
        #offerwall-screen .offer-page-start-btn { background-color: #1abc9c; border: none; width: 100%; max-width: 400px; padding: 15px 20px; border-radius: 12px; color: white; font-weight: 600; font-size: 1.1rem; cursor: pointer; margin-top: 20px; margin-bottom: 20px; flex-shrink: 0; }
        #offerwall-screen .status-badge { padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; color: white; }
        #offerwall-screen .status-pending { background-color: var(--status-pending); }
        #offerwall-screen .status-completed { background-color: var(--status-completed); }
        #offerwall-screen .status-rejected { background-color: var(--status-rejected); }
        #offerwall-screen .support-container { display: flex; flex-direction: column; height: calc(100% - 40px); box-sizing: border-box; }
        #offerwall-screen .message-history { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid var(--card-bg); border-radius: 10px; margin-bottom: 15px; display:flex; flex-direction:column; }
        #offerwall-screen .message { padding: 8px 12px; border-radius: 18px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; }
        #offerwall-screen .user-message { background: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        #offerwall-screen .admin-message { background: var(--card-bg); color: var(--text-light); align-self: flex-start; border-bottom-left-radius: 4px; }
        #offerwall-screen .message-form { display: flex; gap: 10px; }
        #offerwall-screen .message-input { flex-grow: 1; background: var(--card-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; font-size: 1rem; }
        #offerwall-screen .send-btn { background: var(--primary-color); border: none; padding: 0 20px; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; }
        #offerwall-screen .bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; background-color: var(--card-bg); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 1000; }
        #offerwall-screen .nav-item { flex: 1; text-align: center; cursor: pointer; color: var(--text-muted); transition: color 0.3s; }
        #offerwall-screen .nav-item.active { color: var(--primary-color); }
        #offerwall-screen .nav-item svg { width: 24px; height: 24px; }
        #offerwall-screen .nav-item p { margin: 4px 0 0; font-size: 0.7rem; font-weight: 500; }
        
        /* ===== MODIFIED BACK BUTTON STYLE ===== */
        .offerwall-back-button {
            position: fixed;
            left: 15px;
            top: 25px; /* Moved higher */
            width: 45px;
            height: 45px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid #6c63ff;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            backdrop-filter: blur(5px);
            transition: all 0.2s ease;
        }
        .offerwall-back-button:hover {
            background-color: #6c63ff;
            transform: scale(1.1); /* Simplified transform */
        }
        /* ===== END: NEW OFFERWALL PAGE STYLES ===== */

        /* ===== START: NEW TASK UNLOCKER PAGE STYLES ===== */
        #task-unlocker-screen {
            --background-color: #004445;
            --primary-color: #FF57A5;
            --text-color: #F0F0F0;
            --dark-color: #0F0F0F;
            background-color: var(--dark-color);
            color: var(--text-color);
            overflow: hidden;
        }
        #task-unlocker-screen #lock-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--background-color);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        #task-unlocker-screen .user-page {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 40px 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 25px rgba(255, 87, 165, 0.6);
            max-width: 500px;
            width: 90%;
        }
        #task-unlocker-screen .user-page h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 25px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--primary-color);
        }
        #task-unlocker-screen #tu-task-area { margin: 20px 0; display: block; }
        #task-unlocker-screen .task-link {
            display: inline-block;
            padding: 12px 25px;
            background-color: #f0f0f0;
            color: var(--dark-color);
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        #task-unlocker-screen .main-button {
            font-family: 'Bebas Neue', cursive;
            background-color: var(--primary-color);
            color: var(--dark-color);
            border: none;
            padding: 15px 40px;
            font-size: 1.8em;
            font-weight: bold;
            letter-spacing: 1px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
            display: none;
        }
        #task-unlocker-screen #squid-animation-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #000 40%, #060017 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow: hidden;
        }
        #task-unlocker-screen #squid-shape {
            width: 150px;
            height: 150px;
            opacity: 0;
            filter: drop-shadow(0 0 20px #ff57a5) drop-shadow(0 0 40px #ff57a5);
            transform: scale(0);
        }
        #task-unlocker-screen #squid-shape.animate {
            animation: squid-reveal 3s forwards cubic-bezier(0.77, 0, 0.175, 1);
        }
        #task-unlocker-screen #squid-animation-overlay::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 87, 165, 0.15) 0%, transparent 70%);
            animation: bg-pulse 2s infinite alternate ease-in-out;
        }
        @keyframes bg-pulse {
            0% { opacity: 0.4; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.1); }
        }
        @keyframes squid-reveal {
            0% { opacity: 0; transform: scale(0); border-radius: 50%; background: radial-gradient(circle, #ff57a5 20%, #a00057 100%); filter: drop-shadow(0 0 25px #ff57a5); }
            10% { opacity: 1; transform: scale(1.2); border-radius: 50%; }
            30% { transform: scale(1); filter: drop-shadow(0 0 30px #ff57a5); }
            40% { border-radius: 0; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); background: radial-gradient(circle, #00ffff 20%, #0077ff 100%); transform: scale(1.2) rotate(5deg); filter: drop-shadow(0 0 30px #00ffff); }
            55% { transform: scale(1) rotate(-5deg); opacity: 1; }
            70% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); background: radial-gradient(circle, #ffffff 20%, #d0d0d0 100%); transform: scale(1.3) rotate(0deg); filter: drop-shadow(0 0 50px #ffffff); }
            85% { transform: scale(1); opacity: 1; }
            100% { transform: scale(25); opacity: 0; background-color: #ffffff; filter: drop-shadow(0 0 120px #ffffff); }
        }
        /* ===== END: NEW TASK UNLOCKER PAGE STYLES ===== */

        /* ===== START: NEW REFERRAL PAGE STYLES ===== */
        #referral-screen { 
            background-color: #12121e; 
            color: #e0e0e0; 
            font-family: 'Roboto', sans-serif; 
            padding: 0; 
            justify-content: flex-start; 
            min-height: 100vh;
        }
        #referral-screen .mobile-screen { width: 100%; height: 100%; max-width: 420px; background-color: #1e1e2f; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); overflow: hidden; display: flex; flex-direction: column; }
        #referral-screen .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; flex-shrink: 0; }
        #referral-screen .header .user-info { display: flex; align-items: center; }
        #referral-screen .header .user-info .fa-arrow-left { cursor: pointer; }
        #referral-screen .header .user-info i { font-size: 20px; margin-right: 15px; }
        #referral-screen .header .user-info .text-details .username { font-size: 18px; font-weight: 500; }
        #referral-screen .header .user-info .text-details .timestamp { font-size: 12px; color: #888; }
        #referral-screen .header .actions i { font-size: 20px; margin-left: 20px; cursor: pointer; }
        #referral-screen .main-content { padding: 0 20px 20px 20px; flex-grow: 1; overflow-y: auto; }
        #referral-screen .content-card { background-color: #2c2c3e; border-radius: 15px; padding: 20px; margin-bottom: 25px; }
        #referral-screen .referral-card { display: flex; justify-content: space-between; align-items: center; }
        #referral-screen .referral-card .code-info .code { font-size: 18px; font-weight: 500; letter-spacing: 1px; color: #fff; }
        #referral-screen .referral-card .code-info .label { font-size: 14px; color: #a0a0a0; margin-top: 5px; }
        #referral-screen .copy-btn { background-color: #4a7dff; color: white; border: none; border-radius: 25px; padding: 10px 20px; font-size: 14px; cursor: pointer; display: flex; align-items: center; transition: background-color 0.3s; }
        #referral-screen .copy-btn:active { background-color: #3a6dcf; }
        #referral-screen .copy-btn i { margin-left: 8px; }
        #referral-screen .bonus-link { text-align: left; margin: 0 0 20px 5px; color: #a0a0a0; font-size: 16px; }
        #referral-screen .stats-card { display: flex; justify-content: space-around; position: relative; }
        #referral-screen .stat-item { text-align: left; flex-basis: 50%; z-index: 2; }
        #referral-screen .stat-item .label { font-size: 16px; color: #a0a0a0; }
        #referral-screen .stat-item .value { font-size: 22px; font-weight: 700; color: #fff; margin-top: 8px; display: flex; align-items: center; }
        #referral-screen .stat-item .value i { color: #f1c40f; margin-right: 8px; }
        #referral-screen .sticker-banner { position: absolute; background-color: white; color: #333; padding: 5px 15px; border-radius: 15px; font-family: 'Pacifico', cursive; font-size: 16px; transform: rotate(-8deg); top: -20px; left: 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); z-index: 1; }
        #referral-screen .section-title { font-size: 18px; font-weight: 500; margin-bottom: 15px; color: #e0e0e0; }
        #referral-screen .how-it-works ol { list-style: none; padding-left: 0; }
        #referral-screen .how-it-works li { display: flex; align-items: center; margin-bottom: 15px; font-size: 14px; color: #c0c0c0; }
        #referral-screen .how-it-works .step-number { background-color: #4a7dff; color: white; border-radius: 50%; min-width: 25px; height: 25px; display: inline-flex; justify-content: center; align-items: center; font-weight: 700; margin-right: 15px; }
        #referral-screen .referral-list .referral-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #3a3a4a; }
        #referral-screen .referral-list .referral-item:last-child { border-bottom: none; }
        #referral-screen .referral-list .user-details { display: flex; align-items: center; }
        #referral-screen .referral-list .user-details i { font-size: 18px; margin-right: 15px; color: #a0a0a0; }
        #referral-screen .status { font-size: 14px; color: #2ecc71; font-weight: 500; }
        #referral-screen .share-buttons { display: flex; justify-content: space-around; }
        #referral-screen .share-btn { color: white; font-size: 24px; text-decoration: none; transition: transform 0.2s; }
        #referral-screen .share-btn:hover { transform: scale(1.1); }
        #referral-screen .share-btn.whatsapp { color: #25D366; }
        #referral-screen .share-btn.telegram { color: #0088cc; }
        #referral-screen .share-btn.twitter { color: #1DA1F2; }
        #referral-screen .footer { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; flex-shrink: 0; }
        #referral-screen .footer .emoji-btn i { font-size: 24px; cursor: pointer; }
        #referral-screen .reply-btn { background-color: #3a3a4a; color: white; border: none; border-radius: 25px; padding: 10px 20px; font-weight: 500; cursor: pointer; display: flex; align-items: center; }
        #referral-screen .reply-btn i { margin-right: 8px; }
        /* ===== END: NEW REFERRAL PAGE STYLES ===== */

    </style>
</head>
<body>
    <!-- ===== START: NEW FIREBASE LOADING SCREEN HTML ===== -->
    <div id="firebase-loading-screen">
        <div id="bg"></div>
        <canvas id="sparkCanvas"></canvas>
        <img id="center">
        <div id="trees">Loading Game...</div>
        <div id="progress-box">
          <div id="bar"><div id="bar-inner"></div></div>
          <div id="bar-text">loading...</div>
        </div>
    </div>
    <!-- ===== END: NEW FIREBASE LOADING SCREEN HTML ===== -->


    <div class="game-container">
        <div class="top-bar-container">
            <div id="profile-section" class="profile-section">
                <span class="profile-icon"></span>
                <span id="player-name-display">name</span> 
            </div>
        </div>
        <div id="diamond-display">
            <span></span>
            <span id="diamond-count">0</span>
        </div>
        <div id="notification-bell">
            
            <span id="notification-dot"></span>
        </div>

        <div id="game-screen" class="screen">
            <!-- Side buttons are kept -->
            <div id="mining-button"></div>
            <div id="rewards-hub-button"></div>
            <div id="daily-tasks-side-button"></div>
            <div id="refer-button"></div>
        
            <!-- New Clock and Galaxy content -->
            <canvas id="galaxy"></canvas>
            <h1 class="mining-clock-title"> Mining Clock</h1>
            <div class="outer-ring">
                <div class="rotating-border"></div>
                <div class="coin"></div>
                <div class="inner-clock">
                    <div class="hand hour" id="hour"></div>
                    <div class="hand minute" id="minute"></div>
                    <div class="hand second" id="second"></div>
                    <div class="number" style="top:10px; left:50%; transform:translateX(-50%);">12</div>
                    <div class="number" style="top:35px; right:65px;">1</div>
                    <div class="number" style="top:80px; right:25px;">2</div>
                    <div class="number" style="top:130px; right:5px;">3</div>
                    <div class="number" style="bottom:80px; right:25px;">4</div>
                    <div class="number" style="bottom:35px; right:65px;">5</div>
                    <div class="number" style="bottom:10px; left:50%; transform:translateX(-50%);">6</div>
                    <div class="number" style="bottom:35px; left:65px;">7</div>
                    <div class="number" style="bottom:80px; left:25px;">8</div>
                    <div class="number" style="top:130px; left:5px;">9</div>
                    <div class="number" style="top:80px; left:25px;">10</div>
                    <div class="number" style="top:35px; left:65px;">11</div>
                </div>
            </div>

            <!-- New Mining Button and Progress Text -->
            <div class="mining-controls">
                <p id="mining-progress-text">Watch 10 ads to start mining</p>
                <button id="mining-control-button">Watch Ad (0/10)</button>
            </div>
        </div>
        
        <div id="rewards-hub-screen" class="screen scrollable-screen hidden">
            <h2> Rewards Hub </h2>
            <div class="options-container">
                <div class="option-card reward-task-card">
                    <h3>Join Our Community</h3>
                    <p>Join our official Telegram channel for updates, announcements, and special events. Get 99 coins as a one-time reward!</p>
                    <div class="reward-task-buttons">
                        <a href="https://t.me/taptoearningsquid" target="_blank" id="join-telegram-link" class="join-telegram-button">Join Channel</a>
                        <button id="claim-telegram-reward-btn" class="action-button" style="background-color:#27ae60;" disabled>Claim 99 </button>
                    </div>
                </div>
                <div class="option-card reward-task-card">
                    <h3>Daily Bonus</h3>
                    <p>Come back every day to claim your free 20 coins!</p>
                    <div class="reward-task-buttons">
                         <button id="claim-daily-bonus-btn" class="action-button" style="background-color:#e67e22;">Claim 20 </button>
                    </div>
                </div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tournament-screen" class="screen scrollable-screen hidden tournament-bg">
            <h2> All Events & Games </h2>
            <div id="tournament-list-container" class="options-container"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <!-- ===== START: NEW OFFERWALL PAGE HTML ===== -->
        <div id="offerwall-screen" class="screen hidden">
            <div id="offerwall-back-button" class="offerwall-back-button"></div>
            <div id="mainContainer"></div>
            <div id="fullPageOffer" class="offer-page-overlay"></div>
            <div class="bottom-nav">
                <div class="nav-item active" data-page="tasks"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3,4H21V6H3V4M3,11H21V13H3V11M3,18H21V20H3V18Z"></path></svg><p>Tasks</p></div>
                <div class="nav-item" data-page="completed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"></path></svg><p>Completed</p></div>
                <div class="nav-item" data-page="support"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"></path></svg><p>Support</p></div>
            </div>
        </div>
        <!-- ===== END: NEW OFFERWALL PAGE HTML ===== -->

        <div id="tasks-screen" class="screen hidden">
            <h2> Offers & Tasks </h2>
            <div id="tasks-container-all" class="options-container">
                <div id="tasks-options-container"></div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="dvt-game-screen" class="screen scrollable-screen hidden dvt-game-screen-styles">
            <div class="app" role="application">
                <header>
                    <div class="title">GAMES</div>
                    <div class="timer" id="dvt-timerDisplay"> 7</div>
                </header>
                <div class="top-row">
                    <div class="coin-box">
                    <div class="coin" title="Coins"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><circle cx='256' cy='256' r='200' fill='%23ffd24d'/><text x='50%' y='56%' font-size='220' text-anchor='middle' font-family='Arial' fill='%23000' font-weight='700'></text></svg>" alt="coin"><span id="dvt-coinBalance">0</span></div>
                    </div>
                </div>
                <div class="arena">
                    <div class="side" id="dvt-leftSide" data-side="left" role="button" tabindex="0">
                        <div class="side-label">ELEPHANT</div>
                        <div class="side-number" id="dvt-leftNum">-</div>
                        <div class="bet-display" id="dvt-leftBetDisplay"></div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="side" id="dvt-rightSide" data-side="right" role="button" tabindex="0">
                        <div class="side-label">MONKEY</div>
                        <div class="side-number" id="dvt-rightNum">-</div>
                        <div class="bet-display" id="dvt-rightBetDisplay"></div>
                    </div>
                </div>
                <div class="start-wrap"><button class="start-btn" id="dvt-startBtn">Start</button></div>
                <div class="controls" aria-hidden="false" id="dvt-controls">
                    <div class="bet-btn" data-bet="100">100</div><div class="bet-btn" data-bet="500">500</div><div class="bet-btn" data-bet="1000">1000</div><div class="bet-btn" data-bet="2000">2000</div><div class="bet-btn" data-bet="5000">5000</div>
                    <div class="bet-btn all-in-btn" id="dvt-allInBtn">All In</div>
                </div>
                <div class="message" id="dvt-message"></div>
                <div class="footer">
                    <div class="balance">Balance: <span id="dvt-balanceDisplay">0</span></div>
                </div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="diamond-screen" class="screen hidden">
            <h2> Diamond Balance </h2>
            <div class="option-card" style="width: 100%; max-width: 400px;">
                <p>Your current diamond balance is:</p>
                <h1 id="diamond-balance-display" style="font-size: 48px; color: #00e0ff;"> 0</h1>
                <p style="font-size: 14px; margin-top: 20px;">Diamonds can be used for special in-game events and boosts in the future!</p>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="ads-screen" class="screen scrollable-screen hidden">
            <h2> Watch Ads & Earn Rewards</h2>
            <div id="adsList" style="width:100%; max-width:450px;"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <!-- ===== START: NEW TASK UNLOCKER PAGE (INTEGRATED) ===== -->
        <div id="task-unlocker-screen" class="screen hidden">
            <div id="lock-overlay">
                <div class="user-page">
                    <h1 id="tu-instruction-text">Loading...</h1>
                    <div id="tu-task-area">
                        <p>Click the link below to complete your task:</p><br>
                        <a href="#" id="tu-dummy-task" class="task-link" target="_blank">Complete Task</a>
                    </div>
                    <button id="tu-main-action-button" class="main-button">Open</button>
                </div>
            </div>
            <div id="squid-animation-overlay">
                <div id="squid-shape"></div>
            </div>
            <audio id="tu-unlock-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>
            <button class="back-button" data-screen="game-screen" style="position: absolute; bottom: 20px; z-index: 1001;">Back to Game</button>
        </div>
        <!-- ===== END: NEW TASK UNLOCKER PAGE (INTEGRATED) ===== -->
        
        <div id="wallet-screen" class="screen hidden">
            <div class="ws-container">
                <div class="ws-profile">
                    <div class="name" id="wallet-player-name"> Player</div>
                    <div class="balance" id="wallet-balance">0</div>
                </div>
                <div class="ws-value" id="wallet-usd-value">Value: $0.00 USD</div>
                <button class="ws-btn ws-withdraw" id="wallet-open-options-btn">Withdraw</button>
                <button class="ws-btn ws-back" data-screen="game-screen">Back to Game</button>
                <div class="ws-history" id="wallet-history">
                    <h3>Withdrawal History</h3>
                </div>
            </div>
        </div>

        <!-- Wallet Modals -->
        <div class="ws-modal" id="wallet-option-modal">
            <div class="ws-card">
                <h2>Select Withdrawal Method</h2>
                <button class="ws-btn2 ws-withdraw-option-btn" id="wallet-open-upi-btn">
                    <img id="wallet-upi-logo" src="" alt="UPI" class="ws-withdrawal-logo">
                    Withdraw to UPI ID
                </button>
                <button class="ws-btn2 ws-withdraw-option-btn" id="wallet-open-usdt-btn">
                    <img id="wallet-usdt-logo" src="" alt="USDT" class="ws-withdrawal-logo">
                    Withdraw to USDT Wallet
                </button>
            </div>
        </div>
        <div class="ws-modal" id="wallet-upi-modal">
            <div class="ws-card">
                <h2>Withdraw to UPI</h2>
                <div class="ws-input-box">
                    <label>Enter Your Name</label>
                    <input id="wallet-upi-name" type="text" placeholder="Enter your name">
                </div>
                <div class="ws-input-box">
                    <label>Enter Your UPI ID</label>
                    <input id="wallet-upi-id" type="text" placeholder="example@upi">
                </div>
                <div class="ws-input-box">
                    <label>Amount (Coins)</label>
                    <input id="wallet-upi-coins" type="number" placeholder="Enter amount">
                    <div class="ws-note">Minimum withdrawal is 10,000 coins</div>
                </div>
                <button class="ws-btn2" id="wallet-submit-upi-btn">Confirm Withdraw</button>
            </div>
        </div>
        <div class="ws-modal" id="wallet-usdt-modal">
            <div class="ws-card">
                <h2>Withdraw USDT <span class="ws-rate" id="wallet-rate-display">Loading rate...</span></h2>
                <div class="ws-input-box">
                    <label>Select Network</label>
                    <select id="wallet-usdt-network">
                        <option value="">-- Select --</option>
                        <option value="trc20">TRC20 (Tron)</option>
                        <option value="bep20">BEP20 (BSC)</option>
                        <option value="erc20">ERC20 (Ethereum)</option>
                    </select>
                </div>
                <div class="ws-input-box">
                    <label>Wallet Address</label>
                    <input id="wallet-usdt-address" type="text" placeholder="Enter your USDT wallet address">
                </div>
                <div class="ws-input-box">
                    <label>Amount (Coins)</label>
                    <input id="wallet-usdt-coins" type="number" placeholder="Enter amount">
                    <div class="ws-note">Minimum withdrawal is 10,000 coins</div>
                </div>
                <div class="ws-receive-box">
                    <div>Receive</div>
                    <span id="wallet-usdt-receive">0.00 USDT</span>
                </div>
                <button class="ws-btn2" id="wallet-submit-usdt-btn">Confirm Withdraw</button>
            </div>
        </div>
        
        <div id="gift-screen" class="screen hidden">
            <div class="gift-container">
                <h2> Redeem Gift Code</h2>
                <p class="sub-text">A new gift code will be available every 6 hours.</p>
                <p class="highlight">You can win up to 10,000 coins from gift codes!</p>
                
                <input type="text" id="giftCodeInput" placeholder="Enter your gift code">
                <button class="redeem-btn" id="redeem-gift-code-btn">Redeem Code</button>
                <p> OR </p>
                
                <div id="claimButtonContainer">
                    <button class="claim-btn" id="claimBtn1">Claim Gift Code </button>
                </div>
                
                <div id="redeemedMessage" class="redeemed-message">
                    Code successfully redeemed! 
                </div>
                
                <p class="note">Claim a code and redeem it to earn coins </p>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="daily-tasks-screen" class="screen scrollable-screen hidden">
            <div class="dt-wrap">
              <div class="dt-header"><div class="dt-title"> Daily Tasks</div></div>
              <div class="dt-wallet">
                <div> Coins: <span id="dt-coin-balance">0</span></div>
                <div> Diamonds: <span id="dt-diamond-balance">0</span></div>
              </div>
              <div class="dt-list" id="daily-task-list-container"></div>
              <div class="dt-timerBox">
                Next refresh: <span id="dt-refresh-timer">--:--:--</span>
              </div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <!-- ===== NEW REFERRAL SCREEN HTML ===== -->
        <div id="referral-screen" class="screen hidden">
             <div class="mobile-screen">
                <header class="header">
                    <div class="user-info">
                        <i class="fas fa-arrow-left"></i>
                        <div class="text-details">
                            <div class="username">You</div>
                            <div class="timestamp">Just now</div>
                        </div>
                    </div>
                    <div class="actions">
                        <i class="far fa-star"></i>
                        <i class="fas fa-share"></i>
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </header>
                
                <main class="main-content">
                    <div class="content-card referral-card">
                        <div class="code-info">
                            <div id="referral-code" class="code">Loading...</div>
                            <div class="label">Your Referral code</div>
                        </div>
                        <button class="copy-btn" id="copy-btn">COPY LINK <i class="fas fa-link"></i></button>
                    </div>

                    <p id="bonus-link-text" class="bonus-link">Loading...</p>

                    <div class="content-card stats-card">
                        <div id="sticker-banner-text" class="sticker-banner">Loading...</div>
                        <div class="stat-item">
                            <div class="label">Bonus earned</div>
                            <div id="bonus-earned" class="value"><i class="fas fa-coins"></i> 0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Friends referred</div>
                            <div id="friends-referred" class="value"><i class="fas fa-user-friends"></i>&nbsp;0</div>
                        </div>
                    </div>

                    <div class="content-card how-it-works">
                        <h3 id="how-it-works-title" class="section-title">Loading...</h3>
                        <ol id="how-it-works-list"></ol>
                    </div>
                    
                    <div class="content-card my-referrals">
                        <h3 id="my-referrals-title" class="section-title">Loading...</h3>
                        <div class="referral-list" id="referral-list">
                            <p style="text-align: center; color: #a0a0a0;">No referrals yet.</p>
                        </div>
                    </div>

                    <div class="content-card share-section">
                        <h3 class="section-title">Share Your Link</h3>
                        <div class="share-buttons">
                            <a href="#" class="share-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
                            <a href="#" class="share-btn telegram"><i class="fab fa-telegram-plane"></i></a>
                            <a href="#" class="share-btn twitter"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="share-btn"><i class="fas fa-comment-dots"></i></a>
                        </div>
                    </div>
                </main>

                <footer class="footer">
                    <div class="emoji-btn"><i class="far fa-smile"></i></div>
                    <button class="reply-btn"><i class="fas fa-reply"></i> Reply</button>
                </footer>
            </div>
        </div>
        <!-- ===== END OF REFERRAL SCREEN HTML ===== -->

        <div class="nav-container">
            <div class="nav-button active" data-screen="game-screen"><span class="nav-icon"></span><span class="nav-text">Home</span></div>
            <!-- All Button Removed -->
            <div class="nav-button" id="offer-nav-button" data-screen="offerwall-screen"><span class="nav-icon"></span><span class="nav-text">Offer</span></div>
            <!-- Ads Button Removed -->
            <div class="nav-button" data-screen="gift-screen"><span class="nav-icon"></span><span class="nav-text">Gift</span></div>
            <div class="nav-button" data-screen="wallet-screen"><span class="nav-icon"></span><span class="nav-text">Wallet</span></div>
        </div>
    </div>
    
    <div id="notification-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="close-notification-btn"></span>
            <h3> Notifications</h3>
            <div id="notification-list">
                <p>No new messages.</p>
            </div>
        </div>
    </div>

    <div id="name-change-popup" class="popup">
        <div class="popup-content">
            <h3>Enter your name:</h3>
            <input type="text" id="new-name-input" class="withdraw-input" placeholder="Enter new name" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-around; margin-top: 25px; gap: 15px;">
                <button id="cancel-name-button" class="action-button" style="background-color: #e74c3c; flex: 1;">CANCEL</button>
                <button id="confirm-name-button" class="action-button" style="background-color: #2ecc71; flex: 1;">OK</button>
            </div>
        </div>
    </div>

    <div id="tournament-join-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="tournament-join-popup-close"></span>
            <img id="tournament-join-popup-image" src="" alt="Tournament Logo">
            <h3 id="tournament-join-popup-title">Join Tournament</h3>
    
            <div id="tournament-ad-view">
                <p style="font-size: 16px; margin-top: 15px;">You must watch 5 ads to proceed.</p>
                <p>Progress: <strong id="tournament-ad-progress">0 / 5</strong></p>
                <button id="tournament-watch-ad-btn" class="action-button" style="background-color: #f39c12; margin-top: 15px;">Watch Ad</button>
                <button id="tournament-ad-cancel-btn" class="action-button" style="background-color: #e74c3c; margin-top: 10px;">Cancel</button>
            </div>
    
            <div id="tournament-confirm-view" style="display: none;">
                <p>Entry Fee: <strong id="tournament-join-popup-fee">0 </strong></p>
                <p style="font-size: 16px; margin-top: 15px;">Confirm your name to join:</p>
                <input type="text" id="tournament-join-name-input" class="withdraw-input" placeholder="Enter your name">
                <div class="join-popup-buttons">
                    <button id="tournament-join-cancel-btn" class="action-button" style="background-color: #e74c3c; flex: 1;">Cancel</button>
                    <button id="tournament-join-confirm-btn" class="action-button" style="background-color: #f39c12; flex: 1;">Confirm & Join</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="tap-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
    <audio id="mining-start-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-futuristic-interface-sound-2511.mp3" preload="auto"></audio>
    <audio id="coin-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-casino-notification-211.mp3" preload="auto"></audio>
    <audio id="dvt-bg-sound" src="https://assets.mixkit.co/music/preview/mixkit-a-very-happy-christmas-897.mp3" loop preload="auto"></audio>
    <audio id="dvt-timer-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-short-tick-tock-of-a-clock-2213.mp3" preload="auto"></audio>
    <audio id="dvt-tap-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
    <audio id="dvt-left-win-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
    <audio id="dvt-right-win-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-ethereal-fairy-win-sound-2019.mp3" preload="auto"></audio>
    
    <div id="ad-frame-wrapper" style="display: none;">
        <div class="stage">
            <div class="overlay">
                <span>Close in</span>
                <span class="timer" id="ad-timer">15s</span>
                <button id="ad-close-btn" class="closeBtn" disabled>Close</button>
            </div>
            <div id="ad-container">
            </div>
        </div>
    </div>
    
    <div id="auto-ad-overlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 99999; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box;">
        <div style="position: relative; width: 100%; max-width: 330px; height: 100%; max-height: 490px; background-color: #000; border: 2px solid #333; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.5);">
            <div style="padding: 8px 12px; background-color: #1a1a2e; text-align: right; flex-shrink: 0;">
                <span id="auto-ad-timer" style="color: white; font-size: 14px; font-weight: bold; font-family: 'Poppins', sans-serif;"></span>
            </div>
            <iframe id="auto-ad-iframe" style="width: 100%; height: 100%; border: none; flex-grow: 1;"></iframe>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBJrCE4w_QfBqfF3g4O_RuCK4DbjmL9TRg",
          authDomain: "telegram-69052.firebaseapp.com",
          databaseURL: "https://telegram-69052-default-rtdb.firebaseio.com",
          projectId: "telegram-69052",
          storageBucket: "telegram-69052.firebasestorage.app",
          messagingSenderId: "824247387361",
          appId: "1:824247387361:web:f4e6c22abb4b503871a3a0",
          measurementId: "G-GB3LP113V6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const TELEGRAM_BOT_BASE_URL = 'https://t.me/Squid_456_bot';

        let isAdCurrentlyShowing = false; 

        function triggerTelegramAd() {
            if (typeof show_9966888 !== 'function') {
                console.log("Telegram ad function (show_9966888) abhi tak load nahi hua.");
                return;
            }
            if (isAdCurrentlyShowing) {
                console.log("Telegram Ad Roka Gaya: Koi aur ad pehle se chal raha hai.");
                return;
            }
            const isPopupOpen = document.querySelector('.popup[style*="display: flex"], .ws-modal[style*="display: flex"]');
            if (isPopupOpen) {
                console.log("Telegram Ad Roka Gaya: Ek popup khula hai.");
                return;
            }
            if(document.hidden){
                console.log("Telegram Ad Roka Gaya: Page background me hai.");
                return;
            }
            console.log("Telegram ad dikhaya ja raha hai...");
            show_9966888();
        }
        
        let automaticAdTimerInterval = null;
        const autoAdOverlay = document.getElementById('auto-ad-overlay');
        const autoAdIframe = document.getElementById('auto-ad-iframe');
        const autoAdTimerDiv = document.getElementById('auto-ad-timer');
        const AUTO_AD_URL = 'https://www.effectivegatecpm.com/iwcgcd84?key=5cf63a46c0f282002187eab8c211bdb8';
        const AUTO_AD_INTERVAL = 180000;
        const AUTO_AD_DURATION = 20000;

        function showAutomaticAd() {
            // Disabled automatic ads
            if (isAdCurrentlyShowing) return;
            // Removed auto ad logic
        }

        function tryToShowAutomaticAd() {
            // Disabled
        }

        function startAutomaticAdTimer() {
            // Disabled
        }

        const adFrameWrapper = document.getElementById('ad-frame-wrapper');
        const adTimerEl = document.getElementById('ad-timer');
        const adCloseBtn = document.getElementById('ad-close-btn');
        const adContainer = document.getElementById('ad-container');
        let adCanClose = false;
        let adCountdownInterval;

        function showAdFrame(adUrl, onCompleteCallback, options = {}) {
            const defaultOptions = { duration: 15, showOverlay: true };
            const finalOptions = { ...defaultOptions, ...options };

            isAdCurrentlyShowing = true;
            adCanClose = false;
            let remaining = finalOptions.duration;

            const overlay = adFrameWrapper.querySelector('.overlay');
            if (finalOptions.showOverlay) {
                overlay.style.display = 'flex';
                adTimerEl.textContent = remaining + 's';
                adCloseBtn.setAttribute('disabled', 'true');
                adCloseBtn.classList.remove('enabled');
            } else {
                overlay.style.display = 'none';
            }

            adCloseBtn.onclick = null;

            adContainer.innerHTML = '';
            const iframe = document.createElement('iframe');
            iframe.src = adUrl;
            adContainer.appendChild(iframe);
            
            adFrameWrapper.style.display = 'grid';

            history.pushState(null, '', location.href);
            const blockBack = () => {
                if (!adCanClose) {
                    history.pushState(null, '', location.href);
                }
            };
            window.addEventListener('popstate', blockBack);

            function unlock() {
                adCanClose = true;
                if (finalOptions.showOverlay) {
                    adCloseBtn.removeAttribute('disabled');
                    adCloseBtn.classList.add('enabled');
                }
                
                adCloseBtn.onclick = () => {
                    isAdCurrentlyShowing = false;
                    adFrameWrapper.style.display = 'none';
                    adContainer.innerHTML = '';
                    window.removeEventListener('popstate', blockBack);
                    overlay.style.display = 'flex'; 
                    if (onCompleteCallback && typeof onCompleteCallback === 'function') {
                        onCompleteCallback();
                    }
                };
                
                if (!finalOptions.showOverlay) {
                     adCloseBtn.onclick();
                }
            }

            if (adCountdownInterval) clearInterval(adCountdownInterval);
            adCountdownInterval = setInterval(() => {
                remaining -= 1;
                if (finalOptions.showOverlay) {
                    adTimerEl.textContent = (remaining > 0 ? remaining : 0) + 's';
                }
                if (remaining <= 0) {
                    clearInterval(adCountdownInterval);
                    unlock();
                }
            }, 1000);

            setTimeout(() => { if (!adCanClose) unlock(); }, (finalOptions.duration + 1) * 1000);
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'BKC';
            for (let i = 0; i < 3; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function copyTextToClipboard(text, buttonElement) {
            navigator.clipboard.writeText(text).then(() => {
                if (buttonElement) {
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = 'COPIED! <i class="fas fa-check"></i>';
                    setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
                }
                 else {
                    alert('Link Copied!');
                }
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Could not copy link. Please copy it manually.');
            });
        }


        function handleIncomingReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                sessionStorage.setItem('referrerCode', refCode);
            }
        }

        function creditReferrer(referralCode) {
            if (!referralCode) return;
            const usersRef = database.ref('Users');
            usersRef.orderByChild('myReferralC').equalTo(referralCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const referrerData = snapshot.val();
                    const referrerId = Object.keys(referrerData)[0];
                    const referrerUserRef = database.ref(`Users/${referrerId}`);
                    referrerUserRef.transaction(userData => {
                        if (userData) {
                            userData.score = (userData.score || 0) + 400;
                            userData.Totalearning = (userData.Totalearning || 0) + 400;
                            userData.referralsMade = (userData.referralsMade || 0) + 1;
                            userData.referralBonusEarned = (userData.referralBonusEarned || 0) + 400;
                        }
                        return userData;
                    });
                    console.log(`Credited 400 coins to referrer ${referrerId}`);
                }
            });
        }

        function updateUserPresence(userId) {
            if (!userId) return;
            const userPresenceRef = database.ref('/Users/' + userId + '/presence');
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userPresenceRef.set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    userPresenceRef.onDisconnect().set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                }
            });
        }

        function getOrCreateUserId() {
            let userId = localStorage.getItem('tapGameUserId');
            if (!userId) {
                userId = database.ref().push().key;
                localStorage.setItem('tapGameUserId', userId);
            }
            return userId;
        }
        const userId = getOrCreateUserId();
        
        function logUserEvent(eventName, eventData = {}) {
            if (!userId) return;
            const activityRef = database.ref(`userActivity/${userId}`);
            activityRef.push({
                eventName: eventName,
                eventData: eventData,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error("Error logging event:", error);
            });
        }

        let sessionStartTime = Date.now();
        let totalOnlineTime = 0;

        function updateOnlineTime() {
            if (sessionStartTime) {
                const sessionDuration = Date.now() - sessionStartTime;
                totalOnlineTime += sessionDuration;
                sessionStartTime = Date.now(); 
                
                const userRef = database.ref(`Users/${userId}`);
                userRef.child('totalOnlineTime').set(firebase.database.ServerValue.increment(sessionDuration));
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                updateOnlineTime();
                sessionStartTime = null;
            } else {
                sessionStartTime = Date.now();
            }
        });
        window.addEventListener('beforeunload', updateOnlineTime);

        setInterval(updateOnlineTime, 60000);

        function initMiningClockAndGalaxy() {
            const canvas = document.getElementById('galaxy');
            if (!canvas || !document.getElementById('game-screen') || document.getElementById('game-screen').classList.contains('hidden')) {
                return; 
            }
            const ctx = canvas.getContext('2d');
            let stars = [];
            const numStars = 700;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * canvas.width - canvas.width / 2,
                    y: Math.random() * canvas.height - canvas.height / 2,
                    z: Math.random() * canvas.width,
                });
            }
            
            let animationFrameId;
            function animateGalaxy() {
                if (document.getElementById('game-screen').classList.contains('hidden')) {
                    cancelAnimationFrame(animationFrameId); 
                    return;
                }

                ctx.fillStyle = 'rgba(0, 0, 20, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);

                for (let star of stars) {
                    star.z -= 1;
                    if (star.z <= 0) star.z = canvas.width;
                    const k = 128.0 / star.z;
                    const px = star.x * k;
                    const py = star.y * k;
                    const size = (1 - star.z / canvas.width) * 2;
                    ctx.beginPath();
                    ctx.arc(px, py, size, 0, 2 * Math.PI);
                    ctx.fillStyle = `hsl(${200 + Math.random() * 60}, 100%, ${60 + Math.random() * 20}%)`;
                    ctx.fill();
                }

                ctx.restore();
                animationFrameId = requestAnimationFrame(animateGalaxy);
            }
            animateGalaxy();

            let clockInterval;
            function updateClock() {
                if (document.getElementById('game-screen').classList.contains('hidden')) {
                     return;
                }
                const now = new Date();
                const hour = now.getHours() % 12;
                const minute = now.getMinutes();
                const second = now.getSeconds();
                const hourDeg = (hour + minute / 60) * 30;
                const minuteDeg = (minute + second / 60) * 6;
                const secondDeg = second * 6;
                const hourHand = document.getElementById('hour');
                const minuteHand = document.getElementById('minute');
                const secondHand = document.getElementById('second');
                
                if(hourHand) hourHand.style.transform = `rotate(${hourDeg}deg)`;
                if(minuteHand) minuteHand.style.transform = `rotate(${minuteDeg}deg)`;
                if(secondHand) secondHand.style.transform = `rotate(${secondDeg}deg)`;
            }
            
            clockInterval = setInterval(updateClock, 1000);
            updateClock();

            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'class' && document.getElementById('game-screen').classList.contains('hidden')) {
                        clearInterval(clockInterval);
                        cancelAnimationFrame(animationFrameId);
                        observer.disconnect(); 
                    }
                });
            });
            observer.observe(document.getElementById('game-screen'), { attributes: true });
        }
        
        // ===== START: NEW OFFERWALL SCRIPT (ADAPTED FOR THIS GAME) =====
        let offerwallScreenInitialized = false;
        function initializeOfferwallScreen() {
            if (offerwallScreenInitialized) {
                showOfferwallPage('tasks');
                return;
            }
            
            const offerScreen = document.getElementById('offerwall-screen');
            const mainContainer = offerScreen.querySelector('#mainContainer');
            const navItems = offerScreen.querySelectorAll('.nav-item');
            
            // Fixed back button functionality - GOES TO HOME
            const backButton = document.getElementById('offerwall-back-button');
            backButton.addEventListener('click', function() {
                showScreen('game-screen');
            });

            function showOfferwallPage(pageId) {
                mainContainer.innerHTML = '';
                navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
                switch (pageId) {
                    case 'tasks': renderTasksPage(); break;
                    case 'completed': renderCompletedPage(); break;
                    case 'support': renderSupportPage(); break;
                }
            }
            
            function renderTasksPage() {
                mainContainer.innerHTML = `<div class="tabs"><div class="tab active" data-task-type="tasks">Tasks</div><div class="tab" data-task-type="appInstalls">App Install</div><div class="tab" data-task-type="dailyTasks">Daily Tasks</div></div><div id="taskContainer"><p>Loading...</p></div>`;
                const taskTabs = mainContainer.querySelectorAll('.tab');
                taskTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        taskTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        loadAndDisplayTasks(tab.dataset.taskType);
                    });
                });
                loadAndDisplayTasks('tasks');
            }
            
            function renderCompletedPage() {
                mainContainer.innerHTML = `<h3>My Task Status</h3><div id="completedTaskContainer"><p>Loading your tasks...</p></div>`;
                const container = document.getElementById('completedTaskContainer');
                const appInstallsRef = database.ref('appInstalls');
                const userTasksRef = database.ref('userTasks/' + userId);

                appInstallsRef.once('value').then(appInstallsSnapshot => {
                    const appInstallsData = appInstallsSnapshot.val() || {};
                    userTasksRef.on('value', (snapshot) => {
                        container.innerHTML = '';
                        if (!snapshot.exists()) { container.innerHTML = "<p>You haven't started any tasks yet.</p>"; return; }
                        const userTasks = snapshot.val();
                        let hasTasks = false;
                        Object.values(userTasks).forEach(userTask => {
                            const taskDetails = appInstallsData[userTask.taskId];
                            if (taskDetails) {
                                hasTasks = true;
                                container.appendChild(renderUserTaskCard(userTask, taskDetails));
                            }
                        });
                        if (!hasTasks) {
                           container.innerHTML = "<p>You haven't started any tasks yet.</p>";
                        }
                    });
                }).catch(error => { console.error("Error loading completed tasks:", error); container.innerHTML = "<p>Could not load tasks. Please try again.</p>"; });
            }
            
            function renderUserTaskCard(userTask, taskDetails) {
                const card = document.createElement("div"); card.className = "task-card-list"; 
                let statusText = 'Pending', statusClass = 'status-pending';
                if (userTask.status === 'completed') { statusText = 'Completed'; statusClass = 'status-completed'; } 
                else if (userTask.status === 'rejected') { statusText = 'Rejected'; statusClass = 'status-rejected'; }
                card.innerHTML = `<div class="task-left"><div class="task-logo"><img src="${taskDetails.image}" alt="${taskDetails.name}"></div><div class="task-info"><h3>${taskDetails.name}</h3><p> ${taskDetails.reward || 0} Coins</p></div></div><div class="status-badge ${statusClass}">${statusText}</div>`;
                return card;
            }

            function renderSupportPage() {
                mainContainer.innerHTML = `<h3>Support Chat</h3><div class="support-container"><div class="message-history" id="messageHistory"><p>Loading...</p></div><form class="message-form" id="messageForm"><input type="text" id="messageInput" class="message-input" placeholder="Type..." required><button type="submit" class="send-btn">Send</button></form></div>`;
                document.getElementById('messageForm').addEventListener('submit', sendMessage); loadMessages();
            }
            
            function loadMessages() {
                const historyContainer = document.getElementById('messageHistory');
                const messagesRef = database.ref('supportMessages/' + userId);
                messagesRef.on('value', (snapshot) => {
                    historyContainer.innerHTML = '';
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const messageData = childSnapshot.val();
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${messageData.from === 'user' ? 'user-message' : 'admin-message'}`;
                            messageDiv.textContent = messageData.text; historyContainer.appendChild(messageDiv);
                        });
                    } else { historyContainer.innerHTML = '<p>No messages yet.</p>'; }
                    historyContainer.scrollTop = historyContainer.scrollHeight;
                });
            }

            function sendMessage(event) {
                event.preventDefault();
                const messageInput = document.getElementById('messageInput'); const messageText = messageInput.value.trim();
                if (messageText === '' || !userId) return;
                database.ref('supportMessages/' + userId).push({ text: messageText, from: 'user', timestamp: firebase.database.ServerValue.TIMESTAMP }).then(() => { messageInput.value = ''; }).catch(error => { console.error(error); alert("Could not send."); });
            }

            function loadAndDisplayTasks(tabName) {
              const container = document.getElementById('taskContainer'); container.innerHTML = "<p>Loading...</p>"; container.className = ''; 
              if (tabName === 'appInstalls') {
                  container.classList.add('app-install-container');
                  database.ref('appInstalls').once('value').then((snapshot) => {
                      container.innerHTML = "";
                      if (snapshot.exists()) {
                          let activeTasksFound = false;
                          snapshot.forEach(childSnapshot => {
                              const taskId = childSnapshot.key, task = childSnapshot.val();
                              if (task.active) { activeTasksFound = true; container.appendChild(renderOfferwallCard(task, taskId)); }
                          });
                          if(!activeTasksFound) container.innerHTML = "<p>No apps to install.</p>";
                      } else { container.innerHTML = "<p>No apps found.</p>"; }
                  });
                  return;
              }
              database.ref(`settings/${tabName}View`).once('value').then((settingSnapshot) => {
                  const viewMode = settingSnapshot.exists() ? settingSnapshot.val() : 'list';
                  database.ref(tabName).once('value').then((taskSnapshot) => {
                      container.innerHTML = "";
                      if (viewMode === 'grid') container.classList.add('grid-container');
                      if (taskSnapshot.exists()) {
                          let activeTasksFound = false;
                          taskSnapshot.forEach((childSnapshot) => {
                              const t = childSnapshot.val();
                              if (t.active) { activeTasksFound = true; container.appendChild((viewMode === 'grid') ? renderGridCard(t) : renderListCard(t)); }
                          });
                           if(!activeTasksFound) container.innerHTML = "<p>No active tasks found.</p>";
                      } else { container.innerHTML = "<p>No tasks found.</p>"; }
                  });
              });
            }
            
            function startAppInstallTask(taskId) {
                if (!userId || !taskId) return;
                const userTasksRef = database.ref(`userTasks/${userId}`);
                const q = userTasksRef.orderByChild('taskId').equalTo(taskId);
                
                q.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        console.log(`User has already started task: ${taskId}`);
                    } else {
                        const newUserTaskRef = userTasksRef.push();
                        newUserTaskRef.set({
                            taskId: taskId,
                            status: 'pending',
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        console.log(`Task started and logged to DB for user: ${userId}, task: ${taskId}`);
                    }
                });
            }

            function showOfferPage(task, taskId) {
                const offerPage = document.getElementById('fullPageOffer');
                const descriptionText = task.description || 'Install and open the app to get your reward.';
                offerPage.innerHTML = `
                    <span class="offer-page-close-btn">&times;</span>
                    <div class="offer-page-content">
                        <div class="offer-page-reward-circle"><span>${task.reward}</span><small>Coins</small></div>
                        <h2 class="offer-page-title">Complete the Task</h2>
                        <p class="offer-page-subtitle">${task.name || 'High earning app'}</p>
                        <div class="offer-page-steps">${descriptionText}</div>
                    </div>
                    <button class="offer-page-start-btn">Start Task</button>
                `;

                offerPage.querySelector('.offer-page-close-btn').addEventListener('click', () => {
                    offerPage.classList.remove('show');
                });
                
                offerPage.querySelector('.offer-page-start-btn').addEventListener('click', () => {
                    window.open(task.link, '_blank');
                    startAppInstallTask(taskId);
                    offerPage.classList.remove('show');
                });

                offerPage.classList.add('show');
            }

            function renderOfferwallCard(task, taskId) {
                const card = document.createElement("div"); card.className = "offerwall-card";
                const coinIconURL = "https://img.icons8.com/fluency/48/coin.png";
                card.innerHTML = `<div class="offer-logo"><img src="${task.image}" alt="${task.name}"></div><h3 class="offer-title">${task.name}</h3><p class="offer-provider">${task.provider}</p><div class="offer-reward"><img src="${coinIconURL}" alt="coin"><span>${task.reward}</span></div>`;
                card.addEventListener('click', () => { showOfferPage(task, taskId); });
                return card;
            }

            function renderListCard(task) {
                const card = document.createElement("div"); card.className = "task-card-list";
                card.innerHTML = `<div class="task-left"><div class="task-logo"><img src="${task.image}" alt=""></div><div class="task-info"><h3>${task.name}</h3> <p> ${task.reward || 0} Coins</p></div></div><button class="task-btn">View </button>`;
                card.querySelector(".task-btn").addEventListener("click", () => window.open(task.link, "_blank"));
                return card;
            }

            function renderGridCard(task) {
                const card = document.createElement("div"); card.className = "task-card-grid";
                card.style.backgroundImage = `linear-gradient(to top, rgba(0,0,0,0.8), transparent 50%), url('${task.image}')`;
                card.textContent = task.name;
                card.addEventListener("click", () => window.open(task.link, "_blank"));
                return card;
            }

            navItems.forEach(item => item.addEventListener('click', () => showOfferwallPage(item.dataset.page)));
            
            showOfferwallPage('tasks');
            offerwallScreenInitialized = true;
        }
        // ===== END: NEW OFFERWALL SCRIPT =====

        // ===== START: NEW TASK UNLOCKER SCRIPT =====
        let taskUnlockerInitialized = false;
        function initializeTaskUnlockerScreen() {
            if (taskUnlockerInitialized) {
                return;
            }

            const screen = document.getElementById('task-unlocker-screen');
            const instructionText = screen.querySelector('#tu-instruction-text');
            const mainButton = screen.querySelector('#tu-main-action-button');
            const taskArea = screen.querySelector('#tu-task-area');
            const dummyTask = screen.querySelector('#tu-dummy-task');
            const unlockSound = screen.querySelector('#tu-unlock-sound');
            const squidOverlay = screen.querySelector('#squid-animation-overlay');
            const squidShape = screen.querySelector('#squid-shape');

            function logTaskUnlockerAction(action) {
                database.ref('activityLogs/taskUnlocker').push({
                    id: userId,
                    action: action,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }

            function showUnlockedUI(settings) {
                instructionText.textContent = settings.unlockedHeading || 'Task Complete! You Can Proceed';
                mainButton.textContent = 'Open';
                mainButton.style.display = 'block';
                taskArea.style.display = 'none';
            }

            function showLockedUI(settings) {
                instructionText.textContent = settings.mainHeading || 'Complete 1 Task to Unlock';
                mainButton.style.display = 'none';
                taskArea.style.display = 'block';
                dummyTask.style.pointerEvents = 'auto';
                dummyTask.textContent = settings.taskButtonText || 'Complete The Task Now';
                dummyTask.href = settings.taskLink || '#';
            }

            function startSquidAnimation() {
                logTaskUnlockerAction('"Open" Button Clicked & Animation Started');
                if(unlockSound) unlockSound.play().catch(e => console.log("Sound error"));
                squidOverlay.style.display = 'flex';
                squidShape.classList.add('animate');

                squidShape.addEventListener('animationend', () => {
                    // **CHANGE IS HERE**: Show the main wallet screen after animation.
                    showScreen('wallet-screen'); 
                    
                    // Hide the animation overlay for next time
                    squidOverlay.style.display = 'none';
                    squidShape.classList.remove('animate');
                }, { once: true });
            }

            mainButton.addEventListener('click', () => {
                if (mainButton.textContent === 'Open') {
                    startSquidAnimation();
                }
            });

            dummyTask.addEventListener('click', () => {
                logTaskUnlockerAction('Task Link Clicked');
                dummyTask.textContent = 'Please wait...';
                dummyTask.style.pointerEvents = 'none';
            });
            
            const settingsRef = database.ref('taskUnlockerSettings');
            const userUnlockRef = database.ref('taskUnlockerUsers/' + userId);

            settingsRef.on('value', (snapshot) => {
                const settings = snapshot.val() || {};
                userUnlockRef.on('value', (userSnapshot) => {
                    const user = userSnapshot.val();
                    if (!user) {
                        userUnlockRef.set({ id: userId, isUnlocked: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });
                        showLockedUI(settings);
                        return;
                    }
                    userUnlockRef.update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    if (user.isUnlocked) {
                        showUnlockedUI(settings);
                    } else {
                        showLockedUI(settings);
                    }
                });
            });
            logTaskUnlockerAction('Task Unlocker Page Loaded');
            taskUnlockerInitialized = true;
        }
        // ===== END: NEW TASK UNLOCKER SCRIPT =====

        document.addEventListener('DOMContentLoaded', () => {
            // ===== START: NEW FIREBASE LOADING SCREEN SCRIPT =====
            function initFirebaseLoadingScreen() {
                const settingsRef = database.ref('loadingScreenSettings');

                settingsRef.once('value').then(snapshot => {
                    const settings = snapshot.val();
                    if (settings) {
                        if(settings.bg) document.querySelector('#firebase-loading-screen #bg').style.backgroundImage = `url('${settings.bg}')`;
                        if(settings.center) {
                          const c = document.querySelector('#firebase-loading-screen #center');
                          c.src = settings.center;
                          c.style.display = 'block';
                        }
                        document.querySelector('#firebase-loading-screen #trees').textContent = settings.trees || "Loading Game...";
                    } else {
                        document.querySelector('#firebase-loading-screen #trees').textContent = "Loading Game...";
                    }
                });

                let p = 0;
                const bar = document.querySelector('#firebase-loading-screen #bar-inner');
                const txt = document.querySelector('#firebase-loading-screen #bar-text');

                const timer = setInterval(()=>{
                  p += Math.floor(3 + Math.random()*7);
                  if(p>100) p=100;

                  bar.style.width = p + '%';

                  if(p<33) txt.textContent = 'loading...';
                  else if(p<66) txt.textContent = 'initializing...';
                  else txt.textContent = 'almost done...';

                  if(p>=100){
                    txt.textContent = 'ready!';
                    clearInterval(timer);
                    setTimeout(()=>{
                      document.getElementById('firebase-loading-screen').classList.add('hidden');
                    }, 1000);
                  }
                }, 440);

                (function sparkles(){
                  const canvas = document.querySelector('#firebase-loading-screen #sparkCanvas');
                  const ctx = canvas.getContext('2d');
                  function resize(){
                    canvas.width = innerWidth;
                    canvas.height = innerHeight;
                  }
                  resize();
                  addEventListener('resize', resize);

                  const stars = [];
                  for(let i=0;i<25;i++){
                    stars.push({
                      x:Math.random()*canvas.width,
                      y:Math.random()*canvas.height,
                      r:1+Math.random()*2.5,
                      vx:(Math.random()-0.5)*0.3,
                      vy:-0.3-Math.random()*0.5,
                      life:30+Math.random()*70
                    });
                  }

                  function tick(){
                    if (document.getElementById('firebase-loading-screen').classList.contains('hidden')) {
                        return; // Stop animation when loading screen is hidden
                    }
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    for(let s of stars){
                      s.x+=s.vx; s.y+=s.vy; s.life--;
                      if(s.life<0){
                        s.x=Math.random()*canvas.width;
                        s.y=canvas.height+10;
                        s.life=30+Math.random()*70;
                      }
                      ctx.beginPath();
                      ctx.fillStyle="rgba(255,255,255,"+(0.4+0.6*Math.random())+")";
                      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
                      ctx.fill();
                    }
                    requestAnimationFrame(tick);
                  }
                  tick();
                })();
            }
            initFirebaseLoadingScreen();
            // ===== END: NEW FIREBASE LOADING SCREEN SCRIPT =====

            updateUserPresence(userId);

            const elements = {
                gameScreen: document.getElementById('game-screen'),
                profileSection: document.getElementById('profile-section'),
                playerNameDisplay: document.getElementById('player-name-display'),
                screens: document.querySelectorAll('.screen'),
                navButtons: document.querySelectorAll('.nav-button'),
                nameChangePopup: document.getElementById('name-change-popup'),
                newNameInput: document.getElementById('new-name-input'),
                confirmNameButton: document.getElementById('confirm-name-button'),
                cancelNameButton: document.getElementById('cancel-name-button'),
                tasksOptionsContainer: document.getElementById('tasks-options-container'),
                notificationBell: document.getElementById('notification-bell'),
                notificationDot: document.getElementById('notification-dot'),
                notificationPopup: document.getElementById('notification-popup'),
                notificationList: document.getElementById('notification-list'),
                closeNotificationBtn: document.getElementById('close-notification-btn'),
                tournamentScreen: document.getElementById('tournament-screen'),
                tournamentListContainer: document.getElementById('tournament-list-container'),
                tournamentJoinPopup: document.getElementById('tournament-join-popup'),
                tournamentJoinPopupClose: document.getElementById('tournament-join-popup-close'),
                tournamentJoinPopupImage: document.getElementById('tournament-join-popup-image'),
                tournamentJoinPopupTitle: document.getElementById('tournament-join-popup-title'),
                tournamentJoinPopupFee: document.getElementById('tournament-join-popup-fee'),
                tournamentJoinNameInput: document.getElementById('tournament-join-name-input'),
                tournamentJoinCancelBtn: document.getElementById('tournament-join-cancel-btn'),
                tournamentJoinConfirmBtn: document.getElementById('tournament-join-confirm-btn'),
                tournamentAdView: document.getElementById('tournament-ad-view'),
                tournamentConfirmView: document.getElementById('tournament-confirm-view'),
                tournamentAdProgress: document.getElementById('tournament-ad-progress'),
                tournamentWatchAdBtn: document.getElementById('tournament-watch-ad-btn'),
                tournamentAdCancelBtn: document.getElementById('tournament-ad-cancel-btn'),
                rewardsHubButton: document.getElementById('rewards-hub-button'),
                rewardsHubScreen: document.getElementById('rewards-hub-screen'),
                joinTelegramLink: document.getElementById('join-telegram-link'),
                claimTelegramRewardBtn: document.getElementById('claim-telegram-reward-btn'),
                claimDailyBonusBtn: document.getElementById('claim-daily-bonus-btn'),
                walletScreen: document.getElementById('wallet-screen'),
                walletPlayerName: document.getElementById('wallet-player-name'),
                walletBalance: document.getElementById('wallet-balance'),
                walletUsdValue: document.getElementById('wallet-usd-value'),
                walletHistory: document.getElementById('wallet-history'),
                walletOpenOptionsBtn: document.getElementById('wallet-open-options-btn'),
                walletOptionModal: document.getElementById('wallet-option-modal'),
                walletUpiModal: document.getElementById('wallet-upi-modal'),
                walletUsdtModal: document.getElementById('wallet-usdt-modal'),
                walletOpenUpiBtn: document.getElementById('wallet-open-upi-btn'),
                walletOpenUsdtBtn: document.getElementById('wallet-open-usdt-btn'),
                walletUpiLogo: document.getElementById('wallet-upi-logo'),
                walletUsdtLogo: document.getElementById('wallet-usdt-logo'),
                walletSubmitUpiBtn: document.getElementById('wallet-submit-upi-btn'),
                walletSubmitUsdtBtn: document.getElementById('wallet-submit-usdt-btn'),
                walletUpiName: document.getElementById('wallet-upi-name'),
                walletUpiId: document.getElementById('wallet-upi-id'),
                walletUpiCoins: document.getElementById('wallet-upi-coins'),
                walletUsdtNetwork: document.getElementById('wallet-usdt-network'),
                walletUsdtAddress: document.getElementById('wallet-usdt-address'),
                walletUsdtCoins: document.getElementById('wallet-usdt-coins'),
                walletUsdtReceive: document.getElementById('wallet-usdt-receive'),
                miningButton: document.getElementById('mining-button'), // This now opens the DVT Game
                referButton: document.getElementById('refer-button'),
                diamondDisplay: document.getElementById('diamond-display'),
                diamondCount: document.getElementById('diamond-count'),
                diamondScreen: document.getElementById('diamond-screen'),
                diamondBalanceDisplay: document.getElementById('diamond-balance-display'),
                adsScreen: document.getElementById('ads-screen'),
                adsList: document.getElementById('adsList'),
                giftScreen: document.getElementById('gift-screen'),
                giftCodeInput: document.getElementById('giftCodeInput'),
                redeemGiftCodeBtn: document.getElementById('redeem-gift-code-btn'),
                claimButtonContainer: document.getElementById('claimButtonContainer'),
                claimBtn1: document.getElementById('claimBtn1'),
                redeemedMessage: document.getElementById('redeemedMessage'),
                dailyTasksSideButton: document.getElementById('daily-tasks-side-button'),
                dailyTasksScreen: document.getElementById('daily-tasks-screen'),
                dtCoinBalance: document.getElementById('dt-coin-balance'),
                dtDiamondBalance: document.getElementById('dt-diamond-balance'),
                dailyTaskListContainer: document.getElementById('daily-task-list-container'),
                dtRefreshTimer: document.getElementById('dt-refresh-timer'),
                miningControlButton: document.getElementById('mining-control-button'),
                miningProgressText: document.getElementById('mining-progress-text'),
                taskUnlockerScreen: document.getElementById('task-unlocker-screen'),
            };

            // ===== START: NEW SOUND FUNCTIONALITY =====
            function playSound(soundId) {
                const sound = document.getElementById(soundId);
                if (sound) {
                    sound.currentTime = 0; // Rewind to the start
                    sound.play().catch(e => console.log(`Sound play failed: ${e.message}`));
                }
            }

            // Global click listener for all buttons and tappable elements
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('button, .nav-button, .copy-id-btn, .send-screenshot-btn, .join-telegram-button, .profile-section')) {
                    playSound('tap-sound');
                }
            });
            // ===== END: NEW SOUND FUNCTIONALITY =====

            elements.dailyTasksSideButton.addEventListener('click', () => showScreen('daily-tasks-screen'));
            
            let gameSettings = {
                withdrawalsLocked: false,
                withdrawalButtonText: 'Withdraw All Coins',
                isWithdrawalForceUnlocked: false,
                coinValue: 1000,
                logoUrls: { upi: '', usdt: '', coin: '' },
            };
            
            let withdrawalMethods = {
                upi: { isLocked: false, message: '' },
                usdt: { isLocked: false, message: '' }
            };

            let state = {
                score: 0, playerName: 'Player',
                myReferralC: null, referredBy: null,
                withdrawalAdClicks: 0,
                tapCounter: 0,
                messages: [],
                joinedTournaments: {},
                telegramJoinedClaimed: false,
                lastDailyBonusClaim: null,
                isIndividuallyLocked: false,
                totalOnlineTime: 0,
                creationTime: 0,
                diamonds: 0,
                adsProgress: {},
                dailyTaskProgress: {},
                miningAdsWatched: 0,
                isMiningActive: false,
                miningStartTime: 0,
                referralsMade: 0,
                referralBonusEarned: 0,
            };
            
            let currentTournamentJoinProcess = {
                details: null,
                adsWatched: 0,
                adsRequired: 5,
                adUrl: 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6'
            };
            
            // ===== REPLACED DAILY TASK SETTINGS =====
            let dailyTaskSettings = {
                adsTarget: 20,       // Total ads to watch
                rewardCoins: 15,     // Reward after 20 ads
                cooldownHours: 8,    // 8 Hours wait time
                minWatchSeconds: 15  // Ad viewing duration
            };
            
            let claimSettings = {};
            
            let miningCountdownInterval = null;
            const MINING_DURATION = 2 * 60 * 60 * 1000;
            const MINING_REWARD = 900;
            const ADS_REQUIRED_FOR_MINING = 10;

            function formatTime(ms) {
                if (ms <= 0) return "00:00:00";
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            }
            
            function renderMiningButton() {
                const button = elements.miningControlButton;
                const progressText = elements.miningProgressText;

                if (state.isMiningActive) {
                    const timeRemaining = (state.miningStartTime + MINING_DURATION) - Date.now();
                    
                    if (timeRemaining > 0) {
                        button.disabled = true;
                        button.textContent = 'Mining in Progress';
                        progressText.textContent = `Time Left: ${formatTime(timeRemaining)}`;
                        
                        if (miningCountdownInterval) clearInterval(miningCountdownInterval);
                        miningCountdownInterval = setInterval(renderMiningButton, 1000);

                    } else {
                        if (miningCountdownInterval) clearInterval(miningCountdownInterval);
                        button.disabled = false;
                        button.textContent = `Claim ${MINING_REWARD} Coins`;
                        button.classList.add('can-claim');
                        progressText.textContent = "Mining complete!";
                    }
                } else {
                    button.classList.remove('can-claim');
                    const adsWatched = state.miningAdsWatched || 0;
                    if (adsWatched < ADS_REQUIRED_FOR_MINING) {
                        button.disabled = false;
                        button.textContent = `Watch Ad (${adsWatched}/${ADS_REQUIRED_FOR_MINING})`;
                        progressText.textContent = 'Watch 10 ads to start mining';
                    } else {
                        button.disabled = false;
                        button.textContent = 'Start Mining';
                        progressText.textContent = 'Ready to start 2-hour mining session!';
                    }
                }
            }
            
            elements.miningControlButton.addEventListener('click', () => {
                const button = elements.miningControlButton;

                if (state.isMiningActive) {
                    const timeRemaining = (state.miningStartTime + MINING_DURATION) - Date.now();
                    if (timeRemaining <= 0) {
                        state.score += MINING_REWARD;
                        playSound('coin-sound');
                        state.isMiningActive = false;
                        state.miningStartTime = 0;
                        state.miningAdsWatched = 0;
                        saveGame({ 
                            score: state.score, 
                            isMiningActive: state.isMiningActive, 
                            miningStartTime: state.miningStartTime, 
                            miningAdsWatched: state.miningAdsWatched 
                        });
                        alert(`You claimed ${MINING_REWARD} coins!`);
                        updateDisplay();
                        renderMiningButton();
                    }
                } else {
                    const adsWatched = state.miningAdsWatched || 0;
                    if (adsWatched < ADS_REQUIRED_FOR_MINING) {
                        if (typeof show_9966767 !== 'function') {
                            alert("Ad function is not ready yet. Please wait a moment.");
                            return;
                        }
                        
                        button.disabled = true;
                        button.textContent = "Loading Ad...";

                        show_9966767().then(() => {
                            console.log('Rewarded interstitial ad for mining completed.');
                            alert('Ad watched! Your progress has been updated.');
                            
                            state.miningAdsWatched++;
                            saveGame({ miningAdsWatched: state.miningAdsWatched });
                            
                            renderMiningButton(); 
                        });

                    } else {
                        playSound('mining-start-sound');
                        state.isMiningActive = true;
                        state.miningStartTime = Date.now();
                        saveGame({ isMiningActive: state.isMiningActive, miningStartTime: state.miningStartTime });
                        logUserEvent('mining_started');
                        renderMiningButton();
                    }
                }
            });
            
            const dvtGame = {
                elements: {
                    leftSide: document.getElementById('dvt-leftSide'),
                    rightSide: document.getElementById('dvt-rightSide'),
                    leftNum: document.getElementById('dvt-leftNum'),
                    rightNum: document.getElementById('dvt-rightNum'),
                    startBtn: document.getElementById('dvt-startBtn'),
                    controls: document.getElementById('dvt-controls'),
                    messageEl: document.getElementById('dvt-message'),
                    balanceDisplay: document.getElementById('dvt-balanceDisplay'),
                    coinBalance: document.getElementById('dvt-coinBalance'),
                    timerDisplay: document.getElementById('dvt-timerDisplay'),
                    leftBetDisplay: document.getElementById('dvt-leftBetDisplay'),
                    rightBetDisplay: document.getElementById('dvt-rightBetDisplay'),
                    allInBtn: document.getElementById('dvt-allInBtn'),
                    bgSound: document.getElementById('dvt-bg-sound'),
                    timerSound: document.getElementById('dvt-timer-sound'),
                    tapSound: document.getElementById('dvt-tap-sound'),
                    leftWinSound: document.getElementById('dvt-left-win-sound'),
                    rightWinSound: document.getElementById('dvt-right-win-sound')
                },
                state: {
                    payoutMultiplier: 1.8,
                    selectedSide: null,
                    betIncrement: 1000,
                    currentBetAmount: 0,
                    balance: 0, 
                    timer: 7,
                    isGameActive: false,
                    isAllInMode: false
                },
                
                init: function(initialBalance) {
                    this.state.balance = initialBalance;
                    this.updateBalanceDisplay();
                    this.resetUI();
                    this.loadImages(); 
                    this.elements.timerDisplay.textContent = ` ${this.state.timer}`;
                    this.elements.messageEl.innerHTML = `Tap amount select karke side par tap karein.`;

                    if (!this.listenersAdded) {
                        this.addEventListeners();
                        this.listenersAdded = true;
                    }
                },
                
                loadImages: function() {
                    const settingsRef = database.ref('dvt_settings/images');
                    settingsRef.once('value').then(snapshot => {
                        if (snapshot.exists()) {
                            const images = snapshot.val();
                            if (images.left) this.elements.leftSide.style.backgroundImage = `url('${images.left}')`;
                            if (images.right) this.elements.rightSide.style.backgroundImage = `url('${images.right}')`;
                        } else {
                            this.elements.leftSide.style.backgroundImage = `url('https://i.imgur.com/r33y2b2.jpeg')`;
                            this.elements.rightSide.style.backgroundImage = `url('https://i.imgur.com/i4n29i6.jpeg')`;
                        }
                    }).catch(error => {
                        console.error("DVT Game: Error loading images from Firebase", error);
                    });
                },

                resetUI: function() {
                    this.elements.startBtn.disabled = false;
                    this.elements.startBtn.style.opacity = 1;
                    this.elements.controls.querySelectorAll('.bet-btn, .all-in-btn').forEach(b => b.style.pointerEvents = 'auto');
                    this.elements.leftSide.style.pointerEvents = 'auto';
                    this.elements.rightSide.style.pointerEvents = 'auto';
                    this.elements.leftNum.textContent = '-';
                    this.elements.rightNum.textContent = '-';
                    this.elements.leftSide.classList.remove('selected');
                    this.elements.rightSide.classList.remove('selected');
                    this.state.selectedSide = null;
                    this.state.currentBetAmount = 0;
                    this.state.isAllInMode = false;
                    this.elements.allInBtn.classList.remove('active');
                    this.updateBetDisplay();
                },
                
                addEventListeners: function() {
                    this.elements.leftSide.addEventListener('click', () => this.handleSideTap('left'));
                    this.elements.rightSide.addEventListener('click', () => this.handleSideTap('right'));
                    
                    this.elements.controls.querySelectorAll('.bet-btn:not(#dvt-allInBtn)').forEach(b => {
                        const v = parseInt(b.dataset.bet, 10);
                        b.addEventListener('click', () => {
                            this.state.isAllInMode = false;
                            this.elements.allInBtn.classList.remove('active');
                            this.state.betIncrement = v;
                            this.state.currentBetAmount = 0;
                            this.elements.controls.querySelectorAll('.bet-btn').forEach(x => x.classList.remove('active'));
                            b.classList.add('active');
                            this.elements.messageEl.textContent = `Har tap par ${this.state.betIncrement.toLocaleString()} coins lagenge.`;
                            this.elements.messageEl.className = '';
                            this.updateBetDisplay();
                        });
                    });
                    
                    this.elements.allInBtn.addEventListener('click', () => {
                        if (this.state.balance <= 0) {
                            this.elements.messageEl.textContent = 'Aapke paas bet lagane ke liye coins nahi hain!';
                            return;
                        }
                        this.state.isAllInMode = true;
                        this.state.currentBetAmount = this.state.balance;
                        this.elements.controls.querySelectorAll('.bet-btn:not(#dvt-allInBtn)').forEach(b => b.classList.remove('active'));
                        this.elements.allInBtn.classList.add('active');
                        this.elements.messageEl.innerHTML = ` ALL IN! Ab ek side chuno.`;
                        if (this.state.selectedSide) { this.updateBetDisplay(); }
                    });
                    
                    this.elements.startBtn.addEventListener('click', () => this.startCountdown());
                    
                    this.elements.controls.querySelector('.bet-btn[data-bet="1000"]').classList.add('active');
                },
                
                updateBalanceDisplay: function() {
                    this.elements.balanceDisplay.textContent = this.state.balance.toLocaleString();
                    this.elements.coinBalance.textContent = this.state.balance.toLocaleString();
                },

                updateBetDisplay: function() {
                    this.elements.leftBetDisplay.style.display = 'none';
                    this.elements.rightBetDisplay.style.display = 'none';
                    if (this.state.currentBetAmount > 0) {
                        if (this.state.selectedSide === 'left') {
                            this.elements.leftBetDisplay.innerHTML = ` ${this.state.currentBetAmount.toLocaleString()}`;
                            this.elements.leftBetDisplay.style.display = 'block';
                        } else if (this.state.selectedSide === 'right') {
                            this.elements.rightBetDisplay.innerHTML = ` ${this.state.currentBetAmount.toLocaleString()}`;
                            this.elements.rightBetDisplay.style.display = 'block';
                        }
                    }
                },

                handleSideTap: function(tappedSide) {
                    if (this.elements.bgSound.paused) {
                        this.elements.bgSound.volume = 0.3;
                        this.elements.bgSound.play().catch(() => {});
                    }

                    if (this.state.isAllInMode) {
                        this.state.selectedSide = tappedSide;
                    } else {
                        if (this.state.balance < this.state.betIncrement && this.state.currentBetAmount === 0) {
                            this.elements.messageEl.textContent = 'Bet lagane ke liye coins nahi hain!';
                            this.elements.messageEl.className = 'result lose';
                            return;
                        }
                        if (this.state.selectedSide !== tappedSide) {
                            this.state.currentBetAmount = 0;
                            this.state.selectedSide = tappedSide;
                        }
                        if (this.state.balance < this.state.currentBetAmount + this.state.betIncrement) {
                            this.elements.messageEl.textContent = 'Itna bet lagane ke liye balance nahi hai!';
                            this.elements.messageEl.className = 'result lose';
                            return;
                        }
                        playSound('dvt-tap-sound');
                        this.state.currentBetAmount += this.state.betIncrement;
                    }

                    this.elements.leftSide.classList.toggle('selected', this.state.selectedSide === 'left');
                    this.elements.rightSide.classList.toggle('selected', this.state.selectedSide === 'right');
                    this.updateBetDisplay();
                    const sideName = tappedSide === 'left' ? 'ELEPHANT' : 'MONKEY';
                    this.elements.messageEl.innerHTML = this.state.isAllInMode ? ` ALL IN on ${sideName}!` : `Betting on ${sideName}`;
                    this.elements.messageEl.className = '';
                },

                startCountdown: function() {
                    if (!this.state.selectedSide || this.state.currentBetAmount === 0) {
                        this.elements.messageEl.textContent = 'Pehle bet lagayein!';
                        return;
                    }
                    if (this.state.currentBetAmount > this.state.balance) {
                        this.elements.messageEl.textContent = 'Aapke paas utne coins nahi hain';
                        this.elements.messageEl.className = 'result lose';
                        return;
                    }
                    this.elements.startBtn.disabled = true;
                    this.elements.startBtn.style.opacity = 0.7;
                    this.elements.controls.querySelectorAll('.bet-btn, .all-in-btn').forEach(b => b.style.pointerEvents = 'none');
                    this.elements.leftSide.style.pointerEvents = 'none';
                    this.elements.rightSide.style.pointerEvents = 'none';
                    this.elements.messageEl.textContent = 'Generating...';

                    let t = this.state.timer;
                    this.elements.timerDisplay.textContent = ` ${t}`;
                    playSound('dvt-timer-sound');
                    
                    const countdown = setInterval(() => {
                        t--;
                        this.elements.timerDisplay.textContent = ` ${t}`;
                        if (t > 0) playSound('dvt-timer-sound');
                        if (t <= 0) {
                            clearInterval(countdown);
                            this.elements.timerDisplay.textContent = ` ${this.state.timer}`;
                            this.playRound();
                        }
                    }, 1000);
                },
                
                playRound: function() {
                    let a, b;
                    let playerChoice = this.state.selectedSide;
                    const betAmount = this.state.currentBetAmount;
                    const totalBalance = this.state.balance;
                    let winChance = 0.40;
                    if (betAmount >= totalBalance * 0.3) {
                        winChance = 0.10;
                    }

                    if (Math.random() < winChance) {
                        if (playerChoice === 'left') { a = this.randInt(6, 10); b = this.randInt(1, 5); } 
                        else { a = this.randInt(1, 5); b = this.randInt(6, 10); }
                    } else {
                        if (playerChoice === 'left') { a = this.randInt(1, 5); b = this.randInt(6, 10); } 
                        else { a = this.randInt(6, 10); b = this.randInt(1, 5); }
                    }
                    if (a === b) { if (a < 10) a++; else a--; }
                    
                    this.elements.leftNum.textContent = a;
                    this.elements.rightNum.textContent = '...';
                    this.elements.messageEl.textContent = 'Right side ka number aa raha hai...';
                    
                    setTimeout(() => {
                        this.elements.rightNum.textContent = b;
                        setTimeout(() => {
                            const winnerSide = (a > b) ? 'left' : 'right';
                            this.settleOutcome({ winner: winnerSide, a, b });
                        }, 2000);
                    }, 1500);
                },
                
                settleOutcome: function({ winner, a, b }) {
                    const userWon = (this.state.selectedSide === winner);
                    const bet = this.state.currentBetAmount;
                    
                    if (winner === 'left') playSound('dvt-left-win-sound');
                    else playSound('dvt-right-win-sound');
                    
                    if (userWon) {
                        const grossGain = Math.round(bet * this.state.payoutMultiplier);
                        const netGain = grossGain - bet;
                        this.state.balance += netGain;
                        this.elements.messageEl.innerHTML = `YOU WIN! +${netGain.toLocaleString()} coins. (E=${a} M=${b})`;
                        this.elements.messageEl.className = 'result win';
                    } else {
                        this.state.balance -= bet;
                        this.elements.messageEl.innerHTML = `YOU LOSE! -${bet.toLocaleString()} coins. (E=${a} M=${b})`;
                        this.elements.messageEl.className = 'result lose';
                    }

                    state.score = this.state.balance;
                    saveGame({ score: state.score });
                    this.updateBalanceDisplay();
                    this.resetUI();
                    
                    const flashEl = winner === 'left' ? this.elements.leftSide : this.elements.rightSide;
                    flashEl.animate([{ boxShadow: '0 20px 60px rgba(0,0,0,0)' }, { boxShadow: '0 30px 80px rgba(255,255,255,0.06)' }], { duration: 600, fill: 'forwards' });
                    
                    if (this.state.balance <= 0) {
                        this.elements.messageEl.textContent = 'Balance khatam ho gaya!';
                        this.elements.messageEl.className = 'result lose';
                    }
                    
                    setTimeout(() => {
                        this.elements.leftNum.textContent = '-';
                        this.elements.rightNum.textContent = '-';
                        this.elements.leftSide.classList.remove('selected');
                        this.elements.rightSide.classList.remove('selected');
                        this.updateBetDisplay();
                    }, 1500);
                },
                
                randInt: function(min, max) {
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                }
            };
            
            async function loadDailyTaskData() {
                // Keep minimal loading if settings are hardcoded
                try {
                    const settingsSnap = await database.ref('dailyTaskSettings').once('value');
                    // if (settingsSnap.exists()) dailyTaskSettings = { ...dailyTaskSettings, ...settingsSnap.val() };
                } catch (error) {
                    console.error("Failed to load daily task settings from Firebase:", error);
                }
            }

            // ===== REPLACED RENDER FUNCTION FOR DAILY TASKS =====
            function renderNewDailyTasksScreen() {
                elements.dtCoinBalance.textContent = state.score.toLocaleString();
                elements.dtDiamondBalance.textContent = state.diamonds.toLocaleString();
                
                const taskData = state.dailyTaskProgress || { adsWatched: 0, lastCompletionTime: 0 };
                
                // Cooldown Check
                const now = Date.now();
                const msPassed = now - (taskData.lastCompletionTime || 0);
                const msCooldown = dailyTaskSettings.cooldownHours * 60 * 60 * 1000;
                const isCooldownActive = msPassed < msCooldown;

                elements.dailyTaskListContainer.innerHTML = ""; 

                const card = document.createElement("div");
                card.className = "dt-card";
                
                card.style.flexDirection = "column";
                card.style.padding = "20px";
                card.style.alignItems = "center";
                card.style.gap = "15px";
                card.style.background = "linear-gradient(135deg, #2c3e50, #000)";
                card.style.border = "1px solid #f39c12";

                if (isCooldownActive) {
                    const timeLeft = msCooldown - msPassed;
                    const h = Math.floor(timeLeft / (1000 * 60 * 60));
                    const m = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    card.innerHTML = `
                        <div style="font-size: 40px;"></div>
                        <h3 style="margin:0; color:#e74c3c;">Cooldown Active</h3>
                        <p style="color:#aaa;">Please wait before watching more ads.</p>
                        <div style="font-size: 24px; font-weight:bold; color:#fff;">
                            ${h}h ${m}m ${s}s
                        </div>
                    `;
                    
                    if(!window.dailyTaskTimerInterval) {
                        window.dailyTaskTimerInterval = setInterval(() => {
                            if(!document.getElementById('daily-tasks-screen').classList.contains('hidden')) {
                                renderNewDailyTasksScreen();
                            } else {
                                clearInterval(window.dailyTaskTimerInterval);
                                window.dailyTaskTimerInterval = null;
                            }
                        }, 1000);
                    }

                } else {
                    const adsDone = taskData.adsWatched || 0;
                    const target = dailyTaskSettings.adsTarget;
                    const progressPercent = (adsDone / target) * 100;

                    card.innerHTML = `
                        <div style="font-size: 40px;"></div>
                        <h3 style="margin:0; color:#f1c40f;">Daily Ad Challenge</h3>
                        <p style="text-align:center; color:#ddd;">
                            Watch <strong>${target} Ads</strong> to get <br>
                            <span style="font-size:18px; color:#2ecc71; font-weight:bold;">${dailyTaskSettings.rewardCoins} Coins</span>
                        </p>
                        
                        <div style="width:100%; background:#444; height:20px; border-radius:10px; overflow:hidden; margin: 10px 0;">
                            <div style="width:${progressPercent}%; height:100%; background:linear-gradient(90deg, #f1c40f, #e67e22); transition: width 0.3s;"></div>
                        </div>
                        <p style="margin:0; font-weight:bold;">Progress: ${adsDone} / ${target}</p>

                        <button id="start-daily-ad-btn" class="action-button" style="margin-top:10px; width:100%; background:#3498db;">
                            ${adsDone === 0 ? "Start Watching" : "Watch Next Ad"} 
                        </button>
                    `;
                }

                elements.dailyTaskListContainer.appendChild(card);

                const btn = document.getElementById('start-daily-ad-btn');
                if(btn) {
                    btn.addEventListener('click', handleDailyAdWatch);
                }
            }
            
            // ===== NEW HANDLER FOR SINGLE DAILY TASK =====
            async function handleDailyAdWatch() {
                const btn = document.getElementById('start-daily-ad-btn');
                if(btn) btn.disabled = true;

                if (typeof show_9966888 === "function") {
                    show_9966888().then(() => {
                         processAdSuccess();
                    }).catch(err => {
                        console.log("Ad script promise error", err);
                        processAdSuccess(); // Fallback
                    });
                } else {
                    alert("Ad Script not loaded yet. Please wait or refresh.");
                    if(btn) btn.disabled = false;
                }
            }

            async function processAdSuccess() {
                const btn = document.getElementById('start-daily-ad-btn');
                let countdown = dailyTaskSettings.minWatchSeconds;
                if(btn) btn.innerText = `Please wait ${countdown}s...`;
                
                const interval = setInterval(() => {
                    countdown--;
                    if(btn) btn.innerText = `Please wait ${countdown}s...`;
                    
                    if (countdown <= 0) {
                        clearInterval(interval);
                        
                        let taskData = state.dailyTaskProgress || { adsWatched: 0, lastCompletionTime: 0 };
                        taskData.adsWatched = (taskData.adsWatched || 0) + 1;

                        if (taskData.adsWatched >= dailyTaskSettings.adsTarget) {
                            state.score += dailyTaskSettings.rewardCoins;
                            playSound('coin-sound');
                            
                            taskData.adsWatched = 0;
                            taskData.lastCompletionTime = Date.now();
                            
                            alert(` Congratulations! You watched 20 ads and earned ${dailyTaskSettings.rewardCoins} Coins! Cooldown started.`);
                        } else {
                            alert(` Ad Watched! Progress: ${taskData.adsWatched}/${dailyTaskSettings.adsTarget}`);
                        }

                        state.dailyTaskProgress = taskData;
                        saveGame({ 
                            score: state.score, 
                            dailyTaskProgress: state.dailyTaskProgress 
                        });

                        updateDisplay();
                        renderNewDailyTasksScreen();
                    }
                }, 1000);
            }

            function startDailyTaskRefreshTimer() {
                // Legacy support - not strictly needed with new cooldown logic but kept for safety
                const REFRESH_INTERVAL = 9 * 60 * 60 * 1000;
                let lastRefresh = localStorage.getItem("dailyTaskLastRefresh");
                const now = Date.now();

                if (!lastRefresh || now - lastRefresh > REFRESH_INTERVAL) {
                    localStorage.setItem("dailyTaskLastRefresh", now);
                }
                
                const nextRefreshTime = parseInt(localStorage.getItem("dailyTaskLastRefresh")) + REFRESH_INTERVAL;

                setInterval(() => {
                    const left = nextRefreshTime - Date.now();
                    const hrs = Math.floor(left / (1000 * 60 * 60));
                    const mins = Math.floor((left % (1000 * 60 * 60)) / (1000 * 60));
                    const secs = Math.floor((left % (1000 * 60)) / 1000);
                    elements.dtRefreshTimer.textContent = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }, 1000);
            }

            async function checkClaimStatus() {
                const claimContainer = elements.claimButtonContainer;
                const redeemedMsg = elements.redeemedMessage;

                const claimCode = claimSettings.claim1 ? claimSettings.claim1.code : null;
                if (!claimCode) return;
                
                const snapshot = await database.ref(`Users/${userId}/redeemedGiftCodes`).once('value');
                const userRedemptions = snapshot.val() || {};
                
                if (userRedemptions[claimCode]) {
                    claimContainer.style.display = 'none';
                    redeemedMsg.style.display = 'block';
                } else {
                    claimContainer.style.display = 'block';
                    redeemedMsg.style.display = 'none';
                }
            }

            function loadClaimSettings() {
                database.ref('claim_settings').once('value', (snapshot) => {
                    claimSettings = snapshot.val() || {};
                    checkClaimStatus();
                });
            }

            async function redeemCode() {
                let code = elements.giftCodeInput.value.trim().toUpperCase();
                if (code === "") {
                    alert("Please enter a gift code!"); return;
                }
                
                try {
                    let codeData = null;
                    const setting1 = claimSettings[`claim1`];
                    if (setting1 && setting1.code === code) {
                        codeData = setting1;
                    }
                    if (!codeData && claimSettings.common && claimSettings.common.code === code) {
                        codeData = claimSettings.common;
                    }
                    if (!codeData) {
                        alert("Invalid Gift Code! Please enter a correct code."); return;
                    }
                    
                    const snapshot = await database.ref(`Users/${userId}/redeemedGiftCodes`).once('value');
                    const userRedemptions = snapshot.val() || {};
                    
                    if (userRedemptions[code]) {
                        alert("You have already redeemed this code."); return;
                    }

                    const coinsAwarded = parseInt(codeData.coins, 10);
                    state.score += coinsAwarded;
                    playSound('coin-sound');
                    userRedemptions[code] = true;
                    
                    saveGame({ score: state.score, redeemedGiftCodes: userRedemptions });
                    updateDisplay();
                    
                    alert(`Code '${code}' successfully redeemed!  You won ${coinsAwarded} coins!`);
                    
                    elements.giftCodeInput.value = "";
                    if (code === setting1?.code) {
                        checkClaimStatus();
                    }
                } catch (error) {
                    console.error("Redemption Error:", error);
                    alert("Redemption failed! Please try again later.");
                }
            }
            
            function claimCode(button, url) {
                if (!url || url === 'placeholder') {
                    alert("Admin has not set this claim link yet! Please wait.");
                    return;
                }
                lastClickedButton = button;
                window.open(url, '_blank');
            }

            elements.redeemGiftCodeBtn.addEventListener('click', redeemCode);
            elements.claimBtn1.addEventListener('click', () => {
                const setting = claimSettings['claim1'];
                if (setting && setting.url) {
                    claimCode(elements.claimBtn1, setting.url);
                } else {
                    claimCode(elements.claimBtn1, 'placeholder');
                }
            });
            
            function renderRewardsHubScreen() {
                if (state.telegramJoinedClaimed) {
                    elements.claimTelegramRewardBtn.disabled = true;
                    elements.claimTelegramRewardBtn.innerText = 'Claimed ';
                } else {
                    const joinClicked = sessionStorage.getItem('telegramJoinClicked');
                    elements.claimTelegramRewardBtn.disabled = !joinClicked;
                    elements.claimTelegramRewardBtn.innerText = 'Claim 99 ';
                }

                const today = new Date().toDateString();
                if (state.lastDailyBonusClaim === today) {
                    elements.claimDailyBonusBtn.disabled = true;
                    elements.claimDailyBonusBtn.innerText = 'Claimed Today ';
                } else {
                    elements.claimDailyBonusBtn.disabled = false;
                    elements.claimDailyBonusBtn.innerText = 'Claim 20 ';
                }
            }
            
            elements.rewardsHubButton.addEventListener('click', () => {
                const adUrl = 'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44';
                showAdFrame(adUrl, () => {
                    showScreen('rewards-hub-screen');
                });
            });
            
            elements.joinTelegramLink.addEventListener('click', () => {
                if (!state.telegramJoinedClaimed) {
                    elements.claimTelegramRewardBtn.disabled = false;
                    sessionStorage.setItem('telegramJoinClicked', 'true');
                }
            });

            elements.claimTelegramRewardBtn.addEventListener('click', () => {
                if (state.telegramJoinedClaimed) {
                    alert('You have already claimed this reward.');
                    return;
                }
                
                state.score += 99;
                playSound('coin-sound');
                state.telegramJoinedClaimed = true;
                
                saveGame({ score: state.score, Totalearning: state.score, telegramJoinedClaimed: true });
                updateDisplay();
                renderRewardsHubScreen();
                alert('Congratulations! You received 99 coins for joining the community!');
            });

            elements.claimDailyBonusBtn.addEventListener('click', () => {
                const today = new Date().toDateString();
                if (state.lastDailyBonusClaim === today) {
                    alert('You have already claimed your daily bonus. Come back tomorrow!');
                    return;
                }

                state.score += 20;
                playSound('coin-sound');
                state.lastDailyBonusClaim = today;

                saveGame({ score: state.score, Totalearning: state.score, lastDailyBonusClaim: today });
                updateDisplay();
                renderRewardsHubScreen();
                alert('You have claimed your daily bonus of 20 coins!');
            });

            function loadAndDisplayTournaments() {
                const tournamentsRef = database.ref('tournaments');
                elements.tournamentListContainer.innerHTML = ''; 

                tournamentsRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const initialTournamentData = childSnapshot.val();
                            const tournamentId = childSnapshot.key;
                            
                            if (initialTournamentData.isActive) {
                                const card = document.createElement('div');
                                card.className = 'tournament-card';
                                card.id = `tournament-card-${tournamentId}`;
                                
                                const entryFeeText = initialTournamentData.entryFee > 0 ? `${initialTournamentData.entryFee.toLocaleString()} ` : 'Free';
                                const defaultLogoUrl = 'https://dummyimage.com/60x60/2c3e50/ffffff&text=Logo';
                                const finalImageUrl = initialTournamentData.imageUrl || defaultLogoUrl;
                                const dateInfo = initialTournamentData.date || 'TBA';
                                const timeInfo = initialTournamentData.time ? new Date(`1970-01-01T${initialTournamentData.time}`).toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';

                                card.innerHTML = `
                                    <div class="tournament-card-header">
                                        <img src="${finalImageUrl}" alt="Game Logo" class="tournament-card-logo" onerror="this.onerror=null; this.src='${defaultLogoUrl}';">
                                        <div class="tournament-card-title">
                                            <h3>${initialTournamentData.title || 'Untitled Tournament'}</h3>
                                            <p>${initialTournamentData.game || 'Special Event'}</p>
                                        </div>
                                    </div>
                                    <p><strong>Prize Pool:</strong> ${initialTournamentData.prizePool || 'TBA'}</p>
                                    <p><strong>Entry Fee:</strong> ${entryFeeText}</p>
                                    <p><strong>Date & Time:</strong> ${dateInfo} at ${timeInfo}</p>
                                    <p><strong>Rules:</strong> ${initialTournamentData.rules || 'Follow standard rules.'}</p>
                                    
                                    <div id="room-info-${tournamentId}" class="room-info-container" style="display: none;"></div>

                                    <div id="participants-${tournamentId}" class="participant-display-container"></div>
                                    <div id="prize-status-${tournamentId}"></div> 

                                    <button class="join-button"
                                        id="join-button-${tournamentId}"
                                        data-id="${tournamentId}"
                                        data-title="${initialTournamentData.title || 'Tournament'}"
                                        data-fee="${initialTournamentData.entryFee || 0}"
                                        data-link="${initialTournamentData.joinLink || '#'}"
                                        data-image="${initialTournamentData.imageUrl || ''}">
                                        Join Now
                                    </button>
                                `;
                                
                                elements.tournamentListContainer.appendChild(card);

                                const singleTournamentRef = database.ref(`tournaments/${tournamentId}`);
                                singleTournamentRef.on('value', tournamentSnapshot => {
                                    const tournamentData = tournamentSnapshot.val();
                                    if (!tournamentData) return;

                                    const currentCard = document.getElementById(`tournament-card-${tournamentId}`);
                                    const joinButton = document.getElementById(`join-button-${tournamentId}`);
                                    const roomInfoContainer = document.getElementById(`room-info-${tournamentId}`);
                                    const participantsContainer = document.getElementById(`participants-${tournamentId}`);
                                    const prizeStatusContainer = document.getElementById(`prize-status-${tournamentId}`);
                                    if (!currentCard || !joinButton || !roomInfoContainer || !participantsContainer) return;
                                    
                                    let isFinished = false;
                                    if (tournamentData.winningTeam || (tournamentData.participants && Object.values(tournamentData.participants).some(p => p.isWinner))) {
                                        isFinished = true;
                                    }

                                    const hasJoined = state.joinedTournaments && state.joinedTournaments[tournamentId];

                                    if (isFinished) {
                                        joinButton.innerText = 'Tournament Finished';
                                        joinButton.disabled = true;
                                        currentCard.classList.add('finished');
                                        roomInfoContainer.style.display = 'none';
                                    } else {
                                        currentCard.classList.remove('finished');
                                        joinButton.innerText = hasJoined ? 'Joined! Good Luck!' : 'Join Now';
                                        joinButton.disabled = hasJoined;

                                        if (hasJoined) {
                                            const roomId = tournamentData.roomId || 'TBA';
                                            const roomPass = tournamentData.roomPassword || 'TBA';
                                            roomInfoContainer.innerHTML = `
                                                <h4>Room Credentials</h4>
                                                <p><strong>Room ID:</strong> ${roomId}</p>
                                                <p><strong>Password:</strong> ${roomPass}</p>
                                            `;
                                            roomInfoContainer.style.display = 'block';
                                        } else {
                                            roomInfoContainer.style.display = 'none';
                                        }
                                    }
                                    
                                    if (tournamentData.prizeAwarded) {
                                        prizeStatusContainer.innerHTML = `<div class="prize-distributed-message"> Prize Distributed! </div>`;
                                    } else {
                                        prizeStatusContainer.innerHTML = '';
                                    }
                                    
                                    const participants = tournamentData.participants || {};
                                    const participantEntries = Object.entries(participants);

                                    if (participantEntries.length > 0) {
                                        if (tournamentData.minPlayers === 4) {
                                            const winningTeam = tournamentData.winningTeam || null;
                                            const team1 = participantEntries.filter((e, i) => i % 2 === 0);
                                            const team2 = participantEntries.filter((e, i) => i % 2 !== 0);
                                            const team1Html = team1.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            const team2Html = team2.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            participantsContainer.innerHTML = `
                                                <ul class="team-list"><h4>Team A ${winningTeam === 1 ? '' : ''}</h4>${team1Html}</ul>
                                                <div class="vs-separator">VS</div>
                                                <ul class="team-list"><h4>Team B ${winningTeam === 2 ? '' : ''}</h4>${team2Html}</ul>`;
                                        } else {
                                            const participantHtml = participantEntries.map(([userId, playerData]) => {
                                                const winnerIcon = playerData.isWinner ? ' ' : '';
                                                const winnerClass = playerData.isWinner ? 'winner' : '';
                                                return `<li class="participant-item ${winnerClass}"><strong>${winnerIcon}${playerData.name}</strong></li>`;
                                            }).join('');
                                            participantsContainer.innerHTML = `<ul class="team-list" style="width:100%;">${participantHtml}</ul>`;
                                        }
                                        participantsContainer.style.display = 'flex';
                                    } else {
                                        participantsContainer.style.display = 'none';
                                    }
                                });
                            }
                        });
                    }
                }).catch(error => {
                    console.error("Error loading tournaments: ", error);
                    elements.tournamentListContainer.innerHTML += '<p style="text-align:center; color: red;">Could not load events. Please try again later.</p>';
                });
            }

            function initiateTournamentJoinProcess(details) {
                currentTournamentJoinProcess.details = details;
                currentTournamentJoinProcess.adsWatched = 0;
                elements.tournamentJoinPopupTitle.innerText = details.title;
                elements.tournamentJoinPopupImage.src = details.image || 'https://via.placeholder.com/80';
                elements.tournamentAdProgress.innerText = `0 / ${currentTournamentJoinProcess.adsRequired}`;
                elements.tournamentWatchAdBtn.disabled = false;
                elements.tournamentWatchAdBtn.innerText = 'Watch Ad';
                elements.tournamentAdView.style.display = 'block';
                elements.tournamentConfirmView.style.display = 'none';
                elements.tournamentJoinPopup.style.display = 'flex';
            }
            
            elements.tournamentListContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('join-button') && !e.target.disabled) {
                    const button = e.target;
                    const tournamentDetails = {
                        id: button.dataset.id,
                        title: button.dataset.title,
                        fee: button.dataset.fee,
                        link: button.dataset.link,
                        image: button.dataset.image
                    };
                    initiateTournamentJoinProcess(tournamentDetails);
                }
            });

            elements.tournamentWatchAdBtn.addEventListener('click', () => {
                const button = elements.tournamentWatchAdBtn;
                button.disabled = true;
                button.innerText = 'Loading Ad...';

                showAdFrame(currentTournamentJoinProcess.adUrl, () => {
                    button.disabled = false;
                    button.innerText = 'Watch Ad';
                    currentTournamentJoinProcess.adsWatched++;
                    elements.tournamentAdProgress.innerText = `${currentTournamentJoinProcess.adsWatched} / ${currentTournamentJoinProcess.adsRequired}`;
                    if (currentTournamentJoinProcess.adsWatched >= currentTournamentJoinProcess.adsRequired) {
                        elements.tournamentAdView.style.display = 'none';
                        const details = currentTournamentJoinProcess.details;
                        elements.tournamentJoinPopupFee.innerText = `${parseInt(details.fee).toLocaleString()} `;
                        elements.tournamentJoinNameInput.value = state.playerName;
                        elements.tournamentConfirmView.style.display = 'block';
                    }
                });
            });
            
            elements.tournamentJoinConfirmBtn.addEventListener('click', () => {
                const details = currentTournamentJoinProcess.details;
                const tournamentId = details.id;
                const entryFee = parseInt(details.fee, 10);
                const joinLink = details.link;
                const newName = elements.tournamentJoinNameInput.value.trim();
                if (!newName) {
                    alert('Please enter your name to join.'); return;
                }
                if (state.score < entryFee) {
                    alert(`Not enough coins! You need ${entryFee.toLocaleString()}  to join.`); return;
                }
                state.score -= entryFee;
                if (state.playerName !== newName) {
                    state.playerName = newName;
                }
                if (!state.joinedTournaments) state.joinedTournaments = {};
                state.joinedTournaments[tournamentId] = true;
                const dataToSave = {
                    score: state.score, Totalearning: state.score, Name: state.playerName, joinedTournaments: state.joinedTournaments
                };
                const participantData = {
                    name: newName, joinTime: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref(`tournaments/${tournamentId}/participants/${userId}`).set(participantData);
                saveGame(dataToSave);
                updatePlayerNameDisplay();
                updateDisplay();
                alert(`Successfully joined! Fee of ${entryFee.toLocaleString()}  has been paid. The event password will be shared on our Telegram channel. Redirecting you...`);
                elements.tournamentJoinPopup.style.display = 'none';
                if (joinLink && joinLink !== '#') {
                    window.open(joinLink, '_blank');
                }
            });

            function closeTournamentPopup() {
                elements.tournamentJoinPopup.style.display = 'none';
                currentTournamentJoinProcess.details = null;
            }

            elements.tournamentJoinCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentAdCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentJoinPopupClose.addEventListener('click', closeTournamentPopup);
            
            function loadAndDisplayOffers() {
                const offersRef = database.ref('promotions');
                elements.tasksOptionsContainer.innerHTML = '';
                offersRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const promo = childSnapshot.val();
                            if (promo.isActive) {
                                const card = document.createElement('div');
                                card.className = 'option-card clickable';
                                card.innerHTML = `<h3>${promo.title}</h3><p>${promo.text}</p>${promo.imageUrl ? `<img src="${promo.imageUrl}" alt="Offer Image">` : ''}`;
                                card.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (promo.action === 'watchAd') { triggerWatchAd(card); } 
                                    else if (promo.linkUrl && promo.linkUrl !== '#') { window.open(promo.linkUrl, '_blank'); }
                                });
                                elements.tasksOptionsContainer.appendChild(card);
                            }
                        });
                    } else {
                        elements.tasksOptionsContainer.innerHTML = '<p>No active offers right now. Check back later!</p>';
                    }
                });
            }
            function triggerWatchAd(cardElement) {
                if (isAdBoostActive) { alert("A boost is already active! Please wait."); return; }
                isAdBoostActive = true;
                const originalText = cardElement.querySelector('p').innerText;
                cardElement.style.pointerEvents = 'none';
                let countdown = 10;
                cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        isAdBoostActive = false;
                        cardElement.style.pointerEvents = 'auto';
                        cardElement.querySelector('p').innerText = originalText;
                        alert("Ad boost has ended!");
                    }
                }, 1000);
            }
            
            function showNotifications() {
                elements.notificationDot.classList.remove('visible');
                const list = elements.notificationList;
                list.innerHTML = '';

                if (state.messages.length === 0) {
                    list.innerHTML = '<p>No new messages.</p>';
                } else {
                    state.messages.forEach(msg => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.textContent = msg.text;
                        list.appendChild(item);
                    });
                }
                elements.notificationPopup.style.display = 'flex';
            }
            function closeAndClearNotifications() {
                elements.notificationPopup.style.display = 'none';
                if (state.messages.length > 0) {
                    const updates = {};
                    state.messages.forEach(msg => {
                        updates[`/Users/${userId}/messages/${msg.key}`] = null;
                    });
                    database.ref().update(updates);
                    state.messages = [];
                }
            }
            elements.notificationBell.addEventListener('click', showNotifications);
            elements.closeNotificationBtn.addEventListener('click', closeAndClearNotifications);

            function showScreen(screenId) {
                const mainNav = document.querySelector('.nav-container');
                const topBar = document.querySelector('.top-bar-container');
                const diamondDisplay = document.getElementById('diamond-display');
                const notificationBell = document.getElementById('notification-bell');
                
                if (screenId === 'offerwall-screen') {
                    mainNav.style.display = 'none';
                    topBar.style.display = 'none';
                    diamondDisplay.style.display = 'none';
                    notificationBell.style.display = 'none';
                } else {
                    mainNav.style.display = 'flex';
                    topBar.style.display = 'block';
                    diamondDisplay.style.display = 'flex';
                    notificationBell.style.display = 'flex';
                }

                if (miningCountdownInterval) {
                    clearInterval(miningCountdownInterval);
                    miningCountdownInterval = null;
                }
                if (dvtGame.elements.bgSound && !dvtGame.elements.bgSound.paused) {
                    dvtGame.elements.bgSound.pause();
                }

                elements.screens.forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

                logUserEvent('screen_view', { screen: screenId });
                
                const targetScreen = document.getElementById(screenId);
                if(targetScreen) {
                    targetScreen.classList.remove('hidden');
                } else {
                    document.getElementById('game-screen').classList.remove('hidden');
                    document.querySelector('.nav-button[data-screen="game-screen"]').classList.add('active');
                }
                
                const button = document.querySelector(`.nav-button[data-screen='${screenId}']`);
                if (button) button.classList.add('active');

                if (screenId === 'game-screen') { initMiningClockAndGalaxy(); renderMiningButton(); }
                else if (screenId === 'wallet-screen') { renderNewWalletScreen(); } 
                else if (screenId === 'offerwall-screen') { initializeOfferwallScreen(); } 
                else if (screenId === 'tasks-screen') { loadAndDisplayOffers(); } 
                else if (screenId === 'tournament-screen') { loadAndDisplayTournaments(); } 
                else if (screenId === 'rewards-hub-screen') { renderRewardsHubScreen(); }
                else if (screenId === 'dvt-game-screen') { dvtGame.init(state.score); }
                else if (screenId === 'diamond-screen') { renderDiamondScreen(); }
                else if (screenId === 'ads-screen') { renderAdsScreen(); }
                else if (screenId === 'gift-screen') { loadClaimSettings(); }
                else if (screenId === 'daily-tasks-screen') { renderNewDailyTasksScreen(); }
                else if (screenId === 'task-unlocker-screen') { initializeTaskUnlockerScreen(); }
                else if (screenId === 'referral-screen') { renderReferralScreen(); }
            }

            function listenForGameSettings() {
                const settingsRef = database.ref('gameSettings');
                settingsRef.on('value', (snapshot) => {
                    const settings = snapshot.val() || {};
                    gameSettings.withdrawalsLocked = settings.withdrawalsLocked === true;
                    gameSettings.withdrawalButtonText = settings.withdrawalButtonText || 'Withdraw All Coins';
                    gameSettings.isWithdrawalForceUnlocked = settings.isWithdrawalForceUnlocked === true;
                    gameSettings.coinValue = parseInt(settings.coinValue, 10) || 1000;
                    gameSettings.logoUrls = settings.logoUrls || { upi: '', usdt: '', coin: '' };
                    
                    // --- NEW: Apply Coin Logo if available ---
                    if (gameSettings.logoUrls.coin) {
                        const coinUrl = gameSettings.logoUrls.coin;
                        // Update Mining Clock
                        const miningCoin = document.querySelector('#game-screen .coin');
                        if(miningCoin) {
                            miningCoin.style.background = `url('${coinUrl}') no-repeat center center / cover`;
                            miningCoin.style.boxShadow = 'none'; // Remove standard glow if custom image
                        }
                        // Update DVT Game Coin Icon
                        const dvtCoinImg = document.querySelector('.dvt-game-screen-styles .coin img');
                        if(dvtCoinImg) dvtCoinImg.src = coinUrl;
                    }
                    
                    // --- NEW: Update USDT Rate Label Dynamically ---
                    const rateText = `${gameSettings.coinValue.toLocaleString()} Coins = 1 Unit`;
                    if(document.getElementById('wallet-rate-display')) {
                        document.getElementById('wallet-rate-display').textContent = rateText;
                    }

                    if (!elements.walletScreen.classList.contains('hidden')) {
                        renderNewWalletScreen();
                    }
                });
            }

            function loadGame() {
                handleIncomingReferral();
                listenForGameSettings();
                loadDailyTaskData();
                startDailyTaskRefreshTimer();

                const userRef = database.ref(`Users/${userId}`);
                
                const userTasksRef = database.ref('userTasks/' + userId);
                const processCompletedTask = (taskSnapshot) => {
                    const taskData = taskSnapshot.val();
                    if (taskData && taskData.status === 'completed' && !taskData.rewardClaimed) {
                        const taskId = taskData.taskId;
                        const taskRef = database.ref('appInstalls/' + taskId);
                        
                        taskRef.once('value').then(appInstallSnapshot => {
                            if (appInstallSnapshot.exists()) {
                                const appData = appInstallSnapshot.val();
                                const reward = parseInt(appData.reward, 10) || 0;

                                if (reward > 0) {
                                    const updates = {};
                                    updates[`/Users/${userId}/score`] = firebase.database.ServerValue.increment(reward);
                                    updates[`/Users/${userId}/Totalearning`] = firebase.database.ServerValue.increment(reward);
                                    updates[`/userTasks/${userId}/${taskSnapshot.key}/rewardClaimed`] = true;
                                    
                                    database.ref().update(updates).then(() => {
                                        const notificationText = ` Task '${appData.name}' completed! You earned ${reward} coins.`;
                                        alert(notificationText);
                                        database.ref(`Users/${userId}/messages`).push({ text: notificationText });
                                    });
                                }
                            }
                        });
                    }
                };
                userTasksRef.on('child_added', processCompletedTask);
                userTasksRef.on('child_changed', processCompletedTask);

                database.ref('withdrawalMethods').on('value', (snapshot) => {
                    withdrawalMethods = snapshot.val() || { upi: {}, usdt: {} };
                });

                logUserEvent('game_loaded');

                userRef.on('value', (snapshot) => {
                    let data = snapshot.val();
                    let isNewUser = !data;

                    if (isNewUser) {
                        const newCode = generateReferralCode();
                        const referrerCode = sessionStorage.getItem('referrerCode');
                        
                        data = {
                            score: referrerCode ? 400 : 0,
                            Totalearning: referrerCode ? 400 : 0,
                            Name: 'Player',
                            myReferralC: newCode,
                            referredBy: referrerCode || null,
                            creationTime: firebase.database.ServerValue.TIMESTAMP,
                            isWithdrawalLocked: false,
                            totalOnlineTime: 0,
                            diamonds: 0,
                            adsProgress: {},
                            dailyTaskProgress: {},
                            miningAdsWatched: 0,
                            isMiningActive: false,
                            miningStartTime: 0,
                            referralsMade: 0,
                            referralBonusEarned: 0,
                        };

                        if (referrerCode) {
                            creditReferrer(referrerCode);
                            sessionStorage.removeItem('referrerCode');
                            alert(`Welcome! You've received a 400 coin bonus for joining via a referral! `);
                        }
                        
                        userRef.set(data);
                        database.ref(`Referralcodes/${newCode}`).set({ Uid: userId });
                    }
                    
                    state.score = data.score || 0;
                    state.playerName = data.Name || 'Player';
                    state.myReferralC = data.myReferralC || null;
                    state.referredBy = data.referredBy || null;
                    state.isIndividuallyLocked = data.isWithdrawalLocked === true;
                    state.totalOnlineTime = data.totalOnlineTime || 0;
                    state.creationTime = data.creationTime || 0;
                    state.referralsMade = data.referralsMade || 0;
                    state.referralBonusEarned = data.referralBonusEarned || 0;
                    
                    state.withdrawalAdClicks = data.withdrawalAdClicks || 0;
                    
                    state.diamonds = data.diamonds || 0;
                    state.adsProgress = data.adsProgress || {};
                    state.dailyTaskProgress = data.dailyTaskProgress || {};

                    state.miningAdsWatched = data.miningAdsWatched || 0;
                    state.isMiningActive = data.isMiningActive || false;
                    state.miningStartTime = data.miningStartTime || 0;

                    updateDisplay();
                    updatePlayerNameDisplay();
                    
                    if (isNewUser) {
                        database.ref(`Users/${userId}/messages`).on('child_added', (msgSnapshot) => {
                            const msg = msgSnapshot.val();
                            if (msg) {
                                state.messages.push({ key: msgSnapshot.key, text: msg.text });
                                elements.notificationDot.classList.add('visible');
                            }
                        });
                    }
                });
            }

            function saveGame(dataToSave, fullSave = false) {
                if (!userId) return;
                const userRef = database.ref(`Users/${userId}`);
                if (fullSave) {
                    userRef.set({ ...state, lastSeen: firebase.database.ServerValue.TIMESTAMP });
                } 
                else if (dataToSave) {
                    userRef.update(dataToSave);
                }
            }
            function updateDisplay() {
                elements.diamondCount.textContent = state.diamonds.toLocaleString();

                if (!elements.walletScreen.classList.contains('hidden')) {
                    renderNewWalletScreen();
                }
            }
            function updatePlayerNameDisplay() { elements.playerNameDisplay.innerText = state.playerName; }
            
            elements.navButtons.forEach(b => { if(b.dataset.screen){ b.addEventListener('click', () => showScreen(b.dataset.screen)) } });
            document.querySelectorAll('.back-button, .ws-back').forEach(b => b.addEventListener('click', () => showScreen(b.dataset.screen)));
            elements.profileSection.addEventListener('click', () => { elements.newNameInput.value = state.playerName; elements.nameChangePopup.style.display = 'flex'; });
            elements.confirmNameButton.addEventListener('click', () => { const newName = elements.newNameInput.value.trim(); if (newName && newName !== "") { state.playerName = newName; updatePlayerNameDisplay(); saveGame({ Name: newName }); elements.nameChangePopup.style.display = 'none'; } else { alert("Name cannot be empty!"); } });
            elements.cancelNameButton.addEventListener('click', () => elements.nameChangePopup.style.display = 'none');
            
            function renderNewWalletScreen() {
                const MIN_WITHDRAWAL_COINS = 10000;
                const withdrawBtn = document.getElementById('wallet-open-options-btn'); // Target the actual withdraw button, not the nav button

                elements.walletPlayerName.textContent = ' ' + state.playerName;
                elements.walletBalance.textContent = state.score.toLocaleString();
                
                // --- NEW: Calculate Value based on Coin Value from Admin ---
                const coinVal = gameSettings.coinValue || 1000;
                elements.walletUsdValue.textContent = "Value: $" + (state.score / coinVal).toFixed(2) + " USD";
                
                if (state.score < MIN_WITHDRAWAL_COINS) {
                    withdrawBtn.disabled = true;
                    withdrawBtn.textContent = `Need ${MIN_WITHDRAWAL_COINS.toLocaleString()} Coins`;
                } else {
                    withdrawBtn.disabled = false;
                    withdrawBtn.textContent = 'Withdraw';
                }

                renderFirebaseHistory();
            }

            function renderFirebaseHistory() {
                const historyDiv = elements.walletHistory;
                historyDiv.innerHTML = "<h3>Withdrawal History</h3>";
                const historyRef = database.ref(`withdrawals/${userId}`).limitToLast(10);
                
                historyRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        historyDiv.innerHTML += '<p style="text-align:center; font-size: 14px; opacity: 0.7;">No withdrawal history found.</p>';
                        return;
                    }

                    const historyData = [];
                    snapshot.forEach((child) => { historyData.push(child.val()); });
                    
                    historyData.reverse().forEach(item => {
                        let detailsHtml = '';
                        if (item.type === 'UPI') {
                            detailsHtml = `<small>To: ${item.name} (${item.upiId})</small>`;
                        } else if (item.type === 'USDT') {
                            detailsHtml = `<small>To: ${item.wallet} [${item.network.toUpperCase()}]</small>`;
                        }

                        const historyItemHtml = `
                            <div class="ws-history-item">
                                <div>
                                    <div class="amount">${item.coins.toLocaleString()} Coins</div>
                                    ${detailsHtml}
                                </div>
                                <div class="status">${item.status} ${item.status === 'Processing' ? '' : ''}</div>
                            </div>`;
                        historyDiv.innerHTML += historyItemHtml;
                    });
                });
            }
            
            function closeAllWalletModals() {
                document.querySelectorAll(".ws-modal").forEach(m => m.style.display="none");
            }
            
            // **MODIFIED WITHDRAWAL BUTTON LOGIC**
            // Removed Task Unlocker Check. Direct withdrawal allowed.
            elements.walletOpenOptionsBtn.addEventListener('click', () => {
                if (elements.walletOpenOptionsBtn.disabled) return;
                
                elements.walletUpiLogo.src = gameSettings.logoUrls.upi || '';
                elements.walletUsdtLogo.src = gameSettings.logoUrls.usdt || '';
                closeAllWalletModals();
                elements.walletOptionModal.style.display = "flex";
            });
            
            elements.walletOpenUpiBtn.addEventListener('click', () => { closeAllWalletModals(); elements.walletUpiModal.style.display="flex"; });
            elements.walletOpenUsdtBtn.addEventListener('click', () => { closeAllWalletModals(); elements.walletUsdtModal.style.display="flex"; });
            
            document.querySelectorAll('.ws-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeAllWalletModals();
                });
            });
            
            elements.walletUsdtCoins.addEventListener("input", () => {
                let coins = parseInt(elements.walletUsdtCoins.value) || 0;
                // --- NEW: Calculate based on Admin Value ---
                let usdt = (coins / gameSettings.coinValue).toFixed(2); 
                elements.walletUsdtReceive.textContent = usdt + " USDT";
            });

            elements.walletSubmitUpiBtn.addEventListener('click', () => {
                const WITHDRAWAL_AD_URL = "https://www.revenuecpmgate.com/xp7wir795b?key=321c1fdd321363063478cea5854d4832";
                const UPI_DIAMOND_COST = 2000;
                
                let name = elements.walletUpiName.value.trim();
                let upiId = elements.walletUpiId.value.trim();
                let coins = parseInt(elements.walletUpiCoins.value) || 0;
                
                if(!name || !upiId){ alert("Please enter Name and UPI ID!"); return; }
                if(coins < 10000){ alert("Minimum withdrawal is 10,000 coins!"); return; }
                if(coins > state.score){ alert("Insufficient coin balance!"); return; }
                if(state.diamonds < UPI_DIAMOND_COST){ alert(`Insufficient diamonds  you need ${UPI_DIAMOND_COST} diamonds to withdraw.`); return; }

                showAdFrame(WITHDRAWAL_AD_URL, () => {
                    const withdrawalData = {
                        type: 'UPI', name, upiId, coins,
                        date: new Date().toLocaleString(), status: 'Processing'
                    };
                    
                    database.ref(`withdrawals/${userId}`).push(withdrawalData);
                    state.score -= coins;
                    state.diamonds -= UPI_DIAMOND_COST;
                    saveGame({ score: state.score, diamonds: state.diamonds });
                    
                    alert(`Withdrawal request for ${coins.toLocaleString()} coins submitted successfully!`);
                    closeAllWalletModals();
                    renderNewWalletScreen();
                }, { duration: 20 });
            });

            elements.walletSubmitUsdtBtn.addEventListener('click', () => {
                const WITHDRAWAL_AD_URL = "https://www.revenuecpmgate.com/xp7wir795b?key=321c1fdd321363063478cea5854d4832";
                const USDT_DIAMOND_COST = 1000;

                let network = elements.walletUsdtNetwork.value;
                let wallet = elements.walletUsdtAddress.value.trim();
                let coins = parseInt(elements.walletUsdtCoins.value) || 0;
                
                if(!network){ alert("Please select a network!"); return; }
                if(!wallet){ alert("Please enter wallet address!"); return; }
                if(coins < 10000){ alert("Minimum withdrawal is 10,000 coins!"); return; }
                if(coins > state.score){ alert("Insufficient coin balance!"); return; }
                if(state.diamonds < USDT_DIAMOND_COST){ alert(`Insufficient diamonds  you need ${USDT_DIAMOND_COST} diamonds to withdraw.`); return; }

                showAdFrame(WITHDRAWAL_AD_URL, () => {
                    // --- NEW: Calculate based on Admin Value ---
                    const withdrawalData = {
                        type: 'USDT', network, wallet, coins,
                        usdtValue: (coins / gameSettings.coinValue).toFixed(2),
                        date: new Date().toLocaleString(), status: 'Processing'
                    };

                    database.ref(`withdrawals/${userId}`).push(withdrawalData);
                    state.score -= coins;
                    state.diamonds -= USDT_DIAMOND_COST;
                    saveGame({ score: state.score, diamonds: state.diamonds });

                    alert(`Withdrawal request for ${coins.toLocaleString()} coins submitted successfully!`);
                    closeAllWalletModals();
                    renderNewWalletScreen();
                }, { duration: 20 });
            });
            
            const movableAdUrls = [
                'https://www.revenuecpmgate.com/cm8gq6fq3e?key=6fef6bfc0bafc112d36c552fc6edfee4',
                'https://www.revenuecpmgate.com/xzdqc1h54f?key=074a291a6c883adbfdf54b6d73248800',
                'https://www.revenuecpmgate.com/xp7wir795b?key=321c1fdd321363063478cea5854d4832',
                'https://www.revenuecpmgate.com/k9e2z21k?key=3f3e76aef6f9137260e3e14fc78ed8a3',
                'https://www.revenuecpmgate.com/cm8gq6fq3e?key=6fef6bfc0bafc112d36c552fc6edfee4',
            ];
            let currentMovableAdIndex = 0;

            function cycleMovableAd() {
                const adIframe = document.getElementById('movable-ad-iframe');
                if (adIframe) {
                    adIframe.src = movableAdUrls[currentMovableAdIndex];
                    currentMovableAdIndex = (currentMovableAdIndex + 1) % movableAdUrls.length;
                }
            }

            function makeAdDraggable() {
                const adContainer = document.getElementById('movable-ad-container');
                const adHeader = document.getElementById('movable-ad-header');
                if (!adContainer || !adHeader) return;

                let isDragging = false;
                let offsetX, offsetY;

                const startDrag = (e) => {
                    isDragging = true;
                    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    offsetX = clientX - adContainer.getBoundingClientRect().left;
                    offsetY = clientY - adContainer.getBoundingClientRect().top;
                    adContainer.style.cursor = 'grabbing';
                    document.body.style.userSelect = 'none';
                };

                const onDrag = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    let newX = clientX - offsetX;
                    let newY = clientY - offsetY;
                    const maxX = window.innerWidth - adContainer.offsetWidth;
                    const maxY = window.innerHeight - adContainer.offsetHeight;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    adContainer.style.left = `${newX}px`;
                    adContainer.style.top = `${newY}px`;
                    adContainer.style.bottom = 'auto';
                    adContainer.style.right = 'auto';
                };

                const stopDrag = () => {
                    isDragging = false;
                    adContainer.style.cursor = 'move';
                    document.body.style.userSelect = '';
                };

                adHeader.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                adHeader.addEventListener('touchstart', startDrag, { passive: true });
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }
            
            function renderAdsScreen() {
                const adsList = elements.adsList;
                adsList.innerHTML = 'Loading ad slots...';
                
                database.ref('adsSlots').once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        adsList.innerHTML = 'No ad slots available right now.';
                        return;
                    }
                    adsList.innerHTML = '';
                    const adsData = snapshot.val();

                    adsData.forEach((slot, index) => {
                        if (!slot || !slot.adsLinks || slot.adsLinks.length === 0) return;

                        let userProgress = state.adsProgress[index] || { count: 0, currentAd: 0 };

                        const frame = document.createElement("div");
                        frame.className = "ads-frame";

                        frame.innerHTML = `
                            <div class="text-content">
                                <p>${slot.coins}</p>
                                <p>${slot.diamonds}</p>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div class="ad-counter" id="counter-${index}">${userProgress.count}/${slot.totalAds}</div>
                                <button class="play-button" id="play-${index}">
                                    <div class="play-icon"></div>
                                </button>
                            </div>
                        `;
                        adsList.appendChild(frame);

                        const playButton = document.getElementById(`play-${index}`);

                        playButton.addEventListener("click", () => {
                            if (userProgress.count >= slot.totalAds) {
                                alert(" All ads watched for this slot!");
                                return;
                            }

                            const adUrl = slot.adsLinks[userProgress.currentAd];
                            userProgress.currentAd = (userProgress.currentAd + 1) % slot.adsLinks.length;
                            
                            showAdFrame(adUrl, () => {
                                userProgress.count++;
                                document.getElementById(`counter-${index}`).textContent = `${userProgress.count}/${slot.totalAds}`;

                                state.score += parseInt(slot.coins.split(' ')[0], 10) || 0;
                                state.diamonds += parseInt(slot.diamonds.split(' ')[0], 10) || 0;
                                playSound('coin-sound');
                                
                                state.adsProgress[index] = userProgress;
                                saveGame({
                                    score: state.score,
                                    diamonds: state.diamonds,
                                    adsProgress: state.adsProgress
                                });
                                updateDisplay();
                            }, { showOverlay: false }); 
                        });
                    });
                });
            }

            let referralScreenInitialized = false;
            function renderReferralScreen() {
                const screen = document.getElementById('referral-screen');
                const referralCodeEl = document.getElementById('referral-code');
                const bonusEarnedEl = document.getElementById('bonus-earned');
                const friendsReferredEl = document.getElementById('friends-referred');
                const copyBtn = document.getElementById('copy-btn');
                const referralListEl = document.getElementById('referral-list');
                const backBtn = screen.querySelector('.fa-arrow-left');

                referralCodeEl.innerText = state.myReferralC || 'Generating...';
                bonusEarnedEl.innerHTML = `<i class="fas fa-coins"></i> ${(state.referralBonusEarned || 0).toLocaleString()}`;
                friendsReferredEl.innerHTML = `<i class="fas fa-user-friends"></i>&nbsp;${(state.referralsMade || 0)}`;

                database.ref('pageContent').once('value').then(snapshot => {
                    const data = snapshot.val() || {};
                    document.getElementById('sticker-banner-text').innerText = data.stickerText || 'Par invite 400 coins';
                    document.getElementById('bonus-link-text').innerText = data.bonusLinkText || 'Have a Bonus code from your friend?';
                    document.getElementById('how-it-works-title').innerText = data.howItWorksTitle || 'How It Works';
                    document.getElementById('my-referrals-title').innerText = data.myReferralsTitle || 'My Referrals';
                    
                    const listElement = document.getElementById('how-it-works-list');
                    listElement.innerHTML = ''; 
                    listElement.innerHTML += `<li><span class="step-number">1</span> ${data.howItWorksStep1 || 'Share your referral link with friends.'}</li>`;
                    listElement.innerHTML += `<li><span class="step-number">2</span> ${data.howItWorksStep2 || 'You both get a bonus of 400 coins!'}</li>`;
                });
                
                referralListEl.innerHTML = '<p style="text-align: center; color: #a0a0a0;">Loading referrals...</p>';
                if (state.myReferralC) {
                    database.ref('Users').orderByChild('referredBy').equalTo(state.myReferralC).once('value', (snapshot) => {
                        referralListEl.innerHTML = '';
                        if (snapshot.exists()) {
                            snapshot.forEach(childSnapshot => {
                                const referredUser = childSnapshot.val();
                                const item = document.createElement('div');
                                item.className = 'referral-item';
                                item.innerHTML = `<div class="user-details"><i class="fas fa-user-check"></i><span>${referredUser.Name || 'A Friend'}</span></div><div class="status">Joined</div>`;
                                referralListEl.appendChild(item);
                            });
                        } else {
                            referralListEl.innerHTML = '<p style="text-align: center; color: #a0a0a0;">No referrals yet.</p>';
                        }
                    });
                } else {
                     referralListEl.innerHTML = '<p style="text-align: center; color: #a0a0a0;">Referral code not available.</p>';
                }

                if (!referralScreenInitialized) {
                    copyBtn.addEventListener('click', () => {
                        const referralCode = referralCodeEl.innerText;
                        if(referralCode && referralCode !== 'Loading...' && referralCode !== 'Generating...') {
                            const fullReferralLink = `${TELEGRAM_BOT_BASE_URL}?ref=${referralCode}`;
                            copyTextToClipboard(fullReferralLink, copyBtn);
                        }
                    });
                    
                    backBtn.addEventListener('click', () => showScreen('game-screen'));

                    const shareButtons = screen.querySelector('.share-buttons');
                    shareButtons.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.target.closest('.share-btn');
                        if (!target || !state.myReferralC) return;

                        const referralLink = `${TELEGRAM_BOT_BASE_URL}?ref=${state.myReferralC}`;
                        const text = `Join me on Tap-Tap Coin Game and get 400 bonus coins! Use my referral link: ${referralLink}`;
                        
                        let shareUrl;
                        if (target.classList.contains('whatsapp')) {
                            shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
                        } else if (target.classList.contains('telegram')) {
                            shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent('Join me on Tap-Tap Coin Game and get 400 bonus coins!')}`;
                        } else if (target.classList.contains('twitter')) {
                             shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                        }

                        if (shareUrl) {
                            window.open(shareUrl, '_blank');
                        } else {
                            if (navigator.share) {
                                navigator.share({
                                    title: 'Join Tap-Tap Coin Game!',
                                    text: `Join me on Tap-Tap Coin Game and get 400 bonus coins!`,
                                    url: referralLink,
                                }).catch(console.error);
                            } else {
                                alert('Sharing is not supported on your browser. Please copy the link manually.');
                            }
                        }
                    });

                    referralScreenInitialized = true;
                }
            }

            elements.miningButton.addEventListener('click', () => {
                showScreen('dvt-game-screen');
            });

            elements.referButton.addEventListener('click', () => {
                showScreen('referral-screen');
            });

            cycleMovableAd(); 
            setInterval(cycleMovableAd, 60000); 
            makeAdDraggable(); 

            loadGame();
            showScreen('game-screen');
            
            // Automatic Ads are now disabled as requested
            // startAutomaticAdTimer(); 

        });
    </script>

    
        
</body>
</html>
