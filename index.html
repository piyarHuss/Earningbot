<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="monetag" content="22d6e8efe3a929cb1e541a157eff8963">
    <script>(function(s){s.dataset.zone='9976989',s.src='https://forfrogadiertor.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tap-Tap Coin Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap');

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body{
            background-color:#1a1a2e;
            color:#fff;
            font-family:'Poppins',sans-serif;
            display:flex;
            justify-content:center;
            align-items:center;
            user-select:none;
            -webkit-user-select:none;
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease-out;
        }
        .loading-bear { font-size: 80px; animation: run-across 3s ease-in-out infinite; }
        .loading-text { margin-top: 20px; font-size: 24px; color: #fff; }
        #loading-progress-bar { width: 80%; max-width: 300px; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; margin-top: 30px; overflow: hidden; }
        #loading-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #4dff4d, #00b300); border-radius: 10px; animation: fill-progress 5s linear forwards; }
        @keyframes run-across {
            0% { transform: translateX(-100px) scaleX(1); } 49% { transform: translateX(100px) scaleX(1); }
            50% { transform: translateX(100px) scaleX(-1); } 99% { transform: translateX(-100px) scaleX(-1); }
            100% { transform: translateX(-100px) scaleX(1); }
        }
        @keyframes fill-progress { from { width: 0%; } to { width: 100%; } }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        
        .game-container{
            width:100%; 
            height:100%; 
            display:flex; 
            flex-direction:column; 
            position: relative; 
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e); 
            overflow: hidden;
        }
        
        .screen {
            flex-grow:1; 
            display:flex; 
            flex-direction:column; 
            justify-content: center; 
            align-items:center; 
            width:100%; 
            z-index: 2; 
            padding: 20px; 
            box-sizing: border-box; 
            position: relative; 
            overflow-y: auto;
            padding-bottom: 150px;
        }
        .screen.hidden{display:none}

        .scrollable-screen {
            justify-content: flex-start;
            padding-top: 30px;
        }

        .top-bar-container { position: absolute; top: 15px; left: 15px; z-index: 10; }
        .profile-section { display: flex; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 50px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: background-color 0.2s; }
        .profile-section:hover { background-color: rgba(0,0,0,0.5); }
        .profile-icon { font-size: 20px; }
        #player-name-display { font-size: 16px; font-weight: 600; }
        
        #notification-bell {
            position: absolute; top: 15px; right: 65px;
            z-index: 11; font-size: 28px; cursor: pointer;
            padding: 8px; background-color: rgba(0,0,0,0.3);
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        #notification-dot {
            position: absolute; top: 5px; right: 5px;
            width: 10px; height: 10px;
            background-color: red; border-radius: 50%;
            border: 2px solid #1a1a2e;
            display: none; 
        }
        #notification-dot.visible { display: block; }
        #notification-list { max-height: 250px; overflow-y: auto; text-align: left; width: 100%; }
        .notification-item { background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }

        #diamond-display {
            position: absolute; top: 15px; right: 15px;
            z-index: 11; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            background-color: rgba(0,0,0,0.3);
            padding: 6px 12px; border-radius: 50px;
            border: 1px solid rgba(0, 246, 255, 0.3);
        }
        #diamond-count {
            font-size: 16px;
            font-weight: 700;
            color: #00e0ff;
        }

        .coin-container { width: 220px; height: 220px; cursor: pointer; -webkit-tap-highlight-color: transparent; display: flex; justify-content: center; align-items: center; margin: 20px 0; perspective: 1000px; }
        #coin-css { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle at 65% 35%, #fffec8, #ffc700 60%, #e0ac00 100%); box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.4), 0 10px 20px rgba(0, 0, 0, 0.5); position: relative; border: 10px solid #c8a443; display: flex; justify-content: center; align-items: center; text-align: center; transition: transform 0.3s ease-out; transform-style: preserve-3d; pointer-events: none; }
        #coin-css::before { content: ''; position: absolute; width: 80%; height: 80%; border: 4px solid rgba(0,0,0,0.15); border-radius: 50%; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        #coin-css::after { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 40%; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0)); border-radius: 50% / 100%; transform: rotate(45deg); }
        .coin-text { font-size: 24px; font-weight: 700; color: #8B4513; text-shadow: 1px 1px 2px rgba(255,255,255,0.4); line-height: 1.2; z-index: 5; }
        .stats-container { text-align: center; margin-bottom: 15px; margin-top: 60px;}
        #score-display{font-size:48px; font-weight:700; margin: 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.5);}
        #level-display { font-size: 22px; margin-top: 0; color: #ffdd57; font-weight: 600; }
        
        .flipping { animation: tap-flip 0.4s ease-out; }
        @keyframes tap-flip {
            0% { transform: scale(1) rotateY(0deg); } 50% { transform: scale(0.9) rotateY(180deg); } 100% { transform: scale(1) rotateY(360deg); }
        }

        .energy-bar-container{width:90%;max-width: 400px; margin:0 auto;}
        #energy-text{font-size:20px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        .energy-bar-background{background-color:rgba(0,0,0,.3);border-radius:15px;height:20px;padding:4px}
        #energy-bar-fill{background:linear-gradient(90deg,#4dff4d,#00b300);height:100%;border-radius:10px;width:100%;transition:width .2s linear}
        .floating-text{position:absolute;font-size:24px;font-weight:700;color:#fff;pointer-events:none;animation:float-up 1s ease-out forwards; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        @keyframes float-up{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-80px)}}

        .nav-container{
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            display:flex;
            justify-content:space-around;
            background-color:rgba(0,0,0,.3);
            padding: 10px 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
            z-index: 100;
            backdrop-filter: blur(5px);
            box-sizing: border-box;
        }
        .nav-button{cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:5px;opacity:.8;transition:opacity .2s; flex: 1;}
        .nav-button:hover,.nav-button.active{opacity:1}
        .nav-icon{font-size:28px}
        .nav-text{font-size:14px}
        
        #offer-nav-button {
            border-radius: 12px;
            background-color: rgba(243, 156, 18, 0.2);
            animation: pulse-offer-button 2.5s infinite ease-in-out;
            transform-origin: center center;
        }
        @keyframes pulse-offer-button {
            0% { transform: scale(1); box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }
            50% { transform: scale(1.08); box-shadow: 0 0 20px rgba(243, 156, 18, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }
        }

        #rewards-hub-button, #mining-button, #daily-tasks-side-button {
            position: absolute;
            left: 20px;
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: pulse-boost 2s infinite;
        }
        #rewards-hub-button {
            top: 180px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
        }
        #mining-button {
            top: 130px;
            background: linear-gradient(45deg, #f39c12, #e67e22);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.5);
        }
        #daily-tasks-side-button {
            top: 230px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.5);
        }

        #rewards-hub-button:hover, #mining-button:hover, #daily-tasks-side-button:hover {
            transform: scale(1.1);
        }
         #rewards-hub-button:hover {
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.7);
        }
         #mining-button:hover {
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.7);
        }
        #daily-tasks-side-button:hover {
            box-shadow: 0 8px 25px rgba(255, 75, 43, 0.7);
        }

        @keyframes pulse-boost {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        h2, h3{font-size:32px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        h3 {font-size: 28px;}
        p{font-size:18px;margin:5px 0}
        .back-button{background-color:#4CAF50;color:#fff;border:none;padding:15px 30px;font-size:18px;border-radius:10px;cursor:pointer;font-family:'Poppins',sans-serif; margin-top: 20px;}
        .popup{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .popup-content{background-color:#2c3e50;padding:30px;border-radius:15px;text-align:center;width:90%;max-width:380px;position:relative}
        .popup-content h3{margin-top:0}
        .popup-close{position:absolute;top:10px;right:15px;font-size:30px;cursor:pointer}
        
        .options-container { display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 400px; }
        .option-card { background-color: rgba(0,0,0,0.2); border: 2px solid #8e44ad; padding: 20px; border-radius: 15px; text-align: center; cursor: default; transition: background-color 0.2s; }
        .option-card.clickable:hover { background-color: rgba(0,0,0,0.4); cursor: pointer; }
        .option-card h3 { margin: 0 0 10px 0; color: #9b59b6; }
        .option-card p { margin: 0 0 15px 0; font-size: 16px; }
        .option-card img { max-width: 60px; max-height: 60px; margin-top: 10px; border-radius: 8px;}
        .action-button { background-color: #9b59b6; color: white; border: none; padding: 10px 20px; font-size: 18px; border-radius: 10px; cursor: pointer; font-family: 'Poppins',sans-serif; transition: background-color 0.2s;}
        .action-button:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        
        #ad-scripts-container {
            position: fixed;
            bottom: 75px; 
            left: 0;
            width: 100%;
            z-index: 101; 
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent; 
            padding: 5px 0;
            pointer-events: all;
        }
        
        .tournament-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #f39c12;
            padding: 20px;
            border-radius: 15px;
            text-align: left;
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s;
        }
        .tournament-card.finished {
            opacity: 0.6;
            border-color: #7f8c8d;
        }

        .tournament-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .tournament-card-logo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            background-color: rgba(0,0,0,0.3);
        }
        .tournament-card-title h3 {
            margin: 0;
            color: #f1c40f;
            font-size: 22px;
        }
        .tournament-card-title p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        .tournament-card p {
            font-size: 16px;
            margin: 4px 0;
            line-height: 1.5;
        }
        .tournament-card p strong {
            color: #fff;
        }
        .join-button {
            background-color: #f39c12;
            color: white;
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.2s;
        }
        .join-button:hover:not(:disabled) {
            background-color: #e67e22;
        }
        .join-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #tournament-join-popup .popup-content {
            background-color: #34495e;
        }
        #tournament-join-popup-image {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            margin-bottom: 15px;
            object-fit: cover;
        }
        #tournament-join-popup-fee {
            color: #f1c40f;
            font-weight: bold;
        }
        .join-popup-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            gap: 15px;
        }

        .room-info-container {
            background-color: rgba(46, 204, 113, 0.1);
            border: 1px solid #2ecc71;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .room-info-container h4 {
            margin: 0 0 8px 0;
            color: #2ecc71;
            font-size: 16px;
        }
        .room-info-container p {
            margin: 3px 0;
            font-size: 15px;
        }

        .participant-display-container {
            display: none;
            justify-content: space-around;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid rgba(241, 196, 15, 0.3);
            gap: 5px;
        }
        .team-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            text-align: center;
            min-width: 0;
        }
        .team-list h4 {
            margin: 0 0 8px 0;
            color: #f39c12;
            font-size: 16px;
            text-transform: uppercase;
        }
        .participant-item {
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            background-color: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vs-separator {
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            padding: 0 5px;
            align-self: center;
        }
        
        .participant-item.winner strong {
            color: #f1c40f;
        }
        .prize-distributed-message {
            text-align: center;
            font-weight: bold;
            color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #27ae60;
        }
        
        .screen.tournament-bg {
            background: url('https://images.unsplash.com/photo-1581888224555-93d6a8f1b333?q=80&w=1932&auto=format&fit=crop') no-repeat center center/cover;
            position: relative;
            z-index: 1;
        }
        .screen.tournament-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(10, 10, 25, 0.7);
            z-index: -1;
        }
        
        #offer-wall-screen {
            background-color: #121212;
            justify-content: flex-start;
            padding-top: 30px;
            color: #ffffff;
        }
        .offer-wall-container {
            width: 95%;
            max-width: 500px;
            background-color: #1e1e2d;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            box-sizing: border-box;
        }
        .offer-wall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .offer-wall-item:last-child {
            border-bottom: none;
        }
        .offer-wall-item img {
            width: 55px;
            height: 55px;
            margin-right: 0;
            margin-bottom: 10px;
            flex-shrink: 0;
            border-radius: 12px;
        }
        .offer-wall-text {
            flex-grow: 1;
            text-align: center;
        }
        .offer-wall-text h3 {
            font-family: 'Poppins', sans-serif;
            margin: 0 0 2px 0;
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0;
            text-shadow: none;
        }
        .offer-wall-text p {
            margin: 0;
            font-size: 14px;
            color: #a0a0a0;
        }
        .offer-wall-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: 0;
        }
        .offer-wall-reward {
            font-size: 16px;
            font-weight: 700;
            color: #f39c12;
            background-color: rgba(243, 156, 18, 0.15);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid rgba(243, 156, 18, 0.5);
            white-space: nowrap;
        }
        .offer-wall-button {
            background-color: #9b59b6;
            color: #ffffff;
            border: none;
            padding: 8px 22px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .offer-wall-button:hover {
            background-color: #8e44ad;
            transform: translateY(-1px);
        }

        .reward-task-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .reward-task-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .reward-task-buttons .action-button,
        .reward-task-buttons .join-telegram-button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
        }
        .join-telegram-button {
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins',sans-serif;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }
        .join-telegram-button:hover {
            background-color: #0077b3;
        }

        .floating-ad-emoji {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            z-index: 50;
            user-select: none;
            -webkit-user-select: none;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            will-change: transform;
        }
        
        .offer-submission-prompt {
            width: 95%;
            max-width: 500px;
            background-color: rgba(155, 89, 182, 0.15);
            border: 1px solid #9b59b6;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .offer-submission-prompt p {
            font-size: 14px;
            color: #ddd;
            margin: 0 0 15px 0;
            line-height: 1.5;
        }
        .user-id-container {
            background-color: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .user-id-container strong {
            color: #f39c12;
            font-family: monospace;
        }
        .copy-id-btn {
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .copy-id-btn:hover {
            opacity: 1;
        }
        .send-screenshot-btn {
            display: inline-block;
            background-color: #0088cc;
            color: #ffffff;
            padding: 10px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        .send-screenshot-btn:hover {
            background-color: #0077b3;
        }

        #ad-frame-wrapper {
            position: fixed; inset: 0; display: grid; 
            grid-template-rows: 1fr;
            background:#0b0f13; color:#fff; z-index: 9999;
        }
        #ad-frame-wrapper .overlay {
            position: absolute; top:16px; right:16px; display:flex; align-items:center; gap:8px;
            background: rgba(0,0,0,.55); border:1px solid #334155; padding:8px 12px; border-radius: 999px;
            backdrop-filter: blur(4px);
            z-index: 10;
            pointer-events: none;
        }
        #ad-frame-wrapper .timer {
            font-variant-numeric: tabular-nums; font-weight: 700;
        }
        #ad-frame-wrapper .closeBtn {
            pointer-events: auto; appearance:none; border:1px solid #334155; background:#111827; color:#9ca3af;
            padding:6px 10px; border-radius: 999px; cursor:not-allowed; opacity:.6;
            transition: all .2s ease;
        }
        #ad-frame-wrapper .closeBtn.enabled {
            background:#16a34a; border-color:#16a34a; color:#fff; cursor:pointer; opacity:1;
        }
        #ad-frame-wrapper .stage { position: relative; height: 100%; }
        #ad-container {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; overflow: auto;
        }
        #ad-container iframe {
            width: 100%; height: 100%; border: none;
        }
        
        #movable-ad-container {
            position: fixed;
            bottom: 85px; 
            right: 10px;
            width: 300px;
            height: 70px;
            background-color: #1a1a2e;
            border: 2px solid #9b59b6;
            border-radius: 10px;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            touch-action: none; 
        }
        #movable-ad-header {
            background-color: #9b59b6;
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            text-align: center;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
            font-weight: bold;
            height: 20px;
            line-height: 20px;
        }
        #movable-ad-iframe {
            width: 100%;
            height: 50px; 
            border: none;
        }
        
        #wallet-screen .ws-container {
            max-width: 420px;
            margin: auto;
            padding: 15px;
            width: 100%;
        }
        #wallet-screen .ws-profile {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1a40;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        #wallet-screen .ws-profile .name {
            font-weight: bold;
            font-size: 18px;
        }
        #wallet-screen .ws-profile .balance {
            font-size: 22px;
            font-weight: bold;
            color: #ffd369;
        }
        #wallet-screen .ws-value {
            text-align: center;
            font-size: 16px;
            margin: 10px 0 20px 0;
        }
        #wallet-screen .ws-btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        #wallet-screen .ws-withdraw {
            background: #9d4edd;
            color: white;
        }
        #wallet-screen .ws-back {
            background: #6c63ff;
            color: white;
        }
        #wallet-screen .ws-history {
            margin-top: 20px;
            background: #1a1a40;
            border-radius: 12px;
            padding: 12px 15px;
            min-height: 100px;
        }
        #wallet-screen .ws-history h3 {
            margin: 0 0 10px;
            font-size: 18px;
            text-align: center;
            color: #00e0ff;
        }
        #wallet-screen .ws-history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        #wallet-screen .ws-history-item:last-child {
            border: none;
        }
        #wallet-screen .ws-history-item .amount {
            font-weight: bold;
            color: #ffd369;
        }
        #wallet-screen .ws-history-item .status {
            color: #00ff7f;
            font-size: 14px;
        }
        .ws-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .ws-card {
            background: #1a1c2b;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }
        .ws-card h2 {
            margin: 0 0 15px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #19c9e2;
        }
        .ws-rate {
            font-size: 12px;
            background: #0d3b4a;
            padding: 4px 10px;
            border-radius: 8px;
            color: #19c9e2;
            margin-left: 10px;
        }
        .ws-input-box {
            margin: 14px 0;
        }
        .ws-input-box label {
            font-size: 13px;
            margin-bottom: 6px;
            display: block;
            color: #c9c9c9;
        }
        .ws-input-box input,
        .ws-input-box select {
            width: 100%;
            padding: 14px;
            box-sizing: border-box;
            border-radius: 10px;
            border: 1px solid #2a2e45;
            background: #101223;
            color: #fff;
            font-size: 15px;
            outline: none;
        }
        .ws-note {
            font-size: 12px;
            color: #9c9c9c;
            margin-top: 5px;
        }
        .ws-receive-box {
            margin: 18px 0;
            padding: 12px 15px;
            background: #101223;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        .ws-receive-box span {
            color: #1ecb80;
            font-weight: 500;
        }
        .ws-withdraw-option-btn {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        .ws-withdrawal-logo {
            width: 28px; 
            height: 28px; 
            object-fit: contain;
            min-width: 28px; 
        }
        .ws-btn2 {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg,#1ecb80,#16a85f);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            transition: 0.3s;
            margin-top: 15px;
        }
        
        #mining-screen {
            background: #0d0d0d;
        }
        #mining-screen h2 { color: gold; padding-top: 15px; margin-bottom: 20px; font-size: 24px;}
        #mining-ad-area {
            background: #333;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            margin: 20px auto;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #age-gate p {
            font-size: 18px;
            color: #fff;
            margin: 0 0 15px 0;
        }
        #confirm-age-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        #next-ad-timer {
            font-size: 18px;
            font-weight: bold;
            color: #f39c12;
        }
        
        #ads-screen {
            background: #121212;
            padding-top: 20px;
        }
        #ads-screen h2 { font-size: 24px; color: #fff; }
        .ads-frame {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1f1f1f;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            width: 100%;
            max-width: 450px;
        }
        .text-content p { margin: 0; font-size: 1em; font-weight: 600; color: #fff; }
        .ad-counter {
            background: #333;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            color: #fff;
        }
        .play-button {
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .play-icon {
            width: 0; height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 12px solid white;
            margin-left: 3px;
        }

        #gift-screen {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
        }
        .gift-container {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
            color: #333;
        }
        .gift-container h2 {
            margin-bottom: 10px;
            color: #333;
        }
        .gift-container .sub-text {
            font-size: 14px;
            color: #444;
            margin-bottom: 5px;
        }
        .gift-container .highlight {
            font-size: 14px;
            color: #d32f2f;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .gift-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }
        .gift-container button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 10px;
        }
        .gift-container .redeem-btn {
            background: #6a11cb;
            color: white;
        }
        .gift-container .redeem-btn:hover {
            background: #5011a3;
        }
        .gift-container .claim-btn {
            background: #2575fc;
            color: white;
        }
        .gift-container .claim-btn:hover {
            background: #0b57d0;
        }
        .gift-container .note {
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }
        #claimButtonContainer {
            display: block;
        }
        .redeemed-message {
            display: none;
            padding: 12px;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }
        
        /* === NEW DAILY TASK STYLES === */
        #daily-tasks-screen {
            background: #0f0f10;
        }
        #daily-tasks-screen .dt-wrap { max-width: 420px; margin: 0 auto; width: 100%; }
        #daily-tasks-screen .dt-header { margin-bottom: 16px; }  
        #daily-tasks-screen .dt-title { font-size: 20px; font-weight: 700; color: #fff; text-align: center; }  
        #daily-tasks-screen .dt-wallet { display: flex; justify-content: space-between; background: #191919; padding: 12px; border-radius: 14px; margin-bottom: 16px; }  
        #daily-tasks-screen .dt-wallet div { font-size: 15px; font-weight: 600; color: #fff; }  
        #daily-tasks-screen .dt-list { display: flex; flex-direction: column; gap: 12px; }  
        #daily-tasks-screen .dt-card { display: flex; align-items: center; justify-content: space-between; background: #191919; border-radius: 14px; padding: 10px 14px; min-height: 60px; }  
        #daily-tasks-screen .dt-left { display: flex; align-items: center; gap: 10px; }  
        #daily-tasks-screen .dt-avatar { width: 42px; height: 42px; border-radius: 10px; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; font-size: 22px; }  
        #daily-tasks-screen .dt-meta { display: flex; flex-direction: column; }  
        #daily-tasks-screen .dt-name { font-size: 15px; font-weight: 600; color: #fff; }  
        #daily-tasks-screen .dt-desc { font-size: 12px; color: #aaa; }  
        #daily-tasks-screen .dt-task-right { display: flex; align-items: center; gap: 8px; }  
        #daily-tasks-screen .dt-counter { font-size: 14px; font-weight: 600; color: #fff; }  
        #daily-tasks-screen .dt-claim { background: #fff; color: #000; font-weight: 600; border: none; border-radius: 10px; padding: 6px 14px; cursor: pointer; font-size: 14px; }
        #daily-tasks-screen .dt-claim:disabled { background: #555; color: #999; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-bear">üêπ</div>
        <div class="loading-text">Loading Game...</div>
        <div id="loading-progress-bar">
            <div id="loading-progress-fill"></div>
        </div>
    </div>

    <div class="game-container">
        <div class="top-bar-container">
            <div id="profile-section" class="profile-section">
                <span class="profile-icon">üë§</span>
                <span id="player-name-display">Player</span> 
            </div>
        </div>
        <div id="diamond-display">
            <span>üíé</span>
            <span id="diamond-count">0</span>
        </div>
        <div id="notification-bell">
            üîî
            <span id="notification-dot"></span>
        </div>

        <div id="game-screen" class="screen">
            <div id="mining-button">‚õèÔ∏è</div>
            <div id="rewards-hub-button">üéÅ</div>
            <div id="daily-tasks-side-button">üî•</div>
            
            <div class="stats-container" style="margin-top: 60px;">
                <h1 id="score-display">0</h1>
                <div id="level-display">Level 1</div>
            </div>
            <div class="coin-container" id="coin-container">
                <div id="coin-css">
                    <div class="coin-text">TAP TO<br>EARN</div>
                </div>
            </div>
            <div class="energy-bar-container">
                <div id="energy-text">‚ö°Ô∏è 1000 / 1000</div>
                <div class="energy-bar-background"><div id="energy-bar-fill"></div></div>
                <div id="energy-timer-display" style="display: none; text-align: center; margin-top: 10px; font-size: 16px;"></div>
                <div id="fast-recovery-wrapper" style="display: none; width: 100%; text-align: center;">
                    <button id="fast-energy-recovery-btn" class="action-button" style="margin-top: 10px; width: 100%; background-color: #e67e22;">Watch Ad for Faster Refill</button>
                </div>
            </div>
        </div>
        
        <div id="rewards-hub-screen" class="screen scrollable-screen hidden">
            <h2>üéÅ Rewards Hub üéÅ</h2>
            <div class="options-container">
                <div class="option-card reward-task-card">
                    <h3>Join Our Community</h3>
                    <p>Join our official Telegram channel for updates, announcements, and special events. Get 99 coins as a one-time reward!</p>
                    <div class="reward-task-buttons">
                        <a href="https://t.me/taptoearningsquid" target="_blank" id="join-telegram-link" class="join-telegram-button">Join Channel</a>
                        <button id="claim-telegram-reward-btn" class="action-button" style="background-color:#27ae60;" disabled>Claim 99 ü™ô</button>
                    </div>
                </div>
                <div class="option-card reward-task-card">
                    <h3>Daily Bonus</h3>
                    <p>Come back every day to claim your free 20 coins!</p>
                    <div class="reward-task-buttons">
                         <button id="claim-daily-bonus-btn" class="action-button" style="background-color:#e67e22;">Claim 20 ü™ô</button>
                    </div>
                </div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tournament-screen" class="screen scrollable-screen hidden tournament-bg">
            <h2>üèÜ All Events & Games üèÜ</h2>
            <div id="tournament-list-container" class="options-container"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="offer-wall-screen" class="screen scrollable-screen hidden">
            <div class="offer-submission-prompt">
                <p>After completing any offer, send a screenshot with your User ID to our support for verification.</p>
                <div class="user-id-container">
                    Your User ID: <strong id="user-id-display-offer"></strong> 
                    <span class="copy-id-btn" title="Copy User ID">üìã</span>
                </div>
                <a href="https://t.me/Costumer_123" target="_blank" class="send-screenshot-btn">Send Offer Screenshot</a>
            </div>

            <div id="offer-wall-container" class="offer-wall-container">
                 <p style="color: #6c757d; text-align: center;">Loading offers...</p>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tasks-screen" class="screen hidden">
            <h2>üìù Offers & Tasks üìù</h2>
            <div id="tasks-container-all" class="options-container">
                <div id="tasks-options-container"></div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="mining-screen" class="screen scrollable-screen hidden">
            <h2>‚õèÔ∏è Mining Coins ‚õèÔ∏è</h2>
            <div id="mining-ad-area">
                <div id="age-gate">
                    <p>Are you 18+ years old?</p>
                    <button id="confirm-age-btn">Confirm</button>
                </div>
                <div id="next-ad-timer" style="display: none;"></div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="diamond-screen" class="screen hidden">
            <h2>üíé Diamond Balance üíé</h2>
            <div class="option-card" style="width: 100%; max-width: 400px;">
                <p>Your current diamond balance is:</p>
                <h1 id="diamond-balance-display" style="font-size: 48px; color: #00e0ff;">üíé 0</h1>
                <p style="font-size: 14px; margin-top: 20px;">Diamonds can be used for special in-game events and boosts in the future!</p>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="ads-screen" class="screen scrollable-screen hidden">
            <h2>üé¨ Watch Ads & Earn Rewards</h2>
            <div id="adsList" style="width:100%; max-width:450px;"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="wallet-screen" class="screen hidden">
            <div class="ws-container">
                <div class="ws-profile">
                    <div class="name" id="wallet-player-name">üë§ Player</div>
                    <div class="balance" id="wallet-balance">0</div>
                </div>
                <div class="ws-value" id="wallet-usd-value">Value: $0.00 USD</div>
                <button class="ws-btn ws-withdraw" id="wallet-open-options-btn">Withdraw</button>
                <button class="ws-btn ws-back" data-screen="game-screen">Back to Game</button>
                <div class="ws-history" id="wallet-history">
                    <h3>Withdrawal History</h3>
                </div>
            </div>
        </div>

        <!-- Wallet Modals -->
        <div class="ws-modal" id="wallet-option-modal">
            <div class="ws-card">
                <h2>Select Withdrawal Method</h2>
                <button class="ws-btn2 ws-withdraw-option-btn" id="wallet-open-upi-btn">
                    <img id="wallet-upi-logo" src="" alt="UPI" class="ws-withdrawal-logo">
                    Withdraw to UPI ID
                </button>
                <button class="ws-btn2 ws-withdraw-option-btn" id="wallet-open-usdt-btn">
                    <img id="wallet-usdt-logo" src="" alt="USDT" class="ws-withdrawal-logo">
                    Withdraw to USDT Wallet
                </button>
            </div>
        </div>
        <div class="ws-modal" id="wallet-upi-modal">
            <div class="ws-card">
                <h2>Withdraw to UPI</h2>
                <div class="ws-input-box">
                    <label>Enter Your Name</label>
                    <input id="wallet-upi-name" type="text" placeholder="Enter your name">
                </div>
                <div class="ws-input-box">
                    <label>Enter Your UPI ID</label>
                    <input id="wallet-upi-id" type="text" placeholder="example@upi">
                </div>
                <div class="ws-input-box">
                    <label>Amount (Coins)</label>
                    <input id="wallet-upi-coins" type="number" placeholder="Enter amount">
                    <div class="ws-note">Minimum withdrawal is 10,000 coins</div>
                </div>
                <button class="ws-btn2" id="wallet-submit-upi-btn">Confirm Withdraw</button>
            </div>
        </div>
        <div class="ws-modal" id="wallet-usdt-modal">
            <div class="ws-card">
                <h2>Withdraw USDT <span class="ws-rate">100,000 Coins = 1 USDT</span></h2>
                <div class="ws-input-box">
                    <label>Select Network</label>
                    <select id="wallet-usdt-network">
                        <option value="">-- Select --</option>
                        <option value="trc20">TRC20 (Tron)</option>
                        <option value="bep20">BEP20 (BSC)</option>
                        <option value="erc20">ERC20 (Ethereum)</option>
                    </select>
                </div>
                <div class="ws-input-box">
                    <label>Wallet Address</label>
                    <input id="wallet-usdt-address" type="text" placeholder="Enter your USDT wallet address">
                </div>
                <div class="ws-input-box">
                    <label>Amount (Coins)</label>
                    <input id="wallet-usdt-coins" type="number" placeholder="Enter amount">
                    <div class="ws-note">Minimum withdrawal is 10,000 coins</div>
                </div>
                <div class="ws-receive-box">
                    <div>Receive</div>
                    <span id="wallet-usdt-receive">0.00 USDT</span>
                </div>
                <button class="ws-btn2" id="wallet-submit-usdt-btn">Confirm Withdraw</button>
            </div>
        </div>
        
        <div id="gift-screen" class="screen hidden">
            <div class="gift-container">
                <h2>üéÅ Redeem Gift Code</h2>
                <p class="sub-text">A new gift code will be available every 6 hours.</p>
                <p class="highlight">You can win up to 10,000 coins from gift codes!</p>
                
                <input type="text" id="giftCodeInput" placeholder="Enter your gift code">
                <button class="redeem-btn" id="redeem-gift-code-btn">Redeem Code</button>
                <p>‚Äî OR ‚Äî</p>
                
                <div id="claimButtonContainer">
                    <button class="claim-btn" id="claimBtn1">Claim Gift Code ü§ë</button>
                </div>
                
                <div id="redeemedMessage" class="redeemed-message">
                    Code successfully redeemed! ü•≥
                </div>
                
                <p class="note">Claim a code and redeem it to earn coins üöÄ</p>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="daily-tasks-screen" class="screen scrollable-screen hidden">
            <div class="dt-wrap">
                <div class="dt-header">  
                    <div class="dt-title">Daily Tasks</div>  
                </div>    
                <div class="dt-wallet">  
                    <div>ü™ô Coins: <span id="dt-coin-balance">0</span></div>  
                    <div>üíé Diamonds: <span id="dt-diamond-balance">0</span></div>  
                </div>    
                <div class="dt-list" id="daily-task-list-container"></div>  
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div class="nav-container">
            <div class="nav-button active" data-screen="game-screen"><span class="nav-icon">üè†</span><span class="nav-text">Home</span></div>
            <div class="nav-button" data-screen="tournament-screen"><span class="nav-icon">üèÜ</span><span class="nav-text">All</span></div>
            <div class="nav-button" id="offer-nav-button" data-screen="offer-wall-screen"><span class="nav-icon">üì≤</span><span class="nav-text">Offer</span></div>
            <div class="nav-button" data-screen="ads-screen"><span class="nav-icon">üé¨</span><span class="nav-text">ADS</span></div>
            <div class="nav-button" data-screen="gift-screen"><span class="nav-icon">üéÅ</span><span class="nav-text">Gift</span></div>
            <div class="nav-button" data-screen="wallet-screen"><span class="nav-icon">üëõ</span><span class="nav-text">Wallet</span></div>
        </div>
    </div>
    
    <div id="notification-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="close-notification-btn">√ó</span>
            <h3>üîî Notifications</h3>
            <div id="notification-list">
                <p>No new messages.</p>
            </div>
        </div>
    </div>

    <div id="name-change-popup" class="popup">
        <div class="popup-content">
            <h3>Enter your name:</h3>
            <input type="text" id="new-name-input" class="withdraw-input" placeholder="Enter new name" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-around; margin-top: 25px; gap: 15px;">
                <button id="cancel-name-button" class="action-button" style="background-color: #e74c3c; flex: 1;">CANCEL</button>
                <button id="confirm-name-button" class="action-button" style="background-color: #2ecc71; flex: 1;">OK</button>
            </div>
        </div>
    </div>

    <div id="tournament-join-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="tournament-join-popup-close">√ó</span>
            <img id="tournament-join-popup-image" src="" alt="Tournament Logo">
            <h3 id="tournament-join-popup-title">Join Tournament</h3>
    
            <div id="tournament-ad-view">
                <p style="font-size: 16px; margin-top: 15px;">You must watch 5 ads to proceed.</p>
                <p>Progress: <strong id="tournament-ad-progress">0 / 5</strong></p>
                <button id="tournament-watch-ad-btn" class="action-button" style="background-color: #f39c12; margin-top: 15px;">Watch Ad</button>
                <button id="tournament-ad-cancel-btn" class="action-button" style="background-color: #e74c3c; margin-top: 10px;">Cancel</button>
            </div>
    
            <div id="tournament-confirm-view" style="display: none;">
                <p>Entry Fee: <strong id="tournament-join-popup-fee">0 ü™ô</strong></p>
                <p style="font-size: 16px; margin-top: 15px;">Confirm your name to join:</p>
                <input type="text" id="tournament-join-name-input" class="withdraw-input" placeholder="Enter your name">
                <div class="join-popup-buttons">
                    <button id="tournament-join-cancel-btn" class="action-button" style="background-color: #e74c3c; flex: 1;">Cancel</button>
                    <button id="tournament-join-confirm-btn" class="action-button" style="background-color: #f39c12; flex: 1;">Confirm & Join</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="tap-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2b4065a46d.mp3" preload="auto"></audio>
    
    <div id="ad-frame-wrapper" style="display: none;">
        <div class="stage">
            <div class="overlay">
                <span>Close in</span>
                <span class="timer" id="ad-timer">15s</span>
                <button id="ad-close-btn" class="closeBtn" disabled>Close</button>
            </div>
            <div id="ad-container">
            </div>
        </div>
    </div>
    
    <div id="auto-ad-overlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 99999; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box;">
        <div style="position: relative; width: 100%; max-width: 330px; height: 100%; max-height: 490px; background-color: #000; border: 2px solid #333; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.5);">
            <div style="padding: 8px 12px; background-color: #1a1a2e; text-align: right; flex-shrink: 0;">
                <span id="auto-ad-timer" style="color: white; font-size: 14px; font-weight: bold; font-family: 'Poppins', sans-serif;"></span>
            </div>
            <iframe id="auto-ad-iframe" style="width: 100%; height: 100%; border: none; flex-grow: 1;"></iframe>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBJrCE4w_QfBqfF3g4O_RuCK4DbjmL9TRg",
          authDomain: "telegram-69052.firebaseapp.com",
          databaseURL: "https://telegram-69052-default-rtdb.firebaseio.com",
          projectId: "telegram-69052",
          storageBucket: "telegram-69052.firebasestorage.app",
          messagingSenderId: "824247387361",
          appId: "1:824247387361:web:f4e6c22abb4b503871a3a0",
          measurementId: "G-GB3LP113V6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isAdCurrentlyShowing = false; 

        let automaticAdTimerInterval = null;
        const autoAdOverlay = document.getElementById('auto-ad-overlay');
        const autoAdIframe = document.getElementById('auto-ad-iframe');
        const autoAdTimerDiv = document.getElementById('auto-ad-timer');
        const AUTO_AD_URL = 'https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315';
        const AUTO_AD_INTERVAL = 180000;
        const AUTO_AD_DURATION = 20000;

        function showAutomaticAd() {
            if (isAdCurrentlyShowing) return;

            console.log("Automatic ad dikhaya ja raha hai...");
            isAdCurrentlyShowing = true;
            autoAdIframe.src = AUTO_AD_URL;
            autoAdOverlay.style.display = 'flex';

            let timeLeft = AUTO_AD_DURATION / 1000;
            
            const updateTimerText = () => {
                autoAdTimerDiv.textContent = `Ad will close in ${timeLeft}s`;
            };
            
            updateTimerText();

            const timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerText();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);

            setTimeout(() => {
                autoAdOverlay.style.display = 'none';
                autoAdIframe.src = 'about:blank';
                isAdCurrentlyShowing = false;
                console.log("Automatic ad band ho gaya.");
            }, AUTO_AD_DURATION);
        }

        function tryToShowAutomaticAd() {
            if (isAdCurrentlyShowing) {
                console.log("Auto Ad Roka Gaya: Koi aur ad pehle se chal raha hai.");
                return;
            }
            
            const isPopupOpen = document.querySelector('.popup[style*="display: flex"], .ws-modal[style*="display: flex"]');
            if (isPopupOpen) {
                console.log("Auto Ad Roka Gaya: Ek popup khula hai.");
                return;
            }
            
            showAutomaticAd();
        }

        function startAutomaticAdTimer() {
            if (automaticAdTimerInterval) clearInterval(automaticAdTimerInterval);
            automaticAdTimerInterval = setInterval(tryToShowAutomaticAd, AUTO_AD_INTERVAL);
            console.log("Automatic ad timer shuru ho gaya hai.");
        }

        const adFrameWrapper = document.getElementById('ad-frame-wrapper');
        const adTimerEl = document.getElementById('ad-timer');
        const adCloseBtn = document.getElementById('ad-close-btn');
        const adContainer = document.getElementById('ad-container');
        let adCanClose = false;
        let adCountdownInterval;

        function showAdFrame(adUrl, onCompleteCallback, options = {}) {
            const defaultOptions = { duration: 15, showOverlay: true };
            const finalOptions = { ...defaultOptions, ...options };

            isAdCurrentlyShowing = true;
            adCanClose = false;
            let remaining = finalOptions.duration;

            const overlay = adFrameWrapper.querySelector('.overlay');
            if (finalOptions.showOverlay) {
                overlay.style.display = 'flex';
                adTimerEl.textContent = remaining + 's';
                adCloseBtn.setAttribute('disabled', 'true');
                adCloseBtn.classList.remove('enabled');
            } else {
                overlay.style.display = 'none';
            }

            adCloseBtn.onclick = null;

            adContainer.innerHTML = '';
            const iframe = document.createElement('iframe');
            iframe.src = adUrl;
            adContainer.appendChild(iframe);
            
            adFrameWrapper.style.display = 'grid';

            history.pushState(null, '', location.href);
            const blockBack = () => {
                if (!adCanClose) {
                    history.pushState(null, '', location.href);
                }
            };
            window.addEventListener('popstate', blockBack);

            function unlock() {
                adCanClose = true;
                if (finalOptions.showOverlay) {
                    adCloseBtn.removeAttribute('disabled');
                    adCloseBtn.classList.add('enabled');
                }
                
                adCloseBtn.onclick = () => {
                    isAdCurrentlyShowing = false;
                    adFrameWrapper.style.display = 'none';
                    adContainer.innerHTML = '';
                    window.removeEventListener('popstate', blockBack);
                    overlay.style.display = 'flex'; // Reset for next time
                    if (onCompleteCallback && typeof onCompleteCallback === 'function') {
                        onCompleteCallback();
                    }
                };
                
                if (!finalOptions.showOverlay) {
                     adCloseBtn.onclick();
                }
            }

            if (adCountdownInterval) clearInterval(adCountdownInterval);
            adCountdownInterval = setInterval(() => {
                remaining -= 1;
                if (finalOptions.showOverlay) {
                    adTimerEl.textContent = (remaining > 0 ? remaining : 0) + 's';
                }
                if (remaining <= 0) {
                    clearInterval(adCountdownInterval);
                    unlock();
                }
            }, 1000);

            setTimeout(() => { if (!adCanClose) unlock(); }, (finalOptions.duration + 1) * 1000);
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'BKC';
            for (let i = 0; i < 3; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function copyTextToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to your clipboard!');
                }).catch(err => {
                    console.error('Modern copy failed, trying fallback: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('Copied to your clipboard!');
                } else {
                    alert('Could not copy. Please copy it manually.');
                }
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Could not copy. Please copy it manually.');
            }
            document.body.removeChild(textArea);
        }

        function handleIncomingReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                sessionStorage.setItem('referrerCode', refCode);
            }
        }

        function creditReferrer(referralCode) {
            if (!referralCode) return;
            const usersRef = database.ref('Users');
            usersRef.orderByChild('myReferralC').equalTo(referralCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const referrerData = snapshot.val();
                    const referrerId = Object.keys(referrerData)[0];
                    const referrerUserRef = database.ref(`Users/${referrerId}`);
                    referrerUserRef.transaction(userData => {
                        if (userData) {
                            userData.score = (userData.score || 0) + 700;
                            userData.Totalearning = (userData.Totalearning || 0) + 700;
                        }
                        return userData;
                    });
                    console.log(`Credited 700 coins to referrer ${referrerId}`);
                }
            });
        }

        function updateUserPresence(userId) {
            if (!userId) return;
            const userPresenceRef = database.ref('/Users/' + userId + '/presence');
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userPresenceRef.set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    userPresenceRef.onDisconnect().set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                }
            });
        }

        function getOrCreateUserId() {
            let userId = localStorage.getItem('tapGameUserId');
            if (!userId) {
                userId = database.ref().push().key;
                localStorage.setItem('tapGameUserId', userId);
            }
            return userId;
        }
        const userId = getOrCreateUserId();
        
        function logUserEvent(eventName, eventData = {}) {
            if (!userId) return;
            const activityRef = database.ref(`userActivity/${userId}`);
            activityRef.push({
                eventName: eventName,
                eventData: eventData,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error("Error logging event:", error);
            });
        }

        let sessionStartTime = Date.now();
        let totalOnlineTime = 0;

        function updateOnlineTime() {
            if (sessionStartTime) {
                const sessionDuration = Date.now() - sessionStartTime;
                totalOnlineTime += sessionDuration;
                sessionStartTime = Date.now(); 
                
                const userRef = database.ref(`Users/${userId}`);
                userRef.child('totalOnlineTime').set(firebase.database.ServerValue.increment(sessionDuration));
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                updateOnlineTime();
                sessionStartTime = null;
            } else {
                sessionStartTime = Date.now();
            }
        });
        window.addEventListener('beforeunload', updateOnlineTime);

        setInterval(updateOnlineTime, 60000);

        document.addEventListener('DOMContentLoaded', () => {
            updateUserPresence(userId);

            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 3000);

            const elements = {
                gameScreen: document.getElementById('game-screen'),
                profileSection: document.getElementById('profile-section'),
                playerNameDisplay: document.getElementById('player-name-display'),
                coinContainer: document.getElementById('coin-container'),
                coinCss: document.getElementById('coin-css'),
                scoreDisplay: document.getElementById('score-display'),
                energyText: document.getElementById('energy-text'),
                energyBarFill: document.getElementById('energy-bar-fill'),
                screens: document.querySelectorAll('.screen'),
                navButtons: document.querySelectorAll('.nav-button'),
                levelDisplay: document.getElementById('level-display'),
                tapSound: document.getElementById('tap-sound'),
                nameChangePopup: document.getElementById('name-change-popup'),
                newNameInput: document.getElementById('new-name-input'),
                confirmNameButton: document.getElementById('confirm-name-button'),
                cancelNameButton: document.getElementById('cancel-name-button'),
                tasksOptionsContainer: document.getElementById('tasks-options-container'),
                notificationBell: document.getElementById('notification-bell'),
                notificationDot: document.getElementById('notification-dot'),
                notificationPopup: document.getElementById('notification-popup'),
                notificationList: document.getElementById('notification-list'),
                closeNotificationBtn: document.getElementById('close-notification-btn'),
                energyTimerDisplay: document.getElementById('energy-timer-display'),
                fastEnergyRecoveryBtn: document.getElementById('fast-energy-recovery-btn'),
                fastRecoveryWrapper: document.getElementById('fast-recovery-wrapper'),
                tournamentScreen: document.getElementById('tournament-screen'),
                tournamentListContainer: document.getElementById('tournament-list-container'),
                tournamentJoinPopup: document.getElementById('tournament-join-popup'),
                tournamentJoinPopupClose: document.getElementById('tournament-join-popup-close'),
                tournamentJoinPopupImage: document.getElementById('tournament-join-popup-image'),
                tournamentJoinPopupTitle: document.getElementById('tournament-join-popup-title'),
                tournamentJoinPopupFee: document.getElementById('tournament-join-popup-fee'),
                tournamentJoinNameInput: document.getElementById('tournament-join-name-input'),
                tournamentJoinCancelBtn: document.getElementById('tournament-join-cancel-btn'),
                tournamentJoinConfirmBtn: document.getElementById('tournament-join-confirm-btn'),
                tournamentAdView: document.getElementById('tournament-ad-view'),
                tournamentConfirmView: document.getElementById('tournament-confirm-view'),
                tournamentAdProgress: document.getElementById('tournament-ad-progress'),
                tournamentWatchAdBtn: document.getElementById('tournament-watch-ad-btn'),
                tournamentAdCancelBtn: document.getElementById('tournament-ad-cancel-btn'),
                offerWallContainer: document.getElementById('offer-wall-container'),
                rewardsHubButton: document.getElementById('rewards-hub-button'),
                rewardsHubScreen: document.getElementById('rewards-hub-screen'),
                joinTelegramLink: document.getElementById('join-telegram-link'),
                claimTelegramRewardBtn: document.getElementById('claim-telegram-reward-btn'),
                claimDailyBonusBtn: document.getElementById('claim-daily-bonus-btn'),
                userIdDisplayOffer: document.getElementById('user-id-display-offer'),
                walletPlayerName: document.getElementById('wallet-player-name'),
                walletBalance: document.getElementById('wallet-balance'),
                walletUsdValue: document.getElementById('wallet-usd-value'),
                walletHistory: document.getElementById('wallet-history'),
                walletOpenOptionsBtn: document.getElementById('wallet-open-options-btn'),
                walletOptionModal: document.getElementById('wallet-option-modal'),
                walletUpiModal: document.getElementById('wallet-upi-modal'),
                walletUsdtModal: document.getElementById('wallet-usdt-modal'),
                walletOpenUpiBtn: document.getElementById('wallet-open-upi-btn'),
                walletOpenUsdtBtn: document.getElementById('wallet-open-usdt-btn'),
                walletUpiLogo: document.getElementById('wallet-upi-logo'),
                walletUsdtLogo: document.getElementById('wallet-usdt-logo'),
                walletSubmitUpiBtn: document.getElementById('wallet-submit-upi-btn'),
                walletSubmitUsdtBtn: document.getElementById('wallet-submit-usdt-btn'),
                walletUpiName: document.getElementById('wallet-upi-name'),
                walletUpiId: document.getElementById('wallet-upi-id'),
                walletUpiCoins: document.getElementById('wallet-upi-coins'),
                walletUsdtNetwork: document.getElementById('wallet-usdt-network'),
                walletUsdtAddress: document.getElementById('wallet-usdt-address'),
                walletUsdtCoins: document.getElementById('wallet-usdt-coins'),
                walletUsdtReceive: document.getElementById('wallet-usdt-receive'),
                miningButton: document.getElementById('mining-button'),
                diamondDisplay: document.getElementById('diamond-display'),
                diamondCount: document.getElementById('diamond-count'),
                diamondScreen: document.getElementById('diamond-screen'),
                diamondBalanceDisplay: document.getElementById('diamond-balance-display'),
                miningAdArea: document.getElementById('mining-ad-area'),
                ageGate: document.getElementById('age-gate'),
                confirmAgeBtn: document.getElementById('confirm-age-btn'),
                nextAdTimer: document.getElementById('next-ad-timer'),
                adsScreen: document.getElementById('ads-screen'),
                adsList: document.getElementById('adsList'),
                giftScreen: document.getElementById('gift-screen'),
                giftCodeInput: document.getElementById('giftCodeInput'),
                redeemGiftCodeBtn: document.getElementById('redeem-gift-code-btn'),
                claimButtonContainer: document.getElementById('claimButtonContainer'),
                claimBtn1: document.getElementById('claimBtn1'),
                redeemedMessage: document.getElementById('redeemedMessage'),
                dailyTasksSideButton: document.getElementById('daily-tasks-side-button'), // New side button
                dailyTasksScreen: document.getElementById('daily-tasks-screen'),
                dtCoinBalance: document.getElementById('dt-coin-balance'),
                dtDiamondBalance: document.getElementById('dt-diamond-balance'),
                dailyTaskListContainer: document.getElementById('daily-task-list-container'),
            };

            elements.dailyTasksSideButton.addEventListener('click', () => showScreen('daily-tasks-screen'));

            document.querySelector('.copy-id-btn').addEventListener('click', () => {
                if (userId) {
                    const originalAlert = window.alert;
                    window.alert = function(msg) {
                        if (msg.includes('Copied to your clipboard!')) {
                            originalAlert('User ID Copied!');
                        } else {
                            originalAlert(msg);
                        }
                    };
                    copyTextToClipboard(userId);
                    window.alert = originalAlert;
                    
                    const copyBtn = document.querySelector('.copy-id-btn');
                    const originalIcon = copyBtn.textContent;
                    copyBtn.textContent = '‚úÖ';
                    setTimeout(() => {
                        copyBtn.textContent = originalIcon;
                    }, 1500);
                }
            });

            let gameSettings = {
                withdrawalsLocked: false,
                withdrawalButtonText: 'Withdraw All Coins',
                isWithdrawalForceUnlocked: false,
                coinValue: 1000,
                logoUrls: { upi: '', usdt: '' },
            };
            
            let withdrawalMethods = {
                upi: { isLocked: false, message: '' },
                usdt: { isLocked: false, message: '' }
            };

            let state = {
                score: 0, playerName: 'Player', currentLevel: 1, tapPower: 1, tapUpgradeLevel: 0,
                maxEnergy: 1000, currentEnergy: 1000,
                myReferralC: null, referredBy: null,
                withdrawalAdClicks: 0,
                tapCounter: 0,
                messages: [],
                energyDepletedTime: 0,
                energyRecoveryDuration: 0, 
                fastRecoveryAdsWatched: 0,
                joinedTournaments: {},
                telegramJoinedClaimed: false,
                lastDailyBonusClaim: null,
                isIndividuallyLocked: false,
                totalOnlineTime: 0,
                creationTime: 0,
                diamonds: 0,
                adsProgress: {},
                dailyTaskProgress: {},
            };
            
            let currentTournamentJoinProcess = {
                details: null,
                adsWatched: 0,
                adsRequired: 5,
                adUrl: 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6'
            };
            
            let nextAdTimeout, blackoutInterval, countdownInterval;
            
            // --- DAILY TASKS & GIFT PAGE LOGIC (INTEGRATED) ---
            let dailyTaskSettings = { coinsPerTask: 30, tapLimit: 10, delaySeconds: 6 };
            let dailyTaskLinks = {};
            const dailyTasksList = [  
              {id:1, icon:"üòç", name:"Watch Short Ad", desc:"Rewarded Interstitial"}, {id:2, icon:"üòé", name:"Click for Reward", desc:"Rewarded Popup"},  
              {id:3, icon:"ü§ë", name:"Big Cash Bonus", desc:"Earn instantly"}, {id:4, icon:"üí∞", name:"Treasure Reward", desc:"Open & win coins"},  
              {id:5, icon:"üåº", name:"Lucky Flower", desc:"Daily surprise"}, {id:6, icon:"üòô", name:"Fun Task", desc:"Simple action"},  
              {id:7, icon:"üéÆ", name:"Play & Earn", desc:"Mini game reward"}, {id:8, icon:"ü•≥", name:"Celebration Bonus", desc:"Special prize"},  
              {id:9, icon:"üî•", name:"Hot Offer", desc:"Limited time"}, {id:10, icon:"üëÄ", name:"Watch & Win", desc:"Extra reward"},  
              {id:11, icon:"üíé", name:"Diamond Gift", desc:"Premium bonus", diamond:true}, {id:12, icon:"ü™ô", name:"Golden Coin", desc:"Collect coins"},  
              {id:13, icon:"üëÅÔ∏è", name:"Secret View", desc:"Hidden reward"}, {id:14, icon:"üì∫", name:"Double Watch", desc:"Extra bonus"},  
              {id:15, icon:"üéÅ", name:"Triple Watch", desc:"Special gift"}, {id:16, icon:"ü•µ", name:"Hot Challenge", desc:"Complete now"},  
              {id:17, icon:"üí∏", name:"Cash Drop", desc:"Win instantly"}, {id:18, icon:"üéâ", name:"Party Reward", desc:"Enjoy & earn"},  
              {id:19, icon:"‚ù§Ô∏è‚Äçüî•", name:"Love Fire", desc:"Special surprise"}, {id:20, icon:"üëÅÔ∏è", name:"Eye Reward", desc:"Secret bonus"},  
              {id:21, icon:"üå°Ô∏è", name:"Heat Bonus", desc:"Hot prize"}, {id:22, icon:"üê≥", name:"Whale Gift", desc:"Big reward"},  
              {id:23, icon:"‚è∞", name:"Time Bonus", desc:"Claim fast"}, {id:24, icon:"üîì", name:"Unlock Reward", desc:"Hidden treasure"},  
              {id:25, icon:"üáÆüá≥", name:"India Bonus", desc:"Special gift"}  
            ];
            
            let lastClickedButton = null;
            let claimSettings = {};

            async function checkClaimStatus() {
                const claimContainer = elements.claimButtonContainer;
                const redeemedMsg = elements.redeemedMessage;

                const claimCode = claimSettings.claim1 ? claimSettings.claim1.code : null;
                if (!claimCode) return;

                const snapshot = await database.ref('redemptions_by_user/' + userId).once('value');
                const userRedemptions = snapshot.val();
                
                let claimRedeemed = false;
                if (userRedemptions) {
                    for (const key in userRedemptions) {
                        if (userRedemptions[key].code === claimCode) {
                            claimRedeemed = true;
                            break;
                        }
                    }
                }

                if (claimRedeemed) {
                    claimContainer.style.display = 'none';
                    redeemedMsg.style.display = 'block';
                } else {
                    claimContainer.style.display = 'block';
                    redeemedMsg.style.display = 'none';
                }
            }

            function loadClaimSettings() {
                database.ref('claim_settings').once('value', (snapshot) => {
                    claimSettings = snapshot.val() || {};
                    checkClaimStatus();
                });
            }

            async function redeemCode() {
                let code = elements.giftCodeInput.value.trim().toUpperCase();
                if (code === "") {
                    alert("Please enter a gift code!");
                    return;
                }
                
                try {
                    let codeData = null;
                    const setting1 = claimSettings[`claim1`];
                    if (setting1 && setting1.code === code) {
                        codeData = setting1;
                    }
                    if (!codeData && claimSettings.common && claimSettings.common.code === code) {
                        codeData = claimSettings.common;
                    }
                    if (!codeData) {
                        alert("Invalid Gift Code! Please enter a correct code.");
                        return;
                    }
                    
                    const redemptionSnapshot = await database.ref('redemptions_by_user/' + userId).once('value');
                    const userRedemptions = redemptionSnapshot.val();
                    let alreadyRedeemed = false;
                    if (userRedemptions) {
                        for (const key in userRedemptions) {
                            if (userRedemptions[key].code === code) {
                                alreadyRedeemed = true;
                                break;
                            }
                        }
                    }
                    if (alreadyRedeemed) {
                        alert("You have already redeemed the code '" + code + "'. Each code can be redeemed only once.");
                        return;
                    }

                    const coinsAwarded = parseInt(codeData.coins, 10);
                    const timestamp = new Date().toISOString();
                    const redemptionData = { code, coins: coinsAwarded, redeemedAt: timestamp, userId: userId };

                    await database.ref('redeemed_codes').push(redemptionData);
                    await database.ref('redemptions_by_user/' + userId).push({ code, coins: coinsAwarded });
                    
                    state.score += coinsAwarded;
                    saveGame({ score: state.score });
                    updateDisplay();
                    
                    alert("Code '" + code + "' successfully redeemed! üéâ\nYou won " + coinsAwarded + " coins!");
                    
                    elements.giftCodeInput.value = "";
                    if (code === setting1?.code) {
                        checkClaimStatus();
                    }
                } catch (error) {
                    console.error("Redemption Error:", error);
                    alert("Redemption failed! Please try again later. (Error: " + error.message + ")");
                }
            }
            
            function claimCode(button, url) {
                if (!url || url === 'placeholder') {
                    alert("Admin has not set this claim link yet! Please wait.");
                    return;
                }
                lastClickedButton = button;
                window.open(url, '_blank');
            }

            elements.redeemGiftCodeBtn.addEventListener('click', redeemCode);
            elements.claimBtn1.addEventListener('click', () => {
                const setting = claimSettings['claim1'];
                if (setting && setting.url) {
                    claimCode(elements.claimBtn1, setting.url);
                } else {
                    claimCode(elements.claimBtn1, 'placeholder');
                }
            });

            async function loadDailyTaskSettingsAndRender() {
                try {
                    const settingsSnapshot = await database.ref('dailyTaskSettings').once('value');
                    if (settingsSnapshot.exists()) dailyTaskSettings = settingsSnapshot.val();
                    
                    const linksSnapshot = await database.ref('dailyTaskLinks').once('value');
                    if (linksSnapshot.exists()) dailyTaskLinks = linksSnapshot.val();

                    renderDailyTasksScreen();
                } catch (error) {
                    console.error("Failed to load daily task settings:", error);
                    elements.dailyTaskListContainer.innerHTML = "<p style='color:red; text-align:center;'>Could not load tasks. Please try again.</p>";
                }
            }
            
            function renderDailyTasksScreen() {
                elements.dtCoinBalance.textContent = state.score.toLocaleString();
                elements.dtDiamondBalance.textContent = state.diamonds.toLocaleString();
                elements.dailyTaskListContainer.innerHTML = '';

                dailyTasksList.forEach(task => {
                    const taskProgress = state.dailyTaskProgress[`task${task.id}`] || { count: 0 };
                    const remaining = dailyTaskSettings.tapLimit - taskProgress.count;
                    
                    const card = document.createElement("div");
                    card.className="dt-card";
                    card.innerHTML = `  
                        <div class="dt-left">  
                            <div class="dt-avatar">${task.icon}</div>  
                            <div class="dt-meta"><div class="dt-name">${task.name}</div><div class="dt-desc">${task.desc}</div></div>  
                        </div>  
                        <div class="dt-task-right">  
                            <span class="dt-counter">${remaining < 0 ? 0 : remaining}</span>  
                            <button class="dt-claim" ${remaining <= 0 ? 'disabled' : ''}>Claim</button>  
                        </div>  
                    `;
                    
                    const claimButton = card.querySelector('.dt-claim');
                    claimButton.addEventListener('click', () => handleDailyTaskClick(task, claimButton));

                    elements.dailyTaskListContainer.appendChild(card);
                });
            }

            function handleDailyTaskClick(task, button) {
                const taskId = task.id;
                const isDiamond = task.diamond || false;

                const taskProgress = state.dailyTaskProgress[`task${taskId}`] || { count: 0 };
                if (taskProgress.count >= dailyTaskSettings.tapLimit) {
                    alert("‚ùå Limit reached for this task!");
                    return;
                }

                const link = dailyTaskLinks["taskLink" + taskId];
                if (!link) {
                    alert("‚ö†Ô∏è Admin has not set a link for this task yet!");
                    return;
                }
                
                window.open(link, "_blank");
                
                button.disabled = true;
                let countdown = dailyTaskSettings.delaySeconds;
                button.textContent = `Wait ${countdown}s`;
                
                const interval = setInterval(() => {
                    countdown--;
                    button.textContent = `Wait ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(interval);
                    }
                }, 1000);

                setTimeout(() => {
                    taskProgress.count++;
                    state.dailyTaskProgress[`task${taskId}`] = taskProgress;

                    const reward = dailyTaskSettings.coinsPerTask;
                    if (isDiamond) {
                        state.diamonds += reward;
                        alert(`üíé +${reward} Diamonds ‡§Æ‡§ø‡§≤‡•á!`);
                    } else {
                        state.score += reward;
                        alert(`ü™ô +${reward} Coins ‡§Æ‡§ø‡§≤‡•á!`);
                    }

                    saveGame({ 
                        score: state.score, 
                        diamonds: state.diamonds,
                        dailyTaskProgress: state.dailyTaskProgress 
                    });

                    updateDisplay();
                    renderDailyTasksScreen();

                }, dailyTaskSettings.delaySeconds * 1000);
            }
            
            function renderRewardsHubScreen() {
                if (state.telegramJoinedClaimed) {
                    elements.claimTelegramRewardBtn.disabled = true;
                    elements.claimTelegramRewardBtn.innerText = 'Claimed ‚úîÔ∏è';
                } else {
                    const joinClicked = sessionStorage.getItem('telegramJoinClicked');
                    elements.claimTelegramRewardBtn.disabled = !joinClicked;
                    elements.claimTelegramRewardBtn.innerText = 'Claim 99 ü™ô';
                }

                const today = new Date().toDateString();
                if (state.lastDailyBonusClaim === today) {
                    elements.claimDailyBonusBtn.disabled = true;
                    elements.claimDailyBonusBtn.innerText = 'Claimed Today ‚úîÔ∏è';
                } else {
                    elements.claimDailyBonusBtn.disabled = false;
                    elements.claimDailyBonusBtn.innerText = 'Claim 20 ü™ô';
                }
            }
            
            elements.rewardsHubButton.addEventListener('click', () => {
                const adUrl = 'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44';
                showAdFrame(adUrl, () => {
                    showScreen('rewards-hub-screen');
                });
            });
            
            elements.joinTelegramLink.addEventListener('click', () => {
                if (!state.telegramJoinedClaimed) {
                    elements.claimTelegramRewardBtn.disabled = false;
                    sessionStorage.setItem('telegramJoinClicked', 'true');
                }
            });

            elements.claimTelegramRewardBtn.addEventListener('click', () => {
                if (state.telegramJoinedClaimed) {
                    alert('You have already claimed this reward.');
                    return;
                }
                
                state.score += 99;
                state.telegramJoinedClaimed = true;
                
                saveGame({ score: state.score, Totalearning: state.score, telegramJoinedClaimed: true });
                updateDisplay();
                renderRewardsHubScreen();
                alert('Congratulations! You received 99 coins for joining the community!');
            });

            elements.claimDailyBonusBtn.addEventListener('click', () => {
                const today = new Date().toDateString();
                if (state.lastDailyBonusClaim === today) {
                    alert('You have already claimed your daily bonus. Come back tomorrow!');
                    return;
                }

                state.score += 20;
                state.lastDailyBonusClaim = today;

                saveGame({ score: state.score, Totalearning: state.score, lastDailyBonusClaim: today });
                updateDisplay();
                renderRewardsHubScreen();
                alert('You have claimed your daily bonus of 20 coins!');
            });

            function loadAndDisplayAppOffers() {
                const offersRef = database.ref('appOffers');
                const container = elements.offerWallContainer;
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">Loading offers...</p>';

                offersRef.once('value').then(snapshot => {
                    container.innerHTML = ''; 
                    let activeOffersFound = false;
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const offerData = childSnapshot.val();
                            if (offerData && offerData.isActive) {
                                activeOffersFound = true;
                                const offerElement = document.createElement('div');
                                offerElement.className = 'offer-wall-item';
                                offerElement.innerHTML = `
                                    <img src="${offerData.icon}" alt="${offerData.title} Icon">
                                    <div class="offer-wall-text">
                                        <h3>${offerData.title}</h3>
                                        <p>${offerData.description}</p>
                                    </div>
                                    <div class="offer-wall-action">
                                        <div class="offer-wall-reward">
                                            <strong>+${new Intl.NumberFormat().format(offerData.reward || 0)}</strong> ü™ô
                                        </div>
                                        <a href="${offerData.link}" target="_blank" class="offer-wall-button">Start</a>
                                    </div>
                                `;
                                container.appendChild(offerElement);
                            }
                        });
                    }
                    
                    if (!activeOffersFound) {
                        container.innerHTML = '<p style="color: #6c757d; text-align: center;">No offers available right now. Check back later!</p>';
                    }

                }).catch(error => {
                    console.error("Error loading app offers:", error);
                    container.innerHTML = '<p style="color: red; text-align: center;">Could not load offers.</p>';
                });
            }

            function loadAndDisplayTournaments() {
                const tournamentsRef = database.ref('tournaments');
                elements.tournamentListContainer.innerHTML = ''; 

                tournamentsRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const initialTournamentData = childSnapshot.val();
                            const tournamentId = childSnapshot.key;
                            
                            if (initialTournamentData.isActive) {
                                const card = document.createElement('div');
                                card.className = 'tournament-card';
                                card.id = `tournament-card-${tournamentId}`;
                                
                                const entryFeeText = initialTournamentData.entryFee > 0 ? `${initialTournamentData.entryFee.toLocaleString()} ü™ô` : 'Free';
                                const defaultLogoUrl = 'https://dummyimage.com/60x60/2c3e50/ffffff&text=Logo';
                                const finalImageUrl = initialTournamentData.imageUrl || defaultLogoUrl;
                                const dateInfo = initialTournamentData.date || 'TBA';
                                const timeInfo = initialTournamentData.time ? new Date(`1970-01-01T${initialTournamentData.time}`).toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';

                                card.innerHTML = `
                                    <div class="tournament-card-header">
                                        <img src="${finalImageUrl}" alt="Game Logo" class="tournament-card-logo" onerror="this.onerror=null; this.src='${defaultLogoUrl}';">
                                        <div class="tournament-card-title">
                                            <h3>${initialTournamentData.title || 'Untitled Tournament'}</h3>
                                            <p>${initialTournamentData.game || 'Special Event'}</p>
                                        </div>
                                    </div>
                                    <p><strong>Prize Pool:</strong> ${initialTournamentData.prizePool || 'TBA'}</p>
                                    <p><strong>Entry Fee:</strong> ${entryFeeText}</p>
                                    <p><strong>Date & Time:</strong> ${dateInfo} at ${timeInfo}</p>
                                    <p><strong>Rules:</strong> ${initialTournamentData.rules || 'Follow standard rules.'}</p>
                                    
                                    <div id="room-info-${tournamentId}" class="room-info-container" style="display: none;"></div>

                                    <div id="participants-${tournamentId}" class="participant-display-container"></div>
                                    <div id="prize-status-${tournamentId}"></div> 

                                    <button class="join-button"
                                        id="join-button-${tournamentId}"
                                        data-id="${tournamentId}"
                                        data-title="${initialTournamentData.title || 'Tournament'}"
                                        data-fee="${initialTournamentData.entryFee || 0}"
                                        data-link="${initialTournamentData.joinLink || '#'}"
                                        data-image="${initialTournamentData.imageUrl || ''}">
                                        Join Now
                                    </button>
                                `;
                                
                                elements.tournamentListContainer.appendChild(card);

                                const singleTournamentRef = database.ref(`tournaments/${tournamentId}`);
                                singleTournamentRef.on('value', tournamentSnapshot => {
                                    const tournamentData = tournamentSnapshot.val();
                                    if (!tournamentData) return;

                                    const currentCard = document.getElementById(`tournament-card-${tournamentId}`);
                                    const joinButton = document.getElementById(`join-button-${tournamentId}`);
                                    const roomInfoContainer = document.getElementById(`room-info-${tournamentId}`);
                                    const participantsContainer = document.getElementById(`participants-${tournamentId}`);
                                    const prizeStatusContainer = document.getElementById(`prize-status-${tournamentId}`);
                                    if (!currentCard || !joinButton || !roomInfoContainer || !participantsContainer) return;
                                    
                                    let isFinished = false;
                                    if (tournamentData.winningTeam || (tournamentData.participants && Object.values(tournamentData.participants).some(p => p.isWinner))) {
                                        isFinished = true;
                                    }

                                    const hasJoined = state.joinedTournaments && state.joinedTournaments[tournamentId];

                                    if (isFinished) {
                                        joinButton.innerText = 'Tournament Finished';
                                        joinButton.disabled = true;
                                        currentCard.classList.add('finished');
                                        roomInfoContainer.style.display = 'none';
                                    } else {
                                        currentCard.classList.remove('finished');
                                        joinButton.innerText = hasJoined ? 'Joined! Good Luck!' : 'Join Now';
                                        joinButton.disabled = hasJoined;

                                        if (hasJoined) {
                                            const roomId = tournamentData.roomId || 'TBA';
                                            const roomPass = tournamentData.roomPassword || 'TBA';
                                            roomInfoContainer.innerHTML = `
                                                <h4>Room Credentials</h4>
                                                <p><strong>Room ID:</strong> ${roomId}</p>
                                                <p><strong>Password:</strong> ${roomPass}</p>
                                            `;
                                            roomInfoContainer.style.display = 'block';
                                        } else {
                                            roomInfoContainer.style.display = 'none';
                                        }
                                    }
                                    
                                    if (tournamentData.prizeAwarded) {
                                        prizeStatusContainer.innerHTML = `<div class="prize-distributed-message">üèÜ Prize Distributed! üèÜ</div>`;
                                    } else {
                                        prizeStatusContainer.innerHTML = '';
                                    }
                                    
                                    const participants = tournamentData.participants || {};
                                    const participantEntries = Object.entries(participants);

                                    if (participantEntries.length > 0) {
                                        if (tournamentData.minPlayers === 4) {
                                            const winningTeam = tournamentData.winningTeam || null;
                                            const team1 = participantEntries.filter((e, i) => i % 2 === 0);
                                            const team2 = participantEntries.filter((e, i) => i % 2 !== 0);
                                            const team1Html = team1.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            const team2Html = team2.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            participantsContainer.innerHTML = `
                                                <ul class="team-list"><h4>Team A ${winningTeam === 1 ? 'üèÜ' : ''}</h4>${team1Html}</ul>
                                                <div class="vs-separator">VS</div>
                                                <ul class="team-list"><h4>Team B ${winningTeam === 2 ? 'üèÜ' : ''}</h4>${team2Html}</ul>`;
                                        } else {
                                            const participantHtml = participantEntries.map(([userId, playerData]) => {
                                                const winnerIcon = playerData.isWinner ? 'üèÜ ' : '';
                                                const winnerClass = playerData.isWinner ? 'winner' : '';
                                                return `<li class="participant-item ${winnerClass}"><strong>${winnerIcon}${playerData.name}</strong></li>`;
                                            }).join('');
                                            participantsContainer.innerHTML = `<ul class="team-list" style="width:100%;">${participantHtml}</ul>`;
                                        }
                                        participantsContainer.style.display = 'flex';
                                    } else {
                                        participantsContainer.style.display = 'none';
                                    }
                                });
                            }
                        });
                    }
                }).catch(error => {
                    console.error("Error loading tournaments: ", error);
                    elements.tournamentListContainer.innerHTML += '<p style="text-align:center; color: red;">Could not load events. Please try again later.</p>';
                });
            }

            function initiateTournamentJoinProcess(details) {
                currentTournamentJoinProcess.details = details;
                currentTournamentJoinProcess.adsWatched = 0;
                elements.tournamentJoinPopupTitle.innerText = details.title;
                elements.tournamentJoinPopupImage.src = details.image || 'https://via.placeholder.com/80';
                elements.tournamentAdProgress.innerText = `0 / ${currentTournamentJoinProcess.adsRequired}`;
                elements.tournamentWatchAdBtn.disabled = false;
                elements.tournamentWatchAdBtn.innerText = 'Watch Ad';
                elements.tournamentAdView.style.display = 'block';
                elements.tournamentConfirmView.style.display = 'none';
                elements.tournamentJoinPopup.style.display = 'flex';
            }
            
            elements.tournamentListContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('join-button') && !e.target.disabled) {
                    const button = e.target;
                    const tournamentDetails = {
                        id: button.dataset.id,
                        title: button.dataset.title,
                        fee: button.dataset.fee,
                        link: button.dataset.link,
                        image: button.dataset.image
                    };
                    initiateTournamentJoinProcess(tournamentDetails);
                }
            });

            elements.tournamentWatchAdBtn.addEventListener('click', () => {
                const button = elements.tournamentWatchAdBtn;
                button.disabled = true;
                button.innerText = 'Loading Ad...';

                showAdFrame(currentTournamentJoinProcess.adUrl, () => {
                    button.disabled = false;
                    button.innerText = 'Watch Ad';
                    currentTournamentJoinProcess.adsWatched++;
                    elements.tournamentAdProgress.innerText = `${currentTournamentJoinProcess.adsWatched} / ${currentTournamentJoinProcess.adsRequired}`;
                    if (currentTournamentJoinProcess.adsWatched >= currentTournamentJoinProcess.adsRequired) {
                        elements.tournamentAdView.style.display = 'none';
                        const details = currentTournamentJoinProcess.details;
                        elements.tournamentJoinPopupFee.innerText = `${parseInt(details.fee).toLocaleString()} ü™ô`;
                        elements.tournamentJoinNameInput.value = state.playerName;
                        elements.tournamentConfirmView.style.display = 'block';
                    }
                });
            });
            
            elements.tournamentJoinConfirmBtn.addEventListener('click', () => {
                const details = currentTournamentJoinProcess.details;
                const tournamentId = details.id;
                const entryFee = parseInt(details.fee, 10);
                const joinLink = details.link;
                const newName = elements.tournamentJoinNameInput.value.trim();
                if (!newName) {
                    alert('Please enter your name to join.'); return;
                }
                if (state.score < entryFee) {
                    alert(`Not enough coins! You need ${entryFee.toLocaleString()} ü™ô to join.`); return;
                }
                state.score -= entryFee;
                if (state.playerName !== newName) {
                    state.playerName = newName;
                }
                if (!state.joinedTournaments) state.joinedTournaments = {};
                state.joinedTournaments[tournamentId] = true;
                const dataToSave = {
                    score: state.score, Totalearning: state.score, Name: state.playerName, joinedTournaments: state.joinedTournaments
                };
                const participantData = {
                    name: newName, joinTime: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref(`tournaments/${tournamentId}/participants/${userId}`).set(participantData);
                saveGame(dataToSave);
                updatePlayerNameDisplay();
                updateDisplay();
                alert(`Successfully joined! Fee of ${entryFee.toLocaleString()} ü™ô has been paid. The event password will be shared on our Telegram channel. Redirecting you...`);
                elements.tournamentJoinPopup.style.display = 'none';
                if (joinLink && joinLink !== '#') {
                    window.open(joinLink, '_blank');
                }
            });

            function closeTournamentPopup() {
                elements.tournamentJoinPopup.style.display = 'none';
                currentTournamentJoinProcess.details = null;
            }

            elements.tournamentJoinCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentAdCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentJoinPopupClose.addEventListener('click', closeTournamentPopup);
            
            function loadAndDisplayOffers() {
                const offersRef = database.ref('promotions');
                elements.tasksOptionsContainer.innerHTML = '';
                offersRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const promo = childSnapshot.val();
                            if (promo.isActive) {
                                const card = document.createElement('div');
                                card.className = 'option-card clickable';
                                card.innerHTML = `<h3>${promo.title}</h3><p>${promo.text}</p>${promo.imageUrl ? `<img src="${promo.imageUrl}" alt="Offer Image">` : ''}`;
                                card.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (promo.action === 'watchAd') { triggerWatchAd(card); } 
                                    else if (promo.linkUrl && promo.linkUrl !== '#') { window.open(promo.linkUrl, '_blank'); }
                                });
                                elements.tasksOptionsContainer.appendChild(card);
                            }
                        });
                    } else {
                        elements.tasksOptionsContainer.innerHTML = '<p>No active offers right now. Check back later!</p>';
                    }
                });
            }
            function triggerWatchAd(cardElement) {
                if (isAdBoostActive) { alert("A boost is already active! Please wait."); return; }
                isAdBoostActive = true;
                const originalText = cardElement.querySelector('p').innerText;
                cardElement.style.pointerEvents = 'none';
                let countdown = 10;
                cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        isAdBoostActive = false;
                        cardElement.style.pointerEvents = 'auto';
                        cardElement.querySelector('p').innerText = originalText;
                        alert("Ad boost has ended!");
                    }
                }, 1000);
            }
            
            function showNotifications() {
                elements.notificationDot.classList.remove('visible');
                const list = elements.notificationList;
                list.innerHTML = '';

                if (state.messages.length === 0) {
                    list.innerHTML = '<p>No new messages.</p>';
                } else {
                    state.messages.forEach(msg => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.textContent = msg.text;
                        list.appendChild(item);
                    });
                }
                elements.notificationPopup.style.display = 'flex';
            }
            function closeAndClearNotifications() {
                elements.notificationPopup.style.display = 'none';
                if (state.messages.length > 0) {
                    const updates = {};
                    state.messages.forEach(msg => {
                        updates[`/Users/${userId}/messages/${msg.key}`] = null;
                    });
                    database.ref().update(updates);
                    state.messages = [];
                }
            }
            elements.notificationBell.addEventListener('click', showNotifications);
            elements.closeNotificationBtn.addEventListener('click', closeAndClearNotifications);

            function stopMiningProcess() {
                clearTimeout(nextAdTimeout);
                clearInterval(blackoutInterval);
                clearInterval(countdownInterval);
            }
            
            function showScreen(screenId) {
                stopMiningProcess();

                elements.screens.forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

                logUserEvent('screen_view', { screen: screenId });
                
                const targetScreen = document.getElementById(screenId);
                if(targetScreen) {
                    targetScreen.classList.remove('hidden');
                } else {
                    document.getElementById('game-screen').classList.remove('hidden');
                    document.querySelector('.nav-button[data-screen="game-screen"]').classList.add('active');
                }
                
                const button = document.querySelector(`.nav-button[data-screen='${screenId}']`);
                if (button) button.classList.add('active');

                if (screenId === 'wallet-screen') { renderNewWalletScreen(); } 
                else if (screenId === 'offer-wall-screen') { loadAndDisplayAppOffers(); } 
                else if (screenId === 'tasks-screen') { loadAndDisplayOffers(); } 
                else if (screenId === 'tournament-screen') { loadAndDisplayTournaments(); } 
                else if (screenId === 'rewards-hub-screen') { renderRewardsHubScreen(); }
                else if (screenId === 'mining-screen') { startNewMiningProcess(); }
                else if (screenId === 'diamond-screen') { renderDiamondScreen(); }
                else if (screenId === 'ads-screen') { renderAdsScreen(); }
                else if (screenId === 'gift-screen') { loadClaimSettings(); }
                else if (screenId === 'daily-tasks-screen') { loadDailyTaskSettingsAndRender(); }
            }

            function listenForGameSettings() {
                const settingsRef = database.ref('gameSettings');
                settingsRef.on('value', (snapshot) => {
                    const settings = snapshot.val() || {};
                    gameSettings.withdrawalsLocked = settings.withdrawalsLocked === true;
                    gameSettings.withdrawalButtonText = settings.withdrawalButtonText || 'Withdraw All Coins';
                    gameSettings.isWithdrawalForceUnlocked = settings.isWithdrawalForceUnlocked === true;
                    gameSettings.coinValue = parseInt(settings.coinValue, 10) || 1000;
                    gameSettings.logoUrls = settings.logoUrls || { upi: '', usdt: '' };
                    
                    if (!document.getElementById('wallet-screen').classList.contains('hidden')) {
                        renderNewWalletScreen();
                    }
                });
            }

            function loadGame() {
                handleIncomingReferral();
                listenForGameSettings();
                const userRef = database.ref(`Users/${userId}`);
                
                database.ref('withdrawalMethods').on('value', (snapshot) => {
                    withdrawalMethods = snapshot.val() || { upi: {}, usdt: {} };
                });

                logUserEvent('game_loaded');

                userRef.on('value', (snapshot) => {
                    let data = snapshot.val();
                    let isNewUser = !data;

                    if (isNewUser) {
                        const newCode = generateReferralCode();
                        const referrerCode = sessionStorage.getItem('referrerCode');
                        
                        data = {
                            score: referrerCode ? 500 : 0,
                            Totalearning: referrerCode ? 500 : 0,
                            Name: 'Player',
                            myReferralC: newCode,
                            referredBy: referrerCode || null,
                            creationTime: firebase.database.ServerValue.TIMESTAMP,
                            currentEnergy: 1000,
                            isWithdrawalLocked: false,
                            totalOnlineTime: 0,
                            diamonds: 0,
                            adsProgress: {},
                            dailyTaskProgress: {},
                        };

                        if (referrerCode) {
                            creditReferrer(referrerCode);
                            sessionStorage.removeItem('referrerCode');
                            alert(`Welcome! You've received a 500 coin bonus for joining via a referral! üéâ`);
                        }
                        
                        userRef.set(data);
                        database.ref(`Referralcodes/${newCode}`).set({ Uid: userId });
                    }
                    
                    state.score = data.score || 0;
                    state.playerName = data.Name || 'Player';
                    state.myReferralC = data.myReferralC || null;
                    state.referredBy = data.referredBy || null;
                    state.isIndividuallyLocked = data.isWithdrawalLocked === true;
                    state.totalOnlineTime = data.totalOnlineTime || 0;
                    state.creationTime = data.creationTime || 0;
                    
                    state.currentEnergy = data.currentEnergy !== undefined ? data.currentEnergy : state.maxEnergy;
                    state.tapPower = data.tapPower || 1;
                    state.tapUpgradeLevel = data.tapUpgradeLevel || 0;
                    state.withdrawalAdClicks = data.withdrawalAdClicks || 0;
                    
                    state.diamonds = data.diamonds || 0;
                    state.adsProgress = data.adsProgress || {};
                    state.dailyTaskProgress = data.dailyTaskProgress || {};

                    updateDisplay();
                    updatePlayerNameDisplay();
                    checkEnergyCooldown(); 

                    if (elements.userIdDisplayOffer) {
                        elements.userIdDisplayOffer.textContent = userId;
                    }
                    
                    if (isNewUser) {
                        database.ref(`Users/${userId}/messages`).on('child_added', (msgSnapshot) => {
                            const msg = msgSnapshot.val();
                            if (msg) {
                                state.messages.push({ key: msgSnapshot.key, text: msg.text });
                                elements.notificationDot.classList.add('visible');
                            }
                        });
                    }
                });
            }

            function saveGame(dataToSave, fullSave = false) {
                if (!userId) return;
                const userRef = database.ref(`Users/${userId}`);
                if (fullSave) {
                    userRef.set({ ...state, lastSeen: firebase.database.ServerValue.TIMESTAMP });
                } 
                else if (dataToSave) {
                    userRef.update(dataToSave);
                }
            }
            function updateDisplay() {
                elements.scoreDisplay.innerText = state.score.toLocaleString();
                elements.energyText.innerText = `‚ö°Ô∏è ${Math.floor(state.currentEnergy)} / ${state.maxEnergy}`;
                elements.energyBarFill.style.width = `${(state.currentEnergy / state.maxEnergy) * 100}%`;
                elements.diamondCount.textContent = state.diamonds.toLocaleString();
                
                if (state.score >= 1000000) state.currentLevel = 10;
                else if (state.score >= 60000) state.currentLevel = 5;
                else if (state.score >= 40000) state.currentLevel = 4;
                else if (state.score >= 30000) state.currentLevel = 3;
                else if (state.score >= 10000) state.currentLevel = 2;
                else state.currentLevel = 1;
                elements.levelDisplay.innerText = `Level ${state.currentLevel}`;

                if (!document.getElementById('wallet-screen').classList.contains('hidden')) {
                    renderNewWalletScreen();
                }
            }
            function updatePlayerNameDisplay() { elements.playerNameDisplay.innerText = state.playerName; }
            
            function showFloatingText(event, power) {
                const floatingText = document.createElement('div');
                floatingText.innerText = `+${power}`;
                floatingText.className = 'floating-text';
                const x = event.clientX || event.touches[0].clientX;
                const y = event.clientY || event.touches[0].clientY;
                floatingText.style.left = `${x}px`;
                floatingText.style.top = `${y}px`;
                document.body.appendChild(floatingText);
                setTimeout(() => floatingText.remove(), 1000);
            }
            elements.coinContainer.addEventListener('pointerdown', (event) => {
                if (state.currentEnergy <= 0) {
                    return; 
                }
                
                if (!elements.coinCss.classList.contains('flipping')) {
                    elements.coinCss.classList.add('flipping');
                }
                if (elements.tapSound) {
                    elements.tapSound.currentTime = 0;
                    elements.tapSound.play().catch(e => {});
                }

                state.tapCounter++;

                if (state.tapCounter >= 3) {
                    const power = state.tapPower;
                    
                    if (state.currentEnergy >= power) {
                        state.currentEnergy -= power;
                        state.score += power;
                        state.tapCounter = 0;

                        let dataToSave = { 
                            score: state.score, 
                            Totalearning: state.score, 
                            currentEnergy: state.currentEnergy,
                            tapCounter: state.tapCounter
                        };
                        
                        if (state.currentEnergy <= 0) {
                            state.currentEnergy = 0; 
                            dataToSave.currentEnergy = 0;

                            state.energyDepletedTime = Date.now();
                            state.energyRecoveryDuration = 5 * 60 * 60 * 1000; 
                            state.fastRecoveryAdsWatched = 0; 
                            
                            dataToSave.energyDepletedTime = state.energyDepletedTime;
                            dataToSave.energyRecoveryDuration = state.energyRecoveryDuration;
                            dataToSave.fastRecoveryAdsWatched = state.fastRecoveryAdsWatched;

                            checkEnergyCooldown(); 
                        }
                        
                        updateDisplay();
                        showFloatingText(event, power);
                        saveGame(dataToSave);
                    }
                } else {
                    saveGame({ tapCounter: state.tapCounter });
                }
            });
            elements.coinCss.addEventListener('animationend', () => elements.coinCss.classList.remove('flipping'));
            function checkEnergyCooldown() {
                if (state.energyDepletedTime > 0) {
                    const timeRemaining = (state.energyDepletedTime + state.energyRecoveryDuration) - Date.now();
                    if (timeRemaining <= 0) {
                        state.currentEnergy = state.maxEnergy;
                        state.energyDepletedTime = 0;
                        state.energyRecoveryDuration = 0;
                        state.fastRecoveryAdsWatched = 0;
                        elements.energyTimerDisplay.style.display = 'none';
                        elements.fastRecoveryWrapper.style.display = 'none';
                        elements.energyText.style.display = 'block';
                        elements.energyBarFill.parentElement.style.display = 'block';
                        updateDisplay();
                        saveGame({ currentEnergy: state.currentEnergy, energyDepletedTime: 0, energyRecoveryDuration: 0, fastRecoveryAdsWatched: 0 });
                    } else {
                        const hours = Math.floor(timeRemaining / (1000 * 60 * 60)).toString().padStart(2, '0');
                        const minutes = Math.floor((timeRemaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                        const seconds = Math.floor((timeRemaining / 1000) % 60).toString().padStart(2, '0');
                        elements.energyTimerDisplay.innerText = `Next refill in: ${hours}:${minutes}:${seconds}`;
                        elements.energyTimerDisplay.style.display = 'block';
                        elements.energyText.style.display = 'none';
                        elements.energyBarFill.parentElement.style.display = 'none';
                        if (state.fastRecoveryAdsWatched < 150) {
                            elements.fastRecoveryWrapper.style.display = 'block';
                            elements.fastEnergyRecoveryBtn.innerText = `Watch Ad (${state.fastRecoveryAdsWatched}/150) for 30min Refill`;
                        } else {
                            elements.fastRecoveryWrapper.style.display = 'none'; 
                        }
                    }
                } else {
                    elements.energyTimerDisplay.style.display = 'none';
                    elements.fastRecoveryWrapper.style.display = 'none';
                    elements.energyText.style.display = 'block';
                    elements.energyBarFill.parentElement.style.display = 'block';
                }
            }
            elements.fastEnergyRecoveryBtn.addEventListener('click', () => {
                if (state.fastRecoveryAdsWatched >= 150) { alert("You have already watched enough ads."); return; }
                
                const button = elements.fastEnergyRecoveryBtn;
                button.disabled = true;
                button.innerText = 'Loading Ad...';
                
                showAdFrame('https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315', () => {
                    button.disabled = false;
                    state.fastRecoveryAdsWatched++;
                    let dataToSave = { fastRecoveryAdsWatched: state.fastRecoveryAdsWatched };
                    if (state.fastRecoveryAdsWatched >= 150) {
                        state.energyRecoveryDuration = 30 * 60 * 1000; 
                        dataToSave.energyRecoveryDuration = state.energyRecoveryDuration;
                        alert("Success! Energy will now refill in 30 minutes from when it ran out.");
                        elements.fastEnergyRecoveryBtn.style.display = 'none';
                    }
                    saveGame(dataToSave);
                    checkEnergyCooldown(); 
                });
            });
            elements.navButtons.forEach(b => { if(b.dataset.screen){ b.addEventListener('click', () => showScreen(b.dataset.screen)) } });
            document.querySelectorAll('.back-button, .ws-back').forEach(b => b.addEventListener('click', () => showScreen(b.dataset.screen)));
            elements.profileSection.addEventListener('click', () => { elements.newNameInput.value = state.playerName; elements.nameChangePopup.style.display = 'flex'; });
            elements.confirmNameButton.addEventListener('click', () => { const newName = elements.newNameInput.value.trim(); if (newName && newName !== "") { state.playerName = newName; updatePlayerNameDisplay(); saveGame({ Name: newName }); elements.nameChangePopup.style.display = 'none'; } else { alert("Name cannot be empty!"); } });
            elements.cancelNameButton.addEventListener('click', () => elements.nameChangePopup.style.display = 'none');
            
            function renderNewWalletScreen() {
                elements.walletPlayerName.textContent = 'üë§ ' + state.playerName;
                elements.walletBalance.textContent = state.score.toLocaleString();
                elements.walletUsdValue.textContent = "Value: $" + (state.score / 100000).toFixed(2) + " USD";
                renderFirebaseHistory();
            }

            function renderFirebaseHistory() {
                const historyDiv = elements.walletHistory;
                historyDiv.innerHTML = "<h3>Withdrawal History</h3>";
                const historyRef = database.ref(`withdrawals/${userId}`).limitToLast(10);
                
                historyRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        historyDiv.innerHTML += '<p style="text-align:center; font-size: 14px; opacity: 0.7;">No withdrawal history found.</p>';
                        return;
                    }

                    const historyData = [];
                    snapshot.forEach((child) => { historyData.push(child.val()); });
                    
                    historyData.reverse().forEach(item => {
                        let detailsHtml = '';
                        if (item.type === 'UPI') {
                            detailsHtml = `<small>To: ${item.name} (${item.upiId})</small>`;
                        } else if (item.type === 'USDT') {
                            detailsHtml = `<small>To: ${item.wallet} [${item.network.toUpperCase()}]</small>`;
                        }

                        const historyItemHtml = `
                            <div class="ws-history-item">
                                <div>
                                    <div class="amount">${item.coins.toLocaleString()} Coins</div>
                                    ${detailsHtml}
                                </div>
                                <div class="status">${item.status} ${item.status === 'Processing' ? '‚è≥' : '‚úÖ'}</div>
                            </div>`;
                        historyDiv.innerHTML += historyItemHtml;
                    });
                });
            }
            
            function closeAllWalletModals() {
                document.querySelectorAll(".ws-modal").forEach(m => m.style.display="none");
            }
            
            elements.walletOpenOptionsBtn.addEventListener('click', () => {
                elements.walletUpiLogo.src = gameSettings.logoUrls.upi || '';
                elements.walletUsdtLogo.src = gameSettings.logoUrls.usdt || '';

                if (withdrawalMethods.upi && withdrawalMethods.upi.isLocked) {
                    elements.walletOpenUpiBtn.disabled = true;
                    elements.walletOpenUpiBtn.textContent = withdrawalMethods.upi.message || "Currently Unavailable";
                } else {
                    elements.walletOpenUpiBtn.disabled = false;
                    elements.walletOpenUpiBtn.innerHTML = `<img id="wallet-upi-logo" src="${gameSettings.logoUrls.upi || ''}" alt="UPI" class="ws-withdrawal-logo"> Withdraw to UPI ID`;
                }

                if (withdrawalMethods.usdt && withdrawalMethods.usdt.isLocked) {
                    elements.walletOpenUsdtBtn.disabled = true;
                    elements.walletOpenUsdtBtn.textContent = withdrawalMethods.usdt.message || "Currently Unavailable";
                } else {
                    elements.walletOpenUsdtBtn.disabled = false;
                    elements.walletOpenUsdtBtn.innerHTML = `<img id="wallet-usdt-logo" src="${gameSettings.logoUrls.usdt || ''}" alt="USDT" class="ws-withdrawal-logo"> Withdraw to USDT Wallet`;
                }
                
                elements.walletOptionModal.style.display = "flex";
            });

            elements.walletOpenUpiBtn.addEventListener('click', () => { closeAllWalletModals(); elements.walletUpiModal.style.display="flex"; });
            elements.walletOpenUsdtBtn.addEventListener('click', () => { closeAllWalletModals(); elements.walletUsdtModal.style.display="flex"; });
            
            document.querySelectorAll('.ws-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeAllWalletModals();
                });
            });
            
            elements.walletUsdtCoins.addEventListener("input", () => {
                let coins = parseInt(elements.walletUsdtCoins.value) || 0;
                let usdt = (coins / 100000).toFixed(2); 
                elements.walletUsdtReceive.textContent = usdt + " USDT";
            });

            elements.walletSubmitUpiBtn.addEventListener('click', () => {
                const WITHDRAWAL_AD_URL = "https://www.revenuecpmgate.com/xp7wir795b?key=321c1fdd321363063478cea5854d4832";
                const UPI_DIAMOND_COST = 2000;
                
                let name = elements.walletUpiName.value.trim();
                let upiId = elements.walletUpiId.value.trim();
                let coins = parseInt(elements.walletUpiCoins.value) || 0;
                
                if(!name || !upiId){ alert("Please enter Name and UPI ID!"); return; }
                if(coins < 10000){ alert("Minimum withdrawal is 10,000 coins!"); return; }
                if(coins > state.score){ alert("Insufficient coin balance!"); return; }
                if(state.diamonds < UPI_DIAMOND_COST){ alert(`Insufficient diamonds ‚Äî you need ${UPI_DIAMOND_COST} diamonds to withdraw.`); return; }

                showAdFrame(WITHDRAWAL_AD_URL, () => {
                    const withdrawalData = {
                        type: 'UPI', name, upiId, coins,
                        date: new Date().toLocaleString(), status: 'Processing'
                    };
                    
                    database.ref(`withdrawals/${userId}`).push(withdrawalData);
                    state.score -= coins;
                    state.diamonds -= UPI_DIAMOND_COST;
                    saveGame({ score: state.score, diamonds: state.diamonds });
                    
                    alert(`Withdrawal request for ${coins.toLocaleString()} coins submitted successfully!`);
                    closeAllWalletModals();
                    renderNewWalletScreen();
                }, { duration: 20 });
            });

            elements.walletSubmitUsdtBtn.addEventListener('click', () => {
                const WITHDRAWAL_AD_URL = "https://www.revenuecpmgate.com/xp7wir795b?key=321c1fdd321363063478cea5854d4832";
                const USDT_DIAMOND_COST = 1000;

                let network = elements.walletUsdtNetwork.value;
                let wallet = elements.walletUsdtAddress.value.trim();
                let coins = parseInt(elements.walletUsdtCoins.value) || 0;
                
                if(!network){ alert("Please select a network!"); return; }
                if(!wallet){ alert("Please enter wallet address!"); return; }
                if(coins < 10000){ alert("Minimum withdrawal is 10,000 coins!"); return; }
                if(coins > state.score){ alert("Insufficient coin balance!"); return; }
                if(state.diamonds < USDT_DIAMOND_COST){ alert(`Insufficient diamonds ‚Äî you need ${USDT_DIAMOND_COST} diamonds to withdraw.`); return; }

                showAdFrame(WITHDRAWAL_AD_URL, () => {
                    const withdrawalData = {
                        type: 'USDT', network, wallet, coins,
                        usdtValue: (coins / 100000).toFixed(2),
                        date: new Date().toLocaleString(), status: 'Processing'
                    };

                    database.ref(`withdrawals/${userId}`).push(withdrawalData);
                    state.score -= coins;
                    state.diamonds -= USDT_DIAMOND_COST;
                    saveGame({ score: state.score, diamonds: state.diamonds });

                    alert(`Withdrawal request for ${coins.toLocaleString()} coins submitted successfully!`);
                    closeAllWalletModals();
                    renderNewWalletScreen();
                }, { duration: 20 });
            });
            
            function stopNewMiningProcess() {
                clearTimeout(nextAdTimeout);
                clearInterval(blackoutInterval);
                clearInterval(countdownInterval);
            }

            const movableAdUrls = [
                'https://www.revenuecpmgate.com/cm8gq6fq3e?key=6fef6bfc0bafc112d36c552fc6edfee4',
                'https://www.revenuecpmgate.com/xzdqc1h54f?key=074a291a6c883adbfdf54b6d73248800',
                'https://www.revenuecpmgate.com/xp7wir795b?key=321c1fdd321363063478cea5854d4832',
                'https://www.revenuecpmgate.com/k9e2z21k?key=3f3e76aef6f9137260e3e14fc78ed8a3',
                'https://www.revenuecpmgate.com/cm8gq6fq3e?key=6fef6bfc0bafc112d36c552fc6edfee4',
            ];
            let currentMovableAdIndex = 0;

            function cycleMovableAd() {
                const adIframe = document.getElementById('movable-ad-iframe');
                if (adIframe) {
                    adIframe.src = movableAdUrls[currentMovableAdIndex];
                    currentMovableAdIndex = (currentMovableAdIndex + 1) % movableAdUrls.length;
                }
            }

            function makeAdDraggable() {
                const adContainer = document.getElementById('movable-ad-container');
                const adHeader = document.getElementById('movable-ad-header');
                if (!adContainer || !adHeader) return;

                let isDragging = false;
                let offsetX, offsetY;

                const startDrag = (e) => {
                    isDragging = true;
                    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    offsetX = clientX - adContainer.getBoundingClientRect().left;
                    offsetY = clientY - adContainer.getBoundingClientRect().top;
                    adContainer.style.cursor = 'grabbing';
                    document.body.style.userSelect = 'none';
                };

                const onDrag = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    let newX = clientX - offsetX;
                    let newY = clientY - offsetY;
                    const maxX = window.innerWidth - adContainer.offsetWidth;
                    const maxY = window.innerHeight - adContainer.offsetHeight;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    adContainer.style.left = `${newX}px`;
                    adContainer.style.top = `${newY}px`;
                    adContainer.style.bottom = 'auto';
                    adContainer.style.right = 'auto';
                };

                const stopDrag = () => {
                    isDragging = false;
                    adContainer.style.cursor = 'move';
                    document.body.style.userSelect = '';
                };

                adHeader.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                adHeader.addEventListener('touchstart', startDrag, { passive: true });
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }
            
            function renderAdsScreen() {
                const adsList = elements.adsList;
                adsList.innerHTML = 'Loading ad slots...';
                
                database.ref('adsSlots').once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        adsList.innerHTML = 'No ad slots available right now.';
                        return;
                    }
                    adsList.innerHTML = '';
                    const adsData = snapshot.val();

                    adsData.forEach((slot, index) => {
                        if (!slot || !slot.adsLinks || slot.adsLinks.length === 0) return;

                        let userProgress = state.adsProgress[index] || { count: 0, currentAd: 0 };

                        const frame = document.createElement("div");
                        frame.className = "ads-frame";

                        frame.innerHTML = `
                            <div class="text-content">
                                <p>${slot.coins}</p>
                                <p>${slot.diamonds}</p>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div class="ad-counter" id="counter-${index}">${userProgress.count}/${slot.totalAds}</div>
                                <button class="play-button" id="play-${index}">
                                    <div class="play-icon"></div>
                                </button>
                            </div>
                        `;
                        adsList.appendChild(frame);

                        const playButton = document.getElementById(`play-${index}`);

                        playButton.addEventListener("click", () => {
                            if (userProgress.count >= slot.totalAds) {
                                alert("üéâ All ads watched for this slot!");
                                return;
                            }

                            const adUrl = slot.adsLinks[userProgress.currentAd];
                            userProgress.currentAd = (userProgress.currentAd + 1) % slot.adsLinks.length;
                            
                            showAdFrame(adUrl, () => {
                                userProgress.count++;
                                document.getElementById(`counter-${index}`).textContent = `${userProgress.count}/${slot.totalAds}`;

                                state.score += parseInt(slot.coins.split(' ')[0], 10) || 0;
                                state.diamonds += parseInt(slot.diamonds.split(' ')[0], 10) || 0;
                                
                                state.adsProgress[index] = userProgress;
                                saveGame({
                                    score: state.score,
                                    diamonds: state.diamonds,
                                    adsProgress: state.adsProgress
                                });
                                updateDisplay();
                            }, { showOverlay: false }); 
                        });
                    });
                });
            }

            cycleMovableAd(); 
            setInterval(cycleMovableAd, 60000); 
            makeAdDraggable(); 

            loadGame();
            showScreen('game-screen');
            startAutomaticAdTimer();
        });
    </script>
       
    <div id="ad-scripts-container">
        <script type="text/javascript">
            atOptions = {
                'key' : '1485dc1bd0b2b924939f0941a1bfb10f',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/1485dc1bd0b2b924939f0941a1bfb10f/invoke.js"></script>
    </div>

    <div id="movable-ad-container">
        <div id="movable-ad-header">Drag Me ü§è</div>
        <iframe id="movable-ad-iframe" src="about:blank" scrolling="no"></iframe>
    </div>

</body>
</html>
