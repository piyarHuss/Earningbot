<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tap-Tap Coin Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        /* --- NEW FONT FOR MODERN UI --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap');

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body{
            background-color:#1a1a2e;
            color:#fff;
            font-family:'Poppins',sans-serif;
            display:flex;
            justify-content:center;
            align-items:center;
            user-select:none;
            -webkit-user-select:none;
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease-out;
        }
        .loading-bear { font-size: 80px; animation: run-across 3s ease-in-out infinite; }
        .loading-text { margin-top: 20px; font-size: 24px; color: #fff; }
        #loading-progress-bar { width: 80%; max-width: 300px; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; margin-top: 30px; overflow: hidden; }
        #loading-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #4dff4d, #00b300); border-radius: 10px; animation: fill-progress 5s linear forwards; }
        @keyframes run-across {
            0% { transform: translateX(-100px) scaleX(1); } 49% { transform: translateX(100px) scaleX(1); }
            50% { transform: translateX(100px) scaleX(-1); } 99% { transform: translateX(-100px) scaleX(-1); }
            100% { transform: translateX(-100px) scaleX(1); }
        }
        @keyframes fill-progress { from { width: 0%; } to { width: 100%; } }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        
        .game-container{
            width:100%; 
            height:100%; 
            display:flex; 
            flex-direction:column; 
            position: relative; 
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e); 
            overflow: hidden;
        }
        
        .screen {
            flex-grow:1; 
            display:flex; 
            flex-direction:column; 
            justify-content: center; 
            align-items:center; 
            width:100%; 
            z-index: 2; 
            padding: 20px; 
            box-sizing: border-box; 
            position: relative; 
            overflow-y: auto;
            padding-bottom: 150px;
        }
        .screen.hidden{display:none}

        .scrollable-screen {
            justify-content: flex-start;
            padding-top: 30px;
        }

        .top-bar-container { position: absolute; top: 15px; left: 15px; z-index: 10; }
        .profile-section { display: flex; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 50px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: background-color 0.2s; }
        .profile-section:hover { background-color: rgba(0,0,0,0.5); }
        .profile-icon { font-size: 20px; }
        #player-name-display { font-size: 16px; font-weight: 600; }
        
        #airdrop-button {
            position: absolute; top: 15px; right: 65px; /* Make space for the bell */
            z-index: 11; font-size: 28px; cursor: pointer;
            padding: 8px; background-color: rgba(0,0,0,0.3);
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        #notification-bell {
            position: absolute; top: 15px; right: 15px; z-index: 11;
            font-size: 28px; cursor: pointer;
            padding: 8px; background-color: rgba(0,0,0,0.3);
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        #notification-dot {
            position: absolute; top: 5px; right: 5px;
            width: 10px; height: 10px;
            background-color: red; border-radius: 50%;
            border: 2px solid #1a1a2e;
            display: none; 
        }
        #notification-dot.visible { display: block; }
        #notification-list { max-height: 250px; overflow-y: auto; text-align: left; width: 100%; }
        .notification-item { background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }

        .coin-container { width: 220px; height: 220px; cursor: pointer; -webkit-tap-highlight-color: transparent; display: flex; justify-content: center; align-items: center; margin: 20px 0; perspective: 1000px; }
        #coin-css { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle at 65% 35%, #fffec8, #ffc700 60%, #e0ac00 100%); box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.4), 0 10px 20px rgba(0, 0, 0, 0.5); position: relative; border: 10px solid #c8a443; display: flex; justify-content: center; align-items: center; text-align: center; transition: transform 0.3s ease-out; transform-style: preserve-3d; pointer-events: none; }
        #coin-css::before { content: ''; position: absolute; width: 80%; height: 80%; border: 4px solid rgba(0,0,0,0.15); border-radius: 50%; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        #coin-css::after { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 40%; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0)); border-radius: 50% / 100%; transform: rotate(45deg); }
        .coin-text { font-size: 24px; font-weight: 700; color: #8B4513; text-shadow: 1px 1px 2px rgba(255,255,255,0.4); line-height: 1.2; z-index: 5; }
        .stats-container { text-align: center; margin-bottom: 15px; margin-top: 60px;}
        #score-display{font-size:48px; font-weight:700; margin: 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.5);}
        #level-display { font-size: 22px; margin-top: 0; color: #ffdd57; font-weight: 600; }
        
        .flipping { animation: tap-flip 0.4s ease-out; }
        @keyframes tap-flip {
            0% { transform: scale(1) rotateY(0deg); } 50% { transform: scale(0.9) rotateY(180deg); } 100% { transform: scale(1) rotateY(360deg); }
        }

        .energy-bar-container{width:90%;max-width: 400px; margin:0 auto;}
        #energy-text{font-size:20px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        .energy-bar-background{background-color:rgba(0,0,0,.3);border-radius:15px;height:20px;padding:4px}
        #energy-bar-fill{background:linear-gradient(90deg,#4dff4d,#00b300);height:100%;border-radius:10px;width:100%;transition:width .2s linear}
        .floating-text{position:absolute;font-size:24px;font-weight:700;color:#fff;pointer-events:none;animation:float-up 1s ease-out forwards; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        @keyframes float-up{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-80px)}}

        .nav-container{
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            display:flex;
            justify-content:space-around;
            background-color:rgba(0,0,0,.3);
            padding: 10px 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
            z-index: 100;
            backdrop-filter: blur(5px);
            box-sizing: border-box;
        }
        .nav-button{cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:5px;opacity:.8;transition:opacity .2s; flex: 1;}
        .nav-button:hover,.nav-button.active{opacity:1}
        .nav-icon{font-size:28px}
        .nav-text{font-size:14px}
        
        h2, h3{font-size:32px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        h3 {font-size: 28px;}
        p{font-size:18px;margin:5px 0}
        .back-button{background-color:#4CAF50;color:#fff;border:none;padding:15px 30px;font-size:18px;border-radius:10px;cursor:pointer;font-family:'Poppins',sans-serif; margin-top: 20px;}
        .popup{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .popup-content{background-color:#2c3e50;padding:30px;border-radius:15px;text-align:center;width:80%;max-width:350px;position:relative}
        .popup-content h3{margin-top:0}
        .popup-close{position:absolute;top:10px;right:15px;font-size:30px;cursor:pointer}
        .withdraw-options{display:flex;flex-direction:column;gap:15px;margin-top:20px}
        .withdraw-option{background-color:#3498db;color:#fff;border:none;padding:15px;font-size:16px;border-radius:10px;cursor:pointer}
        #withdraw-button{background-color:#3498db;margin-top:10px}
        .withdraw-input { width: 100%; padding: 12px; font-size: 16px; background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        .withdraw-input::placeholder { color: rgba(255,255,255,0.5); }
        .options-container { display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 400px; }
        .option-card { background-color: rgba(0,0,0,0.2); border: 2px solid #8e44ad; padding: 20px; border-radius: 15px; text-align: center; cursor: default; transition: background-color 0.2s; }
        .option-card.clickable:hover { background-color: rgba(0,0,0,0.4); cursor: pointer; }
        .option-card h3 { margin: 0 0 10px 0; color: #9b59b6; }
        .option-card p { margin: 0 0 15px 0; font-size: 16px; }
        .option-card img { max-width: 60px; max-height: 60px; margin-top: 10px; border-radius: 8px;}
        .action-button { background-color: #9b59b6; color: white; border: none; padding: 10px 20px; font-size: 18px; border-radius: 10px; cursor: pointer; font-family: 'Poppins',sans-serif; transition: background-color 0.2s;}
        .action-button:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        
        .coin-flip-container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; box-sizing: border-box; }
        .bet-selection-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .bet-button { background-color: rgba(255,255,255,0.1); color: white; border: 2px solid #9b59b6; padding: 8px 16px; font-size: 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .bet-button.active { background-color: #9b59b6; box-shadow: 0 0 10px #9b59b6; }
        .coin-flip-buttons { display: flex; gap: 20px; }
        .coin-flip-button { padding: 15px 30px; font-size: 20px; }
        #flip-result { font-size: 24px; font-weight: bold; min-height: 30px; margin-top: 15px; }
        #flip-result.win { color: #2ecc71; }
        #flip-result.loss { color: #e74c3c; }
        
        .history-container { margin-top: 30px; width: 90%; max-width: 400px; background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .history-container h3 { font-size: 22px; margin-bottom: 15px; text-align: center; }
        #withdrawal-history-list { max-height: 150px; overflow-y: auto; padding-right: 10px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .history-item-details { text-align: left; }
        .history-item-meta { text-align: right; font-size: 12px; opacity: 0.8; display: flex; flex-direction: column; align-items: flex-end; }
        .history-item-meta .status { font-weight: bold; margin-top: 4px; }
        .status-processing { color: #f1c40f; }

        #ad-scripts-container {
            position: fixed;
            bottom: 80px;
            left: 0;
            width: 100%;
            z-index: 101;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1a1a2e;
            padding: 5px 0;
            pointer-events: all;
        }

        .flappy-game-container {
            border-radius: 20px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            margin-top: 30px;
        }
        .flappy-game-container h1 { margin-top: 0; font-size: 2em; text-shadow: 3px 3px 0px rgba(0,0,0,0.2); }
        .flappy-game-container canvas { background: linear-gradient(to bottom, #87CEEB, #a2dff0); border-radius: 10px; border: 3px solid rgba(255, 255, 255, 0.2); cursor: pointer; box-shadow: inset 0 0 15px rgba(0,0,0,0.2); }
        .flappy-score-container { font-size: 1.2em; font-weight: 600; margin: 10px 0; }
        .flappy-score-value { font-family: 'Press Start 2P', cursive; color: #ffeb3b; font-size: 1.5em; margin-left: 10px; }
        .flappy-score-pulse { animation: flappy-score-pulse 0.3s ease-out; }
        @keyframes flappy-score-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .flappy-action-button { padding: 15px 35px; font-size: 1.2em; font-family: 'Poppins', sans-serif; font-weight: 700; color: white; background: linear-gradient(45deg, #f857a6, #ff5858); border: none; border-radius: 50px; cursor: pointer; margin-top: 15px; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(248, 87, 166, 0.4); text-transform: uppercase; }
        .flappy-action-button:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(248, 87, 166, 0.6); }
        .flappy-action-button:active { transform: translateY(0px) scale(1); }
        #flappy-gameOverPopup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 1001; animation: flappy-fadeIn 0.3s ease-out forwards; }
        @keyframes flappy-fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .flappy-popup-content { background: linear-gradient(135deg, #3c4a6c, #5c3c6b); padding: 30px 40px; border-radius: 15px; text-align: center; border: 2px solid rgba(255, 255, 255, 0.1); box-shadow: 0 0 30px rgba(0,0,0,0.5); animation: flappy-popIn 0.4s ease-out forwards; transform: scale(0.7); opacity: 0; }
        @keyframes flappy-popIn { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .flappy-popup-content h2 { margin-top: 0; color: #ff5858; font-size: 2.5em; }
        .flappy-popup-content p { font-size: 1.3em; }
        .flappy-reward-message { font-size: 1.2em; color: #ffeb3b; font-weight: bold; margin: 15px 0; }

        /* MINING STYLES */
        #mining-pickaxe-icon { font-size: 120px; margin: 20px 0; text-shadow: 3px 5px 15px rgba(0,0,0,0.4); }
        .swinging { animation: pickaxe-swing 1.5s ease-in-out infinite; }
        @keyframes pickaxe-swing {
            0% { transform: rotate(15deg); }
            50% { transform: rotate(-30deg); }
            100% { transform: rotate(15deg); }
        }
        .mine-stats-container { display: flex; flex-direction: column; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; margin-bottom: 20px;}
        .mine-stat { text-align: center; }
        .mine-stat p { margin: 0; font-size: 16px; opacity: 0.8; }
        .mine-stat span { font-size: 24px; font-weight: 700; color: #ffdd57; }
        
        #mine-buttons-container { display: flex; flex-direction: column; align-items: center; width: 90%; max-width: 400px; gap: 10px; }
        .claim-button { background-color: #2ecc71; }
        .upgrade-button { background-color: #3498db; }
        
        /* EVENT/TOURNAMENT CARD STYLE */
        .tournament-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #f39c12;
            padding: 20px;
            border-radius: 15px;
            text-align: left;
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s;
        }
        /* **** NEW: Style for finished tournaments **** */
        .tournament-card.finished {
            opacity: 0.6;
            border-color: #7f8c8d;
        }

        .tournament-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .tournament-card-logo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            background-color: rgba(0,0,0,0.3);
        }
        .tournament-card-title h3 {
            margin: 0;
            color: #f1c40f;
            font-size: 22px;
        }
        .tournament-card-title p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        .tournament-card p {
            font-size: 16px;
            margin: 4px 0;
            line-height: 1.5;
        }
        .tournament-card p strong {
            color: #fff;
        }
        .join-button {
            background-color: #f39c12;
            color: white;
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.2s;
        }
        .join-button:hover:not(:disabled) {
            background-color: #e67e22;
        }
        .join-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #tournament-join-popup .popup-content {
            background-color: #34495e;
        }
        #tournament-join-popup-image {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            margin-bottom: 15px;
            object-fit: cover;
        }
        #tournament-join-popup-fee {
            color: #f1c40f;
            font-weight: bold;
        }
        .join-popup-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            gap: 15px;
        }

        /* **** NEW: Room Info Container **** */
        .room-info-container {
            background-color: rgba(46, 204, 113, 0.1);
            border: 1px solid #2ecc71;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .room-info-container h4 {
            margin: 0 0 8px 0;
            color: #2ecc71;
            font-size: 16px;
        }
        .room-info-container p {
            margin: 3px 0;
            font-size: 15px;
        }

        .participant-display-container {
            display: none; /* Hidden by default, shown by JS if players exist */
            justify-content: space-around;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid rgba(241, 196, 15, 0.3);
            gap: 5px;
        }
        .team-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            text-align: center;
            min-width: 0;
        }
        .team-list h4 {
            margin: 0 0 8px 0;
            color: #f39c12;
            font-size: 16px;
            text-transform: uppercase;
        }
        .participant-item {
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            background-color: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vs-separator {
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            padding: 0 5px;
            align-self: center;
        }
        
        .participant-item.winner strong {
            color: #f1c40f;
        }
        .prize-distributed-message {
            text-align: center;
            font-weight: bold;
            color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #27ae60;
        }

        /* ===== START: MODERN TOURNAMENT CARD STYLES ===== */
        .screen.tournament-bg {
            background: url('https://images.unsplash.com/photo-1581888224555-93d6a8f1b333?q=80&w=1932&auto=format&fit=crop') no-repeat center center/cover;
            position: relative;
            z-index: 1;
        }
        .screen.tournament-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(10, 10, 25, 0.7);
            z-index: -1;
        }
        
        .modern-tournament-card {
            font-family: 'Poppins', sans-serif;
            background: rgba(26, 26, 46, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 246, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(0, 246, 255, 0.25), 0 8px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }
        .modern-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .player-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00f6ff;
            object-fit: cover;
            box-shadow: 0 0 10px #00f6ff;
            flex-shrink: 0;
        }
        .tournament-details { min-width: 0; }
        .tournament-details h2 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            font-size: 20px;
            color: #ffffff;
            text-shadow: 0 0 5px #ffffff, 0 0 10px #00f6ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tournament-details p {
            margin: 0;
            font-size: 14px;
            color: #00f6ff;
            opacity: 0.9;
        }
        .modern-card-info-bar {
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 10px;
            border-radius: 12px;
            border-top: 1px solid rgba(0, 246, 255, 0.2);
            border-bottom: 1px solid rgba(0, 246, 255, 0.2);
        }
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 5px;
            flex: 1;
        }
        .info-item .icon { font-size: 24px; line-height: 1; }
        .info-item .icon.trophy { color: #ffc700; text-shadow: 0 0 8px #ffc700; }
        .info-item .icon.coin { color: #f39c12; text-shadow: 0 0 8px #f39c12; }
        .info-item .icon.calendar { color: #3498db; text-shadow: 0 0 8px #3498db; }
        .info-item span { font-size: 14px; font-weight: 600; color: #eee; }
        .modern-card-rules {
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #00f6ff;
        }
        .modern-card-rules p { margin: 0; font-size: 13px; color: #ccc; line-height: 1.5; }
        .modern-card-rules strong { color: #00f6ff; font-weight: 700; }
        .teams-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .team-box {
            flex: 1;
            background: linear-gradient(145deg, rgba(40, 40, 70, 0.8), rgba(20, 20, 40, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #ccc;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.2s ease-in-out;
        }
        .team-box:hover { border-color: #00f6ff; }
        .vs-separator-modern {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: #ff4757; /* Neon red/pink */
            text-shadow: 0 0 5px #ff4757, 0 0 15px #ff4757;
            animation: pulse-vs 2s infinite ease-in-out;
        }
        @keyframes pulse-vs { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .join-now-button {
            background: linear-gradient(45deg, #f39c12, #ff6b6b); /* Orange-red gradient */
            color: #fff;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6), 0 0 25px rgba(255, 107, 107, 0.4);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .join-now-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.9), 0 0 40px rgba(255, 107, 107, 0.7);
        }
        .join-now-button:active { transform: translateY(0); }
        /* ===== END: MODERN TOURNAMENT CARD STYLES ===== */

    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-bear">🐻</div>
        <div class="loading-text">Loading Game...</div>
        <div id="loading-progress-bar">
            <div id="loading-progress-fill"></div>
        </div>
    </div>

    <div class="game-container">
        <div class="top-bar-container">
            <div id="profile-section" class="profile-section">
                <span class="profile-icon">👤</span>
                <span id="player-name-display">Player</span> 
            </div>
        </div>
        <div id="airdrop-button">💝</div>
        <div id="notification-bell">
            🔔
            <span id="notification-dot"></span>
        </div>

        <div id="game-screen" class="screen">
            <div class="stats-container" style="margin-top: 60px;">
                <h1 id="score-display">0</h1>
                <div id="level-display">Level 1</div>
            </div>
            <div class="coin-container" id="coin-container">
                <div id="coin-css">
                    <div class="coin-text">TAP TO<br>EARN</div>
                </div>
            </div>
            <div class="energy-bar-container">
                <div id="energy-text">⚡️ 1000 / 1000</div>
                <div class="energy-bar-background"><div id="energy-bar-fill"></div></div>
                <div id="energy-timer-display" style="display: none; text-align: center; margin-top: 10px; font-size: 16px;"></div>
                <button id="fast-energy-recovery-btn" class="action-button" style="display: none; margin-top: 10px; width: 100%; background-color: #e67e22;">Watch Ad for Faster Refill</button>
            </div>
        </div>

        <div id="mine-screen" class="screen hidden">
            <h2>⛏️ Auto-Miner ⛏️</h2>
            <div id="mining-pickaxe-icon">⛏️</div>
            <div class="mine-stats-container">
                <div class="mine-stat">
                    <p>Potential Reward</p>
                    <span id="mining-rate-display">+0 🪙</span>
                </div>
                 <div class="mine-stat">
                    <p>Ads Watched</p>
                    <span id="mining-ads-watched-display">0</span>
                </div>
                <div class="mine-stat">
                    <p>Accumulated / Time Left</p>
                    <span id="mining-timer-display">--:--:--</span>
                </div>
            </div>
            <div id="mine-buttons-container">
                <button id="start-mining-button" class="action-button" style="display: none;">Start Mining Now</button>
                <button id="watch-ad-button" class="action-button upgrade-button">Watch Ad</button>
                <button id="claim-mine-button" class="action-button claim-button" style="display: none;">Claim</button>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="games-screen" class="screen scrollable-screen hidden">
            <div class="coin-flip-container">
                <h2>🎲 Coin Flip Game 🎲</h2>
                <p>Select your bet amount:</p>
                <div class="bet-selection-container" id="bet-selection-container">
                    <button class="bet-button active" data-bet="100">100 🪙</button>
                    <button class="bet-button" data-bet="200">200 🪙</button>
                    <button class="bet-button" data-bet="1000">1K 🪙</button>
                    <button class="bet-button" data-bet="3000">3K 🪙</button>
                    <button class="bet-button" data-bet="5000">5K 🪙</button>
                </div>
                <p>Guess the outcome!</p>
                <div class="coin-flip-buttons">
                    <button id="heads-button" class="action-button coin-flip-button">Heads</button>
                    <button id="tails-button" class="action-button coin-flip-button">Tails</button>
                </div>
                <div id="flip-result">Choose your side!</div>
            </div>

            <div class="flappy-game-container">
                <h1>🐏 Flappy Ram 🐏</h1>
                <p style="font-size: 16px; margin-bottom: 10px;">Survive and earn 50 🪙 every 10 seconds!</p>
                <p class="flappy-score-container">Pipes Passed: <span id="flappy-score-value-display" class="flappy-score-value">0</span></p>
                <canvas id="flappyCanvas" width="320" height="480"></canvas>
                <p style="font-size: 16px; margin-top: 10px;">Click the canvas to Jump!</p>
                <button id="flappy-start-button" class="flappy-action-button">Start Game</button>
            </div>

            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tournament-screen" class="screen scrollable-screen hidden tournament-bg">
            <h2>🏆 All Events & Games 🏆</h2>
            <div id="tournament-list-container" class="options-container">
                 <!-- Modern Card example is removed to avoid confusion. Dynamic cards will be loaded here. -->
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="boost-screen" class="screen hidden">
            <h2>🚀 Boosts 🚀</h2>
            <div class="options-container">
                <div class="option-card">
                    <h3>Tap Power x2</h3>
                    <p>Get 2 coins for every tap.</p>
                    <button id="boost-tap-1" class="action-button">Cost: 1,000 🪙</button>
                </div>
                <div class="option-card">
                    <h3>Tap Power x3</h3>
                    <p>Get 3 coins for every tap.</p>
                    <button id="boost-tap-2" class="action-button">Cost: 5,000 🪙</button>
                </div>
                <div class="option-card">
                    <h3>Tap Power x10</h3>
                    <p>Get 10 coins for every tap.</p>
                    <button id="boost-tap-3" class="action-button">Cost: 100,000 🪙</button>
                </div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tasks-screen" class="screen hidden">
            <h2>📝 Offers & Tasks 📝</h2>
            <div id="tasks-container-all" class="options-container">
                <div class="option-card">
                    <h3>Watch & Earn</h3>
                    <p>Watch a quick ad to earn 10 coins instantly!</p>
                    <button id="watch-ad-for-40-coins-btn" class="action-button" style="background-color:#27ae60;">Watch Ad (+10 🪙)</button>
                </div>
                <div class="option-card">
                    <h3>Ad Marathon Challenge</h3>
                    <p>Watch 5000 ads to earn a massive 100,000 coin reward!</p>
                    <p><strong id="long-term-ad-progress-display">Progress: 0 / 5000</strong></p>
                    <button id="long-term-ad-btn" class="action-button" style="background-color:#e67e22;">Watch Ad</button>
                </div>
                <div id="tasks-options-container"></div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="video-screen" class="screen scrollable-screen hidden">
            <h2>🎥 Refer & Watch 🎥</h2>
            <div id="video-tasks-container" class="options-container">
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="wallet-screen" class="screen hidden">
            <h2>👛 My Wallet 👛</h2>
            <p>Your current balance is:</p>
            <h1 id="wallet-score">0</h1>
            <p id="rupee-value">Value: ₹0.00 INR</p>
            
            <div id="withdrawal-ad-task-container" class="options-container" style="width: 100%; margin-top: 20px;">
            </div>

            <button id="withdraw-button" class="back-button" style="display: none;">Withdraw All Coins</button>
            
            <button class="back-button" data-screen="game-screen">Back to Game</button>
            <div class="history-container">
                <h3>Withdrawal History</h3>
                <div id="withdrawal-history-list">
                    <p style="text-align: center; font-size: 16px; opacity: 0.7;">No withdrawal history found.</p>
                </div>
            </div>
        </div>

        <div id="airdrop-screen" class="screen hidden">
            <h2>💝 Love Coin Airdrop 💝</h2>
            <p>Your current Love Coin balance:</p>
            <h1 id="love-coin-balance-display" style="color: #ff80ab;">0 💝</h1>
            <div class="option-card">
                <h3>Earn Love Coins</h3>
                <p>Watch a short ad to receive 1 Love Coin instantly!</p>
                <button id="watch-ad-for-love-coin-btn" class="action-button" style="background-color: #e91e63;">Watch Ad (+1 💝)</button>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div class="nav-container">
            <div class="nav-button active" data-screen="game-screen"><span class="nav-icon">🏠</span><span class="nav-text">Home</span></div>
            <div class="nav-button" data-screen="mine-screen"><span class="nav-icon">⛏️</span><span class="nav-text">Mine</span></div>
            <div class="nav-button" data-screen="games-screen"><span class="nav-icon">🎮</span><span class="nav-text">Games</span></div>
            <div class="nav-button" data-screen="tournament-screen"><span class="nav-icon">🏆</span><span class="nav-text">All</span></div>
            <div class="nav-button" data-screen="boost-screen"><span class="nav-icon">🚀</span><span class="nav-text">Boost</span></div>
            <div class="nav-button" data-screen="tasks-screen"><span class="nav-icon">📝</span><span class="nav-text">Tasks</span></div>
            <div class="nav-button" data-screen="video-screen"><span class="nav-icon">🎥</span><span class="nav-text">Video</span></div>
            <div class="nav-button" data-screen="wallet-screen"><span class="nav-icon">👛</span><span class="nav-text">Wallet</span></div>
        </div>
    </div>
    
    <!-- Popups -->
    <div id="notification-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="close-notification-btn">×</span>
            <h3>🔔 Notifications</h3>
            <div id="notification-list">
                <p>No new messages.</p>
            </div>
        </div>
    </div>

    <div id="withdraw-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="popup-close-button">×</span>
            <h3>Withdraw All Coins</h3>
            <p>You are about to withdraw your entire balance:</p>
            <h3 id="popup-withdrawal-amount" style="color: #ffdd57; margin-top: 10px;"></h3>
            <p id="popup-withdrawal-value-inr" style="margin-bottom: 20px;"></p>
            <div class="withdraw-options">
                <input type="text" id="withdrawal-name-input" class="withdraw-input" placeholder="Enter your full name">
                <input type="text" id="withdrawal-upi-input" class="withdraw-input" placeholder="Enter your UPI ID">
                <button id="upi-withdraw-button" class="withdraw-option">Proceed with UPI</button>
            </div>
        </div>
    </div>
    <div id="name-change-popup" class="popup">
        <div class="popup-content">
            <h3>Enter your name:</h3>
            <input type="text" id="new-name-input" class="withdraw-input" placeholder="Enter new name" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-around; margin-top: 25px; gap: 15px;">
                <button id="cancel-name-button" class="action-button" style="background-color: #e74c3c; flex: 1;">CANCEL</button>
                <button id="confirm-name-button" class="action-button" style="background-color: #2ecc71; flex: 1;">OK</button>
            </div>
        </div>
    </div>

    <div id="tournament-join-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="tournament-join-popup-close">×</span>
            <img id="tournament-join-popup-image" src="" alt="Tournament Logo">
            <h3 id="tournament-join-popup-title">Join Tournament</h3>
    
            <div id="tournament-ad-view">
                <p style="font-size: 16px; margin-top: 15px;">You must watch 5 ads to proceed.</p>
                <p>Progress: <strong id="tournament-ad-progress">0 / 5</strong></p>
                <button id="tournament-watch-ad-btn" class="action-button" style="background-color: #f39c12; margin-top: 15px;">Watch Ad</button>
                <button id="tournament-ad-cancel-btn" class="action-button" style="background-color: #e74c3c; margin-top: 10px;">Cancel</button>
            </div>
    
            <div id="tournament-confirm-view" style="display: none;">
                <p>Entry Fee: <strong id="tournament-join-popup-fee">0 🪙</strong></p>
                <p style="font-size: 16px; margin-top: 15px;">Confirm your name to join:</p>
                <input type="text" id="tournament-join-name-input" class="withdraw-input" placeholder="Enter your name">
                <div class="join-popup-buttons">
                    <button id="tournament-join-cancel-btn" class="action-button" style="background-color: #e74c3c; flex: 1;">Cancel</button>
                    <button id="tournament-join-confirm-btn" class="action-button" style="background-color: #f39c12; flex: 1;">Confirm & Join</button>
                </div>
            </div>
        </div>
    </div>

    <div id="flappy-gameOverPopup">
        <div class="flappy-popup-content">
            <h2>Game Over!</h2>
            <p>Pipes Passed: <span id="flappy-finalScore" class="flappy-score-value">0</span></p>
            <button id="flappy-restart-button" class="flappy-action-button">Play Again</button>
        </div>
    </div>

    <audio id="tap-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2b4065a46d.mp3" preload="auto"></audio>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBJrCE4w_QfBqfF3g4O_RuCK4DbjmL9TRg",
          authDomain: "telegram-69052.firebaseapp.com",
          databaseURL: "https://telegram-69052-default-rtdb.firebaseio.com",
          projectId: "telegram-69052",
          storageBucket: "telegram-69052.firebasestorage.app",
          messagingSenderId: "824247387361",
          appId: "1:824247387361:web:f4e6c22abb4b503871a3a0",
          measurementId: "G-GB3LP113V6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'BKC';
            for (let i = 0; i < 3; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function handleIncomingReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                sessionStorage.setItem('referrerCode', refCode);
            }
        }

        function creditReferrer(referralCode) {
            if (!referralCode) return;
            const usersRef = database.ref('Users');
            usersRef.orderByChild('myReferralC').equalTo(referralCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const referrerData = snapshot.val();
                    const referrerId = Object.keys(referrerData)[0];
                    const referrerUserRef = database.ref(`Users/${referrerId}`);
                    referrerUserRef.transaction(userData => {
                        if (userData) {
                            userData.score = (userData.score || 0) + 700;
                            userData.Totalearning = (userData.Totalearning || 0) + 700;
                        }
                        return userData;
                    });
                    console.log(`Credited 700 coins to referrer ${referrerId}`);
                }
            });
        }

        function updateUserPresence(userId) {
            if (!userId) return;
            const userPresenceRef = database.ref('/Users/' + userId + '/presence');
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userPresenceRef.set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    userPresenceRef.onDisconnect().set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                }
            });
        }

        function getOrCreateUserId() {
            let userId = localStorage.getItem('tapGameUserId');
            if (!userId) {
                userId = database.ref().push().key;
                localStorage.setItem('tapGameUserId', userId);
            }
            return userId;
        }
        const userId = getOrCreateUserId();
        
        const flappyGame = {
            canvas: null, ctx: null, scoreValueDisplay: null, startButton: null,
            gameOverPopup: null, popupContent: null, finalScoreDisplay: null, restartButton: null,
            gameRunning: false, score: 0, pipes: [], frameCount: 0, gameLoop: null,
            rewardInterval: null,
            bird: { x: 60, y: 200, radius: 20, gravity: 0.3, lift: -6, velocity: 0 },
            pipe: { width: 55, gap: 160, speed: 2.5 },
            init() { this.canvas = document.getElementById('flappyCanvas'); if (!this.canvas) return; this.ctx = this.canvas.getContext('2d'); this.scoreValueDisplay = document.getElementById('flappy-score-value-display'); this.startButton = document.getElementById('flappy-start-button'); this.gameOverPopup = document.getElementById('flappy-gameOverPopup'); this.popupContent = this.gameOverPopup.querySelector('.flappy-popup-content'); this.finalScoreDisplay = document.getElementById('flappy-finalScore'); this.restartButton = document.getElementById('flappy-restart-button'); this.canvas.addEventListener('click', () => this.jump()); this.startButton.addEventListener('click', () => this.startGame()); this.restartButton.addEventListener('click', () => this.startGame()); this.resetGame(); },
            drawBird() { if(!this.ctx) return; this.ctx.font = '40px sans-serif'; this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle'; this.ctx.shadowColor = 'rgba(0, 0, 0, 0.3)'; this.ctx.shadowBlur = 5; this.ctx.shadowOffsetX = 3; this.ctx.shadowOffsetY = 3; this.ctx.fillText('🐏', this.bird.x, this.bird.y); this.ctx.shadowColor = 'transparent'; },
            drawPipes() { if(!this.ctx) return; this.pipes.forEach(p => { const pipeGradient = this.ctx.createLinearGradient(p.x, 0, p.x + this.pipe.width, 0); pipeGradient.addColorStop(0, '#73C74B'); pipeGradient.addColorStop(1, '#539E31'); this.ctx.fillStyle = pipeGradient; this.ctx.fillRect(p.x, 0, this.pipe.width, p.topHeight); this.ctx.fillRect(p.x, this.canvas.height - p.bottomHeight, this.pipe.width, p.bottomHeight); this.ctx.fillStyle = '#98D972'; this.ctx.fillRect(p.x, p.topHeight - 15, this.pipe.width, 15); this.ctx.fillRect(p.x, this.canvas.height - p.bottomHeight, this.pipe.width, 15); }); },
            updateGame() { this.bird.velocity += this.bird.gravity; this.bird.y += this.bird.velocity; if (this.bird.y + this.bird.radius > this.canvas.height || this.bird.y - this.bird.radius < 0) { this.endGame(); return; } if (this.frameCount % 90 === 0) { const topHeight = Math.random() * (this.canvas.height - this.pipe.gap - 100) + 50; this.pipes.push({ x: this.canvas.width, topHeight: topHeight, bottomHeight: this.canvas.height - topHeight - this.pipe.gap, passed: false }); } for (let i = this.pipes.length - 1; i >= 0; i--) { this.pipes[i].x -= this.pipe.speed; if (this.bird.x + this.bird.radius > this.pipes[i].x && this.bird.x - this.bird.radius < this.pipes[i].x + this.pipe.width) { if (this.bird.y - this.bird.radius < this.pipes[i].topHeight || this.bird.y + this.bird.radius > this.canvas.height - this.pipes[i].bottomHeight) { this.endGame(); return; } } if (this.pipes[i].x + this.pipe.width < this.bird.x && !this.pipes[i].passed) { this.score++; this.scoreValueDisplay.innerText = this.score; this.scoreValueDisplay.classList.add('flappy-score-pulse'); setTimeout(() => this.scoreValueDisplay.classList.remove('flappy-score-pulse'), 300); this.pipes[i].passed = true; } if (this.pipes[i].x + this.pipe.width < 0) { this.pipes.splice(i, 1); } } this.frameCount++; },
            loop() { if (!this.gameRunning) return; this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.updateGame(); this.drawPipes(); this.drawBird(); this.gameLoop = requestAnimationFrame(() => this.loop()); },
            resetGame() { this.score = 0; this.bird.y = 200; this.bird.velocity = 0; this.pipes = []; this.frameCount = 0; if (this.scoreValueDisplay) this.scoreValueDisplay.innerText = `0`; if (this.ctx) { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.drawBird(); } if (this.gameOverPopup) this.gameOverPopup.style.display = 'none'; },
            startGame() { if (this.gameRunning) return; this.resetGame(); this.gameRunning = true; this.startButton.style.display = 'none'; this.rewardInterval = setInterval(() => { if (this.gameRunning) { state.score += 50; updateDisplay(); saveGame({ score: state.score }); } }, 10000); this.loop(); },
            endGame() {
                if (!this.gameRunning) return;
                window.open('https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315', '_blank');
                this.gameRunning = false;
                cancelAnimationFrame(this.gameLoop);
                if (this.rewardInterval) { clearInterval(this.rewardInterval); this.rewardInterval = null; }
                this.finalScoreDisplay.innerText = this.score;
                this.gameOverPopup.style.display = 'flex';
                this.startButton.style.display = 'block';
                this.startButton.innerText = 'Play Again';
            },
            jump() { if (this.gameRunning) { this.bird.velocity = this.bird.lift; } else if (!this.gameOverPopup.style.display || this.gameOverPopup.style.display === 'none') { this.startGame(); } }
        };

        const videoAdTasks = [
            { id: 'videoTask1', title: 'Starter Video Pack', description: 'Watch 20 videos to earn 900 coins.', goal: 20, reward: 900, url: 'https://www.profitableratecpm.com/qshhszvnad?key=4761223a00e52bd9f2e24d515e6be228' },
            { id: 'videoTask2', title: 'Video Marathon', description: 'Watch 80 videos to earn 5,000 coins.', goal: 80, reward: 5000, url: 'https://www.profitableratecpm.com/vibjgr90?key=2731d0788209fe1d948dd17fd0e0831f' },
            { id: 'videoTask3', title: 'Ultimate Video Challenge', description: 'Watch 3000 videos to earn 35,000 coins.', goal: 3000, reward: 35000, url: 'https://www.profitableratecpm.com/u745rvnfy?key=f5ec06ad491fd1ceab3af658fd2d3010' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            updateUserPresence(userId);

            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 3000);

            const elements = {
                gameScreen: document.getElementById('game-screen'), profileSection: document.getElementById('profile-section'), playerNameDisplay: document.getElementById('player-name-display'),
                coinContainer: document.getElementById('coin-container'), coinCss: document.getElementById('coin-css'), scoreDisplay: document.getElementById('score-display'),
                energyText: document.getElementById('energy-text'), energyBarFill: document.getElementById('energy-bar-fill'), screens: document.querySelectorAll('.screen'),
                navButtons: document.querySelectorAll('.nav-button'), walletScore: document.getElementById('wallet-score'), levelDisplay: document.getElementById('level-display'),
                rupeeValue: document.getElementById('rupee-value'), withdrawButton: document.getElementById('withdraw-button'), withdrawPopup: document.getElementById('withdraw-popup'),
                popupCloseButton: document.getElementById('popup-close-button'), upiWithdrawButton: document.getElementById('upi-withdraw-button'),
                popupWithdrawalAmount: document.getElementById('popup-withdrawal-amount'), popupWithdrawalValueInr: document.getElementById('popup-withdrawal-value-inr'),
                withdrawalNameInput: document.getElementById('withdrawal-name-input'), withdrawalUpiInput: document.getElementById('withdrawal-upi-input'),
                boostTap1Button: document.getElementById('boost-tap-1'), boostTap2Button: document.getElementById('boost-tap-2'), boostTap3Button: document.getElementById('boost-tap-3'),
                headsButton: document.getElementById('heads-button'), tailsButton: document.getElementById('tails-button'), flipResult: document.getElementById('flip-result'),
                betSelectionContainer: document.getElementById('bet-selection-container'), tapSound: document.getElementById('tap-sound'), withdrawalHistoryList: document.getElementById('withdrawal-history-list'),
                nameChangePopup: document.getElementById('name-change-popup'), newNameInput: document.getElementById('new-name-input'),
                confirmNameButton: document.getElementById('confirm-name-button'), cancelNameButton: document.getElementById('cancel-name-button'),
                tasksOptionsContainer: document.getElementById('tasks-options-container'),
                watchAdFor40CoinsBtn: document.getElementById('watch-ad-for-40-coins-btn'),
                longTermAdBtn: document.getElementById('long-term-ad-btn'),
                longTermAdProgressDisplay: document.getElementById('long-term-ad-progress-display'),
                videoTasksContainer: document.getElementById('video-tasks-container'),
                withdrawalAdTaskContainer: document.getElementById('withdrawal-ad-task-container'),
                watchAdButton: document.getElementById('watch-ad-button'),
                startMiningButton: document.getElementById('start-mining-button'),
                claimMineButton: document.getElementById('claim-mine-button'),
                miningPickaxeIcon: document.getElementById('mining-pickaxe-icon'),
                miningRateDisplay: document.getElementById('mining-rate-display'),
                miningAdsWatchedDisplay: document.getElementById('mining-ads-watched-display'),
                miningTimerDisplay: document.getElementById('mining-timer-display'),
                notificationBell: document.getElementById('notification-bell'),
                notificationDot: document.getElementById('notification-dot'),
                notificationPopup: document.getElementById('notification-popup'),
                notificationList: document.getElementById('notification-list'),
                closeNotificationBtn: document.getElementById('close-notification-btn'),
                energyTimerDisplay: document.getElementById('energy-timer-display'),
                fastEnergyRecoveryBtn: document.getElementById('fast-energy-recovery-btn'),
                tournamentScreen: document.getElementById('tournament-screen'),
                tournamentListContainer: document.getElementById('tournament-list-container'),
                tournamentJoinPopup: document.getElementById('tournament-join-popup'),
                tournamentJoinPopupClose: document.getElementById('tournament-join-popup-close'),
                tournamentJoinPopupImage: document.getElementById('tournament-join-popup-image'),
                tournamentJoinPopupTitle: document.getElementById('tournament-join-popup-title'),
                tournamentJoinPopupFee: document.getElementById('tournament-join-popup-fee'),
                tournamentJoinNameInput: document.getElementById('tournament-join-name-input'),
                tournamentJoinCancelBtn: document.getElementById('tournament-join-cancel-btn'),
                tournamentJoinConfirmBtn: document.getElementById('tournament-join-confirm-btn'),
                tournamentAdView: document.getElementById('tournament-ad-view'),
                tournamentConfirmView: document.getElementById('tournament-confirm-view'),
                tournamentAdProgress: document.getElementById('tournament-ad-progress'),
                tournamentWatchAdBtn: document.getElementById('tournament-watch-ad-btn'),
                tournamentAdCancelBtn: document.getElementById('tournament-ad-cancel-btn'),
                airdropButton: document.getElementById('airdrop-button'),
                airdropScreen: document.getElementById('airdrop-screen'),
                loveCoinBalanceDisplay: document.getElementById('love-coin-balance-display'),
                watchAdForLoveCoinBtn: document.getElementById('watch-ad-for-love-coin-btn'),
            };

            let state = {
                score: 0, playerName: 'Player', currentLevel: 1, tapPower: 1, tapUpgradeLevel: 0,
                maxEnergy: 1000, currentEnergy: 1000,
                myReferralC: null, referredBy: null,
                videoTask1Progress: 0, videoTask2Progress: 0, videoTask3Progress: 0,
                videoTask1Claimed: false, videoTask2Claimed: false, videoTask3Claimed: false,
                withdrawalAdClicks: 0,
                isAdTimerActive: false,
                miningAdsWatched: 0,
                miningSessionTier: 0, 
                miningStartTime: 0,
                miningEndTime: 0,
                tapCounter: 0,
                longTermAdProgress: 0,
                longTermAdClaimed: false,
                messages: [],
                energyDepletedTime: 0,
                energyRecoveryDuration: 0, 
                fastRecoveryAdsWatched: 0,
                loveCoins: 0,
                joinedTournaments: {},
            };
            
            let currentBetAmount = 100;
            let isAdBoostActive = false;

            let currentTournamentJoinProcess = {
                details: null,
                adsWatched: 0,
                adsRequired: 5,
                adUrl: 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6'
            };

            // **** MODIFIED FUNCTION: loadAndDisplayTournaments ****
            function loadAndDisplayTournaments() {
                const tournamentsRef = database.ref('tournaments');
                elements.tournamentListContainer.innerHTML = ''; // Clear previous cards

                tournamentsRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const initialTournamentData = childSnapshot.val();
                            const tournamentId = childSnapshot.key;
                            
                            if (initialTournamentData.isActive) {
                                const card = document.createElement('div');
                                card.className = 'tournament-card';
                                card.id = `tournament-card-${tournamentId}`; // Give the card a unique ID
                                
                                const entryFeeText = initialTournamentData.entryFee > 0 ? `${initialTournamentData.entryFee.toLocaleString()} 🪙` : 'Free';
                                const defaultLogoUrl = 'https://dummyimage.com/60x60/2c3e50/ffffff&text=Logo';
                                const finalImageUrl = initialTournamentData.imageUrl || defaultLogoUrl;
                                const dateInfo = initialTournamentData.date || 'TBA';
                                const timeInfo = initialTournamentData.time ? new Date(`1970-01-01T${initialTournamentData.time}`).toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';

                                card.innerHTML = `
                                    <div class="tournament-card-header">
                                        <img src="${finalImageUrl}" alt="Game Logo" class="tournament-card-logo" onerror="this.onerror=null; this.src='${defaultLogoUrl}';">
                                        <div class="tournament-card-title">
                                            <h3>${initialTournamentData.title || 'Untitled Tournament'}</h3>
                                            <p>${initialTournamentData.game || 'Special Event'}</p>
                                        </div>
                                    </div>
                                    <p><strong>Prize Pool:</strong> ${initialTournamentData.prizePool || 'TBA'}</p>
                                    <p><strong>Entry Fee:</strong> ${entryFeeText}</p>
                                    <p><strong>Date & Time:</strong> ${dateInfo} at ${timeInfo}</p>
                                    <p><strong>Rules:</strong> ${initialTournamentData.rules || 'Follow standard rules.'}</p>
                                    
                                    <!-- NEW: Container for Room Info -->
                                    <div id="room-info-${tournamentId}" class="room-info-container" style="display: none;"></div>

                                    <div id="participants-${tournamentId}" class="participant-display-container"></div>
                                    <div id="prize-status-${tournamentId}"></div> 

                                    <button class="join-button"
                                        id="join-button-${tournamentId}"
                                        data-id="${tournamentId}"
                                        data-title="${initialTournamentData.title || 'Tournament'}"
                                        data-fee="${initialTournamentData.entryFee || 0}"
                                        data-link="${initialTournamentData.joinLink || '#'}"
                                        data-image="${initialTournamentData.imageUrl || ''}">
                                        Join Now
                                    </button>
                                `;
                                
                                elements.tournamentListContainer.appendChild(card);

                                // Set up a real-time listener for this specific tournament
                                const singleTournamentRef = database.ref(`tournaments/${tournamentId}`);
                                singleTournamentRef.on('value', tournamentSnapshot => {
                                    const tournamentData = tournamentSnapshot.val();
                                    if (!tournamentData) return;

                                    // Get references to this card's specific elements
                                    const currentCard = document.getElementById(`tournament-card-${tournamentId}`);
                                    const joinButton = document.getElementById(`join-button-${tournamentId}`);
                                    const roomInfoContainer = document.getElementById(`room-info-${tournamentId}`);
                                    const participantsContainer = document.getElementById(`participants-${tournamentId}`);
                                    const prizeStatusContainer = document.getElementById(`prize-status-${tournamentId}`);
                                    if (!currentCard || !joinButton || !roomInfoContainer || !participantsContainer) return;
                                    
                                    // ---- LOGIC FOR FINISHED STATE & ROOM INFO ----

                                    let isFinished = false;
                                    if (tournamentData.winningTeam || (tournamentData.participants && Object.values(tournamentData.participants).some(p => p.isWinner))) {
                                        isFinished = true;
                                    }

                                    const hasJoined = state.joinedTournaments && state.joinedTournaments[tournamentId];

                                    if (isFinished) {
                                        joinButton.innerText = 'Tournament Finished';
                                        joinButton.disabled = true;
                                        currentCard.classList.add('finished');
                                        roomInfoContainer.style.display = 'none'; // Hide room info when finished
                                    } else {
                                        currentCard.classList.remove('finished');
                                        joinButton.innerText = hasJoined ? 'Joined! Good Luck!' : 'Join Now';
                                        joinButton.disabled = hasJoined;

                                        if (hasJoined) {
                                            // Player has joined and tournament is NOT finished, show room info
                                            const roomId = tournamentData.roomId || 'TBA';
                                            const roomPass = tournamentData.roomPassword || 'TBA';
                                            roomInfoContainer.innerHTML = `
                                                <h4>Room Credentials</h4>
                                                <p><strong>Room ID:</strong> ${roomId}</p>
                                                <p><strong>Password:</strong> ${roomPass}</p>
                                            `;
                                            roomInfoContainer.style.display = 'block';
                                        } else {
                                            roomInfoContainer.style.display = 'none';
                                        }
                                    }

                                    // --- EXISTING LOGIC FOR PARTICIPANT & PRIZE DISPLAY ---
                                    
                                    if (tournamentData.prizeAwarded) {
                                        prizeStatusContainer.innerHTML = `<div class="prize-distributed-message">🏆 Prize Distributed! 🏆</div>`;
                                    } else {
                                        prizeStatusContainer.innerHTML = '';
                                    }
                                    
                                    const participants = tournamentData.participants || {};
                                    const participantEntries = Object.entries(participants);

                                    if (participantEntries.length > 0) {
                                        if (tournamentData.minPlayers === 4) {
                                            const winningTeam = tournamentData.winningTeam || null;
                                            const team1 = participantEntries.filter((e, i) => i % 2 === 0);
                                            const team2 = participantEntries.filter((e, i) => i % 2 !== 0);
                                            const team1Html = team1.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            const team2Html = team2.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            participantsContainer.innerHTML = `
                                                <ul class="team-list"><h4>Team A ${winningTeam === 1 ? '🏆' : ''}</h4>${team1Html}</ul>
                                                <div class="vs-separator">VS</div>
                                                <ul class="team-list"><h4>Team B ${winningTeam === 2 ? '🏆' : ''}</h4>${team2Html}</ul>`;
                                        } else {
                                            const participantHtml = participantEntries.map(([userId, playerData]) => {
                                                const winnerIcon = playerData.isWinner ? '🏆 ' : '';
                                                const winnerClass = playerData.isWinner ? 'winner' : '';
                                                return `<li class="participant-item ${winnerClass}"><strong>${winnerIcon}${playerData.name}</strong></li>`;
                                            }).join('');
                                            participantsContainer.innerHTML = `<ul class="team-list" style="width:100%;">${participantHtml}</ul>`;
                                        }
                                        participantsContainer.style.display = 'flex';
                                    } else {
                                        participantsContainer.style.display = 'none';
                                    }
                                });
                            }
                        });
                    }
                }).catch(error => {
                    console.error("Error loading tournaments: ", error);
                    elements.tournamentListContainer.innerHTML += '<p style="text-align:center; color: red;">Could not load events. Please try again later.</p>';
                });
            }

            function initiateTournamentJoinProcess(details) {
                currentTournamentJoinProcess.details = details;
                currentTournamentJoinProcess.adsWatched = 0;
                elements.tournamentJoinPopupTitle.innerText = details.title;
                elements.tournamentJoinPopupImage.src = details.image || 'https://via.placeholder.com/80';
                elements.tournamentAdProgress.innerText = `0 / ${currentTournamentJoinProcess.adsRequired}`;
                elements.tournamentWatchAdBtn.disabled = false;
                elements.tournamentWatchAdBtn.innerText = 'Watch Ad';
                elements.tournamentAdView.style.display = 'block';
                elements.tournamentConfirmView.style.display = 'none';
                elements.tournamentJoinPopup.style.display = 'flex';
            }
            
            elements.tournamentListContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('join-button') && !e.target.disabled) {
                    const button = e.target;
                    const tournamentDetails = {
                        id: button.dataset.id,
                        title: button.dataset.title,
                        fee: button.dataset.fee,
                        link: button.dataset.link,
                        image: button.dataset.image
                    };
                    initiateTournamentJoinProcess(tournamentDetails);
                }
            });

            elements.tournamentWatchAdBtn.addEventListener('click', () => {
                const button = elements.tournamentWatchAdBtn;
                if (state.isAdTimerActive) {
                    alert("Please wait for the current ad timer to finish.");
                    return;
                }
                state.isAdTimerActive = true;
                window.open(currentTournamentJoinProcess.adUrl, '_blank');
                button.disabled = true;
                let countdown = 15;
                button.innerText = `Wait (${countdown}s)`;
                const adInterval = setInterval(() => {
                    countdown--;
                    button.innerText = `Wait (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(adInterval);
                        state.isAdTimerActive = false;
                        button.disabled = false;
                        button.innerText = 'Watch Ad';
                        currentTournamentJoinProcess.adsWatched++;
                        elements.tournamentAdProgress.innerText = `${currentTournamentJoinProcess.adsWatched} / ${currentTournamentJoinProcess.adsRequired}`;
                        if (currentTournamentJoinProcess.adsWatched >= currentTournamentJoinProcess.adsRequired) {
                            elements.tournamentAdView.style.display = 'none';
                            const details = currentTournamentJoinProcess.details;
                            elements.tournamentJoinPopupFee.innerText = `${parseInt(details.fee).toLocaleString()} 🪙`;
                            elements.tournamentJoinNameInput.value = state.playerName;
                            elements.tournamentConfirmView.style.display = 'block';
                        }
                    }
                }, 1000);
            });
            
            elements.tournamentJoinConfirmBtn.addEventListener('click', () => {
                const details = currentTournamentJoinProcess.details;
                const tournamentId = details.id;
                const entryFee = parseInt(details.fee, 10);
                const joinLink = details.link;
                const newName = elements.tournamentJoinNameInput.value.trim();
                if (!newName) {
                    alert('Please enter your name to join.'); return;
                }
                if (state.score < entryFee) {
                    alert(`Not enough coins! You need ${entryFee.toLocaleString()} 🪙 to join.`); return;
                }
                state.score -= entryFee;
                if (state.playerName !== newName) {
                    state.playerName = newName;
                }
                if (!state.joinedTournaments) state.joinedTournaments = {};
                state.joinedTournaments[tournamentId] = true;
                const dataToSave = {
                    score: state.score, Totalearning: state.score, Name: state.playerName, joinedTournaments: state.joinedTournaments
                };
                const participantData = {
                    name: newName, joinTime: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref(`tournaments/${tournamentId}/participants/${userId}`).set(participantData);
                saveGame(dataToSave);
                updatePlayerNameDisplay();
                updateDisplay();
                alert(`Successfully joined! Fee of ${entryFee.toLocaleString()} 🪙 has been paid. The event password will be shared on our Telegram channel. Redirecting you...`);
                elements.tournamentJoinPopup.style.display = 'none';
                if (joinLink && joinLink !== '#') {
                    window.open(joinLink, '_blank');
                }
            });

            function closeTournamentPopup() {
                elements.tournamentJoinPopup.style.display = 'none';
                currentTournamentJoinProcess.details = null;
            }

            elements.tournamentJoinCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentAdCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentJoinPopupClose.addEventListener('click', closeTournamentPopup);

            // --- ALL OTHER JAVASCRIPT FUNCTIONS (UNCHANGED) GO HERE ---
            // (The rest of the JS code is identical to what you provided)
            const MINE_AD_URL = 'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44';
            const MINING_TIERS = {
                0: { ads: 0, totalReward: 0, duration: 0 },
                1: { ads: 1, totalReward: 50, duration: 1 * 60 * 60 * 1000 },
                2: { ads: 2, totalReward: 100, duration: 1 * 60 * 60 * 1000 },
                3: { ads: 20, totalReward: 2000, duration: 3 * 60 * 60 * 1000 },
            };
            function getEligibleMiningTier() {
                if (state.miningAdsWatched >= MINING_TIERS[3].ads) return 3;
                if (state.miningAdsWatched >= MINING_TIERS[2].ads) return 2;
                if (state.miningAdsWatched >= MINING_TIERS[1].ads) return 1;
                return 0;
            }
            function resetMiningState() {
                state.miningAdsWatched = 0; state.miningSessionTier = 0; state.miningStartTime = 0; state.miningEndTime = 0;
                saveGame({ miningAdsWatched: 0, miningSessionTier: 0, miningStartTime: 0, miningEndTime: 0 });
            }
            function renderMineScreen() {
                const now = Date.now();
                const isSessionActive = state.miningStartTime > 0;
                if (isSessionActive) {
                    const isClaimable = now >= state.miningEndTime;
                    elements.watchAdButton.style.display = 'none';
                    elements.startMiningButton.style.display = 'none';
                    if (isClaimable) {
                        elements.miningPickaxeIcon.classList.remove('swinging');
                        elements.claimMineButton.style.display = 'block';
                        elements.claimMineButton.disabled = false;
                        const tierInfo = MINING_TIERS[state.miningSessionTier];
                        elements.claimMineButton.innerText = `Claim ${tierInfo.totalReward.toLocaleString()} 🪙`;
                    } else {
                        elements.miningPickaxeIcon.classList.add('swinging');
                        elements.claimMineButton.style.display = 'block';
                        elements.claimMineButton.disabled = true;
                        elements.claimMineButton.innerText = 'Mining...';
                    }
                } else { 
                    elements.miningPickaxeIcon.classList.remove('swinging');
                    elements.claimMineButton.style.display = 'none';
                    elements.watchAdButton.style.display = 'block';
                    elements.watchAdButton.disabled = false;
                    const eligibleTier = getEligibleMiningTier();
                    let nextTierGoal = 1;
                    if (eligibleTier === 1) nextTierGoal = 2;
                    else if (eligibleTier === 2) nextTierGoal = 20;
                    if (eligibleTier >= 3) {
                         elements.watchAdButton.innerText = 'Max Tier Reached';
                         elements.watchAdButton.disabled = true;
                    } else {
                         elements.watchAdButton.innerText = `Watch Ad (${state.miningAdsWatched}/${nextTierGoal})`;
                    }
                    if (state.miningAdsWatched > 0) {
                        elements.startMiningButton.style.display = 'block';
                    } else {
                        elements.startMiningButton.style.display = 'none';
                    }
                }
                const eligibleTier = getEligibleMiningTier();
                const tierInfo = MINING_TIERS[eligibleTier];
                elements.miningRateDisplay.innerText = `+${tierInfo.totalReward.toLocaleString()} 🪙`;
                elements.miningAdsWatchedDisplay.innerText = state.miningAdsWatched;
                updateMiningTimerDisplay();
            }
            function updateMiningTimerDisplay() {
                if (state.miningStartTime === 0) {
                    elements.miningTimerDisplay.innerText = "Inactive"; return;
                }
                const now = Date.now();
                if (now >= state.miningEndTime) {
                    elements.miningTimerDisplay.innerText = "Finished!"; return;
                }
                const remaining = state.miningEndTime - now;
                const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                const minutes = Math.floor((remaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                const seconds = Math.floor((remaining / 1000) % 60).toString().padStart(2, '0');
                const elapsed = now - state.miningStartTime;
                const duration = state.miningEndTime - state.miningStartTime;
                const progress = elapsed / duration;
                const accumulated = MINING_TIERS[state.miningSessionTier].totalReward * progress;
                elements.miningTimerDisplay.innerText = `${Math.floor(accumulated).toLocaleString()} 🪙 / ${hours}:${minutes}:${seconds}`;
            }
            elements.watchAdButton.addEventListener('click', () => {
                if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                state.isAdTimerActive = true;
                window.open(MINE_AD_URL, '_blank');
                elements.watchAdButton.disabled = true;
                let countdown = 10;
                elements.watchAdButton.innerText = `Wait (${countdown}s)`;
                const adInterval = setInterval(() => {
                    countdown--;
                    elements.watchAdButton.innerText = `Wait (${countdown}s)`;
                    if(countdown <= 0) {
                        clearInterval(adInterval);
                        state.isAdTimerActive = false;
                        state.miningAdsWatched++;
                        saveGame({ miningAdsWatched: state.miningAdsWatched });
                        renderMineScreen();
                    }
                }, 1000);
            });
            elements.startMiningButton.addEventListener('click', () => {
                const eligibleTier = getEligibleMiningTier();
                if (eligibleTier === 0) {
                    alert("You must watch at least one ad to start mining!"); return;
                }
                const tierInfo = MINING_TIERS[eligibleTier];
                state.miningSessionTier = eligibleTier;
                state.miningStartTime = Date.now();
                state.miningEndTime = state.miningStartTime + tierInfo.duration;
                saveGame({
                    miningSessionTier: state.miningSessionTier, miningStartTime: state.miningStartTime, miningEndTime: state.miningEndTime,
                });
                renderMineScreen();
            });
            elements.claimMineButton.addEventListener('click', () => {
                const now = Date.now();
                if (state.miningStartTime > 0 && now >= state.miningEndTime) {
                    const tierInfo = MINING_TIERS[state.miningSessionTier];
                    const claimedAmount = tierInfo.totalReward;
                    state.score += claimedAmount;
                    alert(`You claimed ${claimedAmount.toLocaleString()} coins!`);
                    updateDisplay();
                    resetMiningState(); 
                    renderMineScreen();
                }
            });
            function renderVideoTasks() {
                const container = elements.videoTasksContainer;
                container.innerHTML = '';
                const specialAdCard = document.createElement('div');
                specialAdCard.className = 'option-card';
                specialAdCard.innerHTML = `<h3>Special Offer (18+)</h3><p>Watch a special video to earn a <strong>40 🪙</strong> reward!</p><button id="watch-18plus-ad-btn" class="action-button" style="background-color:#c0392b;">18+</button>`;
                container.appendChild(specialAdCard);
                if (state.myReferralC) {
                    const referralCard = document.createElement('div');
                    referralCard.className = 'option-card';
                    referralCard.innerHTML = `<h3>🤝 Refer a Friend</h3><p>Share your link! You get <strong>700 🪙</strong> automatically when your friend joins. Your friend gets a 500 🪙 bonus!</p><p style="font-size: 14px; margin-bottom: 10px;">Your Code: <strong>${state.myReferralC}</strong></p><button id="copy-referral-link-button" class="action-button" style="background-color: #0088cc;">Copy Invite Link</button>`;
                    container.appendChild(referralCard);
                }
                videoAdTasks.forEach(task => {
                    const progress = state[task.id + 'Progress'] || 0;
                    const isClaimed = state[task.id + 'Claimed'] || false;
                    const isComplete = progress >= task.goal;
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    let buttonHtml;
                    if (isClaimed) {
                         buttonHtml = `<button class="action-button" disabled>Claimed ✅</button>`;
                    } else if (isComplete) {
                        buttonHtml = `<button class="action-button claim-video-reward-button" data-task-id="${task.id}" style="background-color: #2ecc71;">Claim ${task.reward.toLocaleString()} 🪙</button>`;
                    } else {
                        buttonHtml = `<button class="action-button video-task-button" data-task-id="${task.id}">Watch Video</button>`;
                    }
                    card.innerHTML = `<h3>${task.title}</h3><p>${task.description}</p><p><strong>Progress: ${progress} / ${task.goal}</strong></p>${buttonHtml}`;
                    container.appendChild(card);
                });
            }
            elements.videoTasksContainer.addEventListener('click', (e) => {
                const button = e.target;
                if (button.id === 'watch-18plus-ad-btn') {
                    if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                    state.isAdTimerActive = true;
                    window.open('https://www.profitableratecpm.com/uhnqngyf?key=d467c8e5498339a61ae6addd69e30d9e', '_blank');
                    button.disabled = true;
                    let countdown = 30; 
                    const originalText = button.innerText;
                    button.innerText = `Wait (${countdown}s)`;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        button.innerText = `Wait (${countdown}s)`;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            state.score += 40; 
                            updateDisplay();
                            saveGame({ score: state.score, Totalearning: state.score });
                            alert("You earned 40 coins!");
                            button.disabled = false;
                            button.innerText = originalText;
                            state.isAdTimerActive = false;
                        }
                    }, 1000);
                }
                if (button.id === 'copy-referral-link-button') {
                    const webReferralLink = `${window.location.origin}${window.location.pathname}?ref=${state.myReferralC}`;
                    navigator.clipboard.writeText(webReferralLink).then(() => {
                        alert('Invite link copied to your clipboard!');
                    }).catch(err => {
                        alert('Could not copy the link.');
                    });
                }
                if (button.classList.contains('video-task-button')) {
                    if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                    const taskId = button.dataset.taskId;
                    const task = videoAdTasks.find(t => t.id === taskId);
                    if (!task) return;
                    state.isAdTimerActive = true;
                    window.open(task.url, '_blank');
                    button.disabled = true;
                    let countdown = 10;
                    button.innerText = `Wait (${countdown}s)`;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        button.innerText = `Wait (${countdown}s)`;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            state[taskId + 'Progress']++;
                            saveGame({ [taskId + 'Progress']: state[taskId + 'Progress'] });
                            renderVideoTasks(); 
                            state.isAdTimerActive = false;
                        }
                    }, 1000);
                }
                if (button.classList.contains('claim-video-reward-button')) {
                    const taskId = button.dataset.taskId;
                    const task = videoAdTasks.find(t => t.id === taskId);
                    if (!task || state[taskId + 'Claimed']) return;
                    state.score += task.reward;
                    state[taskId + 'Claimed'] = true;
                    alert(`Congratulations! You have claimed ${task.reward.toLocaleString()} coins! 🎉`);
                    saveGame({ score: state.score, [taskId + 'Claimed']: true });
                    updateDisplay();
                    renderVideoTasks();
                }
            });
            function loadAndDisplayOffers() {
                const offersRef = database.ref('promotions');
                elements.tasksOptionsContainer.innerHTML = '';
                offersRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const promo = childSnapshot.val();
                            if (promo.isActive) {
                                const card = document.createElement('div');
                                card.className = 'option-card clickable';
                                card.innerHTML = `<h3>${promo.title}</h3><p>${promo.text}</p>${promo.imageUrl ? `<img src="${promo.imageUrl}" alt="Offer Image">` : ''}`;
                                card.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (promo.action === 'watchAd') { triggerWatchAd(card); } 
                                    else if (promo.linkUrl && promo.linkUrl !== '#') { window.open(promo.linkUrl, '_blank'); }
                                });
                                elements.tasksOptionsContainer.appendChild(card);
                            }
                        });
                    } else {
                        elements.tasksOptionsContainer.innerHTML = '<p>No active offers right now. Check back later!</p>';
                    }
                });
            }
            function triggerWatchAd(cardElement) {
                if (isAdBoostActive) { alert("A boost is already active! Please wait."); return; }
                isAdBoostActive = true;
                const originalText = cardElement.querySelector('p').innerText;
                cardElement.style.pointerEvents = 'none';
                let countdown = 10;
                cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        isAdBoostActive = false;
                        cardElement.style.pointerEvents = 'auto';
                        cardElement.querySelector('p').innerText = originalText;
                        alert("Ad boost has ended!");
                    }
                }, 1000);
            }
            function renderWithdrawalHistory() {
                const historyList = elements.withdrawalHistoryList;
                historyList.innerHTML = '<p style="text-align: center; font-size: 16px; opacity: 0.7;">Loading history...</p>';
                const historyRef = database.ref(`withdrawals/${userId}`);
                historyRef.once('value', (snapshot) => {
                    historyList.innerHTML = '';
                    if (!snapshot.exists()) {
                        historyList.innerHTML = '<p style="text-align: center; font-size: 16px; opacity: 0.7;">No withdrawal history found.</p>';
                        return;
                    }
                    snapshot.forEach((childSnapshot) => {
                        const item = childSnapshot.val();
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'history-item';
                        const amountInRupees = (item.amount / 1000).toFixed(2);
                        const recipientInfo = item.name ? `${item.name} (${item.upiId})` : item.upiId;
                        itemDiv.innerHTML = `<div class="history-item-details"><strong>${item.amount.toLocaleString()} 🪙</strong> (₹${amountInRupees})<br><span style="font-size:14px; opacity: 0.8;">To: ${recipientInfo}</span></div><div class="history-item-meta"><span>${item.date}</span><span class="status status-${item.status.toLowerCase()}">${item.status}</span></div>`;
                        historyList.prepend(itemDiv);
                    });
                });
            }
            function renderWalletScreen() {
                elements.walletScore.innerText = state.score.toLocaleString();
                const rupeeValue = (state.score / 1000).toFixed(2);
                elements.rupeeValue.innerText = `Value: ₹${rupeeValue} INR`;

                const goal = 20; 
                if (state.withdrawalAdClicks >= goal) {
                    elements.withdrawalAdTaskContainer.style.display = 'none';
                    elements.withdrawButton.style.display = 'block';
                } else {
                    elements.withdrawalAdTaskContainer.style.display = 'flex';
                    elements.withdrawButton.style.display = 'none';
                    elements.withdrawalAdTaskContainer.innerHTML = `
                        <div class="option-card">
                            <h3>Unlock Withdrawals</h3>
                            <p>Watch 20 ads to enable the withdrawal button.</p>
                            <p><strong>Progress: ${state.withdrawalAdClicks} / ${goal}</strong></p>
                            <button id="watch-ad-for-withdrawal" class="action-button">Watch Ad</button>
                        </div>
                    `;
                }
                renderWithdrawalHistory();
            }
            function renderLongTermAdTask() {
                elements.longTermAdProgressDisplay.innerHTML = `<strong>Progress: ${state.longTermAdProgress} / 5000</strong>`;
                const button = elements.longTermAdBtn;

                if (state.longTermAdClaimed) {
                    button.innerText = "Claimed ✅";
                    button.disabled = true;
                    button.classList.remove('claim-button');
                } else if (state.longTermAdProgress >= 5000) {
                    button.innerText = "Claim 100,000 🪙";
                    button.disabled = false;
                    button.classList.add('claim-button');
                } else {
                    button.innerText = "Watch Ad";
                    button.disabled = false;
                    button.classList.remove('claim-button');
                }
            }
            elements.withdrawalAdTaskContainer.addEventListener('click', (e) => {
                if(e.target.id === 'watch-ad-for-withdrawal') {
                    if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                    state.isAdTimerActive = true;
                    window.open('https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315', '_blank');
                    const button = e.target;
                    button.disabled = true;
                    let countdown = 10;
                    button.innerText = `Wait (${countdown}s)`;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        button.innerText = `Wait (${countdown}s)`;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            state.withdrawalAdClicks++;
                            saveGame({ withdrawalAdClicks: state.withdrawalAdClicks });
                            renderWalletScreen(); 
                            state.isAdTimerActive = false;
                        }
                    }, 1000);
                }
            });
            elements.watchAdFor40CoinsBtn.addEventListener('click', () => {
                if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                state.isAdTimerActive = true;
                
                const adUrlFor40Coins = 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6';
                window.open(adUrlFor40Coins, '_blank');

                const button = elements.watchAdFor40CoinsBtn;
                button.disabled = true;
                let countdown = 35; 
                button.innerText = `Wait (${countdown}s)`;

                const countdownInterval = setInterval(() => {
                    countdown--;
                    button.innerText = `Wait (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        state.score += 10; 
                        updateDisplay();
                        saveGame({ score: state.score, Totalearning: state.score });
                        alert("You earned 10 coins!");
                        button.disabled = false;
                        button.innerText = "Watch Ad (+10 🪙)";
                        state.isAdTimerActive = false;
                    }
                }, 1000);
            });
            elements.longTermAdBtn.addEventListener('click', () => {
                if(state.longTermAdClaimed) return;

                if (state.longTermAdProgress >= 5000) {
                    state.score += 100000;
                    state.longTermAdClaimed = true;
                    saveGame({ score: state.score, Totalearning: state.score, longTermAdClaimed: true });
                    alert("Congratulations! You've earned 100,000 coins! 🎉");
                    updateDisplay();
                    renderLongTermAdTask();
                    return;
                }

                if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                state.isAdTimerActive = true;

                const adUrlForMarathon = 'https://www.profitableratecpm.com/d4cku5ewnn?key=a29645f253b4d6eb62da85d3f5105d02';
                window.open(adUrlForMarathon, '_blank');

                const button = elements.longTermAdBtn;
                button.disabled = true;
                let countdown = 30;
                button.innerText = `Wait (${countdown}s)`;
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    button.innerText = `Wait (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        state.longTermAdProgress++;
                        saveGame({ longTermAdProgress: state.longTermAdProgress });
                        renderLongTermAdTask();
                        state.isAdTimerActive = false;
                    }
                }, 1000);
            });
            function showNotifications() {
                elements.notificationDot.classList.remove('visible');
                const list = elements.notificationList;
                list.innerHTML = '';

                if (state.messages.length === 0) {
                    list.innerHTML = '<p>No new messages.</p>';
                } else {
                    state.messages.forEach(msg => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.textContent = msg.text;
                        list.appendChild(item);
                    });
                }
                elements.notificationPopup.style.display = 'flex';
            }
            function closeAndClearNotifications() {
                elements.notificationPopup.style.display = 'none';
                if (state.messages.length > 0) {
                    const updates = {};
                    state.messages.forEach(msg => {
                        updates[`/Users/${userId}/messages/${msg.key}`] = null;
                    });
                    database.ref().update(updates);
                    state.messages = [];
                }
            }
            elements.notificationBell.addEventListener('click', showNotifications);
            elements.closeNotificationBtn.addEventListener('click', closeAndClearNotifications);
            function showScreen(screenId) {
                const previouslyActiveScreen = document.querySelector('.screen:not(.hidden)');
                if (previouslyActiveScreen && previouslyActiveScreen.id === 'games-screen' && screenId !== 'games-screen') {
                    if (flappyGame.gameRunning) { flappyGame.endGame(); }
                }
                elements.screens.forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.nav-button[data-screen]').forEach(b => b.classList.remove('active'));
                
                const targetScreen = document.getElementById(screenId);
                if(targetScreen) {
                    targetScreen.classList.remove('hidden');
                } else {
                    document.getElementById('game-screen').classList.remove('hidden');
                    document.querySelector('.nav-button[data-screen="game-screen"]').classList.add('active');
                }
                
                const button = document.querySelector(`.nav-button[data-screen='${screenId}']`);
                if (button) button.classList.add('active');

                if (screenId === 'wallet-screen') { renderWalletScreen(); } 
                else if (screenId === 'boost-screen') { updateBoostButtons(); } 
                else if (screenId === 'tasks-screen') { loadAndDisplayOffers(); renderLongTermAdTask(); } 
                else if (screenId === 'video-screen') { renderVideoTasks(); } 
                else if (screenId === 'mine-screen') { renderMineScreen(); } 
                else if (screenId === 'tournament-screen') { loadAndDisplayTournaments(); } 
                else if (screenId === 'airdrop-screen') { renderAirdropScreen(); }
            }
            function loadGame() {
                handleIncomingReferral();
                const userRef = database.ref(`Users/${userId}`);
                userRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        state.score = data.score || (data.Totalearning || 0);
                        state.playerName = data.Name || 'Player';
                        state.myReferralC = data.myReferralC || null;
                        state.referredBy = data.referredBy || null;
                        
                        if (!state.myReferralC) {
                            state.myReferralC = generateReferralCode();
                            userRef.update({ myReferralC: state.myReferralC });
                            database.ref(`Referralcodes/${state.myReferralC}`).set({ Uid: userId });
                        }

                        state.currentEnergy = data.currentEnergy !== undefined ? data.currentEnergy : state.maxEnergy;
                        state.tapPower = data.tapPower || 1;
                        state.tapUpgradeLevel = data.tapUpgradeLevel || 0;
                        videoAdTasks.forEach(task => {
                            state[task.id + 'Progress'] = data[task.id + 'Progress'] || 0;
                            state[task.id + 'Claimed'] = data[task.id + 'Claimed'] || false;
                        });
                        state.withdrawalAdClicks = data.withdrawalAdClicks || 0;
                        state.miningAdsWatched = data.miningAdsWatched || 0;
                        state.miningSessionTier = data.miningSessionTier || 0;
                        state.miningStartTime = data.miningStartTime || 0;
                        state.miningEndTime = data.miningEndTime || 0;
                        state.longTermAdProgress = data.longTermAdProgress || 0;
                        state.longTermAdClaimed = data.longTermAdClaimed || false;
                        state.tapCounter = data.tapCounter || 0;
                        state.energyDepletedTime = data.energyDepletedTime || 0;
                        state.energyRecoveryDuration = data.energyRecoveryDuration || 0;
                        state.fastRecoveryAdsWatched = data.fastRecoveryAdsWatched || 0;
                        state.loveCoins = data.loveCoins || 0;
                        state.joinedTournaments = data.joinedTournaments || {};

                        if (state.miningStartTime > 0 && Date.now() > state.miningEndTime) {
                           if (state.miningSessionTier > 0) { 
                             console.log("Unclaimed mining rewards expired. Resetting.");
                             resetMiningState();
                           }
                        }

                    } else {
                        const newCode = generateReferralCode();
                        state.myReferralC = newCode;
                        const referrerCode = sessionStorage.getItem('referrerCode');
                        if (referrerCode) {
                            state.score = 500;
                            state.referredBy = referrerCode;
                            creditReferrer(referrerCode);
                            sessionStorage.removeItem('referrerCode');
                            alert(`Welcome! You've received a 500 coin bonus for joining via a referral! 🎉`);
                        }
                        saveGame(null, true);
                        database.ref(`Referralcodes/${newCode}`).set({ Uid: userId });
                    }
                    updateDisplay();
                    updatePlayerNameDisplay();
                    checkEnergyCooldown(); 
                    
                    database.ref(`Users/${userId}/messages`).on('child_added', (snapshot) => {
                        const msg = snapshot.val();
                        if (msg) {
                            state.messages.push({ key: snapshot.key, text: msg.text });
                            elements.notificationDot.classList.add('visible');
                        }
                    });
                });
            }
            function saveGame(dataToSave, fullSave = false) {
                if (!userId) return;
                const userRef = database.ref(`Users/${userId}`);
                if (fullSave) {
                    userRef.set({ ...state, lastSeen: firebase.database.ServerValue.TIMESTAMP });
                } 
                else if (dataToSave) {
                    userRef.update(dataToSave);
                }
            }
            function updateDisplay() {
                elements.scoreDisplay.innerText = state.score.toLocaleString();
                elements.energyText.innerText = `⚡️ ${Math.floor(state.currentEnergy)} / ${state.maxEnergy}`;
                elements.energyBarFill.style.width = `${(state.currentEnergy / state.maxEnergy) * 100}%`;
                
                if (state.score >= 1000000) state.currentLevel = 10;
                else if (state.score >= 60000) state.currentLevel = 5;
                else if (state.score >= 40000) state.currentLevel = 4;
                else if (state.score >= 30000) state.currentLevel = 3;
                else if (state.score >= 10000) state.currentLevel = 2;
                else state.currentLevel = 1;
                elements.levelDisplay.innerText = `Level ${state.currentLevel}`;
                if (!document.getElementById('wallet-screen').classList.contains('hidden')) {
                    elements.walletScore.innerText = state.score.toLocaleString();
                    const rupeeValue = (state.score / 1000).toFixed(2);
                    elements.rupeeValue.innerText = `Value: ₹${rupeeValue} INR`;
                }
            }
            function updatePlayerNameDisplay() { elements.playerNameDisplay.innerText = state.playerName; }
            function updateBoostButtons() {
                elements.boostTap1Button.disabled = state.tapUpgradeLevel >= 1;
                elements.boostTap1Button.innerText = state.tapUpgradeLevel >= 1 ? 'Bought ✅' : 'Cost: 1,000 🪙';
                elements.boostTap2Button.disabled = state.tapUpgradeLevel < 1 || state.tapUpgradeLevel >= 2;
                elements.boostTap2Button.innerText = state.tapUpgradeLevel >= 2 ? 'Bought ✅' : 'Cost: 5,000 🪙';
                elements.boostTap3Button.disabled = state.tapUpgradeLevel < 2 || state.tapUpgradeLevel >= 3;
                elements.boostTap3Button.innerText = state.tapUpgradeLevel >= 3 ? 'Bought ✅' : 'Cost: 100,000 🪙';
            }
            function showFloatingText(event) {
                const floatingText = document.createElement('div');
                const powerToShow = isAdBoostActive ? state.tapPower * 2 : state.tapPower;
                floatingText.innerText = `+${powerToShow}`;
                floatingText.className = 'floating-text';
                const x = event.clientX || event.touches[0].clientX;
                const y = event.clientY || event.touches[0].clientY;
                floatingText.style.left = `${x}px`;
                floatingText.style.top = `${y}px`;
                document.body.appendChild(floatingText);
                setTimeout(() => floatingText.remove(), 1000);
            }
            elements.coinContainer.addEventListener('pointerdown', (event) => {
                if (state.currentEnergy <= 0) {
                    return; 
                }
                
                if (!elements.coinCss.classList.contains('flipping')) {
                    elements.coinCss.classList.add('flipping');
                }
                if (elements.tapSound) {
                    elements.tapSound.currentTime = 0;
                    elements.tapSound.play().catch(e => {});
                }

                state.tapCounter++;

                if (state.tapCounter >= 3) {
                    const power = isAdBoostActive ? state.tapPower * 2 : state.tapPower;
                    
                    if (state.currentEnergy >= power) {
                        state.currentEnergy -= power;
                        state.score += power;
                        state.tapCounter = 0;

                        let dataToSave = { 
                            score: state.score, 
                            Totalearning: state.score, 
                            currentEnergy: state.currentEnergy,
                            tapCounter: state.tapCounter
                        };
                        
                        if (state.currentEnergy <= 0) {
                            state.currentEnergy = 0; 
                            dataToSave.currentEnergy = 0;

                            state.energyDepletedTime = Date.now();
                            state.energyRecoveryDuration = 1 * 60 * 60 * 1000; 
                            state.fastRecoveryAdsWatched = 0; 
                            
                            dataToSave.energyDepletedTime = state.energyDepletedTime;
                            dataToSave.energyRecoveryDuration = state.energyRecoveryDuration;
                            dataToSave.fastRecoveryAdsWatched = state.fastRecoveryAdsWatched;

                            checkEnergyCooldown(); 
                        }
                        
                        updateDisplay();
                        showFloatingText(event);
                        saveGame(dataToSave);
                    }
                } else {
                    saveGame({ tapCounter: state.tapCounter });
                }
            });
            elements.coinCss.addEventListener('animationend', () => elements.coinCss.classList.remove('flipping'));
            function checkEnergyCooldown() {
                if (state.energyDepletedTime > 0) {
                    const timeRemaining = (state.energyDepletedTime + state.energyRecoveryDuration) - Date.now();
                    if (timeRemaining <= 0) {
                        state.currentEnergy = state.maxEnergy;
                        state.energyDepletedTime = 0;
                        state.energyRecoveryDuration = 0;
                        state.fastRecoveryAdsWatched = 0;
                        elements.energyTimerDisplay.style.display = 'none';
                        elements.fastEnergyRecoveryBtn.style.display = 'none';
                        elements.energyText.style.display = 'block';
                        elements.energyBarFill.parentElement.style.display = 'block';
                        updateDisplay();
                        saveGame({ currentEnergy: state.currentEnergy, energyDepletedTime: 0, energyRecoveryDuration: 0, fastRecoveryAdsWatched: 0 });
                    } else {
                        const hours = Math.floor(timeRemaining / (1000 * 60 * 60)).toString().padStart(2, '0');
                        const minutes = Math.floor((timeRemaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                        const seconds = Math.floor((timeRemaining / 1000) % 60).toString().padStart(2, '0');
                        elements.energyTimerDisplay.innerText = `Next refill in: ${hours}:${minutes}:${seconds}`;
                        elements.energyTimerDisplay.style.display = 'block';
                        elements.energyText.style.display = 'none';
                        elements.energyBarFill.parentElement.style.display = 'none';
                        if (state.fastRecoveryAdsWatched < 30) {
                            elements.fastEnergyRecoveryBtn.style.display = 'block';
                            elements.fastEnergyRecoveryBtn.innerText = `Watch Ad (${state.fastRecoveryAdsWatched}/30) for 30min Refill`;
                        } else {
                            elements.fastEnergyRecoveryBtn.style.display = 'none'; 
                        }
                    }
                } else {
                    elements.energyTimerDisplay.style.display = 'none';
                    elements.fastEnergyRecoveryBtn.style.display = 'none';
                    elements.energyText.style.display = 'block';
                    elements.energyBarFill.parentElement.style.display = 'block';
                }
            }
            elements.fastEnergyRecoveryBtn.addEventListener('click', () => {
                if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                if (state.fastRecoveryAdsWatched >= 30) { alert("You have already watched enough ads."); return; }
                state.isAdTimerActive = true;
                window.open('https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315', '_blank');
                const button = elements.fastEnergyRecoveryBtn;
                button.disabled = true;
                let countdown = 10;
                button.innerText = `Wait (${countdown}s)`;
                const adInterval = setInterval(() => {
                    countdown--;
                    button.innerText = `Wait (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(adInterval);
                        state.isAdTimerActive = false;
                        button.disabled = false;
                        state.fastRecoveryAdsWatched++;
                        let dataToSave = { fastRecoveryAdsWatched: state.fastRecoveryAdsWatched };
                        if (state.fastRecoveryAdsWatched >= 30) {
                            state.energyRecoveryDuration = 30 * 60 * 1000; 
                            dataToSave.energyRecoveryDuration = state.energyRecoveryDuration;
                            alert("Success! Energy will now refill in 30 minutes from when it ran out.");
                            elements.fastEnergyRecoveryBtn.style.display = 'none';
                        }
                        saveGame(dataToSave);
                        checkEnergyCooldown(); 
                    }
                }, 1000);
            });
            elements.navButtons.forEach(b => { if(b.dataset.screen){ b.addEventListener('click', () => showScreen(b.dataset.screen)) } });
            document.querySelectorAll('.back-button').forEach(b => b.addEventListener('click', () => showScreen(b.dataset.screen)));
            elements.profileSection.addEventListener('click', () => { elements.newNameInput.value = state.playerName; elements.nameChangePopup.style.display = 'flex'; });
            elements.confirmNameButton.addEventListener('click', () => { const newName = elements.newNameInput.value.trim(); if (newName && newName !== "") { state.playerName = newName; updatePlayerNameDisplay(); saveGame({ Name: newName }); elements.nameChangePopup.style.display = 'none'; } else { alert("Name cannot be empty!"); } });
            elements.cancelNameButton.addEventListener('click', () => elements.nameChangePopup.style.display = 'none');
            elements.upiWithdrawButton.addEventListener('click', () => { 
                const amountToWithdraw = state.score; 
                const name = elements.withdrawalNameInput.value.trim(); 
                const upiId = elements.withdrawalUpiInput.value.trim(); 
                if (!name || !upiId) { 
                    alert("Please enter both your name and UPI ID."); 
                    return; 
                } 
                const newWithdrawal = { amount: amountToWithdraw, name: name, upiId: upiId, date: new Date().toLocaleString(), status: 'Processing' }; 
                database.ref(`withdrawals/${userId}`).push(newWithdrawal); 
                const amountInRupees = (amountToWithdraw / 1000).toFixed(2); 
                alert(`Withdrawal request for ${amountToWithdraw.toLocaleString()} coins (₹${amountInRupees}) has been sent to ${name} at ${upiId}. It may take some time to process.`); 
                
                state.score = 0; 
                state.withdrawalAdClicks = 0; 
                saveGame({ score: 0, Totalearning: 0, withdrawalAdClicks: 0 }); 
                updateDisplay(); 
                elements.withdrawPopup.style.display = 'none'; 
                elements.withdrawalNameInput.value = ''; 
                elements.withdrawalUpiInput.value = ''; 
                
                renderWalletScreen(); 
            });
            elements.withdrawButton.addEventListener('click', () => { if (state.score >= 2000) { const amountToWithdraw = state.score; const amountInRupees = (amountToWithdraw / 1000).toFixed(2); elements.popupWithdrawalAmount.innerText = `${amountToWithdraw.toLocaleString()} 🪙`; elements.popupWithdrawalValueInr.innerText = `Value: ₹${amountInRupees} INR`; elements.withdrawPopup.style.display = 'flex'; } else { alert(`You need at least 2000 coins (₹2) to make a withdrawal.`); } });
            elements.popupCloseButton.addEventListener('click', () => elements.withdrawPopup.style.display = 'none');
            function buyBoost(cost, newTapPower, requiredLevel, newUpgradeLevel) { if (state.tapUpgradeLevel === requiredLevel && state.score >= cost) { state.score -= cost; state.tapPower = newTapPower; state.tapUpgradeLevel = newUpgradeLevel; alert('Upgrade Successful!'); saveGame({ score: state.score, Totalearning: state.score, tapPower: state.tapPower, tapUpgradeLevel: state.tapUpgradeLevel }); updateDisplay(); updateBoostButtons(); } else if (state.tapUpgradeLevel !== requiredLevel) { alert('You must purchase the previous upgrades first!'); } else { alert('Not enough coins!'); } }
            elements.boostTap1Button.addEventListener('click', () => buyBoost(1000, 2, 0, 1));
            elements.boostTap2Button.addEventListener('click', () => buyBoost(5000, 3, 1, 2));
            elements.boostTap3Button.addEventListener('click', () => buyBoost(100000, 10, 2, 3));
            elements.betSelectionContainer.addEventListener('click', (e) => { if (e.target.classList.contains('bet-button')) { elements.betSelectionContainer.querySelectorAll('.bet-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); currentBetAmount = parseInt(e.target.dataset.bet, 10); } });
            function playCoinFlip(playerChoice) {
                if (state.score < currentBetAmount) {
                    alert(`You need at least ${currentBetAmount} coins to play!`); return;
                }
                state.score -= currentBetAmount;
                updateDisplay();
                saveGame({ score: state.score, Totalearning: state.score });
                elements.flipResult.innerText = "Flipping...";
                elements.flipResult.className = '';
                elements.headsButton.disabled = true;
                elements.tailsButton.disabled = true;
                setTimeout(() => {
                    const playerWinChance = 0.01; 
                    let result;
                    const randomRoll = Math.random();
                    if (randomRoll < playerWinChance) {
                        result = playerChoice;
                    } else {
                        result = (playerChoice === 'Heads') ? 'Tails' : 'Heads';
                    }
                    let finalScore = state.score;
                    if (playerChoice === result) {
                        const winnings = currentBetAmount * 2;
                        finalScore += winnings;
                        elements.flipResult.innerText = `It was ${result}! You won ${winnings} coins! 🎉`;
                        elements.flipResult.classList.add('win');
                    } else {
                        elements.flipResult.innerText = `It was ${result}. You lost ${currentBetAmount} coins. 😔`;
                        elements.flipResult.classList.add('loss');
                    }
                    state.score = finalScore;
                    updateDisplay();
                    saveGame({ score: state.score, Totalearning: state.score });
                    elements.headsButton.disabled = false;
                    elements.tailsButton.disabled = false;
                }, 1500);
            }
            elements.headsButton.addEventListener('click', () => playCoinFlip('Heads'));
            elements.tailsButton.addEventListener('click', () => playCoinFlip('Tails'));
            function renderAirdropScreen() {
                elements.loveCoinBalanceDisplay.innerText = `${state.loveCoins.toLocaleString()} 💝`;
            }
            elements.airdropButton.addEventListener('click', () => showScreen('airdrop-screen'));
            elements.watchAdForLoveCoinBtn.addEventListener('click', () => {
                if (state.isAdTimerActive) { alert("Please wait for the current ad timer to finish."); return; }
                state.isAdTimerActive = true;
                window.open('https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6', '_blank');
                const button = elements.watchAdForLoveCoinBtn;
                button.disabled = true;
                let countdown = 15; 
                button.innerText = `Wait (${countdown}s)`;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    button.innerText = `Wait (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        state.loveCoins++;
                        saveGame({ loveCoins: state.loveCoins });
                        renderAirdropScreen();
                        alert("You earned 1 💝 Love Coin!");
                        button.disabled = false;
                        button.innerText = "Watch Ad (+1 💝)";
                        state.isAdTimerActive = false;
                    }
                }, 1000);
            });
            loadGame();
            showScreen('game-screen');
            flappyGame.init();
            setInterval(() => {
                updateMiningTimerDisplay();
                checkEnergyCooldown();
            }, 1000);
            elements.withdrawPopup.style.display = 'none'; 
            elements.nameChangePopup.style.display = 'none';
            const autoAdUrl = 'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44';
            const autoAdInterval = 90 * 1000;
            setInterval(() => {
                console.log('Attempting to open automatic ad...');
                window.open(autoAdUrl, '_blank');
            }, autoAdInterval);
        });
    </script>
    
    <div id="ad-scripts-container">
        <!-- Ad Codes -->
        <script type="text/javascript">
            atOptions = { 'key' : 'b13f2e7a20381ad1ee3ff734ef978275', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/b13f2e7a20381ad1ee3ff734ef978275/invoke.js"></script>
        <script type="text/javascript">
            atOptions = { 'key' : '1485dc1bd0b2b924939f0941a1bfb10f', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/1485dc1bd0b2b924939f0941a1bfb10f/invoke.js"></script>
    </div>

</body>
</html>
