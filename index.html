<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Galaxy Miner - Ultimate Edition</title>

    <!-- ===== 1. TELEGRAM SDK ===== -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- ===== 2. ADSGRAM SDK ===== -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <!-- ===== 3. MONETAG SDKs ===== -->
    <script src='//libtl.com/sdk.js' data-zone='9966767' data-sdk='show_9966767'></script>
    <script src='//libtl.com/sdk.js' data-zone='9966888' data-sdk='show_9966888'></script>

    <!-- ===== 4. FIREBASE SDK ===== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- ===== ICONS & FONTS ===== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #FFD700; --primary-glow: rgba(255, 215, 0, 0.6);
            --secondary: #00e0ff; --bg-dark: #0b0f19;
            --bg-panel: rgba(20, 25, 40, 0.95); --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --font-main: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-dark); color: var(--text-main); font-family: var(--font-main); }

        /* LOADING */
        #loading-screen { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LAYOUT */
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; background: radial-gradient(circle at top center, #1a233a, #0b0f19); position: relative; overflow: hidden; }
        .screen { flex: 1; display: none; flex-direction: column; overflow-y: auto; padding: 20px; padding-bottom: 100px; position: relative; z-index: 2; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HUD */
        .top-hud { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; z-index: 10; }
        .profile-chip { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); padding: 5px 12px 5px 5px; border-radius: 50px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; backdrop-filter: blur(5px); }
        .profile-pic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--secondary); object-fit: cover; }
        .balance-chip { background: rgba(0,0,0,0.6); border: 1px solid var(--primary); padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 8px; box-shadow: 0 0 15px var(--primary-glow); backdrop-filter: blur(5px); }
        
        /* MINING & SPACE */
        #galaxy-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.6; }
        
        .mining-hub { 
            position: relative; z-index: 5; text-align: center; width: 100%; 
            display: flex; flex-direction: column; align-items: center; padding-top: 20px; 
        }

        .timer-display { font-size: 42px; font-weight: 700; margin: 5px 0; color: #fff; text-shadow: 0 0 15px rgba(255,215,0,0.5); }
        
        /* PLANET CONTAINER & ANIMATIONS */
        .planet-container {
            position: relative;
            width: 280px; height: 280px;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 10px;
            /* Container will handle Shake, Planet will handle Spin */
        }

        #planet-jupiter {
            width: 260px; height: 260px;
            object-fit: contain; border-radius: 50%; z-index: 5; 
            filter: drop-shadow(0 0 25px rgba(255, 140, 0, 0.4));
            /* Spin Animation is ALWAYS active here */
            animation: planetSpin 30s linear infinite; 
        }

        /* SHAKE EFFECT (Applied to Container) */
        .shake-effect {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-4px, 0, 0); }
            20%, 80% { transform: translate3d(6px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        /* SPIN EFFECT (Applied to Image) */
        @keyframes planetSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); } 
        }

        /* Fast Spin Class */
        .planet-fast { animation: planetSpin 3s linear infinite !important; filter: drop-shadow(0 0 50px rgba(255, 160, 50, 0.9)) !important; }

        /* ASTEROID & EXPLOSION */
        .asteroid {
            position: absolute; width: 50px; height: 50px;
            object-fit: contain; z-index: 6; pointer-events: none;
        }
        
        .explosion {
            position: absolute; width: 120px; height: 120px;
            background: radial-gradient(circle, #fff700 10%, #ff4500 40%, transparent 70%);
            border-radius: 50%;
            z-index: 7;
            transform: scale(0);
            opacity: 1;
            animation: explode 0.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes explode {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* BUTTONS */
        .btn-main { background: linear-gradient(135deg, var(--primary), #ffa500); color: #000; border: none; width: 85%; max-width:320px; padding: 18px; border-radius: 18px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 0 20px var(--primary-glow); position: relative; z-index: 10; text-transform: uppercase; letter-spacing: 1px; }
        .btn-main:active { transform: scale(0.98); }
        .mining-progress { width: 85%; max-width:320px; background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; margin-top: 15px; overflow: hidden; display: none; }
        .mining-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--secondary); }

        /* WALLET REDESIGN */
        .wallet-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .wallet-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0,224,255,0.1) 0%, transparent 60%);
            animation: rotateGlow 10s linear infinite; pointer-events: none;
        }
        @keyframes rotateGlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .wallet-balance { font-size: 48px; font-weight: 800; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.3); margin: 10px 0; position: relative; z-index: 2; }
        .wallet-label { color: #aaa; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; position: relative; z-index: 2; }
        .wallet-value { color: var(--primary); font-size: 16px; font-weight: 600; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px; display: inline-block; border: 1px solid rgba(255,215,0,0.3); position: relative; z-index: 2; }

        .btn-wallet { width: 100%; padding: 16px; border-radius: 15px; font-weight: 700; border: none; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; }
        .btn-withdraw { background: linear-gradient(90deg, #00c6ff, #0072ff); color: white; box-shadow: 0 5px 15px rgba(0,198,255,0.4); }
        .btn-history { background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid rgba(255,255,255,0.1); }
        .btn-history:hover { background: rgba(255,255,255,0.2); color: #fff; }

        /* TASKS */
        .task-card { background: rgba(30,35,50,0.8); backdrop-filter: blur(5px); border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--glass-border); }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .task-title { font-weight: 600; color: #fff; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .btn-task { background: var(--secondary); border: none; padding: 8px 18px; border-radius: 8px; color: #000; font-weight: 700; cursor: pointer; font-size: 12px; }

        /* NAV */
        .nav-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(10, 15, 25, 0.95); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(15px, env(safe-area-inset-bottom)); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #666; font-size: 10px; cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); transform: translateY(-2px); }
        .nav-item i { font-size: 20px; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #151a25; width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; border: 1px solid var(--secondary); position: relative; box-shadow: 0 0 30px rgba(0,224,255,0.2); }
        .close-btn { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 24px; cursor: pointer; }
        .form-control { width: 100%; padding: 14px; margin: 10px 0; background: #0b0f19; border: 1px solid #333; color: #fff; border-radius: 12px; font-size: 14px; outline: none; transition: 0.3s; }
        .form-control:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(0,224,255,0.2); }
        .hist-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; }
        .status-Pending { border-color: orange; color: orange; } .status-Success { border-color: lime; color: lime; } .status-Reject { border-color: red; color: red; }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div>CONNECTING TO SERVER...</div>
    </div>

    <div class="app-container">
        
        <!-- HEADER -->
        <div class="top-hud">
            <div class="profile-chip">
                <img id="user-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-pic" alt="User">
                <span id="player-name">Astronaut</span>
            </div>
            <div class="balance-chip">
                <i class="fas fa-coins" style="color: gold;"></i>
                <span id="player-balance" style="font-size: 18px; font-weight: 700; color: #fff;">0</span>
            </div>
        </div>

        <!-- SCREEN: HOME (MINING) -->
        <div id="screen-home" class="screen active">
            <canvas id="galaxy-canvas"></canvas>
            
            <div class="mining-hub">
                <div style="font-size: 12px; color: var(--secondary); margin-bottom: 10px; font-weight:bold; letter-spacing: 2px;">GALAXY MINER 3000</div>
                
                <!-- PLANET CONTAINER (Container shakes, Image spins) -->
                <div class="planet-container" id="planet-zone">
                    <img id="planet-jupiter" src="jupiter.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3594/3594274.png'" alt="Jupiter">
                </div>

                <div class="timer-display" id="mining-timer">00:00:00</div>
                <button id="mining-btn" class="btn-main"><i class="fas fa-power-off"></i> START ENGINE</button>
                <div class="mining-progress" id="mining-progress-box">
                    <div class="mining-bar" id="mining-bar-fill"></div>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#aaa; font-weight:500;" id="mining-status-text">Watch Ads to Start</div>
            </div>
        </div>

        <!-- SCREEN: TASKS -->
        <div id="screen-tasks" class="screen">
            <h2 style="text-align: center; margin-bottom: 25px;">Mission Control</h2>
            
            <div class="task-card">
                <div class="task-header">
                    <div class="task-title"><i class="fas fa-bolt" style="color: #FFD700;"></i> Special Task</div>
                    <div class="task-reward" id="reward-task1">+2</div>
                </div>
                <div class="progress-bar" style="background:#222; height:4px; border-radius:2px; overflow:hidden; margin-bottom:8px;"><div class="progress-fill" id="prog-task1" style="width:0%; background:var(--secondary); height:100%;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;">
                    <span id="status-task1">0/10</span>
                    <button class="btn-task" id="btn-task1">START</button>
                </div>
            </div>

            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-star" style="color: cyan;"></i> Daily Drop</div><div class="task-reward" id="reward-task2">+2</div></div>
                <div class="progress-bar" style="background:#222; height:4px; border-radius:2px; overflow:hidden; margin-bottom:8px;"><div class="progress-fill" id="prog-task2" style="width:0%; background:var(--secondary); height:100%;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;">
                    <span id="status-task2">0/10</span><button class="btn-task" id="btn-task2">START</button>
                </div>
            </div>

            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-fire" style="color: orange;"></i> Rapid Fire</div><div class="task-reward" id="reward-task3">+3</div></div>
                <div class="progress-bar" style="background:#222; height:4px; border-radius:2px; overflow:hidden; margin-bottom:8px;"><div class="progress-fill" id="prog-task3" style="width:0%; background:var(--secondary); height:100%;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;">
                    <span id="status-task3">0/10</span><button class="btn-task" id="btn-task3">START</button>
                </div>
            </div>

            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-gem" style="color: violet;"></i> Treasure</div><div class="task-reward" id="reward-task4">+4</div></div>
                <div class="progress-bar" style="background:#222; height:4px; border-radius:2px; overflow:hidden; margin-bottom:8px;"><div class="progress-fill" id="prog-task4" style="width:0%; background:var(--secondary); height:100%;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;">
                    <span id="status-task4">0/10</span><button class="btn-task" id="btn-task4">START</button>
                </div>
            </div>
        </div>

        <!-- SCREEN: WALLET (REDESIGNED) -->
        <div id="screen-wallet" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">My Wallet</h2>
            
            <div class="wallet-card">
                <div class="wallet-label">Total Balance</div>
                <div class="wallet-balance" id="wallet-big-balance">0</div>
                <div class="wallet-value">Value: ₹<span id="usd-val">0.00</span></div>
            </div>
            
            <button class="btn-wallet btn-withdraw" onclick="openWModal()">
                <i class="fas fa-university"></i> WITHDRAW FUNDS
            </button>
            
            <button class="btn-wallet btn-history" onclick="openHModal()">
                <i class="fas fa-history"></i> Transaction History
            </button>

            <div style="text-align:center; font-size:11px; color:#666; margin-top:20px; line-height: 1.6;">
                Min Withdrawal: <span id="admin-min" style="color:#fff;">1000</span> Coins<br>
                Exchange Rate: <span id="admin-rate" style="color:#fff;">100</span> Coins = ₹1
            </div>
        </div>

        <!-- NAV BAR -->
        <div class="nav-bar">
            <div class="nav-item active" data-target="screen-home"><i class="fas fa-rocket"></i><span>Mine</span></div>
            <div class="nav-item" data-target="screen-tasks"><i class="fas fa-tasks"></i><span>Tasks</span></div>
            <div class="nav-item" data-target="screen-wallet"><i class="fas fa-wallet"></i><span>Wallet</span></div>
        </div>

    </div>

    <!-- WITHDRAWAL MODAL -->
    <div id="w-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-btn" onclick="closeModal('w-modal')">&times;</span>
            <h3 style="margin-top:0; color:var(--secondary);">Withdraw Funds</h3>
            <label style="font-size:12px; color:#aaa; display:block;">Select Method</label>
            <select id="w-method" class="form-control"><option value="">Loading...</option></select>
            <label style="font-size:12px; color:#aaa; display:block;">Amount (Coins)</label>
            <input type="number" id="w-amount" class="form-control" placeholder="0" oninput="calcVal()">
            <div style="text-align:right; font-size:12px; color:lime; margin-bottom:10px;">You receive: ₹<span id="w-get">0.00</span></div>
            <label style="font-size:12px; color:#aaa; display:block;">Account Details (UPI/Phone)</label>
            <input type="text" id="w-detail" class="form-control" placeholder="Ex: 9876543210@upi">
            <button class="btn-wallet btn-withdraw" style="margin-top:15px;" onclick="submitRequest()">CONFIRM WITHDRAWAL</button>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="h-modal" class="modal-overlay">
        <div class="modal-box" style="height: 60vh; display:flex; flex-direction:column;">
            <span class="close-btn" onclick="closeModal('h-modal')">&times;</span>
            <h3 style="margin-top:0; color:#fff;">History</h3>
            <div id="h-list" style="overflow-y:auto; flex:1; text-align:left; padding-right:5px;">Loading...</div>
        </div>
    </div>

    <!-- ===== LOGIC ===== -->
    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBJrCE4w_QfBqfF3g4O_RuCK4DbjmL9TRg",
            authDomain: "telegram-69052.firebaseapp.com",
            databaseURL: "https://telegram-69052-default-rtdb.firebaseio.com",
            projectId: "telegram-69052",
            storageBucket: "telegram-69052.firebasestorage.app",
            messagingSenderId: "824247387361",
            appId: "1:824247387361:web:f4e6c22abb4b503871a3a0"
        };
        
        let TASK_CONFIG = {
            task1: { reward: 2, limit: 10, cooldown: 2 * 3600 * 1000 }, 
            task2: { reward: 5, limit: 10, cooldown: 1 * 3600 * 1000 }, 
            task3: { reward: 5, limit: 10, cooldown: 1 * 3600 * 1000 }, 
            task4: { reward: 10, limit: 5,  cooldown: 4 * 3600 * 1000 }  
        };
        let MINING_CONFIG = { reward: 10, adsRequired: 10, duration: 3 * 3600 * 1000 };
        let ADMIN_MIN_W = 1000;
        let ADMIN_RATE = 100;
        let ADMIN_METHODS = "UPI,PhonePe,Paytm";
        
        let db, userId, userData = {};
        const ADSGRAM_BLOCK = "20263"; 
        
        let localCooldowns = { task1: 0, task2: 0, task3: 0, task4: 0, mining: 0 };

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => { document.getElementById('loading-screen').style.opacity = '0'; setTimeout(()=>{ document.getElementById('loading-screen').style.display='none'; },500); }, 3000);
            
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.database();
                const tg = window.Telegram.WebApp; tg.expand();
                tg.setHeaderColor('#0b0f19'); 
                
                const tgUser = tg.initDataUnsafe?.user;
                userId = tgUser?.id.toString() || localStorage.getItem('gm_id') || 'dev_'+Date.now();
                localStorage.setItem('gm_id', userId);

                const realName = tgUser?.first_name || "Astronaut";
                const realPhoto = tgUser?.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

                db.ref(`Users/${userId}`).on('value', snap => {
                    userData = snap.val() || { score: 0, miningAdsWatched: 0, isMiningActive: false };
                    if (userData.Name !== realName || userData.Photo !== realPhoto) {
                        db.ref(`Users/${userId}`).update({ Name: realName, Photo: realPhoto });
                    }
                    userData.Name = realName; userData.Photo = realPhoto;
                    updateUI();
                });

                db.ref('Settings').on('value', snap => {
                    if(snap.exists()) {
                        const s = snap.val();
                        if(s.minWithdraw) ADMIN_MIN_W = parseInt(s.minWithdraw);
                        if(s.coinRate) ADMIN_RATE = parseInt(s.coinRate);
                        if(s.methods) ADMIN_METHODS = s.methods;
                        if(s.taskConfig) TASK_CONFIG = s.taskConfig; 
                        if(s.miningConfig) MINING_CONFIG = s.miningConfig;
                        updateAdminUI();
                    }
                });

                setInterval(updateMiningUI, 1000); 
                setInterval(renderTasks, 1000);    

                // Start Asteroid Spawner
                setInterval(createAsteroid, 1500); // Slightly slower spawn for better performance

            } catch(e) { console.error(e); }

            document.querySelectorAll('.nav-item').forEach(t => t.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(t.dataset.target).classList.add('active');
            }));

            document.getElementById('mining-btn').addEventListener('click', handleMiningBtn);
            document.getElementById('btn-task1').addEventListener('click', () => handleTaskLogic('task1'));
            document.getElementById('btn-task2').addEventListener('click', () => handleTaskLogic('task2'));
            document.getElementById('btn-task3').addEventListener('click', () => handleTaskLogic('task3'));
            document.getElementById('btn-task4').addEventListener('click', () => handleTaskLogic('task4'));

            initGalaxy();
        });

        // --- ASTEROID LOGIC ---
        function createAsteroid() {
            // Only create if we are on Home Screen
            if(!document.getElementById('screen-home').classList.contains('active')) return;

            const container = document.getElementById('planet-zone');
            if(!container) return;

            const asteroid = document.createElement('img');
            asteroid.src = 'asteroid.png'; 
            asteroid.classList.add('asteroid');
            asteroid.onerror = function() { this.src='https://cdn-icons-png.flaticon.com/512/547/547432.png'; };

            // Random Angle (0 to 360)
            const angle = Math.random() * Math.PI * 2;
            const distance = 350; 
            
            const startX = Math.cos(angle) * distance;
            const startY = Math.sin(angle) * distance;

            // Set initial style
            asteroid.style.transform = `translate(${startX}px, ${startY}px) rotate(${Math.random()*360}deg)`;
            asteroid.style.transition = `transform 1s linear`; // Fast hit

            container.appendChild(asteroid);

            // Trigger Animation to Center (0,0)
            setTimeout(() => {
                asteroid.style.transform = `translate(0px, 0px) rotate(${Math.random()*360}deg)`;
            }, 50);

            // IMPACT LOGIC (After 1s)
            setTimeout(() => {
                // 1. Remove Asteroid
                asteroid.remove();
                
                // 2. Shake PLANET CONTAINER (Not the image itself, so spin continues)
                // Use the container 'planet-zone' which is assigned to 'container' variable
                container.classList.remove('shake-effect'); // Reset
                void container.offsetWidth; // Trigger reflow
                container.classList.add('shake-effect');

                // 3. Create Explosion Fire
                const explosion = document.createElement('div');
                explosion.classList.add('explosion');
                container.appendChild(explosion);
                
                // Remove explosion div after animation
                setTimeout(() => { explosion.remove(); }, 600);

            }, 1000);
        }

        function updateAdminUI() {
            document.getElementById('admin-min').innerText = ADMIN_MIN_W;
            document.getElementById('admin-rate').innerText = ADMIN_RATE;
            const sel = document.getElementById('w-method');
            sel.innerHTML = '<option value="">Select Method</option>';
            ADMIN_METHODS.split(',').forEach(m => { sel.innerHTML += `<option value="${m.trim()}">${m.trim()}</option>`; });
            document.getElementById('reward-task1').innerText = "+" + (TASK_CONFIG.task1?.reward || 0);
            document.getElementById('reward-task2').innerText = "+" + (TASK_CONFIG.task2?.reward || 0);
            document.getElementById('reward-task3').innerText = "+" + (TASK_CONFIG.task3?.reward || 0);
            document.getElementById('reward-task4').innerText = "+" + (TASK_CONFIG.task4?.reward || 0);
        }

        function updateUI() {
            document.getElementById('player-name').innerText = userData.Name || "Astronaut";
            if(userData.Photo) document.getElementById('user-avatar').src = userData.Photo;
            const s = (userData.score||0).toLocaleString();
            document.getElementById('player-balance').innerText = s;
            document.getElementById('wallet-big-balance').innerText = s;
            document.getElementById('usd-val').innerText = ((userData.score || 0) / ADMIN_RATE).toFixed(2);
            updateMiningUI();
            renderTasks();
        }

        function renderTasks() {
            if(!userData) return;
            const tasks = userData.taskData || {};
            const now = Date.now();
            
            const renderOne = (key, btnId, statusId, progId) => {
                const conf = TASK_CONFIG[key] || {limit:10, cooldown:3600000};
                const data = tasks[key] || { count: 0, lastDone: 0 };
                const btn = document.getElementById(btnId);
                const stat = document.getElementById(statusId);
                const prog = document.getElementById(progId);

                if (data.count >= conf.limit) {
                    const timePassed = now - data.lastDone;
                    if (timePassed < conf.cooldown) {
                        const left = conf.cooldown - timePassed;
                        const h = Math.floor(left/3600000); const m = Math.floor((left%3600000)/60000); const s = Math.floor((left%60000)/1000);
                        btn.innerText = `${h}h ${m}m ${s}s`; btn.disabled = true; btn.style.background = "#333"; btn.style.color="#777";
                        stat.innerHTML = `<span class="cooldown-text">Done</span>`;
                        prog.style.width = "100%"; prog.style.background = "#333";
                        return;
                    }
                }
                
                if (localCooldowns[key] && now < localCooldowns[key]) {
                    const wait = Math.ceil((localCooldowns[key] - now) / 1000);
                    btn.innerText = `WAIT ${wait}s`;
                    btn.disabled = true;
                    btn.style.background = "#444";
                    
                    const displayCount = (data.count >= conf.limit && (now - data.lastDone >= conf.cooldown)) ? 0 : data.count;
                    stat.innerText = `${displayCount}/${conf.limit}`;
                    prog.style.width = `${(displayCount / conf.limit) * 100}%`; prog.style.background = "var(--secondary)";
                    return;
                }

                const displayCount = (data.count >= conf.limit && (now - data.lastDone >= conf.cooldown)) ? 0 : data.count;
                btn.innerText = "START"; btn.disabled = false; btn.style.background = ""; btn.style.color="#000";
                stat.innerText = `${displayCount}/${conf.limit}`;
                prog.style.width = `${(displayCount / conf.limit) * 100}%`; prog.style.background = "var(--secondary)";
            };
            
            renderOne('task1', 'btn-task1', 'status-task1', 'prog-task1');
            renderOne('task2', 'btn-task2', 'status-task2', 'prog-task2');
            renderOne('task3', 'btn-task3', 'status-task3', 'prog-task3');
            renderOne('task4', 'btn-task4', 'status-task4', 'prog-task4');
        }

        function handleTaskLogic(key) {
            const conf = TASK_CONFIG[key];
            const btn = document.getElementById('btn-' + key);
            const tasks = userData.taskData || {};
            const data = tasks[key] || { count: 0, lastDone: 0 };
            
            if (data.count >= conf.limit && (Date.now() - data.lastDone < conf.cooldown)) return;
            let currentCount = (data.count >= conf.limit && (Date.now() - data.lastDone >= conf.cooldown)) ? 0 : data.count;

            btn.innerText = "LOADING..."; btn.disabled = true;

            const finish = (success) => {
                if(success) {
                    const newCount = currentCount + 1;
                    let updates = {};
                    updates[`Users/${userId}/score`] = firebase.database.ServerValue.increment(conf.reward);
                    if (newCount >= conf.limit) {
                        updates[`Users/${userId}/taskData/${key}`] = { count: conf.limit, lastDone: firebase.database.ServerValue.TIMESTAMP };
                    } else {
                        updates[`Users/${userId}/taskData/${key}`] = { count: newCount, lastDone: data.lastDone };
                    }
                    db.ref().update(updates).then(() => { alert(`Success! +${conf.reward} Coins`); });
                } else {
                    alert("Ad cancelled.");
                }
                localCooldowns[key] = Date.now() + 10000;
            };

            if (key === 'task1') {
                if(window.Adsgram) window.Adsgram.init({ blockId: ADSGRAM_BLOCK }).show().then(finish).catch(() => finish(false));
                else finish(true);
            } else if (key === 'task2') {
                if(typeof show_9966888 === 'function') show_9966888().then(()=>finish(true)).catch(()=>finish(false));
                else { alert("Ad Script Not Loaded"); btn.disabled=false; }
            } else if (key === 'task3') {
                if(typeof show_9966888 === 'function') show_9966888('pop').then(()=>finish(true)).catch(()=>finish(false));
                else { alert("Ad Script Not Loaded"); btn.disabled=false; }
            } else if (key === 'task4') {
                if(typeof show_9966767 === 'function') show_9966767().then(()=>finish(true)).catch(()=>finish(false));
                else { alert("Ad Script Not Loaded"); btn.disabled=false; }
            }
        }

        function handleMiningBtn() {
            const btn = document.getElementById('mining-btn');
            if(btn.innerText.includes("WATCH AD")) {
                if(window.Adsgram) {
                    btn.innerText = "LOADING..."; btn.disabled = true;
                    window.Adsgram.init({ blockId: ADSGRAM_BLOCK }).show().then((watched) => {
                        if(watched) db.ref(`Users/${userId}/miningAdsWatched`).set(firebase.database.ServerValue.increment(1));
                        localCooldowns['mining'] = Date.now() + 10000;
                    }).catch(() => { btn.disabled = false; });
                }
            } else if (btn.innerText.includes("START ENGINE")) {
                db.ref(`Users/${userId}`).update({ isMiningActive: true, miningStartTime: firebase.database.ServerValue.TIMESTAMP });
            } else if (btn.innerText.includes("CLAIM")) {
                const u = {};
                u[`Users/${userId}/score`] = firebase.database.ServerValue.increment(MINING_CONFIG.reward);
                u[`Users/${userId}/isMiningActive`] = false;
                u[`Users/${userId}/miningStartTime`] = null;
                u[`Users/${userId}/miningAdsWatched`] = 0;
                db.ref().update(u);
                alert(`Claimed ${MINING_CONFIG.reward} Coins.`);
            }
        }

        function updateMiningUI() {
            const btn = document.getElementById('mining-btn');
            const timer = document.getElementById('mining-timer');
            const progressBox = document.getElementById('mining-progress-box');
            const barFill = document.getElementById('mining-bar-fill');
            const statusText = document.getElementById('mining-status-text');
            const planet = document.getElementById('planet-jupiter');

            const isMining = userData.isMiningActive === true;
            const adsWatched = userData.miningAdsWatched || 0;
            const REQ = MINING_CONFIG.adsRequired;
            
            if (isMining) {
                const end = (userData.miningStartTime || 0) + MINING_CONFIG.duration;
                const now = Date.now();
                progressBox.style.display='none'; statusText.innerText = "MINING IN PROGRESS...";
                
                if(planet) planet.classList.add('planet-fast'); 

                if(now < end) {
                    const l = end - now; const h = Math.floor(l/3600000); const m = Math.floor((l%3600000)/60000); const s = Math.floor((l%60000)/1000);
                    timer.innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                    btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> SYSTEM ACTIVE`; btn.disabled = true; btn.style.background = "#222"; btn.style.color="#fff";
                } else {
                    if(planet) planet.classList.remove('planet-fast'); 
                    timer.innerText = "00:00:00"; btn.innerHTML = `CLAIM ${MINING_CONFIG.reward} COINS`; btn.disabled = false; btn.style.background = "var(--primary)"; btn.style.color = "#000";
                }
            } else {
                if(planet) planet.classList.remove('planet-fast');
                timer.innerText = "03:00:00";
                
                if(localCooldowns['mining'] && Date.now() < localCooldowns['mining']) {
                    const wait = Math.ceil((localCooldowns['mining'] - Date.now()) / 1000);
                    btn.innerHTML = `WAIT ${wait}s`;
                    btn.disabled = true;
                    btn.style.background = "#333";
                    progressBox.style.display = 'block';
                    barFill.style.width = ((adsWatched / REQ) * 100) + "%";
                    statusText.innerText = `Watch ${REQ - adsWatched} more ads to enable`;
                    return;
                }

                if (adsWatched < REQ) {
                    btn.innerHTML = `WATCH AD (${adsWatched}/${REQ})`; btn.disabled = false; btn.style.background = "var(--secondary)"; btn.style.color="#000";
                    progressBox.style.display = 'block';
                    barFill.style.width = ((adsWatched / REQ) * 100) + "%";
                    statusText.innerText = `Watch ${REQ - adsWatched} more ads to enable`;
                } else {
                    btn.innerHTML = `<i class="fas fa-power-off"></i> START ENGINE`; btn.disabled = false; btn.style.background = "#28a745"; btn.style.color = "#fff";
                    progressBox.style.display = 'none'; statusText.innerText = "System Ready.";
                }
            }
        }

        function initGalaxy() {
            const c = document.getElementById('galaxy-canvas'); const x = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            let s = []; for(let i=0;i<80;i++)s.push({x:Math.random()*c.width,y:Math.random()*c.height, r:Math.random()*1.5});
            function l(){x.clearRect(0,0,c.width,c.height);x.fillStyle='rgba(255,255,255,0.6)';s.forEach(p=>{p.y+=0.2;if(p.y>c.height)p.y=0;x.beginPath();x.arc(p.x,p.y,p.r,0,7);x.fill()});requestAnimationFrame(l)}
            l();
        }
        function openWModal() { document.getElementById('w-modal').style.display='flex'; }
        function openHModal() { 
            document.getElementById('h-modal').style.display='flex'; 
            const list = document.getElementById('h-list'); list.innerHTML = "<div style='text-align:center; margin-top:20px; color:#666;'><i class='fas fa-circle-notch fa-spin'></i> Loading...</div>";
            db.ref('Withdrawals').orderByChild('userId').equalTo(userId).once('value', snap => {
                list.innerHTML = "";
                if(!snap.exists()) { list.innerHTML="<p style='color:#777; text-align:center; margin-top:20px;'>No history found.</p>"; return; }
                const data = []; snap.forEach(c => data.push(c.val()));
                data.reverse().forEach(w => {
                    list.innerHTML += `<div class="hist-item"><div><b style='color:#fff; font-size:14px;'>₹${w.rupeeVal}</b><br><small style='color:#888'>${w.date}</small></div><div style='text-align:right; font-size:11px; color:#aaa;'>${w.method}<br><span class='status-${w.status}'>${w.status}</span></div></div>`;
                });
            });
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function calcVal() { document.getElementById('w-get').innerText = (document.getElementById('w-amount').value / ADMIN_RATE).toFixed(2); }
        function submitRequest() {
            const amt = parseInt(document.getElementById('w-amount').value);
            const met = document.getElementById('w-method').value;
            const det = document.getElementById('w-detail').value;
            if(!amt || !met || !det) return alert("Please fill all details.");
            if(amt < ADMIN_MIN_W) return alert(`Minimum withdrawal is ${ADMIN_MIN_W} Coins`);
            if(amt > userData.score) return alert("Insufficient Balance!");
            
            // Disable button
            const btn = document.querySelector('.btn-withdraw');
            const oldText = btn.innerHTML;
            btn.innerHTML = "Processing..."; btn.disabled = true;

            const req = { userId: userId, userName: userData.Name, amount: amt, rupeeVal: (amt/ADMIN_RATE).toFixed(2), method: met, details: det, status: "Pending", date: new Date().toLocaleString() };
            db.ref('Withdrawals').push(req).then(() => {
                db.ref(`Users/${userId}/score`).set(firebase.database.ServerValue.increment(-amt));
                alert("Withdrawal Requested Successfully!"); 
                closeModal('w-modal');
                document.getElementById('w-amount').value = "";
                btn.innerHTML = oldText; btn.disabled = false;
            });
        }
    </script>
</body>
</html>
