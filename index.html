<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tap-Tap Coin Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        /* --- NEW FONT FOR MODERN UI --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap');

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body{
            background-color:#1a1a2e;
            color:#fff;
            font-family:'Poppins',sans-serif;
            display:flex;
            justify-content:center;
            align-items:center;
            user-select:none;
            -webkit-user-select:none;
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease-out;
        }
        .loading-bear { font-size: 80px; animation: run-across 3s ease-in-out infinite; }
        .loading-text { margin-top: 20px; font-size: 24px; color: #fff; }
        #loading-progress-bar { width: 80%; max-width: 300px; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; margin-top: 30px; overflow: hidden; }
        #loading-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #4dff4d, #00b300); border-radius: 10px; animation: fill-progress 5s linear forwards; }
        @keyframes run-across {
            0% { transform: translateX(-100px) scaleX(1); } 49% { transform: translateX(100px) scaleX(1); }
            50% { transform: translateX(100px) scaleX(-1); } 99% { transform: translateX(-100px) scaleX(-1); }
            100% { transform: translateX(-100px) scaleX(1); }
        }
        @keyframes fill-progress { from { width: 0%; } to { width: 100%; } }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        
        .game-container{
            width:100%; 
            height:100%; 
            display:flex; 
            flex-direction:column; 
            position: relative; 
            background: radial-gradient(circle at 50% 50%, #3a4a6b, #1a1a2e); 
            overflow: hidden;
        }
        
        .screen {
            flex-grow:1; 
            display:flex; 
            flex-direction:column; 
            justify-content: center; 
            align-items:center; 
            width:100%; 
            z-index: 2; 
            padding: 20px; 
            box-sizing: border-box; 
            position: relative; 
            overflow-y: auto;
            padding-bottom: 250px; 
        }
        .screen.hidden{display:none}

        .scrollable-screen {
            justify-content: flex-start;
            padding-top: 30px;
        }

        .top-bar-container { position: absolute; top: 15px; left: 15px; z-index: 10; }
        .profile-section { display: flex; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 50px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: background-color 0.2s; }
        .profile-section:hover { background-color: rgba(0,0,0,0.5); }
        .profile-icon { font-size: 20px; }
        #player-name-display { font-size: 16px; font-weight: 600; }
        
        #airdrop-button {
            position: absolute; top: 15px; right: 65px;
            z-index: 11; font-size: 28px; cursor: pointer;
            padding: 8px; background-color: rgba(0,0,0,0.3);
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        #notification-bell {
            position: absolute; top: 15px; right: 15px; z-index: 11;
            font-size: 28px; cursor: pointer;
            padding: 8px; background-color: rgba(0,0,0,0.3);
            border-radius: 50%; width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        #notification-dot {
            position: absolute; top: 5px; right: 5px;
            width: 10px; height: 10px;
            background-color: red; border-radius: 50%;
            border: 2px solid #1a1a2e;
            display: none; 
        }
        #notification-dot.visible { display: block; }
        #notification-list { max-height: 250px; overflow-y: auto; text-align: left; width: 100%; }
        .notification-item { background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }

        .coin-container { width: 220px; height: 220px; cursor: pointer; -webkit-tap-highlight-color: transparent; display: flex; justify-content: center; align-items: center; margin: 20px 0; perspective: 1000px; }
        #coin-css { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle at 65% 35%, #fffec8, #ffc700 60%, #e0ac00 100%); box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.4), 0 10px 20px rgba(0, 0, 0, 0.5); position: relative; border: 10px solid #c8a443; display: flex; justify-content: center; align-items: center; text-align: center; transition: transform 0.3s ease-out; transform-style: preserve-3d; pointer-events: none; }
        #coin-css::before { content: ''; position: absolute; width: 80%; height: 80%; border: 4px solid rgba(0,0,0,0.15); border-radius: 50%; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        #coin-css::after { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 40%; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0)); border-radius: 50% / 100%; transform: rotate(45deg); }
        .coin-text { font-size: 24px; font-weight: 700; color: #8B4513; text-shadow: 1px 1px 2px rgba(255,255,255,0.4); line-height: 1.2; z-index: 5; }
        .stats-container { text-align: center; margin-bottom: 15px; margin-top: 60px;}
        #score-display{font-size:48px; font-weight:700; margin: 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.5);}
        #level-display { font-size: 22px; margin-top: 0; color: #ffdd57; font-weight: 600; }
        
        .flipping { animation: tap-flip 0.4s ease-out; }
        @keyframes tap-flip {
            0% { transform: scale(1) rotateY(0deg); } 50% { transform: scale(0.9) rotateY(180deg); } 100% { transform: scale(1) rotateY(360deg); }
        }

        .energy-bar-container{width:90%;max-width: 400px; margin:0 auto;}
        #energy-text{font-size:20px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        .energy-bar-background{background-color:rgba(0,0,0,.3);border-radius:15px;height:20px;padding:4px}
        #energy-bar-fill{background:linear-gradient(90deg,#4dff4d,#00b300);height:100%;border-radius:10px;width:100%;transition:width .2s linear}
        .floating-text{position:absolute;font-size:24px;font-weight:700;color:#fff;pointer-events:none;animation:float-up 1s ease-out forwards; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        @keyframes float-up{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-80px)}}

        .nav-container{
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            display:flex;
            justify-content:space-around;
            background-color:rgba(0,0,0,.3);
            padding: 10px 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
            z-index: 100;
            backdrop-filter: blur(5px);
            box-sizing: border-box;
        }
        .nav-button{cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:5px;opacity:.8;transition:opacity .2s; flex: 1;}
        .nav-button:hover,.nav-button.active{opacity:1}
        .nav-icon{font-size:28px}
        .nav-text{font-size:14px}
        
        #offer-nav-button {
            border-radius: 12px;
            background-color: rgba(243, 156, 18, 0.2);
            animation: pulse-offer-button 2.5s infinite ease-in-out;
            transform-origin: center center;
        }
        @keyframes pulse-offer-button {
            0% { transform: scale(1); box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }
            50% { transform: scale(1.08); box-shadow: 0 0 20px rgba(243, 156, 18, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 5px rgba(243, 156, 18, 0.3); }
        }

        #spin-earn-button, #rewards-hub-button, #zone-button, #eighteen-plus-button {
            position: absolute;
            left: 20px;
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            animation: pulse-boost 2s infinite;
        }
        #spin-earn-button {
            top: 130px; 
            background: linear-gradient(45deg, #e74c3c, #f39c12);
        }
        #rewards-hub-button {
            top: 180px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
        }
        #zone-button {
            top: 230px;
            background: linear-gradient(45deg, #3498db, #9b59b6);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.5);
        }
        /* नया 18+ बटन */
        #eighteen-plus-button {
            top: 280px;
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.5);
        }

        #spin-earn-button:hover, #rewards-hub-button:hover, #zone-button:hover, #eighteen-plus-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.7);
        }
         #rewards-hub-button:hover {
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.7);
        }
         #zone-button:hover {
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.7);
        }
        #eighteen-plus-button:hover {
             box-shadow: 0 8px 25px rgba(192, 57, 43, 0.7);
        }

        @keyframes pulse-boost {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .wheel-container {
            position: relative;
            width: 280px;
            height: 280px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #f39c12;
            z-index: 10;
        }
        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #c8a443;
            background-color: #e0ac00;
            position: relative;
            overflow: hidden;
            transition: transform 5s cubic-bezier(.2, .9, .3, 1);
        }
        .wheel-segment {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .segment-text {
            transform: rotate(90deg);
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        h2, h3{font-size:32px;margin-bottom:10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);}
        h3 {font-size: 28px;}
        p{font-size:18px;margin:5px 0}
        .back-button{background-color:#4CAF50;color:#fff;border:none;padding:15px 30px;font-size:18px;border-radius:10px;cursor:pointer;font-family:'Poppins',sans-serif; margin-top: 20px;}
        .popup{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .popup-content{background-color:#2c3e50;padding:30px;border-radius:15px;text-align:center;width:90%;max-width:380px;position:relative}
        .popup-content h3{margin-top:0}
        .popup-close{position:absolute;top:10px;right:15px;font-size:30px;cursor:pointer}
        .withdraw-options{display:flex;flex-direction:column;gap:15px;margin-top:20px}
        .withdraw-option{background-color:#3498db;color:#fff;border:none;padding:15px;font-size:16px;border-radius:10px;cursor:pointer}
        #withdraw-button{background-color:#3498db;margin-top:10px}
        #withdraw-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .withdraw-input { width: 100%; padding: 12px; font-size: 16px; background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        .withdraw-input::placeholder { color: rgba(255,255,255,0.5); }
        .options-container { display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 400px; }
        .option-card { background-color: rgba(0,0,0,0.2); border: 2px solid #8e44ad; padding: 20px; border-radius: 15px; text-align: center; cursor: default; transition: background-color 0.2s; }
        .option-card.clickable:hover { background-color: rgba(0,0,0,0.4); cursor: pointer; }
        .option-card h3 { margin: 0 0 10px 0; color: #9b59b6; }
        .option-card p { margin: 0 0 15px 0; font-size: 16px; }
        .option-card img { max-width: 60px; max-height: 60px; margin-top: 10px; border-radius: 8px;}
        .action-button { background-color: #9b59b6; color: white; border: none; padding: 10px 20px; font-size: 18px; border-radius: 10px; cursor: pointer; font-family: 'Poppins',sans-serif; transition: background-color 0.2s;}
        .action-button:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        
        .coin-flip-container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; box-sizing: border-box; }
        .bet-selection-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .bet-button { background-color: rgba(255,255,255,0.1); color: white; border: 2px solid #9b59b6; padding: 8px 16px; font-size: 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .bet-button.active { background-color: #9b59b6; box-shadow: 0 0 10px #9b59b6; }
        .coin-flip-buttons { display: flex; gap: 20px; }
        .coin-flip-button { padding: 15px 30px; font-size: 20px; }
        #flip-result { font-size: 24px; font-weight: bold; min-height: 30px; margin-top: 15px; }
        #flip-result.win { color: #2ecc71; }
        #flip-result.loss { color: #e74c3c; }
        
        .history-container { margin-top: 30px; width: 90%; max-width: 400px; background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .history-container h3 { font-size: 22px; margin-bottom: 15px; text-align: center; }
        #withdrawal-history-list { max-height: 150px; overflow-y: auto; padding-right: 10px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .history-item-details { text-align: left; }
        .history-item-meta { text-align: right; font-size: 12px; opacity: 0.8; display: flex; flex-direction: column; align-items: flex-end; }
        .history-item-meta .status { font-weight: bold; margin-top: 4px; }
        .status-processing { color: #f1c40f; }

        #ad-scripts-container {
            position: fixed;
            bottom: 75px; 
            left: 0;
            width: 100%;
            z-index: 101; 
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent; 
            padding: 5px 0;
            pointer-events: all;
        }

        .tournament-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #f39c12;
            padding: 20px;
            border-radius: 15px;
            text-align: left;
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s;
        }
        .tournament-card.finished {
            opacity: 0.6;
            border-color: #7f8c8d;
        }

        .tournament-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .tournament-card-logo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            background-color: rgba(0,0,0,0.3);
        }
        .tournament-card-title h3 {
            margin: 0;
            color: #f1c40f;
            font-size: 22px;
        }
        .tournament-card-title p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        .tournament-card p {
            font-size: 16px;
            margin: 4px 0;
            line-height: 1.5;
        }
        .tournament-card p strong {
            color: #fff;
        }
        .join-button {
            background-color: #f39c12;
            color: white;
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.2s;
        }
        .join-button:hover:not(:disabled) {
            background-color: #e67e22;
        }
        .join-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #tournament-join-popup .popup-content {
            background-color: #34495e;
        }
        #tournament-join-popup-image {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            margin-bottom: 15px;
            object-fit: cover;
        }
        #tournament-join-popup-fee {
            color: #f1c40f;
            font-weight: bold;
        }
        .join-popup-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            gap: 15px;
        }

        .room-info-container {
            background-color: rgba(46, 204, 113, 0.1);
            border: 1px solid #2ecc71;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .room-info-container h4 {
            margin: 0 0 8px 0;
            color: #2ecc71;
            font-size: 16px;
        }
        .room-info-container p {
            margin: 3px 0;
            font-size: 15px;
        }

        .participant-display-container {
            display: none;
            justify-content: space-around;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid rgba(241, 196, 15, 0.3);
            gap: 5px;
        }
        .team-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            text-align: center;
            min-width: 0;
        }
        .team-list h4 {
            margin: 0 0 8px 0;
            color: #f39c12;
            font-size: 16px;
            text-transform: uppercase;
        }
        .participant-item {
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            background-color: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vs-separator {
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            padding: 0 5px;
            align-self: center;
        }
        
        .participant-item.winner strong {
            color: #f1c40f;
        }
        .prize-distributed-message {
            text-align: center;
            font-weight: bold;
            color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #27ae60;
        }
        
        .ad-minimum-watch-note {
            font-size: 12px;
            color: #f1c40f;
            opacity: 0.8;
            margin-top: 8px;
            text-align: center;
            font-weight: 600;
        }

        .screen.tournament-bg {
            background: url('https://images.unsplash.com/photo-1581888224555-93d6a8f1b333?q=80&w=1932&auto=format&fit=crop') no-repeat center center/cover;
            position: relative;
            z-index: 1;
        }
        .screen.tournament-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(10, 10, 25, 0.7);
            z-index: -1;
        }
        
        .modern-tournament-card {
            font-family: 'Poppins', sans-serif;
            background: rgba(26, 26, 46, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 246, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(0, 246, 255, 0.25), 0 8px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }
        .modern-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .player-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00f6ff;
            object-fit: cover;
            box-shadow: 0 0 10px #00f6ff;
            flex-shrink: 0;
        }
        .tournament-details { min-width: 0; }
        .tournament-details h2 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            font-size: 20px;
            color: #ffffff;
            text-shadow: 0 0 5px #ffffff, 0 0 10px #00f6ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tournament-details p {
            margin: 0;
            font-size: 14px;
            color: #00f6ff;
            opacity: 0.9;
        }
        .modern-card-info-bar {
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 10px;
            border-radius: 12px;
            border-top: 1px solid rgba(0, 246, 255, 0.2);
            border-bottom: 1px solid rgba(0, 246, 255, 0.2);
        }
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 5px;
            flex: 1;
        }
        .info-item .icon { font-size: 24px; line-height: 1; }
        .info-item .icon.trophy { color: #ffc700; text-shadow: 0 0 8px #ffc700; }
        .info-item .icon.coin { color: #f39c12; text-shadow: 0 0 8px #f39c12; }
        .info-item .icon.calendar { color: #3498db; text-shadow: 0 0 8px #3498db; }
        .info-item span { font-size: 14px; font-weight: 600; color: #eee; }
        .modern-card-rules {
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #00f6ff;
        }
        .modern-card-rules p { margin: 0; font-size: 13px; color: #ccc; line-height: 1.5; }
        .modern-card-rules strong { color: #00f6ff; font-weight: 700; }
        .teams-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .team-box {
            flex: 1;
            background: linear-gradient(145deg, rgba(40, 40, 70, 0.8), rgba(20, 20, 40, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #ccc;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.2s ease-in-out;
        }
        .team-box:hover { border-color: #00f6ff; }
        .vs-separator-modern {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: #ff4757;
            text-shadow: 0 0 5px #ff4757, 0 0 15px #ff4757;
            animation: pulse-vs 2s infinite ease-in-out;
        }
        @keyframes pulse-vs { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .join-now-button {
            background: linear-gradient(45deg, #f39c12, #ff6b6b);
            color: #fff;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6), 0 0 25px rgba(255, 107, 107, 0.4);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .join-now-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.9), 0 0 40px rgba(255, 107, 107, 0.7);
        }
        .join-now-button:active { transform: translateY(0); }
        
        #offer-wall-screen {
            background-color: #121212; /* Dark background */
            justify-content: flex-start;
            padding-top: 30px;
            color: #ffffff; /* Default text color to white */
        }
        .offer-wall-container {
            width: 95%;
            max-width: 500px;
            background-color: #1e1e2d; /* Dark container */
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.3); /* Purple glow */
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            box-sizing: border-box;
        }
        .offer-wall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Lighter border for dark bg */
        }
        .offer-wall-item:last-child {
            border-bottom: none;
        }
        .offer-wall-item img {
            width: 55px;
            height: 55px;
            margin-right: 0;
            margin-bottom: 10px;
            flex-shrink: 0;
            border-radius: 12px;
        }
        .offer-wall-text {
            flex-grow: 1;
            text-align: center;
        }
        .offer-wall-text h3 {
            font-family: 'Poppins', sans-serif;
            margin: 0 0 2px 0;
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0; /* Light text color */
            text-shadow: none;
        }
        .offer-wall-text p {
            margin: 0;
            font-size: 14px;
            color: #a0a0a0; /* Greyer text color */
        }
        .offer-wall-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: 0;
        }
        .offer-wall-reward {
            font-size: 16px;
            font-weight: 700;
            color: #f39c12; /* Orange text */
            background-color: rgba(243, 156, 18, 0.15); /* Darker orange bg */
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid rgba(243, 156, 18, 0.5);
            white-space: nowrap;
        }
        .offer-wall-button {
            background-color: #9b59b6; /* Purple button */
            color: #ffffff;
            border: none; /* Removed border */
            padding: 8px 22px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .offer-wall-button:hover {
            background-color: #8e44ad; /* Darker purple on hover */
            transform: translateY(-1px);
        }

        #earn-box-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .earn-box-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            border: 2px solid #8e44ad;
            padding: 15px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .earn-box-item-info {
            text-align: left;
        }
        .earn-box-item-info h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #fff;
        }
        .earn-box-item-info p {
            margin: 0;
            font-size: 16px;
            color: #f1c40f;
            font-weight: bold;
        }
        .earn-box-button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }
        .earn-box-item.locked {
            opacity: 0.5;
            border-color: #7f8c8d;
            background-color: rgba(0,0,0,0.1);
        }
        .earn-box-item.locked .earn-box-button {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        .earn-box-item.claimed {
            border-color: #27ae60;
            background-color: rgba(46, 204, 113, 0.1);
        }
        .earn-box-item.claimed .earn-box-button {
            background-color: #27ae60;
            cursor: default;
        }
        .lucky-box-item {
            border-color: #e67e22;
            background: linear-gradient(45deg, rgba(230, 126, 34, 0.2), rgba(243, 156, 18, 0.2));
        }
        .lucky-box-item .earn-box-item-info h4 {
            color: #f39c12;
        }
        .lucky-box-progress {
            font-size: 14px;
            color: #ccc;
            margin-top: 5px;
        }
        .reward-task-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .reward-task-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .reward-task-buttons .action-button,
        .reward-task-buttons .join-telegram-button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
        }
        .join-telegram-button {
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins',sans-serif;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }
        .join-telegram-button:hover {
            background-color: #0077b3;
        }

        #customer-service-btn {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #0088cc, #00aaff);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.5);
            transition: all 0.2s ease-in-out;
            z-index: 10;
        }
        #customer-service-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 136, 204, 0.7);
        }
        
        .floating-ad-emoji {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            z-index: 50;
            user-select: none;
            -webkit-user-select: none;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            will-change: transform; /* Performance optimization */
        }
        
        .offer-submission-prompt {
            width: 95%;
            max-width: 500px;
            background-color: rgba(155, 89, 182, 0.15);
            border: 1px solid #9b59b6;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .offer-submission-prompt p {
            font-size: 14px;
            color: #ddd;
            margin: 0 0 15px 0;
            line-height: 1.5;
        }
        .user-id-container {
            background-color: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .user-id-container strong {
            color: #f39c12;
            font-family: monospace;
        }
        .copy-id-btn {
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .copy-id-btn:hover {
            opacity: 1;
        }
        .send-screenshot-btn {
            display: inline-block;
            background-color: #0088cc; /* Telegram Blue */
            color: #ffffff;
            padding: 10px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        .send-screenshot-btn:hover {
            background-color: #0077b3;
        }

        #ad-frame-wrapper {
            position: fixed; inset: 0; display: grid; 
            grid-template-rows: 1fr;
            background:#0b0f13; color:#fff; z-index: 9999;
        }
        #ad-frame-wrapper .overlay {
            position: absolute; top:16px; right:16px; display:flex; align-items:center; gap:8px;
            background: rgba(0,0,0,.55); border:1px solid #334155; padding:8px 12px; border-radius: 999px;
            backdrop-filter: blur(4px);
            z-index: 10;
            pointer-events: none;
        }
        #ad-frame-wrapper .timer {
            font-variant-numeric: tabular-nums; font-weight: 700;
        }
        #ad-frame-wrapper .closeBtn {
            pointer-events: auto; appearance:none; border:1px solid #334155; background:#111827; color:#9ca3af;
            padding:6px 10px; border-radius: 999px; cursor:not-allowed; opacity:.6;
            transition: all .2s ease;
        }
        #ad-frame-wrapper .closeBtn.enabled {
            background:#16a34a; border-color:#16a34a; color:#fff; cursor:pointer; opacity:1;
        }
        #ad-frame-wrapper .stage { position: relative; height: 100%; }
        #ad-container {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; overflow: auto;
        }
        #ad-container iframe {
            width: 100%; height: 100%; border: none;
        }

        #zone-ad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 20, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }
        .zone-ad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .zone-ad-coins, .zone-ad-timer {
            font-size: 16px;
            font-weight: 600;
        }
        .zone-ad-coins span {
            color: #f1c40f;
            font-family: 'Orbitron', sans-serif;
        }
        #zone-close-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
        }
        .zone-ad-content {
            flex-grow: 1;
            padding: 10px;
            box-sizing: border-box;
        }
        #zone-ad-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 10px;
            background-color: #000;
        }

        #movable-ad-container {
            position: fixed;
            bottom: 85px; 
            right: 10px;
            width: 300px;
            height: 70px;
            background-color: #1a1a2e;
            border: 2px solid #9b59b6;
            border-radius: 10px;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            touch-action: none; 
        }
        #movable-ad-header {
            background-color: #9b59b6;
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            text-align: center;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
            font-weight: bold;
            height: 20px;
            line-height: 20px;
        }
        #movable-ad-iframe {
            width: 100%;
            height: 50px; 
            border: none;
        }

        /* 18+ Ads Screen Styles */
        #eighteen-plus-screen {
            background:#111;
        }
        .ads-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 15px;
          width: 100%;
        }
        .ads-grid iframe {
          width: 100%;
          height: 200px;
          border: 2px solid #333;
          border-radius: 8px;
          background:#000;
          filter: blur(10px);
          transition: filter 0.4s ease;
        }
        .ads-grid iframe:hover {
          filter: blur(3px);
        }


    </style>
    
    <style>
        :root {
            --hk-bg: #0d0f21;
            --hk-glow: #00f6ff;
            --hk-purple: #9b59b6;
            --hk-card-bg: rgba(28, 32, 64, 0.7);
            --hk-border-color: rgba(0, 246, 255, 0.3);
        }

        body, .game-container {
            background-color: var(--hk-bg);
            background-image: radial-gradient(circle at 50% 20%, rgba(30, 34, 77, 0.8) 0%, transparent 60%);
            font-family: 'Poppins', sans-serif;
        }

        #score-display, #eighteen-plus-coin-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 52px;
            color: #ffffff;
            text-shadow: 0 0 8px #fff, 0 0 20px var(--hk-glow), 0 0 30px var(--hk-glow);
        }
        #eighteen-plus-coin-display { font-size: 32px; margin-bottom: 15px; }

        #level-display {
            color: var(--hk-glow);
            font-weight: 700;
            text-shadow: 0 0 10px var(--hk-glow);
        }

        #coin-css {
            background: radial-gradient(circle at 65% 35%, #2a305e, #1a1a2e 80%);
            border: 5px solid var(--hk-glow);
            box-shadow: 0 0 30px var(--hk-glow), inset 0 0 20px rgba(0, 246, 255, 0.3);
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
        }
        .coin-container:active #coin-css {
             transform: scale(0.95);
             box-shadow: 0 0 45px var(--hk-glow), inset 0 0 25px rgba(0, 246, 255, 0.5);
        }
        .coin-text { display: none; }
        #coin-css::before {
            content: '🐹';
            font-size: 100px;
            border: none;
            box-shadow: none;
            text-shadow: 0 0 15px #fff;
            animation: bounce-hamster 2s ease-in-out infinite;
        }
        @keyframes bounce-hamster {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        #coin-css::after { display: none; }
        
        #energy-text {
             text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        .energy-bar-background {
            background-color: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #energy-bar-fill {
            background: linear-gradient(90deg, #3498db, var(--hk-glow));
            box-shadow: 0 0 8px var(--hk-glow);
        }

        .nav-container {
            background-color: rgba(13, 15, 33, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--hk-border-color);
            padding-bottom: env(safe-area-inset-bottom, 5px);
            padding-top: 5px;
        }
        .nav-button {
            opacity: 0.7;
        }
        .nav-button.active, .nav-button:hover {
            opacity: 1;
        }
        .nav-button.active .nav-icon,
        .nav-button.active .nav-text {
            color: var(--hk-glow);
            text-shadow: 0 0 8px var(--hk-glow);
        }
        .nav-icon {
            transition: transform 0.2s;
        }
        .nav-button:hover .nav-icon {
            transform: translateY(-2px);
        }

        .action-button, .back-button, .join-button, .withdraw-option {
            background: linear-gradient(45deg, #8e44ad, var(--hk-purple));
            border: 1px solid rgba(155, 89, 182, 0.8);
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.5), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.2s ease-in-out;
            font-weight: 700;
        }
        .action-button:hover:not(:disabled), .back-button:hover:not(:disabled), .join-button:hover:not(:disabled), .withdraw-option:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(155, 89, 182, 0.8), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .action-button:disabled, .join-button:disabled {
            background: #50586c;
            border-color: #7f8c8d;
            box-shadow: none;
        }

        .option-card, .tournament-card, .coin-flip-container, .history-container, .popup-content, .offer-submission-prompt {
            background: var(--hk-card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--hk-border-color);
            border-radius: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        
        .option-card h3, h2, h3 {
             font-family: 'Orbitron', sans-serif;
             color: #fff;
             text-shadow: 0 0 5px #fff, 0 0 10px var(--hk-glow);
        }
        .option-card p {
            color: #ccc;
        }
        
        .popup-content {
            background: linear-gradient(135deg, #1e224d, #0d0f21);
        }
        #offer-wall-screen, .tournament-bg, .tournament-bg::before {
            background: var(--hk-bg) !important;
        }
        .tournament-bg {
             background-image: radial-gradient(circle at 50% 20%, rgba(30, 34, 77, 0.5) 0%, transparent 70%) !important;
        }
        
        .floating-text {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px var(--hk-glow);
        }

    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-bear">🐹</div>
        <div class="loading-text">Loading Game...</div>
        <div id="loading-progress-bar">
            <div id="loading-progress-fill" style="background: linear-gradient(90deg, #3498db, #00f6ff);"></div>
        </div>
    </div>

    <div class="game-container">
        <div class="top-bar-container">
            <div id="profile-section" class="profile-section">
                <span class="profile-icon">👤</span>
                <span id="player-name-display">Player</span> 
            </div>
        </div>
        <div id="airdrop-button">💝</div>
        <div id="notification-bell">
            🔔
            <span id="notification-dot"></span>
        </div>

        <div id="game-screen" class="screen">
            <div id="spin-earn-button">🚀</div>
            <div id="rewards-hub-button">🎁</div>
            <div id="zone-button" title="Time Zone">⚡️</div>
            <div id="eighteen-plus-button" title="18+ Ads">🔞</div>


            <div class="stats-container" style="margin-top: 60px;">
                <h1 id="score-display">0</h1>
                <div id="level-display">Level 1</div>
            </div>
            <div class="coin-container" id="coin-container">
                <div id="coin-css">
                    <div class="coin-text">TAP TO<br>EARN</div>
                </div>
            </div>
            <div class="energy-bar-container">
                <div id="energy-text">⚡️ 1000 / 1000</div>
                <div class="energy-bar-background"><div id="energy-bar-fill"></div></div>
                <div id="energy-timer-display" style="display: none; text-align: center; margin-top: 10px; font-size: 16px;"></div>
                <div id="fast-recovery-wrapper" style="display: none; width: 100%; text-align: center;">
                    <button id="fast-energy-recovery-btn" class="action-button" style="margin-top: 10px; width: 100%; background-color: #e67e22;">Watch Ad for Faster Refill</button>
                </div>
            </div>
        </div>
        
        <div id="games-screen" class="screen scrollable-screen hidden">
            <div class="coin-flip-container">
                <h2>🎲 Coin Flip Game 🎲</h2>
                <p>Select your bet amount:</p>
                <div class="bet-selection-container" id="bet-selection-container">
                    <button class="bet-button active" data-bet="100">100 🪙</button>
                    <button class="bet-button" data-bet="200">200 🪙</button>
                    <button class="bet-button" data-bet="1000">1K 🪙</button>
                    <button class="bet-button" data-bet="3000">3K 🪙</button>
                    <button class="bet-button" data-bet="5000">5K 🪙</button>
                </div>
                <p>Guess the outcome!</p>
                <div class="coin-flip-buttons">
                    <button id="heads-button" class="action-button coin-flip-button">Heads</button>
                    <button id="tails-button" class="action-button coin-flip-button">Tails</button>
                </div>
                <div id="flip-result">Choose your side!</div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="earn-box-screen" class="screen scrollable-screen hidden">
            <h2>☀️ Daily Earn Box ☀️</h2>
            <p style="font-size: 16px; text-align: center; max-width: 350px;">Complete tasks daily to earn rewards. Progress resets every day!</p>
            <div id="earn-box-list-container" class="options-container" style="margin-top: 20px;"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="rewards-hub-screen" class="screen scrollable-screen hidden">
            <h2>🎁 Rewards Hub 🎁</h2>
            <div class="options-container">
                <div class="option-card reward-task-card">
                    <h3>Join Our Community</h3>
                    <p>Join our official Telegram channel for updates, announcements, and special events. Get 99 coins as a one-time reward!</p>
                    <div class="reward-task-buttons">
                        <a href="https://t.me/taptoearningsquid" target="_blank" id="join-telegram-link" class="join-telegram-button">Join Channel</a>
                        <button id="claim-telegram-reward-btn" class="action-button" style="background-color:#27ae60;" disabled>Claim 99 🪙</button>
                    </div>
                </div>

                <div class="option-card reward-task-card">
                    <h3>Daily Bonus</h3>
                    <p>Come back every day to claim your free 20 coins!</p>
                    <div class="reward-task-buttons">
                         <button id="claim-daily-bonus-btn" class="action-button" style="background-color:#e67e22;">Claim 20 🪙</button>
                    </div>
                </div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tournament-screen" class="screen scrollable-screen hidden tournament-bg">
            <h2>🏆 All Events & Games 🏆</h2>
            <div id="tournament-list-container" class="options-container"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="offer-wall-screen" class="screen scrollable-screen hidden">
            <div class="offer-submission-prompt">
                <p>After completing any offer, send a screenshot with your User ID to our support for verification.</p>
                <div class="user-id-container">
                    Your User ID: <strong id="user-id-display-offer"></strong> 
                    <span class="copy-id-btn" title="Copy User ID">📋</span>
                </div>
                <a href="https://t.me/Costomer_c" target="_blank" class="send-screenshot-btn">Send Offer Screenshot</a>
            </div>

            <div id="offer-wall-container" class="offer-wall-container">
                 <p style="color: #6c757d; text-align: center;">Loading offers...</p>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="tasks-screen" class="screen hidden">
            <h2>📝 Offers & Tasks 📝</h2>
            <div id="tasks-container-all" class="options-container">
                <div id="tasks-options-container"></div>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div id="video-screen" class="screen scrollable-screen hidden">
            <h2>🎥 Refer & Watch 🎥</h2>
            <div id="video-tasks-container" class="options-container"></div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <div id="wallet-screen" class="screen hidden">
            <a href="https://t.me/Costomer_c" target="_blank" id="customer-service-btn" title="Contact">🎧</a>

            <h2>👛 My Wallet 👛</h2>
            <p>Your current balance is:</p>
            <h1 id="wallet-score">0</h1>
            <p id="rupee-value">Value: ₹0.00 INR</p>
            
            <div id="withdrawal-ad-task-container" class="options-container" style="width: 100%; margin-top: 20px;"></div>

            <p id="withdrawal-day-note" style="color: #f1c40f; font-weight: bold; margin-top: 15px; text-align: center; display: none;"></p>
            
            <button id="withdraw-button" class="back-button">Withdraw All Coins</button>
            
            <button class="back-button" data-screen="game-screen">Back to Game</button>
            <div class="history-container">
                <h3>Withdrawal History</h3>
                <div id="withdrawal-history-list">
                    <p style="text-align: center; font-size: 16px; opacity: 0.7;">No withdrawal history found.</p>
                </div>
            </div>
        </div>

        <div id="airdrop-screen" class="screen hidden">
            <h2>💝 Love Coin Airdrop 💝</h2>
            <p>Your current Love Coin balance:</p>
            <h1 id="love-coin-balance-display" style="color: #ff80ab;">0 💝</h1>
            <div class="option-card">
                <h3>Earn Love Coins</h3>
                <p>Watch a short ad to receive 1 Love Coin instantly!</p>
                <button id="watch-ad-for-love-coin-btn" class="action-button" style="background-color: #e91e63;">Watch Ad (+1 💝)</button>
            </div>
            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>

        <!-- नई 18+ Ads स्क्रीन -->
        <div id="eighteen-plus-screen" class="screen scrollable-screen hidden">
            <h2>🚀 18+ Ads Zone 🚀</h2>
            <p>You are earning 1 coin per second!</p>
            <h1 id="eighteen-plus-coin-display">0 🪙</h1>

            <!-- CHANGE START: This container will be filled by JavaScript -->
            <div class="ads-grid">
                <!-- Iframes will be generated here dynamically -->
            </div>
            <!-- CHANGE END -->

            <button class="back-button" data-screen="game-screen">Back to Game</button>
        </div>
        
        <div class="nav-container">
            <div class="nav-button active" data-screen="game-screen"><span class="nav-icon">🏠</span><span class="nav-text">Home</span></div>
            <div class="nav-button" data-screen="games-screen"><span class="nav-icon">🎮</span><span class="nav-text">Games</span></div>
            <div class="nav-button" data-screen="earn-box-screen"><span class="nav-icon">🎁</span><span class="nav-text">Earn</span></div>
            <div class="nav-button" data-screen="tournament-screen"><span class="nav-icon">🏆</span><span class="nav-text">All</span></div>
            <div class="nav-button" id="offer-nav-button" data-screen="offer-wall-screen"><span class="nav-icon">📲</span><span class="nav-text">Offer</span></div>
            <div class="nav-button" data-screen="tasks-screen"><span class="nav-icon">📝</span><span class="nav-text">Tasks</span></div>
            <div class="nav-button" data-screen="video-screen"><span class="nav-icon">🎥</span><span class="nav-text">Video</span></div>
            <div class="nav-button" data-screen="wallet-screen"><span class="nav-icon">👛</span><span class="nav-text">Wallet</span></div>
        </div>
    </div>
    
    <div id="notification-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="close-notification-btn">×</span>
            <h3>🔔 Notifications</h3>
            <div id="notification-list">
                <p>No new messages.</p>
            </div>
        </div>
    </div>

    <div id="spin-wheel-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="spin-wheel-popup-close">×</span>
            <h3>Spin to Earn!</h3>
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <div id="wheel"></div>
            </div>
            <button id="spin-button" class="action-button" style="background-color: #f39c12; width: 100%; padding: 15px; font-size: 20px;">
                Spin
            </button>
        </div>
    </div>

    <div id="withdraw-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="popup-close-button">×</span>
            <h3>Withdraw All Coins</h3>
            <p>You are about to withdraw your entire balance:</p>
            <h3 id="popup-withdrawal-amount" style="color: #ffdd57; margin-top: 10px;"></h3>
            <p id="popup-withdrawal-value-inr" style="margin-bottom: 20px;"></p>
            <div class="withdraw-options">
                <input type="text" id="withdrawal-name-input" class="withdraw-input" placeholder="Enter your full name">
                <input type="text" id="withdrawal-upi-input" class="withdraw-input" placeholder="Enter your UPI ID">
                <button id="upi-withdraw-button" class="withdraw-option">Proceed with UPI</button>
            </div>
        </div>
    </div>
    <div id="name-change-popup" class="popup">
        <div class="popup-content">
            <h3>Enter your name:</h3>
            <input type="text" id="new-name-input" class="withdraw-input" placeholder="Enter new name" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-around; margin-top: 25px; gap: 15px;">
                <button id="cancel-name-button" class="action-button" style="background-color: #e74c3c; flex: 1;">CANCEL</button>
                <button id="confirm-name-button" class="action-button" style="background-color: #2ecc71; flex: 1;">OK</button>
            </div>
        </div>
    </div>

    <div id="tournament-join-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" id="tournament-join-popup-close">×</span>
            <img id="tournament-join-popup-image" src="" alt="Tournament Logo">
            <h3 id="tournament-join-popup-title">Join Tournament</h3>
    
            <div id="tournament-ad-view">
                <p style="font-size: 16px; margin-top: 15px;">You must watch 5 ads to proceed.</p>
                <p>Progress: <strong id="tournament-ad-progress">0 / 5</strong></p>
                <button id="tournament-watch-ad-btn" class="action-button" style="background-color: #f39c12; margin-top: 15px;">Watch Ad</button>
                <button id="tournament-ad-cancel-btn" class="action-button" style="background-color: #e74c3c; margin-top: 10px;">Cancel</button>
            </div>
    
            <div id="tournament-confirm-view" style="display: none;">
                <p>Entry Fee: <strong id="tournament-join-popup-fee">0 🪙</strong></p>
                <p style="font-size: 16px; margin-top: 15px;">Confirm your name to join:</p>
                <input type="text" id="tournament-join-name-input" class="withdraw-input" placeholder="Enter your name">
                <div class="join-popup-buttons">
                    <button id="tournament-join-cancel-btn" class="action-button" style="background-color: #e74c3c; flex: 1;">Cancel</button>
                    <button id="tournament-join-confirm-btn" class="action-button" style="background-color: #f39c12; flex: 1;">Confirm & Join</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="tap-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2b4065a46d.mp3" preload="auto"></audio>
    
    <div id="ad-frame-wrapper" style="display: none;">
        <div class="stage">
            <div class="overlay">
                <span>Close in</span>
                <span class="timer" id="ad-timer">15s</span>
                <button id="ad-close-btn" class="closeBtn" disabled>Close</button>
            </div>
            <div id="ad-container">
            </div>
        </div>
    </div>

    <div id="zone-ad-overlay" style="display: none;">
        <div class="zone-ad-header">
            <div class="zone-ad-coins">Coins: <span id="zone-coin-display">0</span></div>
            <div class="zone-ad-timer">Next Ad In: <span id="zone-next-ad-timer">30</span>s</div>
            <button id="zone-close-btn">✖ Close</button>
        </div>
        <div class="zone-ad-content">
            <iframe id="zone-ad-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <div id="auto-ad-overlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 99999; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box;">
        <div style="position: relative; width: 100%; max-width: 330px; height: 100%; max-height: 490px; background-color: #000; border: 2px solid #333; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.5);">
            <div style="padding: 8px 12px; background-color: #1a1a2e; text-align: right; flex-shrink: 0;">
                <span id="auto-ad-timer" style="color: white; font-size: 14px; font-weight: bold; font-family: 'Poppins', sans-serif;"></span>
            </div>
            <iframe id="auto-ad-iframe" style="width: 100%; height: 100%; border: none; flex-grow: 1;"></iframe>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBJrCE4w_QfBqfF3g4O_RuCK4DbjmL9TRg",
          authDomain: "telegram-69052.firebaseapp.com",
          databaseURL: "https://telegram-69052-default-rtdb.firebaseio.com",
          projectId: "telegram-69052",
          storageBucket: "telegram-69052.firebasestorage.app",
          messagingSenderId: "824247387361",
          appId: "1:824247387361:web:f4e6c22abb4b503871a3a0",
          measurementId: "G-GB3LP113V6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isAdCurrentlyShowing = false; 

        let automaticAdTimerInterval = null;
        const autoAdOverlay = document.getElementById('auto-ad-overlay');
        const autoAdIframe = document.getElementById('auto-ad-iframe');
        const autoAdTimerDiv = document.getElementById('auto-ad-timer');
        const AUTO_AD_URL = 'https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315';
        const AUTO_AD_INTERVAL = 28000;
        const AUTO_AD_DURATION = 6000;

        function showAutomaticAd() {
            if (isAdCurrentlyShowing) return;

            console.log("Automatic ad dikhaya ja raha hai...");
            isAdCurrentlyShowing = true;
            autoAdIframe.src = AUTO_AD_URL;
            autoAdOverlay.style.display = 'flex';

            let timeLeft = AUTO_AD_DURATION / 1000;
            
            const updateTimerText = () => {
                autoAdTimerDiv.textContent = `Ad will close in ${timeLeft}s`;
            };
            
            updateTimerText();

            const timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerText();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);

            setTimeout(() => {
                autoAdOverlay.style.display = 'none';
                autoAdIframe.src = 'about:blank';
                isAdCurrentlyShowing = false;
                console.log("Automatic ad band ho gaya.");
            }, AUTO_AD_DURATION);
        }

        function tryToShowAutomaticAd() {
            if (isAdCurrentlyShowing) {
                console.log("Auto Ad Roka Gaya: Koi aur ad pehle se chal raha hai.");
                return;
            }

            const isPopupOpen = document.querySelector('.popup[style*="display: flex"]');
            if (isPopupOpen) {
                console.log("Auto Ad Roka Gaya: Ek popup khula hai.");
                return;
            }
            
            const isZoneOpen = document.getElementById('zone-ad-overlay').style.display !== 'none';
             if (isZoneOpen) {
                console.log("Auto Ad Roka Gaya: Time Zone active hai.");
                return;
            }

            const isEighteenPlusOpen = !document.getElementById('eighteen-plus-screen').classList.contains('hidden');
            if (isEighteenPlusOpen) {
                console.log("Auto Ad Roka Gaya: 18+ Ads screen active hai.");
                return;
            }

            showAutomaticAd();
        }

        function startAutomaticAdTimer() {
            if (automaticAdTimerInterval) clearInterval(automaticAdTimerInterval);
            automaticAdTimerInterval = setInterval(tryToShowAutomaticAd, AUTO_AD_INTERVAL);
            console.log("Automatic ad timer shuru ho gaya hai.");
        }

        const adFrameWrapper = document.getElementById('ad-frame-wrapper');
        const adTimerEl = document.getElementById('ad-timer');
        const adCloseBtn = document.getElementById('ad-close-btn');
        const adContainer = document.getElementById('ad-container');
        let adCanClose = false;
        let adCountdownInterval;

        function showAdFrame(adUrl, onCompleteCallback) {
            isAdCurrentlyShowing = true;
            adCanClose = false;
            let remaining = 15;

            adTimerEl.textContent = remaining + 's';
            adCloseBtn.setAttribute('disabled', 'true');
            adCloseBtn.classList.remove('enabled');
            adCloseBtn.onclick = null;

            adContainer.innerHTML = '';
            const iframe = document.createElement('iframe');
            iframe.src = adUrl;
            adContainer.appendChild(iframe);
            
            adFrameWrapper.style.display = 'grid';

            history.pushState(null, '', location.href);
            const blockBack = () => {
                if (!adCanClose) {
                    history.pushState(null, '', location.href);
                }
            };
            window.addEventListener('popstate', blockBack);

            function unlock() {
                adCanClose = true;
                adCloseBtn.removeAttribute('disabled');
                adCloseBtn.classList.add('enabled');
                adCloseBtn.onclick = () => {
                    isAdCurrentlyShowing = false;
                    adFrameWrapper.style.display = 'none';
                    adContainer.innerHTML = '';
                    window.removeEventListener('popstate', blockBack);
                    if (onCompleteCallback && typeof onCompleteCallback === 'function') {
                        onCompleteCallback();
                    }
                };
            }

            if (adCountdownInterval) clearInterval(adCountdownInterval);
            adCountdownInterval = setInterval(() => {
                remaining -= 1;
                if (remaining <= 0) {
                    clearInterval(adCountdownInterval);
                    unlock();
                }
                adTimerEl.textContent = (remaining > 0 ? remaining : 0) + 's';
            }, 1000);

            setTimeout(() => { if (!adCanClose) unlock(); }, (15 + 1) * 1000);
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'BKC';
            for (let i = 0; i < 3; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function copyTextToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to your clipboard!');
                }).catch(err => {
                    console.error('Modern copy failed, trying fallback: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('Copied to your clipboard!');
                } else {
                    alert('Could not copy. Please copy it manually.');
                }
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Could not copy. Please copy it manually.');
            }
            document.body.removeChild(textArea);
        }

        function handleIncomingReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                sessionStorage.setItem('referrerCode', refCode);
            }
        }

        function creditReferrer(referralCode) {
            if (!referralCode) return;
            const usersRef = database.ref('Users');
            usersRef.orderByChild('myReferralC').equalTo(referralCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const referrerData = snapshot.val();
                    const referrerId = Object.keys(referrerData)[0];
                    const referrerUserRef = database.ref(`Users/${referrerId}`);
                    referrerUserRef.transaction(userData => {
                        if (userData) {
                            userData.score = (userData.score || 0) + 700;
                            userData.Totalearning = (userData.Totalearning || 0) + 700;
                        }
                        return userData;
                    });
                    console.log(`Credited 700 coins to referrer ${referrerId}`);
                }
            });
        }

        function updateUserPresence(userId) {
            if (!userId) return;
            const userPresenceRef = database.ref('/Users/' + userId + '/presence');
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userPresenceRef.set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    userPresenceRef.onDisconnect().set({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                }
            });
        }

        function getOrCreateUserId() {
            let userId = localStorage.getItem('tapGameUserId');
            if (!userId) {
                userId = database.ref().push().key;
                localStorage.setItem('tapGameUserId', userId);
            }
            return userId;
        }
        const userId = getOrCreateUserId();
        
        function logUserEvent(eventName, eventData = {}) {
            if (!userId) return;
            const activityRef = database.ref(`userActivity/${userId}`);
            activityRef.push({
                eventName: eventName,
                eventData: eventData,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error("Error logging event:", error);
            });
        }

        let sessionStartTime = Date.now();
        let totalOnlineTime = 0;

        function updateOnlineTime() {
            if (sessionStartTime) {
                const sessionDuration = Date.now() - sessionStartTime;
                totalOnlineTime += sessionDuration;
                sessionStartTime = Date.now(); 
                
                const userRef = database.ref(`Users/${userId}`);
                userRef.child('totalOnlineTime').set(firebase.database.ServerValue.increment(sessionDuration));
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                updateOnlineTime();
                sessionStartTime = null; 
            } else {
                sessionStartTime = Date.now(); 
            }
        });
        window.addEventListener('beforeunload', updateOnlineTime);

        setInterval(updateOnlineTime, 60000);

        const videoAdTasks = [
            { id: 'videoTask1', title: 'Starter Video Pack', description: 'Watch 20 videos to earn 900 coins.', goal: 20, reward: 900, url: 'https://www.profitableratecpm.com/qshhszvnad?key=4761223a00e52bd9f2e24d515e6be228' },
            { id: 'videoTask2', title: 'Video Marathon', description: 'Watch 150 videos to earn 5,000 coins.', goal: 150, reward: 5000, url: 'https://www.profitableratecpm.com/vibjgr90?key=2731d0788209fe1d948dd17fd0e0831f' },
            { id: 'videoTask3', title: 'Ultimate Video Challenge', description: 'Watch 3000 videos to earn 35,000 coins.', goal: 3000, reward: 35000, url: 'https://www.profitableratecpm.com/u745rvnfy?key=f5ec06ad491fd1ceab3af658fd2d3010' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            updateUserPresence(userId);

            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 3000);

            const elements = {
                gameScreen: document.getElementById('game-screen'), profileSection: document.getElementById('profile-section'), playerNameDisplay: document.getElementById('player-name-display'),
                coinContainer: document.getElementById('coin-container'), coinCss: document.getElementById('coin-css'), scoreDisplay: document.getElementById('score-display'),
                energyText: document.getElementById('energy-text'), energyBarFill: document.getElementById('energy-bar-fill'), screens: document.querySelectorAll('.screen'),
                navButtons: document.querySelectorAll('.nav-button'), walletScore: document.getElementById('wallet-score'), levelDisplay: document.getElementById('level-display'),
                rupeeValue: document.getElementById('rupee-value'), withdrawButton: document.getElementById('withdraw-button'), withdrawPopup: document.getElementById('withdraw-popup'),
                popupCloseButton: document.getElementById('popup-close-button'), upiWithdrawButton: document.getElementById('upi-withdraw-button'),
                popupWithdrawalAmount: document.getElementById('popup-withdrawal-amount'), popupWithdrawalValueInr: document.getElementById('popup-withdrawal-value-inr'),
                withdrawalNameInput: document.getElementById('withdrawal-name-input'), withdrawalUpiInput: document.getElementById('withdrawal-upi-input'),
                headsButton: document.getElementById('heads-button'), tailsButton: document.getElementById('tails-button'), flipResult: document.getElementById('flip-result'),
                betSelectionContainer: document.getElementById('bet-selection-container'), tapSound: document.getElementById('tap-sound'), withdrawalHistoryList: document.getElementById('withdrawal-history-list'),
                nameChangePopup: document.getElementById('name-change-popup'), newNameInput: document.getElementById('new-name-input'),
                confirmNameButton: document.getElementById('confirm-name-button'), cancelNameButton: document.getElementById('cancel-name-button'),
                tasksOptionsContainer: document.getElementById('tasks-options-container'),
                videoTasksContainer: document.getElementById('video-tasks-container'),
                withdrawalAdTaskContainer: document.getElementById('withdrawal-ad-task-container'),
                notificationBell: document.getElementById('notification-bell'),
                notificationDot: document.getElementById('notification-dot'),
                notificationPopup: document.getElementById('notification-popup'),
                notificationList: document.getElementById('notification-list'),
                closeNotificationBtn: document.getElementById('close-notification-btn'),
                energyTimerDisplay: document.getElementById('energy-timer-display'),
                fastEnergyRecoveryBtn: document.getElementById('fast-energy-recovery-btn'),
                fastRecoveryWrapper: document.getElementById('fast-recovery-wrapper'),
                tournamentScreen: document.getElementById('tournament-screen'),
                tournamentListContainer: document.getElementById('tournament-list-container'),
                tournamentJoinPopup: document.getElementById('tournament-join-popup'),
                tournamentJoinPopupClose: document.getElementById('tournament-join-popup-close'),
                tournamentJoinPopupImage: document.getElementById('tournament-join-popup-image'),
                tournamentJoinPopupTitle: document.getElementById('tournament-join-popup-title'),
                tournamentJoinPopupFee: document.getElementById('tournament-join-popup-fee'),
                tournamentJoinNameInput: document.getElementById('tournament-join-name-input'),
                tournamentJoinCancelBtn: document.getElementById('tournament-join-cancel-btn'),
                tournamentJoinConfirmBtn: document.getElementById('tournament-join-confirm-btn'),
                tournamentAdView: document.getElementById('tournament-ad-view'),
                tournamentConfirmView: document.getElementById('tournament-confirm-view'),
                tournamentAdProgress: document.getElementById('tournament-ad-progress'),
                tournamentWatchAdBtn: document.getElementById('tournament-watch-ad-btn'),
                tournamentAdCancelBtn: document.getElementById('tournament-ad-cancel-btn'),
                airdropButton: document.getElementById('airdrop-button'),
                airdropScreen: document.getElementById('airdrop-screen'),
                loveCoinBalanceDisplay: document.getElementById('love-coin-balance-display'),
                watchAdForLoveCoinBtn: document.getElementById('watch-ad-for-love-coin-btn'),
                offerWallContainer: document.getElementById('offer-wall-container'),
                earnBoxScreen: document.getElementById('earn-box-screen'),
                earnBoxListContainer: document.getElementById('earn-box-list-container'),
                spinEarnButton: document.getElementById('spin-earn-button'),
                spinWheelPopup: document.getElementById('spin-wheel-popup'),
                spinWheelPopupClose: document.getElementById('spin-wheel-popup-close'),
                wheel: document.getElementById('wheel'),
                spinButton: document.getElementById('spin-button'),
                withdrawalDayNote: document.getElementById('withdrawal-day-note'),
                rewardsHubButton: document.getElementById('rewards-hub-button'),
                rewardsHubScreen: document.getElementById('rewards-hub-screen'),
                joinTelegramLink: document.getElementById('join-telegram-link'),
                claimTelegramRewardBtn: document.getElementById('claim-telegram-reward-btn'),
                claimDailyBonusBtn: document.getElementById('claim-daily-bonus-btn'),
                userIdDisplayOffer: document.getElementById('user-id-display-offer'),
                zoneButton: document.getElementById('zone-button'),
                zoneAdOverlay: document.getElementById('zone-ad-overlay'),
                zoneCoinDisplay: document.getElementById('zone-coin-display'),
                zoneNextAdTimer: document.getElementById('zone-next-ad-timer'),
                zoneCloseBtn: document.getElementById('zone-close-btn'),
                zoneAdIframe: document.getElementById('zone-ad-iframe'),
                eighteenPlusButton: document.getElementById('eighteen-plus-button'), // नया
                eighteenPlusCoinDisplay: document.getElementById('eighteen-plus-coin-display'), // नया
            };

            document.querySelector('.copy-id-btn').addEventListener('click', () => {
                if (userId) {
                    const originalAlert = window.alert;
                    window.alert = function(msg) {
                        if (msg.includes('Copied to your clipboard!')) {
                            originalAlert('User ID Copied!');
                        } else {
                            originalAlert(msg);
                        }
                    };
                    copyTextToClipboard(userId);
                    window.alert = originalAlert;
                    
                    const copyBtn = document.querySelector('.copy-id-btn');
                    const originalIcon = copyBtn.textContent;
                    copyBtn.textContent = '✅';
                    setTimeout(() => {
                        copyBtn.textContent = originalIcon;
                    }, 1500);
                }
            });

            let gameSettings = {
                withdrawalsLocked: false,
                withdrawalButtonText: 'Withdraw All Coins',
                isWithdrawalForceUnlocked: false,
                coinValue: 1000,
            };

            let state = {
                score: 0, playerName: 'Player', currentLevel: 1, tapPower: 1, tapUpgradeLevel: 0,
                maxEnergy: 1000, currentEnergy: 1000,
                myReferralC: null, referredBy: null,
                videoTask1Progress: 0, videoTask2Progress: 0, videoTask3Progress: 0,
                videoTask1Claimed: false, videoTask2Claimed: false, videoTask3Claimed: false,
                withdrawalAdClicks: 0,
                tapCounter: 0,
                messages: [],
                energyDepletedTime: 0,
                energyRecoveryDuration: 0, 
                fastRecoveryAdsWatched: 0,
                loveCoins: 0,
                joinedTournaments: {},
                earnBoxProgress: 0,
                earnBoxLastReset: new Date().toDateString(),
                luckyBoxAdProgress: 0,
                luckyBoxClaimed: false,
                telegramJoinedClaimed: false,
                lastDailyBonusClaim: null,
                isIndividuallyLocked: false,
                totalOnlineTime: 0, 
                creationTime: 0, 
            };
            
            let currentBetAmount = 100;
            let isSpinning = false; 

            let currentTournamentJoinProcess = {
                details: null,
                adsWatched: 0,
                adsRequired: 5,
                adUrl: 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6'
            };
            
            const spinPrizes = [
                { text: '3 🪙', type: 'coin', value: 3, chance: 35, color: '#2ecc71' },
                { text: '2 🪙', type: 'coin', value: 2, chance: 30, color: '#3498db' },
                { text: '5 🪙', type: 'coin', value: 5, chance: 15, color: '#9b59b6' },
                { text: '1 💝', type: 'lovecoin', value: 1, chance: 10, color: '#e91e63' },
                { text: '8 🪙', type: 'coin', value: 8, chance: 10, color: '#e67e22' }
            ];

            const zoneAdLinks = [
                'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44',
                'https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315',
                'https://www.profitableratecpm.com/d4cku5ewnn?key=a29645f253b4d6eb62da85d3f5105d02',
                'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6',
                'https://www.profitableratecpm.com/qshhszvnad?key=4761223a00e52bd9f2e24d515e6be228',
                'https://www.profitableratecpm.com/vibjgr90?key=2731d0788209fe1d948dd17fd0e0831f',
                'https://www.profitableratecpm.com/u745rvnfy?key=f5ec06ad491fd1ceab3af658fd2d3010'
            ];

            let isZoneActive = false;
            let zoneCoinInterval = null;
            let zoneNextAdTimeout = null;
            let zoneTimerInterval = null;
            let currentAdIndex = 0;
            let zoneEarnedCoins = 0;

            // 18+ Ads Zone Variables
            let eighteenPlusInterval = null;
            let eighteenPlusEarnedCoins = 0;
            let areRotatingAdsSetup = false; // Flag to prevent multiple setups

            // CHANGE START: New function for rotating ads
            function setupRotatingAds() {
                if (areRotatingAdsSetup) return; // Agar pehle se setup hai to दोबारा na chalayein

                const ads = [
                    "https://www.effectivecpmrate.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44", "https://www.effectivecpmrate.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315",
                    "https://www.effectivecpmrate.com/d4cku5ewnn?key=a29645f253b4d6eb62da85d3f5105d02", "https://www.effectivecpmrate.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6",
                    "https://www.effectivecpmrate.com/uhnqngyf?key=d467c8e5498339a61ae6addd69e30d9e", "https://www.effectivecpmrate.com/qshhszvnad?key=4761223a00e52bd9f2e24d515e6be228",
                    "https://www.effectivecpmrate.com/vibjgr90?key=2731d0788209fe1d948dd17fd0e0831f", "https://www.effectivecpmrate.com/kqjzi4xeiy?key=f578578e5fd55e77bc7a4ed6db68ab12",
                    "https://www.effectivecpmrate.com/u745rvnfy?key=f5ec06ad491fd1ceab3af658fd2d3010", "https://www.effectivecpmrate.com/d9z62k5p?key=08f4a2df35c92d1a70c52d6e15e9330b",
                    "https://www.effectivecpmrate.com/rj6vbfw?key=ea05d3f2e8ff71c42d3a3459dff90bc5", "https://www.effectivecpmrate.com/y3b5q8?key=92d758e3f13c242ee20f7183762a8fa6",
                    "https://www.effectivecpmrate.com/f3pxgvd?key=bfe18a6c5f912ce45c390f7e16317e82", "https://www.effectivecpmrate.com/z2m8hf?key=9e6c5f10d842713e4fcf718c5a173d0f",
                    "https://www.effectivecpmrate.com/w4t7h9?key=2c7b71d9e014c34e92f46a9f851b21de", "https://www.effectivecpmrate.com/x6r3jk?key=84f5a6d3e182b14e3c9f471d6a5c9a30",
                    "https://www.effectivecpmrate.com/ek5ustzbq?key=58f7db2163388fdd87a9f8962e87ca00", "https://www.effectivecpmrate.com/vg9i0xb8d?key=b5bb38294632caf2dd245bd68ce66b6a",
                    "https://www.effectivecpmrate.com/uf1tkctz?key=43c2218a238e8421bcbf0847d9839a69", "https://www.effectivecpmrate.com/tx32n4xkyq?key=7bbbf8fd5ad8a5e7a9093c60604087a2"
                ];

                const adsContainer = document.querySelector("#eighteen-plus-screen .ads-grid");
                if (!adsContainer) return;
                
                adsContainer.innerHTML = ''; // Pehle se मौजूद iframes ko saaf karein
                const totalIframes = 21; // Kitne iframe dikhane hain

                for (let i = 0; i < totalIframes; i++) {
                    const iframe = document.createElement("iframe");
                    iframe.src = ads[(i % ads.length)];
                    adsContainer.appendChild(iframe);

                    // Har ek iframe ke liye alag interval set karein
                    (function(currentIframe, initialIndex) {
                        let adIndex = initialIndex;
                        const intervalTime = (30 + i * 10) * 1000;
                        
                        setInterval(() => {
                            adIndex = (adIndex + 1) % ads.length;
                            currentIframe.src = ads[adIndex];
                        }, intervalTime);
                    })(iframe, (i % ads.length));
                }
                
                areRotatingAdsSetup = true; // Flag set karein taaki ye dobara na chale
            }
            // CHANGE END

            function startEighteenPlusCoinEarner() {
                isAdCurrentlyShowing = true;
                eighteenPlusEarnedCoins = 0;
                elements.eighteenPlusCoinDisplay.innerText = '0 🪙';

                if (eighteenPlusInterval) clearInterval(eighteenPlusInterval);
                eighteenPlusInterval = setInterval(() => {
                    state.score++;
                    eighteenPlusEarnedCoins++;
                    elements.eighteenPlusCoinDisplay.innerText = `${eighteenPlusEarnedCoins.toLocaleString()} 🪙`;
                    updateDisplay(); // Update main score display as well
                }, 1000); // 1 coin per 1 second
            }

            function stopEighteenPlusCoinEarner() {
                if (!eighteenPlusInterval) return;
                isAdCurrentlyShowing = false;
                clearInterval(eighteenPlusInterval);
                eighteenPlusInterval = null;
                saveGame({ score: state.score, Totalearning: state.score });
                alert(`You earned ${eighteenPlusEarnedCoins.toLocaleString()} coins from the 18+ Ads Zone!`);
            }

            elements.eighteenPlusButton.addEventListener('click', () => {
                showScreen('eighteen-plus-screen');
                // CHANGE: Rotating ads setup function ko call karein
                setupRotatingAds();
                startEighteenPlusCoinEarner();
            });


            function startZoneAds() {
                if (isZoneActive) return;
                isAdCurrentlyShowing = true;
                isZoneActive = true;
                currentAdIndex = 0;
                zoneEarnedCoins = 0;
                elements.zoneCoinDisplay.innerText = zoneEarnedCoins;
                elements.zoneAdOverlay.style.display = 'flex';
                
                showNextZoneAd();

                zoneCoinInterval = setInterval(() => {
                    state.score++;
                    zoneEarnedCoins++;
                    elements.zoneCoinDisplay.innerText = zoneEarnedCoins.toLocaleString();
                    updateDisplay();
                }, 2000); // बदला हुआ: 1000ms से 2000ms
            }

            function stopZoneAds() {
                if (!isZoneActive) return;
                isAdCurrentlyShowing = false;
                isZoneActive = false;
                
                clearInterval(zoneCoinInterval);
                clearTimeout(zoneNextAdTimeout);
                clearInterval(zoneTimerInterval);

                elements.zoneAdOverlay.style.display = 'none';
                elements.zoneAdIframe.src = 'about:blank';

                saveGame({ score: state.score, Totalearning: state.score });
                alert(`You earned ${zoneEarnedCoins.toLocaleString()} coins from the Time Zone!`);
            }

            function showNextZoneAd() {
                if (!isZoneActive) return;

                if (currentAdIndex >= zoneAdLinks.length) {
                    currentAdIndex = 0;
                }

                const adUrl = zoneAdLinks[currentAdIndex];
                elements.zoneAdIframe.src = adUrl;

                let timeLeft = 30;
                elements.zoneNextAdTimer.innerText = timeLeft;
                if(zoneTimerInterval) clearInterval(zoneTimerInterval);
                zoneTimerInterval = setInterval(() => {
                    timeLeft--;
                    if (timeLeft >= 0) {
                        elements.zoneNextAdTimer.innerText = timeLeft;
                    }
                }, 1000);

                if(zoneNextAdTimeout) clearTimeout(zoneNextAdTimeout);
                zoneNextAdTimeout = setTimeout(() => {
                    currentAdIndex++;
                    showNextZoneAd();
                }, 30000);
            }

            elements.zoneButton.addEventListener('click', startZoneAds);
            elements.zoneCloseBtn.addEventListener('click', stopZoneAds);
            
            function setupSpinWheel() {
                const wheel = elements.wheel;
                wheel.innerHTML = '';
                let gradientString = 'conic-gradient(';
                let cumulativePercent = 0;

                const segmentAngle = 360 / spinPrizes.length;

                spinPrizes.forEach((prize, index) => {
                    const startPercent = cumulativePercent;
                    const endPercent = cumulativePercent + (100 / spinPrizes.length);
                    gradientString += `${prize.color} ${startPercent}% ${endPercent}%, `;
                    cumulativePercent = endPercent;

                    const textAngle = (index * segmentAngle) + (segmentAngle / 2);
                    
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'wheel-segment';
                    segmentDiv.style.transform = `rotate(${textAngle}deg)`;
                    
                    const textDiv = document.createElement('div');
                    textDiv.className = 'segment-text';
                    textDiv.innerText = prize.text;
                    textDiv.style.marginLeft = '100px';

                    segmentDiv.appendChild(textDiv);
                    wheel.appendChild(segmentDiv);
                });

                gradientString = gradientString.slice(0, -2) + ')'; 
                wheel.style.background = gradientString;
            }

            function getWinningPrize() {
                const rand = Math.random() * 100;
                let cumulativeChance = 0;
                for (const prize of spinPrizes) {
                    cumulativeChance += prize.chance;
                    if (rand < cumulativeChance) {
                        return prize;
                    }
                }
                return spinPrizes[0]; 
            }

            elements.spinEarnButton.addEventListener('click', () => {
                const adUrl = 'https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315';
                showAdFrame(adUrl, () => {
                    elements.spinWheelPopup.style.display = 'flex';
                });
            });

            elements.spinWheelPopupClose.addEventListener('click', () => {
                elements.spinWheelPopup.style.display = 'none';
            });
            
            elements.spinButton.addEventListener('click', () => {
                if (isSpinning) return;
                
                const button = elements.spinButton;
                button.disabled = true;
                button.innerText = "Spinning...";
                isSpinning = true;
                const winningPrize = getWinningPrize();
                const winningIndex = spinPrizes.indexOf(winningPrize);
                
                const segmentAngle = 360 / spinPrizes.length;
                const randomOffset = Math.random() * (segmentAngle * 0.8) - (segmentAngle * 0.4);
                const finalAngle = (360 * 5) - (winningIndex * segmentAngle) - (segmentAngle / 2) + randomOffset;
                
                elements.wheel.style.transform = `rotate(${finalAngle}deg)`;

                setTimeout(() => {
                    let dataToSave = {};
                    if (winningPrize.type === 'coin') {
                        state.score += winningPrize.value;
                        dataToSave = { score: state.score, Totalearning: state.score };
                    } else {
                        state.loveCoins++;
                        dataToSave = { loveCoins: state.loveCoins };
                    }
                    
                    saveGame(dataToSave);
                    updateDisplay();
                    renderAirdropScreen();
                    alert(`Congratulations! You won ${winningPrize.text}`);

                    isSpinning = false;
                    button.disabled = false;
                    button.innerText = "Spin";

                    elements.wheel.style.transition = 'none';
                    elements.wheel.style.transform = `rotate(0deg)`;
                    setTimeout(() => {
                        elements.wheel.style.transition = 'transform 5s cubic-bezier(.2, .9, .3, 1)';
                    }, 50);

                }, 5100); 
            });

            function renderRewardsHubScreen() {
                if (state.telegramJoinedClaimed) {
                    elements.claimTelegramRewardBtn.disabled = true;
                    elements.claimTelegramRewardBtn.innerText = 'Claimed ✔️';
                } else {
                    const joinClicked = sessionStorage.getItem('telegramJoinClicked');
                    elements.claimTelegramRewardBtn.disabled = !joinClicked;
                    elements.claimTelegramRewardBtn.innerText = 'Claim 99 🪙';
                }

                const today = new Date().toDateString();
                if (state.lastDailyBonusClaim === today) {
                    elements.claimDailyBonusBtn.disabled = true;
                    elements.claimDailyBonusBtn.innerText = 'Claimed Today ✔️';
                } else {
                    elements.claimDailyBonusBtn.disabled = false;
                    elements.claimDailyBonusBtn.innerText = 'Claim 20 🪙';
                }
            }
            
            elements.rewardsHubButton.addEventListener('click', () => {
                const adUrl = 'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44';
                showAdFrame(adUrl, () => {
                    showScreen('rewards-hub-screen');
                });
            });
            
            elements.joinTelegramLink.addEventListener('click', () => {
                if (!state.telegramJoinedClaimed) {
                    elements.claimTelegramRewardBtn.disabled = false;
                    sessionStorage.setItem('telegramJoinClicked', 'true');
                }
            });

            elements.claimTelegramRewardBtn.addEventListener('click', () => {
                if (state.telegramJoinedClaimed) {
                    alert('You have already claimed this reward.');
                    return;
                }
                
                state.score += 99;
                state.telegramJoinedClaimed = true;
                
                saveGame({ score: state.score, Totalearning: state.score, telegramJoinedClaimed: true });
                updateDisplay();
                renderRewardsHubScreen();
                alert('Congratulations! You received 99 coins for joining the community!');
            });

            elements.claimDailyBonusBtn.addEventListener('click', () => {
                const today = new Date().toDateString();
                if (state.lastDailyBonusClaim === today) {
                    alert('You have already claimed your daily bonus. Come back tomorrow!');
                    return;
                }

                state.score += 20;
                state.lastDailyBonusClaim = today;

                saveGame({ score: state.score, Totalearning: state.score, lastDailyBonusClaim: today });
                updateDisplay();
                renderRewardsHubScreen();
                alert('You have claimed your daily bonus of 20 coins!');
            });


            function loadAndDisplayAppOffers() {
                const offersRef = database.ref('appOffers');
                const container = elements.offerWallContainer;
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">Loading offers...</p>';

                offersRef.once('value').then(snapshot => {
                    container.innerHTML = ''; 
                    let activeOffersFound = false;
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const offerData = childSnapshot.val();
                            if (offerData && offerData.isActive) {
                                activeOffersFound = true;
                                const offerElement = document.createElement('div');
                                offerElement.className = 'offer-wall-item';
                                offerElement.innerHTML = `
                                    <img src="${offerData.icon}" alt="${offerData.title} Icon">
                                    <div class="offer-wall-text">
                                        <h3>${offerData.title}</h3>
                                        <p>${offerData.description}</p>
                                    </div>
                                    <div class="offer-wall-action">
                                        <div class="offer-wall-reward">
                                            <strong>+${new Intl.NumberFormat().format(offerData.reward || 0)}</strong> 🪙
                                        </div>
                                        <a href="${offerData.link}" target="_blank" class="offer-wall-button">Start</a>
                                    </div>
                                `;
                                container.appendChild(offerElement);
                            }
                        });
                    }
                    
                    if (!activeOffersFound) {
                        container.innerHTML = '<p style="color: #6c757d; text-align: center;">No offers available right now. Check back later!</p>';
                    }

                }).catch(error => {
                    console.error("Error loading app offers:", error);
                    container.innerHTML = '<p style="color: red; text-align: center;">Could not load offers.</p>';
                });
            }

            function checkAndResetEarnBox() {
                const today = new Date().toDateString();
                if (state.earnBoxLastReset !== today) {
                    console.log("New day detected. Resetting daily earn box.");
                    state.earnBoxProgress = 0;
                    state.luckyBoxAdProgress = 0;
                    state.luckyBoxClaimed = false;
                    state.earnBoxLastReset = today;
                    saveGame({
                        earnBoxProgress: 0,
                        luckyBoxAdProgress: 0,
                        luckyBoxClaimed: false,
                        earnBoxLastReset: today
                    });
                }
            }
            
            function renderEarnBoxScreen() {
                const container = elements.earnBoxListContainer;
                container.innerHTML = '';
                const TOTAL_TASKS = 200;
                const LUCKY_BOX_ADS_REQUIRED = 100;
                const LUCKY_BOX_REWARD = 3000;

                for (let i = 1; i <= TOTAL_TASKS; i++) {
                    const taskEl = document.createElement('div');
                    taskEl.classList.add('earn-box-item');

                    const reward = (i % 2 !== 0) ? 12 : 15;
                    let status = 'locked';
                    let buttonText = 'Locked';
                    let buttonDisabled = true;

                    if (i - 1 < state.earnBoxProgress) {
                        status = 'claimed';
                        buttonText = 'Claimed ✔️';
                        buttonDisabled = true;
                    } else if (i - 1 === state.earnBoxProgress) {
                        status = 'available';
                        buttonText = 'Watch Ad';
                        buttonDisabled = false;
                    }

                    taskEl.classList.add(status);

                    taskEl.innerHTML = `
                        <div class="earn-box-item-info">
                            <h4>Task #${i}</h4>
                            <p>+ ${reward} 🪙</p>
                        </div>
                        <button
                            class="action-button earn-box-button"
                            data-task-id="${i}"
                            data-reward="${reward}"
                            ${buttonDisabled ? 'disabled' : ''}
                        >${buttonText}</button>
                    `;
                    container.appendChild(taskEl);
                }

                const luckyBoxEl = document.createElement('div');
                luckyBoxEl.classList.add('earn-box-item', 'lucky-box-item');
                let luckyBoxStatus = 'locked';
                let luckyBoxButtonText = 'Locked';
                let luckyBoxButtonDisabled = true;
                let progressText = '';

                if (state.earnBoxProgress >= TOTAL_TASKS) {
                    if (state.luckyBoxClaimed) {
                        luckyBoxStatus = 'claimed';
                        luckyBoxButtonText = 'Claimed ✔️';
                        luckyBoxButtonDisabled = true;
                    } else {
                        luckyBoxStatus = 'available';
                        progressText = `<p class="lucky-box-progress">Progress: ${state.luckyBoxAdProgress} / ${LUCKY_BOX_ADS_REQUIRED} ads</p>`;
                        if (state.luckyBoxAdProgress >= LUCKY_BOX_ADS_REQUIRED) {
                            luckyBoxButtonText = `Claim ${LUCKY_BOX_REWARD.toLocaleString()} 🪙`;
                            luckyBoxButtonDisabled = false;
                        } else {
                            luckyBoxButtonText = 'Watch Ad';
                            luckyBoxButtonDisabled = false;
                        }
                    }
                }

                luckyBoxEl.classList.add(luckyBoxStatus);

                luckyBoxEl.innerHTML = `
                    <div class="earn-box-item-info">
                        <h4>⭐ Lucky Box ⭐</h4>
                        <p>+ ${LUCKY_BOX_REWARD.toLocaleString()} 🪙</p>
                        ${progressText}
                    </div>
                    <button
                        class="action-button earn-box-button"
                        data-task-id="lucky"
                        data-reward="${LUCKY_BOX_REWARD}"
                        ${luckyBoxButtonDisabled ? 'disabled' : ''}
                    >${luckyBoxButtonText}</button>
                `;
                container.appendChild(luckyBoxEl);
            }

            elements.earnBoxListContainer.addEventListener('click', e => {
                if (!e.target.classList.contains('earn-box-button')) return;

                const button = e.target;
                const taskId = button.dataset.taskId;
                const reward = parseInt(button.dataset.reward, 10);
                const AD_URL = 'https://www.profitableratecpm.com/qshhszvnad?key=4761223a00e52bd9f2e24d515e6be228';
                
                button.disabled = true;
                button.innerText = 'Loading Ad...';

                if (taskId !== 'lucky') {
                    const taskIdNum = parseInt(taskId, 10);
                    if (taskIdNum - 1 === state.earnBoxProgress) {
                        showAdFrame(AD_URL, () => {
                            state.score += reward;
                            state.earnBoxProgress++;
                            saveGame({ score: state.score, Totalearning: state.score, earnBoxProgress: state.earnBoxProgress });
                            updateDisplay();
                            renderEarnBoxScreen();
                        });
                    }
                } else {
                    if (state.luckyBoxAdProgress >= 100) { 
                        state.score += reward;
                        state.luckyBoxClaimed = true;
                        saveGame({ score: state.score, Totalearning: state.score, luckyBoxClaimed: true });
                        alert(`Congratulations! You've received the Lucky Box reward of ${reward.toLocaleString()} coins!`);
                        updateDisplay();
                        renderEarnBoxScreen();
                    } else {
                        showAdFrame(AD_URL, () => {
                            state.luckyBoxAdProgress++;
                            saveGame({ luckyBoxAdProgress: state.luckyBoxAdProgress });
                            renderEarnBoxScreen();
                        });
                    }
                }
            });

            function loadAndDisplayTournaments() {
                const tournamentsRef = database.ref('tournaments');
                elements.tournamentListContainer.innerHTML = ''; 

                tournamentsRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const initialTournamentData = childSnapshot.val();
                            const tournamentId = childSnapshot.key;
                            
                            if (initialTournamentData.isActive) {
                                const card = document.createElement('div');
                                card.className = 'tournament-card';
                                card.id = `tournament-card-${tournamentId}`;
                                
                                const entryFeeText = initialTournamentData.entryFee > 0 ? `${initialTournamentData.entryFee.toLocaleString()} 🪙` : 'Free';
                                const defaultLogoUrl = 'https://dummyimage.com/60x60/2c3e50/ffffff&text=Logo';
                                const finalImageUrl = initialTournamentData.imageUrl || defaultLogoUrl;
                                const dateInfo = initialTournamentData.date || 'TBA';
                                const timeInfo = initialTournamentData.time ? new Date(`1970-01-01T${initialTournamentData.time}`).toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';

                                card.innerHTML = `
                                    <div class="tournament-card-header">
                                        <img src="${finalImageUrl}" alt="Game Logo" class="tournament-card-logo" onerror="this.onerror=null; this.src='${defaultLogoUrl}';">
                                        <div class="tournament-card-title">
                                            <h3>${initialTournamentData.title || 'Untitled Tournament'}</h3>
                                            <p>${initialTournamentData.game || 'Special Event'}</p>
                                        </div>
                                    </div>
                                    <p><strong>Prize Pool:</strong> ${initialTournamentData.prizePool || 'TBA'}</p>
                                    <p><strong>Entry Fee:</strong> ${entryFeeText}</p>
                                    <p><strong>Date & Time:</strong> ${dateInfo} at ${timeInfo}</p>
                                    <p><strong>Rules:</strong> ${initialTournamentData.rules || 'Follow standard rules.'}</p>
                                    
                                    <div id="room-info-${tournamentId}" class="room-info-container" style="display: none;"></div>

                                    <div id="participants-${tournamentId}" class="participant-display-container"></div>
                                    <div id="prize-status-${tournamentId}"></div> 

                                    <button class="join-button"
                                        id="join-button-${tournamentId}"
                                        data-id="${tournamentId}"
                                        data-title="${initialTournamentData.title || 'Tournament'}"
                                        data-fee="${initialTournamentData.entryFee || 0}"
                                        data-link="${initialTournamentData.joinLink || '#'}"
                                        data-image="${initialTournamentData.imageUrl || ''}">
                                        Join Now
                                    </button>
                                `;
                                
                                elements.tournamentListContainer.appendChild(card);

                                const singleTournamentRef = database.ref(`tournaments/${tournamentId}`);
                                singleTournamentRef.on('value', tournamentSnapshot => {
                                    const tournamentData = tournamentSnapshot.val();
                                    if (!tournamentData) return;

                                    const currentCard = document.getElementById(`tournament-card-${tournamentId}`);
                                    const joinButton = document.getElementById(`join-button-${tournamentId}`);
                                    const roomInfoContainer = document.getElementById(`room-info-${tournamentId}`);
                                    const participantsContainer = document.getElementById(`participants-${tournamentId}`);
                                    const prizeStatusContainer = document.getElementById(`prize-status-${tournamentId}`);
                                    if (!currentCard || !joinButton || !roomInfoContainer || !participantsContainer) return;
                                    
                                    let isFinished = false;
                                    if (tournamentData.winningTeam || (tournamentData.participants && Object.values(tournamentData.participants).some(p => p.isWinner))) {
                                        isFinished = true;
                                    }

                                    const hasJoined = state.joinedTournaments && state.joinedTournaments[tournamentId];

                                    if (isFinished) {
                                        joinButton.innerText = 'Tournament Finished';
                                        joinButton.disabled = true;
                                        currentCard.classList.add('finished');
                                        roomInfoContainer.style.display = 'none';
                                    } else {
                                        currentCard.classList.remove('finished');
                                        joinButton.innerText = hasJoined ? 'Joined! Good Luck!' : 'Join Now';
                                        joinButton.disabled = hasJoined;

                                        if (hasJoined) {
                                            const roomId = tournamentData.roomId || 'TBA';
                                            const roomPass = tournamentData.roomPassword || 'TBA';
                                            roomInfoContainer.innerHTML = `
                                                <h4>Room Credentials</h4>
                                                <p><strong>Room ID:</strong> ${roomId}</p>
                                                <p><strong>Password:</strong> ${roomPass}</p>
                                            `;
                                            roomInfoContainer.style.display = 'block';
                                        } else {
                                            roomInfoContainer.style.display = 'none';
                                        }
                                    }
                                    
                                    if (tournamentData.prizeAwarded) {
                                        prizeStatusContainer.innerHTML = `<div class="prize-distributed-message">🏆 Prize Distributed! 🏆</div>`;
                                    } else {
                                        prizeStatusContainer.innerHTML = '';
                                    }
                                    
                                    const participants = tournamentData.participants || {};
                                    const participantEntries = Object.entries(participants);

                                    if (participantEntries.length > 0) {
                                        if (tournamentData.minPlayers === 4) {
                                            const winningTeam = tournamentData.winningTeam || null;
                                            const team1 = participantEntries.filter((e, i) => i % 2 === 0);
                                            const team2 = participantEntries.filter((e, i) => i % 2 !== 0);
                                            const team1Html = team1.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            const team2Html = team2.map(([uid, pdata]) => `<li class="participant-item">${pdata.name}</li>`).join('');
                                            participantsContainer.innerHTML = `
                                                <ul class="team-list"><h4>Team A ${winningTeam === 1 ? '🏆' : ''}</h4>${team1Html}</ul>
                                                <div class="vs-separator">VS</div>
                                                <ul class="team-list"><h4>Team B ${winningTeam === 2 ? '🏆' : ''}</h4>${team2Html}</ul>`;
                                        } else {
                                            const participantHtml = participantEntries.map(([userId, playerData]) => {
                                                const winnerIcon = playerData.isWinner ? '🏆 ' : '';
                                                const winnerClass = playerData.isWinner ? 'winner' : '';
                                                return `<li class="participant-item ${winnerClass}"><strong>${winnerIcon}${playerData.name}</strong></li>`;
                                            }).join('');
                                            participantsContainer.innerHTML = `<ul class="team-list" style="width:100%;">${participantHtml}</ul>`;
                                        }
                                        participantsContainer.style.display = 'flex';
                                    } else {
                                        participantsContainer.style.display = 'none';
                                    }
                                });
                            }
                        });
                    }
                }).catch(error => {
                    console.error("Error loading tournaments: ", error);
                    elements.tournamentListContainer.innerHTML += '<p style="text-align:center; color: red;">Could not load events. Please try again later.</p>';
                });
            }

            function initiateTournamentJoinProcess(details) {
                currentTournamentJoinProcess.details = details;
                currentTournamentJoinProcess.adsWatched = 0;
                elements.tournamentJoinPopupTitle.innerText = details.title;
                elements.tournamentJoinPopupImage.src = details.image || 'https://via.placeholder.com/80';
                elements.tournamentAdProgress.innerText = `0 / ${currentTournamentJoinProcess.adsRequired}`;
                elements.tournamentWatchAdBtn.disabled = false;
                elements.tournamentWatchAdBtn.innerText = 'Watch Ad';
                elements.tournamentAdView.style.display = 'block';
                elements.tournamentConfirmView.style.display = 'none';
                elements.tournamentJoinPopup.style.display = 'flex';
            }
            
            elements.tournamentListContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('join-button') && !e.target.disabled) {
                    const button = e.target;
                    const tournamentDetails = {
                        id: button.dataset.id,
                        title: button.dataset.title,
                        fee: button.dataset.fee,
                        link: button.dataset.link,
                        image: button.dataset.image
                    };
                    initiateTournamentJoinProcess(tournamentDetails);
                }
            });

            elements.tournamentWatchAdBtn.addEventListener('click', () => {
                const button = elements.tournamentWatchAdBtn;
                button.disabled = true;
                button.innerText = 'Loading Ad...';

                showAdFrame(currentTournamentJoinProcess.adUrl, () => {
                    button.disabled = false;
                    button.innerText = 'Watch Ad';
                    currentTournamentJoinProcess.adsWatched++;
                    elements.tournamentAdProgress.innerText = `${currentTournamentJoinProcess.adsWatched} / ${currentTournamentJoinProcess.adsRequired}`;
                    if (currentTournamentJoinProcess.adsWatched >= currentTournamentJoinProcess.adsRequired) {
                        elements.tournamentAdView.style.display = 'none';
                        const details = currentTournamentJoinProcess.details;
                        elements.tournamentJoinPopupFee.innerText = `${parseInt(details.fee).toLocaleString()} 🪙`;
                        elements.tournamentJoinNameInput.value = state.playerName;
                        elements.tournamentConfirmView.style.display = 'block';
                    }
                });
            });
            
            elements.tournamentJoinConfirmBtn.addEventListener('click', () => {
                const details = currentTournamentJoinProcess.details;
                const tournamentId = details.id;
                const entryFee = parseInt(details.fee, 10);
                const joinLink = details.link;
                const newName = elements.tournamentJoinNameInput.value.trim();
                if (!newName) {
                    alert('Please enter your name to join.'); return;
                }
                if (state.score < entryFee) {
                    alert(`Not enough coins! You need ${entryFee.toLocaleString()} 🪙 to join.`); return;
                }
                state.score -= entryFee;
                if (state.playerName !== newName) {
                    state.playerName = newName;
                }
                if (!state.joinedTournaments) state.joinedTournaments = {};
                state.joinedTournaments[tournamentId] = true;
                const dataToSave = {
                    score: state.score, Totalearning: state.score, Name: state.playerName, joinedTournaments: state.joinedTournaments
                };
                const participantData = {
                    name: newName, joinTime: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref(`tournaments/${tournamentId}/participants/${userId}`).set(participantData);
                saveGame(dataToSave);
                updatePlayerNameDisplay();
                updateDisplay();
                alert(`Successfully joined! Fee of ${entryFee.toLocaleString()} 🪙 has been paid. The event password will be shared on our Telegram channel. Redirecting you...`);
                elements.tournamentJoinPopup.style.display = 'none';
                if (joinLink && joinLink !== '#') {
                    window.open(joinLink, '_blank');
                }
            });

            function closeTournamentPopup() {
                elements.tournamentJoinPopup.style.display = 'none';
                currentTournamentJoinProcess.details = null;
            }

            elements.tournamentJoinCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentAdCancelBtn.addEventListener('click', closeTournamentPopup);
            elements.tournamentJoinPopupClose.addEventListener('click', closeTournamentPopup);
            
            function renderVideoTasks() {
                const container = elements.videoTasksContainer;
                container.innerHTML = '';

                const watchAndEarnCard = document.createElement('div');
                watchAndEarnCard.className = 'option-card';
                watchAndEarnCard.innerHTML = `
                    <h3>Watch & Earn</h3>
                    <p>Watch a quick ad to earn 10 coins instantly!</p>
                    <button id="watch-ad-for-10-coins-btn" class="action-button" style="background-color:#27ae60;">Watch Ad (+10 🪙)</button>
                `;
                container.appendChild(watchAndEarnCard);
            
                const specialAdCard = document.createElement('div');
                specialAdCard.className = 'option-card';
                specialAdCard.innerHTML = `<h3>Special Offer (18+)</h3><p>Watch a special video to earn a <strong>15 🪙</strong> reward!</p><button id="watch-18plus-ad-btn" class="action-button" style="background-color:#c0392b;">18+</button>`;
                container.appendChild(specialAdCard);

                if (state.myReferralC) {
                    const referralCard = document.createElement('div');
                    referralCard.className = 'option-card';
                    referralCard.innerHTML = `<h3>🤝 Refer a Friend</h3><p>Share your link! You get <strong>700 🪙</strong> automatically when your friend joins. Your friend gets a 500 🪙 bonus!</p><p style="font-size: 14px; margin-bottom: 10px;">Your Code: <strong>${state.myReferralC}</strong></p><button id="copy-referral-link-button" class="action-button" style="background-color: #0088cc;">Copy Invite Link</button>`;
                    container.appendChild(referralCard);
                }

                videoAdTasks.forEach(task => {
                    const progress = state[task.id + 'Progress'] || 0;
                    const isClaimed = state[task.id + 'Claimed'] || false;
                    const isComplete = progress >= task.goal;
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    let buttonHtml;
                    if (isClaimed) {
                         buttonHtml = `<button class="action-button" disabled>Claimed ✅</button>`;
                    } else if (isComplete) {
                        buttonHtml = `<button class="action-button claim-video-reward-button" data-task-id="${task.id}" style="background-color: #2ecc71;">Claim ${task.reward.toLocaleString()} 🪙</button>`;
                    } else {
                        buttonHtml = `<button class="action-button video-task-button" data-task-id="${task.id}">Watch Video</button>`;
                    }
                    card.innerHTML = `<h3>${task.title}</h3><p>${task.description}</p><p><strong>Progress: ${progress} / ${task.goal}</strong></p>${buttonHtml}`;
                    container.appendChild(card);
                });
            }

            elements.videoTasksContainer.addEventListener('click', (e) => {
                const button = e.target;
                
                if (button.id === 'watch-ad-for-10-coins-btn') {
                    button.disabled = true;
                    button.innerText = 'Loading Ad...';
                    const adUrlFor10Coins = 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6';
                    
                    showAdFrame(adUrlFor10Coins, () => {
                        state.score += 10; 
                        updateDisplay();
                        saveGame({ score: state.score, Totalearning: state.score });
                        alert("You earned 10 coins!");
                        button.disabled = false;
                        button.innerText = "Watch Ad (+10 🪙)";
                    });
                }
                
                if (button.id === 'watch-18plus-ad-btn') {
                    button.disabled = true;
                    button.innerText = 'Loading Ad...';
                    showAdFrame('https://www.profitableratecpm.com/uhnqngyf?key=d467c8e5498339a61ae6addd69e30d9e', () => {
                        state.score += 15; 
                        updateDisplay();
                        saveGame({ score: state.score, Totalearning: state.score });
                        alert("You earned 15 coins!");
                        button.disabled = false;
                        button.innerText = "18+";
                    });
                }
                if (button.id === 'copy-referral-link-button') {
                    const webReferralLink = `https://t.me/squid_456_bot?start=${state.myReferralC}`;
                    copyTextToClipboard(webReferralLink);
                }
                if (button.classList.contains('video-task-button')) {
                    const taskId = button.dataset.taskId;
                    const task = videoAdTasks.find(t => t.id === taskId);
                    if (!task) return;

                    button.disabled = true;
                    button.innerText = 'Loading Ad...';
                    showAdFrame(task.url, () => {
                        state[taskId + 'Progress']++;
                        saveGame({ [taskId + 'Progress']: state[taskId + 'Progress'] });
                        renderVideoTasks(); 
                    });
                }
                if (button.classList.contains('claim-video-reward-button')) {
                    const taskId = button.dataset.taskId;
                    const task = videoAdTasks.find(t => t.id === taskId);
                    if (!task || state[taskId + 'Claimed']) return;
                    state.score += task.reward;
                    state[taskId + 'Claimed'] = true;
                    alert(`Congratulations! You have claimed ${task.reward.toLocaleString()} coins! 🎉`);
                    saveGame({ score: state.score, [taskId + 'Claimed']: true });
                    updateDisplay();
                    renderVideoTasks();
                }
            });
            function loadAndDisplayOffers() {
                const offersRef = database.ref('promotions');
                elements.tasksOptionsContainer.innerHTML = '';
                offersRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const promo = childSnapshot.val();
                            if (promo.isActive) {
                                const card = document.createElement('div');
                                card.className = 'option-card clickable';
                                card.innerHTML = `<h3>${promo.title}</h3><p>${promo.text}</p>${promo.imageUrl ? `<img src="${promo.imageUrl}" alt="Offer Image">` : ''}`;
                                card.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (promo.action === 'watchAd') { triggerWatchAd(card); } 
                                    else if (promo.linkUrl && promo.linkUrl !== '#') { window.open(promo.linkUrl, '_blank'); }
                                });
                                elements.tasksOptionsContainer.appendChild(card);
                            }
                        });
                    } else {
                        elements.tasksOptionsContainer.innerHTML = '<p>No active offers right now. Check back later!</p>';
                    }
                });
            }
            function triggerWatchAd(cardElement) {
                if (isAdBoostActive) { alert("A boost is already active! Please wait."); return; }
                isAdBoostActive = true;
                const originalText = cardElement.querySelector('p').innerText;
                cardElement.style.pointerEvents = 'none';
                let countdown = 10;
                cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    cardElement.querySelector('p').innerText = `Boost Active! (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        isAdBoostActive = false;
                        cardElement.style.pointerEvents = 'auto';
                        cardElement.querySelector('p').innerText = originalText;
                        alert("Ad boost has ended!");
                    }
                }, 1000);
            }
            function renderWithdrawalHistory() {
                const historyList = elements.withdrawalHistoryList;
                historyList.innerHTML = '<p style="text-align: center; font-size: 16px; opacity: 0.7;">Loading history...</p>';
                const historyRef = database.ref(`withdrawals/${userId}`);
                historyRef.once('value', (snapshot) => {
                    historyList.innerHTML = '';
                    if (!snapshot.exists()) {
                        historyList.innerHTML = '<p style="text-align: center; font-size: 16px; opacity: 0.7;">No withdrawal history found.</p>';
                        return;
                    }
                    snapshot.forEach((childSnapshot) => {
                        const item = childSnapshot.val();
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'history-item';
                        const amountInRupees = (item.amount / gameSettings.coinValue).toFixed(2);
                        const recipientInfo = item.name ? `${item.name} (${item.upiId})` : item.upiId;
                        itemDiv.innerHTML = `<div class="history-item-details"><strong>${item.amount.toLocaleString()} 🪙</strong> (₹${amountInRupees})<br><span style="font-size:14px; opacity: 0.8;">To: ${recipientInfo}</span></div><div class="history-item-meta"><span>${item.date}</span><span class="status status-${item.status.toLowerCase()}">${item.status}</span></div>`;
                        historyList.prepend(itemDiv);
                    });
                });
            }
            
            function renderWalletScreen() {
                elements.walletScore.innerText = state.score.toLocaleString();
                const rupeeValue = (state.score / gameSettings.coinValue).toFixed(2);
                elements.rupeeValue.innerText = `Value: ₹${rupeeValue} INR`;

                elements.withdrawButton.innerText = gameSettings.withdrawalButtonText;
                
                if (state.isIndividuallyLocked) {
                    elements.withdrawButton.disabled = true;
                    elements.withdrawButton.innerText = "Withdrawal Temporarily Locked";
                    elements.withdrawalDayNote.style.display = 'none';
                    elements.withdrawalAdTaskContainer.style.display = 'none';
                    renderWithdrawalHistory();
                    return; 
                }

                if (gameSettings.withdrawalsLocked) {
                    elements.withdrawButton.disabled = true;
                    elements.withdrawButton.innerText = "Withdrawal available only Sunday";
                    elements.withdrawalDayNote.style.display = 'none';
                    elements.withdrawalAdTaskContainer.style.display = 'none';
                    renderWithdrawalHistory();
                    return;
                }
                
                if (gameSettings.isWithdrawalForceUnlocked) {
                    elements.withdrawButton.disabled = false;
                    elements.withdrawalDayNote.style.display = 'none';
                    elements.withdrawalAdTaskContainer.style.display = 'none';
                    renderWithdrawalHistory();
                    return;
                }

                const today = new Date();
                const dayOfWeek = today.getDay(); 
                const isSunday = dayOfWeek === 0;
                const goal = 20;
                const adsWatchedSufficiently = state.withdrawalAdClicks >= goal;

                if (!isSunday) {
                    elements.withdrawButton.disabled = true;
                    elements.withdrawButton.innerText = "Unavailable (Sundays Only)";
                    elements.withdrawalDayNote.innerText = "Withdrawal is available only on Sundays.";
                    elements.withdrawalDayNote.style.display = 'block';
                    elements.withdrawalAdTaskContainer.style.display = 'none'; 
                } else {
                    elements.withdrawalDayNote.style.display = 'none';
                    elements.withdrawButton.innerText = gameSettings.withdrawalButtonText;

                    if (adsWatchedSufficiently) {
                        elements.withdrawalAdTaskContainer.style.display = 'none';
                        elements.withdrawButton.disabled = false; 
                    } else {
                        elements.withdrawalAdTaskContainer.style.display = 'flex';
                        elements.withdrawButton.disabled = true; 
                        elements.withdrawalAdTaskContainer.innerHTML = `
                            <div class="option-card">
                                <h3>Unlock Withdrawals</h3>
                                <p>Watch ${goal} ads to enable the withdrawal button.</p>
                                <p><strong>Progress: ${state.withdrawalAdClicks} / ${goal}</strong></p>
                                <button id="watch-ad-for-withdrawal" class="action-button">Watch Ad</button>
                            </div>
                        `;
                    }
                }
                renderWithdrawalHistory();
            }

            elements.withdrawalAdTaskContainer.addEventListener('click', (e) => {
                if(e.target.id === 'watch-ad-for-withdrawal') {
                    const button = e.target;
                    button.disabled = true;
                    button.innerText = 'Loading Ad...';
                    
                    showAdFrame('https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315', () => {
                        state.withdrawalAdClicks++;
                        saveGame({ withdrawalAdClicks: state.withdrawalAdClicks });
                        renderWalletScreen(); 
                    });
                }
            });

            function showNotifications() {
                elements.notificationDot.classList.remove('visible');
                const list = elements.notificationList;
                list.innerHTML = '';

                if (state.messages.length === 0) {
                    list.innerHTML = '<p>No new messages.</p>';
                } else {
                    state.messages.forEach(msg => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.textContent = msg.text;
                        list.appendChild(item);
                    });
                }
                elements.notificationPopup.style.display = 'flex';
            }
            function closeAndClearNotifications() {
                elements.notificationPopup.style.display = 'none';
                if (state.messages.length > 0) {
                    const updates = {};
                    state.messages.forEach(msg => {
                        updates[`/Users/${userId}/messages/${msg.key}`] = null;
                    });
                    database.ref().update(updates);
                    state.messages = [];
                }
            }
            elements.notificationBell.addEventListener('click', showNotifications);
            elements.closeNotificationBtn.addEventListener('click', closeAndClearNotifications);
            
            function showScreen(screenId) {
                const previouslyActiveScreen = document.querySelector('.screen:not(.hidden)');
                if (previouslyActiveScreen) {
                    if (previouslyActiveScreen.id === 'eighteen-plus-screen') {
                        stopEighteenPlusCoinEarner();
                    }
                }

                elements.screens.forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

                logUserEvent('screen_view', { screen: screenId }); 
                
                const targetScreen = document.getElementById(screenId);
                if(targetScreen) {
                    targetScreen.classList.remove('hidden');
                } else {
                    document.getElementById('game-screen').classList.remove('hidden');
                    document.querySelector('.nav-button[data-screen="game-screen"]').classList.add('active');
                }
                
                const button = document.querySelector(`.nav-button[data-screen='${screenId}']`);
                if (button) button.classList.add('active');

                if (screenId === 'wallet-screen') { renderWalletScreen(); } 
                else if (screenId === 'offer-wall-screen') { loadAndDisplayAppOffers(); }
                else if (screenId === 'tasks-screen') { loadAndDisplayOffers(); } 
                else if (screenId === 'video-screen') { renderVideoTasks(); } 
                else if (screenId === 'tournament-screen') { loadAndDisplayTournaments(); } 
                else if (screenId === 'airdrop-screen') { renderAirdropScreen(); }
                else if (screenId === 'earn-box-screen') { renderEarnBoxScreen(); }
                else if (screenId === 'rewards-hub-screen') { renderRewardsHubScreen(); }
            }

            function listenForGameSettings() {
                const settingsRef = database.ref('gameSettings');
                settingsRef.on('value', (snapshot) => {
                    const settings = snapshot.val() || {};
                    gameSettings.withdrawalsLocked = settings.withdrawalsLocked === true;
                    gameSettings.withdrawalButtonText = settings.withdrawalButtonText || 'Withdraw All Coins';
                    gameSettings.isWithdrawalForceUnlocked = settings.isWithdrawalForceUnlocked === true;
                    gameSettings.coinValue = parseInt(settings.coinValue, 10) || 1000;
                    
                    if (!document.getElementById('wallet-screen').classList.contains('hidden')) {
                        renderWalletScreen();
                    }
                });
            }

            function loadGame() {
                handleIncomingReferral();
                listenForGameSettings();
                const userRef = database.ref(`Users/${userId}`);

                logUserEvent('game_loaded');

                userRef.on('value', (snapshot) => {
                    let data = snapshot.val();
                    let isNewUser = !data;

                    if (isNewUser) {
                        const newCode = generateReferralCode();
                        const referrerCode = sessionStorage.getItem('referrerCode');
                        
                        data = {
                            score: referrerCode ? 500 : 0,
                            Totalearning: referrerCode ? 500 : 0,
                            Name: 'Player',
                            myReferralC: newCode,
                            referredBy: referrerCode || null,
                            creationTime: firebase.database.ServerValue.TIMESTAMP,
                            currentEnergy: 1000,
                            isWithdrawalLocked: false,
                            totalOnlineTime: 0,
                        };

                        if (referrerCode) {
                            creditReferrer(referrerCode);
                            sessionStorage.removeItem('referrerCode');
                            alert(`Welcome! You've received a 500 coin bonus for joining via a referral! 🎉`);
                        }
                        
                        userRef.set(data);
                        database.ref(`Referralcodes/${newCode}`).set({ Uid: userId });
                    }
                    
                    state.score = data.score || 0;
                    state.playerName = data.Name || 'Player';
                    state.myReferralC = data.myReferralC || null;
                    state.referredBy = data.referredBy || null;
                    state.isIndividuallyLocked = data.isWithdrawalLocked === true;
                    state.totalOnlineTime = data.totalOnlineTime || 0;
                    state.creationTime = data.creationTime || 0;
                    
                    state.currentEnergy = data.currentEnergy !== undefined ? data.currentEnergy : state.maxEnergy;
                    state.tapPower = data.tapPower || 1;
                    state.tapUpgradeLevel = data.tapUpgradeLevel || 0;
                    state.withdrawalAdClicks = data.withdrawalAdClicks || 0;

                    updateDisplay();
                    updatePlayerNameDisplay();
                    checkEnergyCooldown(); 

                    if (elements.userIdDisplayOffer) {
                        elements.userIdDisplayOffer.textContent = userId;
                    }
                    
                    if (isNewUser) {
                        database.ref(`Users/${userId}/messages`).on('child_added', (msgSnapshot) => {
                            const msg = msgSnapshot.val();
                            if (msg) {
                                state.messages.push({ key: msgSnapshot.key, text: msg.text });
                                elements.notificationDot.classList.add('visible');
                            }
                        });
                    }
                });
            }

            function saveGame(dataToSave, fullSave = false) {
                if (!userId) return;
                const userRef = database.ref(`Users/${userId}`);
                if (fullSave) {
                    userRef.set({ ...state, lastSeen: firebase.database.ServerValue.TIMESTAMP });
                } 
                else if (dataToSave) {
                    userRef.update(dataToSave);
                }
            }
            function updateDisplay() {
                elements.scoreDisplay.innerText = state.score.toLocaleString();
                elements.energyText.innerText = `⚡️ ${Math.floor(state.currentEnergy)} / ${state.maxEnergy}`;
                elements.energyBarFill.style.width = `${(state.currentEnergy / state.maxEnergy) * 100}%`;
                
                if (state.score >= 1000000) state.currentLevel = 10;
                else if (state.score >= 60000) state.currentLevel = 5;
                else if (state.score >= 40000) state.currentLevel = 4;
                else if (state.score >= 30000) state.currentLevel = 3;
                else if (state.score >= 10000) state.currentLevel = 2;
                else state.currentLevel = 1;
                elements.levelDisplay.innerText = `Level ${state.currentLevel}`;
                if (!document.getElementById('wallet-screen').classList.contains('hidden')) {
                    elements.walletScore.innerText = state.score.toLocaleString();
                    const rupeeValue = (state.score / gameSettings.coinValue).toFixed(2); 
                    elements.rupeeValue.innerText = `Value: ₹${rupeeValue} INR`;
                }
            }
            function updatePlayerNameDisplay() { elements.playerNameDisplay.innerText = state.playerName; }
            
            function showFloatingText(event, power) {
                const floatingText = document.createElement('div');
                floatingText.innerText = `+${power}`;
                floatingText.className = 'floating-text';
                const x = event.clientX || event.touches[0].clientX;
                const y = event.clientY || event.touches[0].clientY;
                floatingText.style.left = `${x}px`;
                floatingText.style.top = `${y}px`;
                document.body.appendChild(floatingText);
                setTimeout(() => floatingText.remove(), 1000);
            }
            elements.coinContainer.addEventListener('pointerdown', (event) => {
                if (state.currentEnergy <= 0) {
                    return; 
                }
                
                if (!elements.coinCss.classList.contains('flipping')) {
                    elements.coinCss.classList.add('flipping');
                }
                if (elements.tapSound) {
                    elements.tapSound.currentTime = 0;
                    elements.tapSound.play().catch(e => {});
                }

                state.tapCounter++;

                if (state.tapCounter >= 3) {
                    const power = state.tapPower;
                    
                    if (state.currentEnergy >= power) {
                        state.currentEnergy -= power;
                        state.score += power;
                        state.tapCounter = 0;

                        let dataToSave = { 
                            score: state.score, 
                            Totalearning: state.score, 
                            currentEnergy: state.currentEnergy,
                            tapCounter: state.tapCounter
                        };
                        
                        if (state.currentEnergy <= 0) {
                            state.currentEnergy = 0; 
                            dataToSave.currentEnergy = 0;

                            state.energyDepletedTime = Date.now();
                            state.energyRecoveryDuration = 5 * 60 * 60 * 1000; 
                            state.fastRecoveryAdsWatched = 0; 
                            
                            dataToSave.energyDepletedTime = state.energyDepletedTime;
                            dataToSave.energyRecoveryDuration = state.energyRecoveryDuration;
                            dataToSave.fastRecoveryAdsWatched = state.fastRecoveryAdsWatched;

                            checkEnergyCooldown(); 
                        }
                        
                        updateDisplay();
                        showFloatingText(event, power);
                        saveGame(dataToSave);
                    }
                } else {
                    saveGame({ tapCounter: state.tapCounter });
                }
            });
            elements.coinCss.addEventListener('animationend', () => elements.coinCss.classList.remove('flipping'));
            function checkEnergyCooldown() {
                if (state.energyDepletedTime > 0) {
                    const timeRemaining = (state.energyDepletedTime + state.energyRecoveryDuration) - Date.now();
                    if (timeRemaining <= 0) {
                        state.currentEnergy = state.maxEnergy;
                        state.energyDepletedTime = 0;
                        state.energyRecoveryDuration = 0;
                        state.fastRecoveryAdsWatched = 0;
                        elements.energyTimerDisplay.style.display = 'none';
                        elements.fastRecoveryWrapper.style.display = 'none';
                        elements.energyText.style.display = 'block';
                        elements.energyBarFill.parentElement.style.display = 'block';
                        updateDisplay();
                        saveGame({ currentEnergy: state.currentEnergy, energyDepletedTime: 0, energyRecoveryDuration: 0, fastRecoveryAdsWatched: 0 });
                    } else {
                        const hours = Math.floor(timeRemaining / (1000 * 60 * 60)).toString().padStart(2, '0');
                        const minutes = Math.floor((timeRemaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                        const seconds = Math.floor((timeRemaining / 1000) % 60).toString().padStart(2, '0');
                        elements.energyTimerDisplay.innerText = `Next refill in: ${hours}:${minutes}:${seconds}`;
                        elements.energyTimerDisplay.style.display = 'block';
                        elements.energyText.style.display = 'none';
                        elements.energyBarFill.parentElement.style.display = 'none';
                        if (state.fastRecoveryAdsWatched < 150) {
                            elements.fastRecoveryWrapper.style.display = 'block';
                            elements.fastEnergyRecoveryBtn.innerText = `Watch Ad (${state.fastRecoveryAdsWatched}/150) for 30min Refill`;
                        } else {
                            elements.fastRecoveryWrapper.style.display = 'none'; 
                        }
                    }
                } else {
                    elements.energyTimerDisplay.style.display = 'none';
                    elements.fastRecoveryWrapper.style.display = 'none';
                    elements.energyText.style.display = 'block';
                    elements.energyBarFill.parentElement.style.display = 'block';
                }
            }
            elements.fastEnergyRecoveryBtn.addEventListener('click', () => {
                if (state.fastRecoveryAdsWatched >= 150) { alert("You have already watched enough ads."); return; }
                
                const button = elements.fastEnergyRecoveryBtn;
                button.disabled = true;
                button.innerText = 'Loading Ad...';
                
                showAdFrame('https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315', () => {
                    button.disabled = false;
                    state.fastRecoveryAdsWatched++;
                    let dataToSave = { fastRecoveryAdsWatched: state.fastRecoveryAdsWatched };
                    if (state.fastRecoveryAdsWatched >= 150) {
                        state.energyRecoveryDuration = 30 * 60 * 1000; 
                        dataToSave.energyRecoveryDuration = state.energyRecoveryDuration;
                        alert("Success! Energy will now refill in 30 minutes from when it ran out.");
                        elements.fastEnergyRecoveryBtn.style.display = 'none';
                    }
                    saveGame(dataToSave);
                    checkEnergyCooldown(); 
                });
            });
            elements.navButtons.forEach(b => { if(b.dataset.screen){ b.addEventListener('click', () => showScreen(b.dataset.screen)) } });
            document.querySelectorAll('.back-button').forEach(b => b.addEventListener('click', () => showScreen(b.dataset.screen)));
            elements.profileSection.addEventListener('click', () => { elements.newNameInput.value = state.playerName; elements.nameChangePopup.style.display = 'flex'; });
            elements.confirmNameButton.addEventListener('click', () => { const newName = elements.newNameInput.value.trim(); if (newName && newName !== "") { state.playerName = newName; updatePlayerNameDisplay(); saveGame({ Name: newName }); elements.nameChangePopup.style.display = 'none'; } else { alert("Name cannot be empty!"); } });
            elements.cancelNameButton.addEventListener('click', () => elements.nameChangePopup.style.display = 'none');
            elements.upiWithdrawButton.addEventListener('click', () => { 
                const amountToWithdraw = state.score; 
                const name = elements.withdrawalNameInput.value.trim(); 
                const upiId = elements.withdrawalUpiInput.value.trim(); 
                if (!name || !upiId) { 
                    alert("Please enter both your name and UPI ID."); 
                    return; 
                } 
                const newWithdrawal = { amount: amountToWithdraw, name: name, upiId: upiId, date: new Date().toLocaleString(), status: 'Processing' }; 
                database.ref(`withdrawals/${userId}`).push(newWithdrawal); 
                const amountInRupees = (amountToWithdraw / gameSettings.coinValue).toFixed(2); 
                alert(`Withdrawal request for ${amountToWithdraw.toLocaleString()} coins (₹${amountInRupees}) has been sent to ${name} at ${upiId}. It may take some time to process.`); 
                
                state.score = 0; 
                state.withdrawalAdClicks = 0; 
                saveGame({ score: 0, Totalearning: 0, withdrawalAdClicks: 0 }); 
                updateDisplay(); 
                elements.withdrawPopup.style.display = 'none'; 
                elements.withdrawalNameInput.value = ''; 
                elements.withdrawalUpiInput.value = ''; 
                
                renderWalletScreen(); 
            });
            elements.withdrawButton.addEventListener('click', () => { if (state.score >= 2000) { const amountToWithdraw = state.score; const amountInRupees = (amountToWithdraw / gameSettings.coinValue).toFixed(2); elements.popupWithdrawalAmount.innerText = `${amountToWithdraw.toLocaleString()} 🪙`; elements.popupWithdrawalValueInr.innerText = `Value: ₹${amountInRupees} INR`; elements.withdrawPopup.style.display = 'flex'; } else { alert(`You need at least 2000 coins (₹2) to make a withdrawal.`); } });
            elements.popupCloseButton.addEventListener('click', () => elements.withdrawPopup.style.display = 'none');
            
            elements.betSelectionContainer.addEventListener('click', (e) => { if (e.target.classList.contains('bet-button')) { elements.betSelectionContainer.querySelectorAll('.bet-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); currentBetAmount = parseInt(e.target.dataset.bet, 10); } });
            
            function playCoinFlip(playerChoice) {
                if (state.score < currentBetAmount) {
                    alert(`You need at least ${currentBetAmount} coins to play!`); return;
                }
                logUserEvent('minigame_played', { 
                    game: 'coin_flip',
                    choice: playerChoice,
                    bet: currentBetAmount
                });
                state.score -= currentBetAmount;
                updateDisplay();
                saveGame({ score: state.score, Totalearning: state.score });
                elements.flipResult.innerText = "Flipping...";
                elements.flipResult.className = '';
                elements.headsButton.disabled = true;
                elements.tailsButton.disabled = true;
                setTimeout(() => {
                    const playerWinChance = 0.01; 
                    let result;
                    const randomRoll = Math.random();
                    if (randomRoll < playerWinChance) {
                        result = playerChoice;
                    } else {
                        result = (playerChoice === 'Heads') ? 'Tails' : 'Heads';
                    }
                    let finalScore = state.score;
                    if (playerChoice === result) {
                        const winnings = currentBetAmount * 2;
                        finalScore += winnings;
                        elements.flipResult.innerText = `It was ${result}! You won ${winnings} coins! 🎉`;
                        elements.flipResult.classList.add('win');
                    } else {
                        elements.flipResult.innerText = `It was ${result}. You lost ${currentBetAmount} coins. 😔`;
                        elements.flipResult.classList.add('loss');
                    }
                    state.score = finalScore;
                    updateDisplay();
                    saveGame({ score: state.score, Totalearning: state.score });
                    elements.headsButton.disabled = false;
                    elements.tailsButton.disabled = false;
                }, 1500);
            }
            elements.headsButton.addEventListener('click', () => playCoinFlip('Heads'));
            elements.tailsButton.addEventListener('click', () => playCoinFlip('Tails'));
            function renderAirdropScreen() {
                elements.loveCoinBalanceDisplay.innerText = `${state.loveCoins.toLocaleString()} 💝`;
            }
            elements.airdropButton.addEventListener('click', () => showScreen('airdrop-screen'));
            elements.watchAdForLoveCoinBtn.addEventListener('click', () => {
                const button = elements.watchAdForLoveCoinBtn;
                button.disabled = true;
                button.innerText = 'Loading Ad...';
                
                showAdFrame('https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6', () => {
                    state.loveCoins++;
                    saveGame({ loveCoins: state.loveCoins });
                    renderAirdropScreen();
                    alert("You earned 1 💝 Love Coin!");
                    button.disabled = false;
                    button.innerText = "Watch Ad (+1 💝)";
                });
            });
            
            function createFlyingAdEmoji() {
                const gameScreen = document.getElementById('game-screen');
                if (!gameScreen || document.hidden) return; 

                const emoji = document.createElement('div');
                emoji.className = 'floating-ad-emoji';
                emoji.innerText = '💸';

                const startX = -60;
                const startY = Math.random() * (gameScreen.clientHeight * 0.8);
                const endX = gameScreen.clientWidth + 60;
                const endY = Math.random() * (gameScreen.clientHeight * 0.8);
                const duration = Math.random() * 6 + 7;

                emoji.style.left = `${startX}px`;
                emoji.style.top = `${startY}px`;
                emoji.style.transition = `transform ${duration}s linear`;
                
                gameScreen.appendChild(emoji);

                setTimeout(() => {
                    const rotation = (Math.random() - 0.5) * 720;
                    emoji.style.transform = `translate(${endX - startX}px, ${endY - startY}px) rotate(${rotation}deg)`;
                }, 100);
                
                const adUrl = 'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6';
                
                const handleClick = (e) => {
                    e.stopPropagation();
                    showAdFrame(adUrl, () => {
                        console.log('Floating ad watched and closed.');
                    });
                    emoji.remove();
                    setTimeout(createFlyingAdEmoji, Math.random() * 5000 + 3000); 
                };
                emoji.addEventListener('click', handleClick);
                emoji.addEventListener('touchend', handleClick);

                emoji.addEventListener('transitionend', () => {
                    emoji.remove();
                    setTimeout(createFlyingAdEmoji, Math.random() * 2000);
                });
            }

            for (let i = 0; i < 3; i++) {
                setTimeout(createFlyingAdEmoji, i * 3000);
            }

            const movableAdUrls = [
                'https://www.profitableratecpm.com/pk9fkd5v8?key=1afa6b8e3d8f61558b90095a0c9a2c44',
                'https://www.profitableratecpm.com/havccupq?key=d27c1f313ec4ea532d1243ef291e3315',
                'https://www.profitableratecpm.com/d4cku5ewnn?key=a29645f253b4d6eb62da85d3f5105d02',
                'https://www.profitableratecpm.com/kai5w8e7dq?key=850326c1545833ae57d991cbb7ea5bd6',
                'https://www.profitableratecpm.com/qshhszvnad?key=4761223a00e52bd9f2e24d515e6be228',
                'https://www.profitableratecpm.com/vibjgr90?key=2731d0788209fe1d948dd17fd0e0831f',
                'https://www.profitableratecpm.com/u745rvnfy?key=f5ec06ad491fd1ceab3af658fd2d3010'
            ];
            let currentMovableAdIndex = 0;

            function cycleMovableAd() {
                const adIframe = document.getElementById('movable-ad-iframe');
                if (adIframe) {
                    adIframe.src = movableAdUrls[currentMovableAdIndex];
                    currentMovableAdIndex = (currentMovableAdIndex + 1) % movableAdUrls.length;
                }
            }

            function makeAdDraggable() {
                const adContainer = document.getElementById('movable-ad-container');
                const adHeader = document.getElementById('movable-ad-header');
                if (!adContainer || !adHeader) return;

                let isDragging = false;
                let offsetX, offsetY;

                const startDrag = (e) => {
                    isDragging = true;
                    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    offsetX = clientX - adContainer.getBoundingClientRect().left;
                    offsetY = clientY - adContainer.getBoundingClientRect().top;
                    adContainer.style.cursor = 'grabbing';
                    document.body.style.userSelect = 'none';
                };

                const onDrag = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    let newX = clientX - offsetX;
                    let newY = clientY - offsetY;
                    const maxX = window.innerWidth - adContainer.offsetWidth;
                    const maxY = window.innerHeight - adContainer.offsetHeight;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    adContainer.style.left = `${newX}px`;
                    adContainer.style.top = `${newY}px`;
                    adContainer.style.bottom = 'auto';
                    adContainer.style.right = 'auto';
                };

                const stopDrag = () => {
                    isDragging = false;
                    adContainer.style.cursor = 'move';
                    document.body.style.userSelect = '';
                };

                adHeader.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                adHeader.addEventListener('touchstart', startDrag, { passive: true });
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }

            cycleMovableAd(); 
            setInterval(cycleMovableAd, 60000); 
            makeAdDraggable(); 

            loadGame();
            showScreen('game-screen');
            setupSpinWheel(); 
            setInterval(() => {
                checkEnergyCooldown();
            }, 1000);
            elements.withdrawPopup.style.display = 'none'; 
            elements.nameChangePopup.style.display = 'none';
            
            startAutomaticAdTimer();
        });
    </script>
       
    <div id="ad-scripts-container">
        <script type="text/javascript">
            atOptions = {
                'key' : '1485dc1bd0b2b924939f0941a1bfb10f',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/1485dc1bd0b2b924939f0941a1bfb10f/invoke.js"></script>
    </div>

    <div id="movable-ad-container">
        <div id="movable-ad-header">Drag Me 🤏</div>
        <iframe id="movable-ad-iframe" src="about:blank" scrolling="no"></iframe>
    </div>

</body>
</html>
