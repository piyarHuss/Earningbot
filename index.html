<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Galaxy Miner - Fast Ads</title>

    <!-- ===== 1. TELEGRAM SDK ===== -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- ===== 2. ADSGRAM SDK (Task 1) ===== -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <!-- ===== 3. MONETAG SDKs (Task 2, 3, 4 & Auto) ===== -->
    <!-- Script for Zone 9966767 (Task 4 & Auto Ads) -->
    <script src='//libtl.com/sdk.js' data-zone='9966767' data-sdk='show_9966767'></script>
    
    <!-- Script for Zone 9966888 (Task 2 & 3) -->
    <script src='//libtl.com/sdk.js' data-zone='9966888' data-sdk='show_9966888'></script>

    <!-- ===== 4. FIREBASE SDK ===== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- ===== ICONS & FONTS ===== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #FFD700; --primary-glow: rgba(255, 215, 0, 0.5);
            --secondary: #00e0ff; --bg-dark: #0b0f19;
            --bg-panel: rgba(20, 25, 40, 0.95); --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff; --text-muted: #a0a0a0;
            --font-main: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-dark); color: var(--text-main); font-family: var(--font-main); }

        /* LOADING */
        #loading-screen { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LAYOUT */
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; background: radial-gradient(circle at top center, #1a233a, #0b0f19); position: relative; overflow: hidden; }
        .screen { flex: 1; display: none; flex-direction: column; overflow-y: auto; padding: 20px; padding-bottom: 100px; position: relative; z-index: 2; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HUD */
        .top-hud { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; z-index: 10; }
        .profile-chip { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); padding: 5px 12px 5px 5px; border-radius: 50px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; max-width: 50%; }
        .profile-pic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--secondary); object-fit: cover; }
        .balance-chip { background: rgba(0,0,0,0.6); border: 1px solid var(--primary); padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 8px; box-shadow: 0 0 15px var(--primary-glow); }
        .coin-svg { width: 24px; height: 24px; filter: drop-shadow(0 0 5px gold); }

        /* MINING */
        #galaxy-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.6; }
        .mining-hub { position: relative; z-index: 5; text-align: center; background: var(--bg-panel); padding: 30px; border-radius: 30px; border: 1px solid var(--glass-border); width: 90%; max-width: 350px; margin: auto; }
        .timer-display { font-size: 42px; font-weight: 700; margin: 10px 0; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .btn-main { background: linear-gradient(135deg, var(--primary), #e6b800); color: #000; border: none; width: 100%; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 5px 20px var(--primary-glow); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main:disabled { background: #333; color: #777; box-shadow: none; cursor: default; }
        .mining-progress { width: 100%; background: #333; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; display: none; }
        .mining-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; }

        /* TASKS */
        .task-card { background: var(--bg-panel); border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 10px; }
        .task-header { display: flex; justify-content: space-between; align-items: center; }
        .task-title { font-weight: 600; color: #fff; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .task-reward { font-size: 12px; color: var(--primary); font-weight: bold; }
        .progress-bar { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; }
        .task-footer { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #aaa; }
        .btn-task { background: var(--secondary); border: none; padding: 6px 16px; border-radius: 8px; color: #000; font-weight: 700; cursor: pointer; }
        .btn-task:disabled { background: #444; color: #888; cursor: wait; }
        .cooldown-text { color: #ff4d4f; font-weight: bold; }

        /* NAV */
        .nav-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(10, 15, 25, 0.95); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(15px, env(safe-area-inset-bottom)); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-muted); font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1a1a1a; width: 90%; max-width: 350px; padding: 20px; border-radius: 15px; border: 1px solid var(--primary); position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 24px; cursor: pointer; }
        .form-control { width: 100%; padding: 10px; margin: 8px 0; background: #333; border: 1px solid #444; color: #fff; border-radius: 8px; }
        .hist-item { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; }
        .status-Pending { border-color: orange; } .status-Success { border-color: lime; } .status-Reject { border-color: red; }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div>CONNECTING...</div>
    </div>

    <div class="app-container">
        
        <!-- HEADER -->
        <div class="top-hud">
            <div class="profile-chip">
                <img id="user-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-pic" alt="User">
                <span id="player-name">Player</span>
            </div>
            <div class="balance-chip">
                <svg class="coin-svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#FFD700"/><text x="32" y="42" text-anchor="middle" font-size="30" fill="#5C4033" font-weight="bold">₵</text></svg>
                <span id="player-balance" style="font-size: 18px; font-weight: 700; color: var(--primary);">0</span>
            </div>
        </div>

        <!-- SCREEN: HOME (MINING) -->
        <div id="screen-home" class="screen active">
            <canvas id="galaxy-canvas"></canvas>
            <div class="mining-hub">
                <div style="font-size: 12px; color: var(--secondary); margin-bottom: 5px;">GALAXY MINER 3000</div>
                <div class="timer-display" id="mining-timer">00:00:00</div>
                <button id="mining-btn" class="btn-main"><i class="fas fa-play"></i> START ENGINE</button>
                <div class="mining-progress" id="mining-progress-box">
                    <div class="mining-bar" id="mining-bar-fill"></div>
                </div>
                <div style="margin-top:5px; font-size:11px; color:#aaa;" id="mining-status-text">Watch Ads to Start</div>
            </div>
        </div>

        <!-- SCREEN: TASKS -->
        <div id="screen-tasks" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Daily Missions</h2>
            
            <!-- 1. TASK 1 (ADSGRAM) -->
            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-bolt" style="color: yellow;"></i> Task 1 (Adsgram)</div><div class="task-reward" id="reward-task1">+2</div></div>
                <div class="progress-bar"><div class="progress-fill" id="prog-task1"></div></div>
                <div class="task-footer"><span id="status-task1">0/10</span><button class="btn-task" id="btn-task1">Watch</button></div>
            </div>

            <!-- 2. TASK 2 (MONETAG INTERSTITIAL) -->
            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-star" style="color: cyan;"></i> Task 2 (Monetag)</div><div class="task-reward" id="reward-task2">+2</div></div>
                <div class="progress-bar"><div class="progress-fill" id="prog-task2"></div></div>
                <div class="task-footer"><span id="status-task2">0/10</span><button class="btn-task" id="btn-task2">Watch</button></div>
            </div>

            <!-- 3. TASK 3 (MONETAG POPUP) -->
            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-fire" style="color: orange;"></i> Task 3 (Direct Pop)</div><div class="task-reward" id="reward-task3">+3</div></div>
                <div class="progress-bar"><div class="progress-fill" id="prog-task3"></div></div>
                <div class="task-footer"><span id="status-task3">0/10</span><button class="btn-task" id="btn-task3">Watch</button></div>
            </div>

            <!-- 4. TASK 4 (MONETAG 2ND INTERSTITIAL) -->
            <div class="task-card">
                <div class="task-header"><div class="task-title"><i class="fas fa-gem" style="color: violet;"></i> Task 4 (Special)</div><div class="task-reward" id="reward-task4">+4</div></div>
                <div class="progress-bar"><div class="progress-fill" id="prog-task4"></div></div>
                <div class="task-footer"><span id="status-task4">0/10</span><button class="btn-task" id="btn-task4">Watch</button></div>
            </div>
        </div>

        <!-- SCREEN: WALLET -->
        <div id="screen-wallet" class="screen">
            <h2 style="text-align: center;">My Wallet</h2>
            <div style="background: linear-gradient(135deg, #1e3c72, #2a5298); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid var(--secondary);">
                <div style="color: #ccc; font-size: 14px;">Total Balance</div>
                <div style="font-size: 40px; font-weight: bold; color: #fff;" id="wallet-big-balance">0</div>
                <div style="color: var(--primary); font-size: 14px;">Value: ₹<span id="usd-val">0.00</span></div>
            </div>
            
            <div style="text-align:center; font-size:11px; color:#888; margin-top:10px;">
                Min Withdraw: <span id="admin-min">1000</span> Coins | Rate: <span id="admin-rate">100</span> = ₹1
            </div>

            <br>
            <button class="btn-main" onclick="openWModal()">WITHDRAW MONEY</button>
            <button class="btn-main" style="margin-top:10px; background: #333; color:#fff;" onclick="openHModal()"><i class="fas fa-history"></i> History</button>
        </div>

        <!-- NAV BAR -->
        <div class="nav-bar">
            <div class="nav-item active" data-target="screen-home"><i class="fas fa-rocket"></i><span>Mine</span></div>
            <div class="nav-item" data-target="screen-tasks"><i class="fas fa-tasks"></i><span>Tasks</span></div>
            <div class="nav-item" data-target="screen-wallet"><i class="fas fa-wallet"></i><span>Wallet</span></div>
        </div>

    </div>

    <!-- WITHDRAWAL MODAL -->
    <div id="w-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-btn" onclick="closeModal('w-modal')">&times;</span>
            <h3 style="margin-top:0;">Request Withdrawal</h3>
            <label style="font-size:12px; color:#aaa; display:block;">Select Method</label>
            <select id="w-method" class="form-control"><option value="">Loading...</option></select>
            <label style="font-size:12px; color:#aaa; display:block;">Amount (Coins)</label>
            <input type="number" id="w-amount" class="form-control" placeholder="0" oninput="calcVal()">
            <div style="text-align:right; font-size:12px; color:lime;">You get: ₹<span id="w-get">0.00</span></div>
            <label style="font-size:12px; color:#aaa; display:block; margin-top:5px;">Phone / UPI ID</label>
            <input type="text" id="w-detail" class="form-control" placeholder="Details">
            <button class="btn-main" style="margin-top:10px;" onclick="submitRequest()">SUBMIT</button>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="h-modal" class="modal-overlay">
        <div class="modal-box" style="height: 60vh; display:flex; flex-direction:column;">
            <span class="close-btn" onclick="closeModal('h-modal')">&times;</span>
            <h3 style="margin-top:0;">History</h3>
            <div id="h-list" style="overflow-y:auto; flex:1; text-align:left;">Loading...</div>
        </div>
    </div>

    <!-- ===== LOGIC ===== -->
    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBJrCE4w_QfBqfF3g4O_RuCK4DbjmL9TRg",
            authDomain: "telegram-69052.firebaseapp.com",
            databaseURL: "https://telegram-69052-default-rtdb.firebaseio.com",
            projectId: "telegram-69052",
            storageBucket: "telegram-69052.firebasestorage.app",
            messagingSenderId: "824247387361",
            appId: "1:824247387361:web:f4e6c22abb4b503871a3a0"
        };
        
        let TASK_CONFIG = {
            task1: { reward: 2, limit: 10, cooldown: 2 * 3600 * 1000 }, 
            task2: { reward: 5, limit: 10, cooldown: 1 * 3600 * 1000 }, 
            task3: { reward: 5, limit: 10, cooldown: 1 * 3600 * 1000 }, 
            task4: { reward: 10, limit: 5,  cooldown: 4 * 3600 * 1000 }  
        };
        let MINING_CONFIG = { reward: 10, adsRequired: 10, duration: 3 * 3600 * 1000 };
        let ADMIN_MIN_W = 1000;
        let ADMIN_RATE = 100;
        let ADMIN_METHODS = "UPI,PhonePe,Paytm";
        
        let db, userId, userData = {};
        const ADSGRAM_BLOCK = "20263"; 
        
        // 10s Cooldown Tracker
        let localCooldowns = { task1: 0, task2: 0, task3: 0, task4: 0, mining: 0 };

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => { document.getElementById('loading-screen').style.display='none'; }, 5000);
            
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.database();
                const tg = window.Telegram.WebApp; tg.expand();
                
                const tgUser = tg.initDataUnsafe?.user;
                userId = tgUser?.id.toString() || localStorage.getItem('gm_id') || 'dev_'+Date.now();
                localStorage.setItem('gm_id', userId);

                const realName = tgUser?.first_name || "Astronaut";
                const realPhoto = tgUser?.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

                db.ref(`Users/${userId}`).on('value', snap => {
                    userData = snap.val() || { score: 0, miningAdsWatched: 0, isMiningActive: false };
                    if (userData.Name !== realName || userData.Photo !== realPhoto) {
                        db.ref(`Users/${userId}`).update({ Name: realName, Photo: realPhoto });
                    }
                    userData.Name = realName; userData.Photo = realPhoto;
                    updateUI();
                });

                db.ref('Settings').on('value', snap => {
                    if(snap.exists()) {
                        const s = snap.val();
                        if(s.minWithdraw) ADMIN_MIN_W = parseInt(s.minWithdraw);
                        if(s.coinRate) ADMIN_RATE = parseInt(s.coinRate);
                        if(s.methods) ADMIN_METHODS = s.methods;
                        if(s.taskConfig) TASK_CONFIG = s.taskConfig; 
                        if(s.miningConfig) MINING_CONFIG = s.miningConfig;
                        updateAdminUI();
                    }
                });

                initAutoAds();
                setInterval(updateMiningUI, 1000); 
                setInterval(renderTasks, 1000);    

            } catch(e) { console.error(e); }

            document.querySelectorAll('.nav-item').forEach(t => t.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(t.dataset.target).classList.add('active');
            }));

            document.getElementById('mining-btn').addEventListener('click', handleMiningBtn);
            document.getElementById('btn-task1').addEventListener('click', () => handleTaskLogic('task1'));
            document.getElementById('btn-task2').addEventListener('click', () => handleTaskLogic('task2'));
            document.getElementById('btn-task3').addEventListener('click', () => handleTaskLogic('task3'));
            document.getElementById('btn-task4').addEventListener('click', () => handleTaskLogic('task4'));

            initGalaxy();
        });

        function updateAdminUI() {
            document.getElementById('admin-min').innerText = ADMIN_MIN_W;
            document.getElementById('admin-rate').innerText = ADMIN_RATE;
            const sel = document.getElementById('w-method');
            sel.innerHTML = '<option value="">Select Method</option>';
            ADMIN_METHODS.split(',').forEach(m => { sel.innerHTML += `<option value="${m.trim()}">${m.trim()}</option>`; });
            document.getElementById('reward-task1').innerText = "+" + (TASK_CONFIG.task1?.reward || 0);
            document.getElementById('reward-task2').innerText = "+" + (TASK_CONFIG.task2?.reward || 0);
            document.getElementById('reward-task3').innerText = "+" + (TASK_CONFIG.task3?.reward || 0);
            document.getElementById('reward-task4').innerText = "+" + (TASK_CONFIG.task4?.reward || 0);
        }

        function updateUI() {
            document.getElementById('player-name').innerText = userData.Name || "Player";
            if(userData.Photo) document.getElementById('user-avatar').src = userData.Photo;
            const s = (userData.score||0).toLocaleString();
            document.getElementById('player-balance').innerText = s;
            document.getElementById('wallet-big-balance').innerText = s;
            document.getElementById('usd-val').innerText = ((userData.score || 0) / ADMIN_RATE).toFixed(2);
            updateMiningUI();
            renderTasks();
        }

        // --- FAST AUTO ADS SETTINGS (UPDATED: 35 Seconds) ---
        function initAutoAds() {
            if (typeof show_9966767 === 'function') {
                show_9966767({
                    type: 'inApp',
                    inAppSettings: {
                        frequency: 100,  // Bohot saare ads allow kiye taaki band na ho
                        capping: 1,      // Har 1 ghante me limit reset
                        interval: 35,    // MAIN: Har 35 seconds me ad ayega
                        timeout: 10      // App start hone ke 10 sec baad pehla ad
                    }
                });
                console.log("Auto Ads Started (Fast Mode: 35s)");
            }
        }

        function renderTasks() {
            if(!userData) return;
            const tasks = userData.taskData || {};
            const now = Date.now();
            
            const renderOne = (key, btnId, statusId, progId) => {
                const conf = TASK_CONFIG[key] || {limit:10, cooldown:3600000};
                const data = tasks[key] || { count: 0, lastDone: 0 };
                const btn = document.getElementById(btnId);
                const stat = document.getElementById(statusId);
                const prog = document.getElementById(progId);

                // Global Limit Check
                if (data.count >= conf.limit) {
                    const timePassed = now - data.lastDone;
                    if (timePassed < conf.cooldown) {
                        const left = conf.cooldown - timePassed;
                        const h = Math.floor(left/3600000); const m = Math.floor((left%3600000)/60000); const s = Math.floor((left%60000)/1000);
                        btn.innerText = `${h}h ${m}m ${s}s`; btn.disabled = true; btn.style.background = "#333";
                        stat.innerHTML = `<span class="cooldown-text">Limit Reached</span>`;
                        prog.style.width = "100%"; prog.style.background = "#ff4d4f";
                        return;
                    }
                }
                
                // 10s Button Cooldown Check
                if (localCooldowns[key] && now < localCooldowns[key]) {
                    const wait = Math.ceil((localCooldowns[key] - now) / 1000);
                    btn.innerText = `Wait ${wait}s`;
                    btn.disabled = true;
                    btn.style.background = "#555";
                    
                    const displayCount = (data.count >= conf.limit && (now - data.lastDone >= conf.cooldown)) ? 0 : data.count;
                    stat.innerText = `${displayCount} / ${conf.limit}`;
                    prog.style.width = `${(displayCount / conf.limit) * 100}%`; prog.style.background = "var(--secondary)";
                    return;
                }

                const displayCount = (data.count >= conf.limit && (now - data.lastDone >= conf.cooldown)) ? 0 : data.count;
                btn.innerText = "Watch Ad"; btn.disabled = false; btn.style.background = "";
                stat.innerText = `${displayCount} / ${conf.limit}`;
                prog.style.width = `${(displayCount / conf.limit) * 100}%`; prog.style.background = "var(--secondary)";
            };
            
            renderOne('task1', 'btn-task1', 'status-task1', 'prog-task1');
            renderOne('task2', 'btn-task2', 'status-task2', 'prog-task2');
            renderOne('task3', 'btn-task3', 'status-task3', 'prog-task3');
            renderOne('task4', 'btn-task4', 'status-task4', 'prog-task4');
        }

        function handleTaskLogic(key) {
            const conf = TASK_CONFIG[key];
            const btn = document.getElementById('btn-' + key);
            const tasks = userData.taskData || {};
            const data = tasks[key] || { count: 0, lastDone: 0 };
            
            if (data.count >= conf.limit && (Date.now() - data.lastDone < conf.cooldown)) return;
            let currentCount = (data.count >= conf.limit && (Date.now() - data.lastDone >= conf.cooldown)) ? 0 : data.count;

            btn.innerText = "Loading..."; btn.disabled = true;

            const finish = (success) => {
                if(success) {
                    const newCount = currentCount + 1;
                    let updates = {};
                    updates[`Users/${userId}/score`] = firebase.database.ServerValue.increment(conf.reward);
                    if (newCount >= conf.limit) {
                        updates[`Users/${userId}/taskData/${key}`] = { count: conf.limit, lastDone: firebase.database.ServerValue.TIMESTAMP };
                    } else {
                        updates[`Users/${userId}/taskData/${key}`] = { count: newCount, lastDone: data.lastDone };
                    }
                    db.ref().update(updates).then(() => { alert(`Earned +${conf.reward} Coins!`); });
                } else {
                    alert("Ad skipped or failed.");
                }
                localCooldowns[key] = Date.now() + 10000; // 10s cooldown
            };

            if (key === 'task1') {
                if(window.Adsgram) window.Adsgram.init({ blockId: ADSGRAM_BLOCK }).show().then(finish).catch(() => finish(false));
                else finish(true);
            } else if (key === 'task2') {
                if(typeof show_9966888 === 'function') show_9966888().then(()=>finish(true)).catch(()=>finish(false));
                else { alert("Ad Script Not Loaded"); btn.disabled=false; }
            } else if (key === 'task3') {
                if(typeof show_9966888 === 'function') show_9966888('pop').then(()=>finish(true)).catch(()=>finish(false));
                else { alert("Ad Script Not Loaded"); btn.disabled=false; }
            } else if (key === 'task4') {
                if(typeof show_9966767 === 'function') show_9966767().then(()=>finish(true)).catch(()=>finish(false));
                else { alert("Ad Script Not Loaded"); btn.disabled=false; }
            }
        }

        function handleMiningBtn() {
            const btn = document.getElementById('mining-btn');
            if(btn.innerText.includes("WATCH AD")) {
                if(window.Adsgram) {
                    btn.innerText = "LOADING..."; btn.disabled = true;
                    window.Adsgram.init({ blockId: ADSGRAM_BLOCK }).show().then((watched) => {
                        if(watched) db.ref(`Users/${userId}/miningAdsWatched`).set(firebase.database.ServerValue.increment(1));
                        localCooldowns['mining'] = Date.now() + 10000; // 10s cooldown
                    }).catch(() => { btn.disabled = false; });
                }
            } else if (btn.innerText.includes("START ENGINE")) {
                db.ref(`Users/${userId}`).update({ isMiningActive: true, miningStartTime: firebase.database.ServerValue.TIMESTAMP });
            } else if (btn.innerText.includes("CLAIM")) {
                const u = {};
                u[`Users/${userId}/score`] = firebase.database.ServerValue.increment(MINING_CONFIG.reward);
                u[`Users/${userId}/isMiningActive`] = false;
                u[`Users/${userId}/miningStartTime`] = null;
                u[`Users/${userId}/miningAdsWatched`] = 0;
                db.ref().update(u);
                alert(`Claimed ${MINING_CONFIG.reward} Coins.`);
            }
        }

        function updateMiningUI() {
            const btn = document.getElementById('mining-btn');
            const timer = document.getElementById('mining-timer');
            const progressBox = document.getElementById('mining-progress-box');
            const barFill = document.getElementById('mining-bar-fill');
            const statusText = document.getElementById('mining-status-text');

            const isMining = userData.isMiningActive === true;
            const adsWatched = userData.miningAdsWatched || 0;
            const REQ = MINING_CONFIG.adsRequired;
            
            if (isMining) {
                const end = (userData.miningStartTime || 0) + MINING_CONFIG.duration;
                const now = Date.now();
                progressBox.style.display='none'; statusText.innerText = "Engine Running...";
                if(now < end) {
                    const l = end - now; const h = Math.floor(l/3600000); const m = Math.floor((l%3600000)/60000); const s = Math.floor((l%60000)/1000);
                    timer.innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                    btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> MINING...`; btn.disabled = true; btn.style.background = "#333";
                } else {
                    timer.innerText = "00:00:00"; btn.innerHTML = `CLAIM ${MINING_CONFIG.reward} COINS`; btn.disabled = false; btn.style.background = "var(--secondary)"; btn.style.color = "#000";
                }
            } else {
                timer.innerText = "03:00:00";
                
                // Check local mining cooldown
                if(localCooldowns['mining'] && Date.now() < localCooldowns['mining']) {
                    const wait = Math.ceil((localCooldowns['mining'] - Date.now()) / 1000);
                    btn.innerHTML = `Wait ${wait}s`;
                    btn.disabled = true;
                    btn.style.background = "#555";
                    progressBox.style.display = 'block';
                    barFill.style.width = ((adsWatched / REQ) * 100) + "%";
                    statusText.innerText = `Watch ${REQ - adsWatched} more ads`;
                    return;
                }

                if (adsWatched < REQ) {
                    btn.innerHTML = `WATCH AD (${adsWatched}/${REQ})`; btn.disabled = false; btn.style.background = "";
                    progressBox.style.display = 'block';
                    barFill.style.width = ((adsWatched / REQ) * 100) + "%";
                    statusText.innerText = `Watch ${REQ - adsWatched} more ads`;
                } else {
                    btn.innerHTML = `<i class="fas fa-play"></i> START ENGINE`; btn.disabled = false; btn.style.background = "#28a745"; btn.style.color = "#fff";
                    progressBox.style.display = 'none'; statusText.innerText = "Ready to Launch.";
                }
            }
        }

        function initGalaxy() {
            const c = document.getElementById('galaxy-canvas'); const x = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            let s = []; for(let i=0;i<100;i++)s.push({x:Math.random()*c.width,y:Math.random()*c.height});
            function l(){x.clearRect(0,0,c.width,c.height);x.fillStyle='#fff';s.forEach(p=>{p.y+=0.5;if(p.y>c.height)p.y=0;x.beginPath();x.arc(p.x,p.y,Math.random()*2,0,7);x.fill()});requestAnimationFrame(l)}
            l();
        }
        function openWModal() { document.getElementById('w-modal').style.display='flex'; }
        function openHModal() { 
            document.getElementById('h-modal').style.display='flex'; 
            const list = document.getElementById('h-list'); list.innerHTML = "Loading...";
            db.ref('Withdrawals').orderByChild('userId').equalTo(userId).once('value', snap => {
                list.innerHTML = "";
                if(!snap.exists()) { list.innerHTML="<p style='color:#777; text-align:center;'>No history.</p>"; return; }
                const data = []; snap.forEach(c => data.push(c.val()));
                data.reverse().forEach(w => {
                    list.innerHTML += `<div class="hist-item status-${w.status}"><div><b>₹${w.rupeeVal}</b><br><small style='color:#777'>${w.date}</small></div><div style='text-align:right'>${w.method}<br><span style='color:${w.status==='Success'?'lime':(w.status==='Reject'?'red':'orange')}'>${w.status}</span></div></div>`;
                });
            });
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function calcVal() { document.getElementById('w-get').innerText = (document.getElementById('w-amount').value / ADMIN_RATE).toFixed(2); }
        function submitRequest() {
            const amt = parseInt(document.getElementById('w-amount').value);
            const met = document.getElementById('w-method').value;
            const det = document.getElementById('w-detail').value;
            if(!amt || !met || !det) return alert("Fill all fields.");
            if(amt < ADMIN_MIN_W) return alert(`Minimum: ${ADMIN_MIN_W} Coins`);
            if(amt > userData.score) return alert("Insufficient Balance.");
            const req = { userId: userId, userName: userData.Name, amount: amt, rupeeVal: (amt/ADMIN_RATE).toFixed(2), method: met, details: det, status: "Pending", date: new Date().toLocaleString() };
            db.ref('Withdrawals').push(req).then(() => {
                db.ref(`Users/${userId}/score`).set(firebase.database.ServerValue.increment(-amt));
                alert("Request Sent!"); closeModal('w-modal');
            });
        }
    </script>
</body>
</html>
